============================== PROJECT STRUCTURE ==============================
SwiftDevBot-Lite/
    ‚îú‚îÄ‚îÄ .git/ [EXCLUDED_DIR]
    ‚îú‚îÄ‚îÄ .venv/ [EXCLUDED_DIR]
    ‚îú‚îÄ‚îÄ alembic_migrations/
    ‚îÇ       ‚îú‚îÄ‚îÄ versions/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ .gitkeep
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ d10040ec2cb7_initial_migration_for_core_tables.py
    ‚îÇ       ‚îú‚îÄ‚îÄ env.py
    ‚îÇ       ‚îî‚îÄ‚îÄ script.py.mako
    ‚îú‚îÄ‚îÄ cli_commands/
    ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îú‚îÄ‚îÄ backup_cmd.py
    ‚îÇ       ‚îú‚îÄ‚îÄ bot_cmd.py
    ‚îÇ       ‚îú‚îÄ‚îÄ cli_utils.py
    ‚îÇ       ‚îú‚îÄ‚îÄ control_cmd.py
    ‚îÇ       ‚îú‚îÄ‚îÄ db_cmd.py
    ‚îÇ       ‚îú‚îÄ‚îÄ module_cmd.py
    ‚îÇ       ‚îú‚îÄ‚îÄ setup_cmd.py
    ‚îÇ       ‚îú‚îÄ‚îÄ system_cmd.py
    ‚îÇ       ‚îî‚îÄ‚îÄ user_cmd.py
    ‚îú‚îÄ‚îÄ core/
    ‚îÇ       ‚îú‚îÄ‚îÄ admin/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ entry/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ handlers_entry.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ logs_viewer/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_logs.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_modules.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_modules.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ modules_mgmt/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_modules.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_modules.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ roles/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_crud_fsm.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_details.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_list.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_role_perms.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_roles.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ sys_info/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_sys_info.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_sys_info.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ users/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_details.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_direct_perms.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_list.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_roles_assign.py
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_users.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ filters_admin.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_log_viewer.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_module_management.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ keyboards_admin_common.py
    ‚îÇ       ‚îú‚îÄ‚îÄ cache/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ manager.py
    ‚îÇ       ‚îú‚îÄ‚îÄ database/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ base.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ core_models.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ db_utils.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ manager.py
    ‚îÇ       ‚îú‚îÄ‚îÄ events/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ dispatcher.py
    ‚îÇ       ‚îú‚îÄ‚îÄ http_client/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ manager.py
    ‚îÇ       ‚îú‚îÄ‚îÄ i18n/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ middleware.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ translator.py
    ‚îÇ       ‚îú‚îÄ‚îÄ rbac/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ service.py
    ‚îÇ       ‚îú‚îÄ‚îÄ schemas/
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ module_manifest.py
    ‚îÇ       ‚îú‚îÄ‚îÄ sys_modules/
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îú‚îÄ‚îÄ ui/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ callback_data_factories.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_core_ui.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ keyboards_core.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ navigation_core.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ registry_ui.py
    ‚îÇ       ‚îú‚îÄ‚îÄ users/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ middleware.py
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ service.py
    ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îú‚îÄ‚îÄ app_settings.py
    ‚îÇ       ‚îú‚îÄ‚îÄ bot_entrypoint.py
    ‚îÇ       ‚îú‚îÄ‚îÄ logging_manager.py
    ‚îÇ       ‚îú‚îÄ‚îÄ module_loader.py
    ‚îÇ       ‚îî‚îÄ‚îÄ services_provider.py
    ‚îú‚îÄ‚îÄ locales/
    ‚îú‚îÄ‚îÄ modules/
    ‚îÇ       ‚îú‚îÄ‚îÄ example_module/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ callback_data_factories_example.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ handlers_example.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ keyboards_example.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ manifest.yaml
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ models.py
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ module_settings.yaml
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ permissions.py
    ‚îÇ       ‚îú‚îÄ‚îÄ .gitkeep
    ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îî‚îÄ‚îÄ Create_modules.md
    ‚îú‚îÄ‚îÄ project_data/
    ‚îÇ       ‚îú‚îÄ‚îÄ Cache_data/
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ .gitkeep
    ‚îÇ       ‚îú‚îÄ‚îÄ Config/
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ modules_settings/
    ‚îÇ       ‚îÇ               ‚îî‚îÄ‚îÄ example_module.yaml
    ‚îÇ       ‚îú‚îÄ‚îÄ core_backups/
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ .gitkeep
    ‚îÇ       ‚îú‚îÄ‚îÄ Database_files/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ .gitkeep
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ sdb_clean_test.db [EXCLUDED_FILE]
    ‚îÇ       ‚îú‚îÄ‚îÄ Logs/
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 2025/
    ‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ 08-August/
    ‚îÇ       ‚îÇ       ‚îÇ               ‚îî‚îÄ‚îÄ 01/
    ‚îÇ       ‚îÇ       ‚îÇ                       ‚îî‚îÄ‚îÄ 05_sdb.log [EXCLUDED_FILE]
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ .gitkeep
    ‚îÇ       ‚îú‚îÄ‚îÄ module_backups/
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ .gitkeep
    ‚îÇ       ‚îî‚îÄ‚îÄ .gitignore
    ‚îú‚îÄ‚îÄ scripts/
    ‚îÇ       ‚îú‚îÄ‚îÄ clean_cache.py
    ‚îÇ       ‚îú‚îÄ‚îÄ commands.txt
    ‚îÇ       ‚îú‚îÄ‚îÄ create_project_structure.py
    ‚îÇ       ‚îú‚îÄ‚îÄ replace_uk_to_ua.py
    ‚îÇ       ‚îú‚îÄ‚îÄ reset_alembic.py
    ‚îÇ       ‚îú‚îÄ‚îÄ snapshot_generator.py
    ‚îÇ       ‚îî‚îÄ‚îÄ test_db_support.py
    ‚îú‚îÄ‚îÄ .env
    ‚îú‚îÄ‚îÄ .env.example
    ‚îú‚îÄ‚îÄ .gitignore
    ‚îú‚îÄ‚îÄ alembic.ini
    ‚îú‚îÄ‚îÄ babel.cfg
    ‚îú‚îÄ‚îÄ config.yaml
    ‚îú‚îÄ‚îÄ project_snapshot.txt [EXCLUDED_FILE]
    ‚îú‚îÄ‚îÄ requirements.txt
    ‚îú‚îÄ‚îÄ run_bot.py
    ‚îú‚îÄ‚îÄ sdb
    ‚îî‚îÄ‚îÄ sdb.py

======================================================================

------------------------------ FILE: config.yaml ------------------------------
# –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SwiftDevBot (config.yaml)
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —à–∞–±–ª–æ–Ω –¥–ª—è –∫–æ–º–∞–Ω–¥—ã 'sdb config init'.
# –†–∞–±–æ—á–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ project_data/Config/core_settings.yaml

db:
  type: "sqlite"  # –¢–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: "sqlite", "postgresql", "mysql"
  # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É SQLite, –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞ (core.project_data_path)
  # sqlite_path: "Database_files/swiftdevbot.db" 
  # pg_dsn: "postgresql+asyncpg://user:pass@host:port/dbname" # DSN –¥–ª—è PostgreSQL
  # mysql_dsn: "mysql+aiomysql://user:pass@host:port/dbname" # DSN –¥–ª—è MySQL
  echo_sql: false # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã SQLAlchemy (—É—Ä–æ–≤–µ–Ω—å DEBUG)

cache:
  # type: "memory" # –¢–∏–ø –∫—ç—à–∞: "memory", "redis"
  # redis_url: "redis://localhost:6379/0" # URL –¥–ª—è Redis

telegram:
  # token: "–í–ê–®_–¢–ï–õ–ï–ì–†–ê–ú_–¢–û–ö–ï–ù" # !!! –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –£–ö–ê–ó–´–í–ê–¢–¨ BOT_TOKEN –í .env –§–ê–ô–õ–ï !!!
  polling_timeout: 30 # –¢–∞–π–º–∞—É—Ç –¥–ª—è long polling (—Å–µ–∫—É–Ω–¥—ã)

module_repo:
  index_url: "https://raw.githubusercontent.com/soverxos/SwiftDevBot-Modules/main/modules_index.json" # URL –∫ –∏–Ω–¥–µ–∫—Å—É –º–æ–¥—É–ª–µ–π

core:
  # –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞. –ú–æ–∂–µ—Ç –±—ã—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –∏–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º –∫ –∫–æ—Ä–Ω—é –ø—Ä–æ–µ–∫—Ç–∞.
  project_data_path: "./project_data" 
  super_admins: [] # –°–ø–∏—Å–æ–∫ Telegram ID —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä: [123456789, 9876543210]
  
  # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π, –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞
  enabled_modules_config_path: "Config/enabled_modules.json" 
  
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
  log_level: "INFO" # –£—Ä–æ–≤–µ–Ω—å: TRACE, DEBUG, INFO, WARNING, ERROR, CRITICAL
  log_to_file: true # –ü–∏—Å–∞—Ç—å –ª–∏ –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª
  # –ë–∞–∑–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ project_data_path).
  # –§–∞–π–ª—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö YYYY/MM-MonthName/DD/HH_sdb.log
  log_structured_dir: "Logs" 
  # –†–æ—Ç–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ –ª–æ–≥–∞ –ø–æ —Ä–∞–∑–º–µ—Ä—É.
  log_rotation_size: "100 MB" 
  # –ö–∞–∫ –¥–æ–ª–≥–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "30 days", "3 months").
  # –†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ–π –æ—á–∏—Å—Ç–∫–∏ –≤–Ω—É—Ç—Ä–∏ –±–æ—Ç–∞.
  log_retention_period_structured: "3 months" 

  sdb_version: "0.1.0" # –í–µ—Ä—Å–∏—è —è–¥—Ä–∞ (–º–æ–∂–Ω–æ –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å –∑–¥–µ—Å—å, –µ—Å–ª–∏ –±–µ—Ä–µ—Ç—Å—è –∏–∑ –¥–µ—Ñ–æ–ª—Ç–∞ –º–æ–¥–µ–ª–∏)
  setup_bot_commands_on_startup: true # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ª–∏ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

  i18n:
    # –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞)
    locales_dir: "locales" 
    domain: "bot"
    default_locale: "en"
    available_locales: ["en", "ua"]


======================================================================

------------------------------ FILE: .gitignore ------------------------------
# === Swift / Xcode ===
.build/
DerivedData/
*.xcworkspace
*.xcodeproj/
*.xcuserdata/
*.swiftpm/
Package.resolved
TEST/

# Swift Playgrounds
timeline.xctimeline
playground.xcworkspace

# === Python ===
# Byte-compiled / optimized / DLL files
__pycache__/
*.py[cod]
*$py.class
*.so

# C extensions
*.so

# Distribution / packaging
.Python
build/
develop-eggs/
dist/
downloads/
project_data/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
pip-wheel-metadata/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# PyInstaller
*.manifest
*.spec

# Installer logs
pip-log.txt
pip-delete-this-directory.txt

# Unit test / coverage reports
htmlcov/
.tox/
.nox/
.coverage
.coverage.*
.cache
nosetests.xml
coverage.xml
*.cover
*.py,cover
.hypothesis/
.pytest_cache/

# Virtual environments
.venv/
venv/
ENV/
env/ # –û—Å—Ç–∞–≤–∏–º –æ–¥–∏–Ω 'env/'
env.bak/
venv.bak/

# pipenv/poetry/pyproject artifacts
Pipfile.lock
poetry.lock
pyproject.toml.lock

# Jupyter Notebook
.ipynb_checkpoints

# IPython
profile_default/
ipython_config.py

# pyenv
.python-version

# celery beat schedule file
celerybeat-schedule

# SageMath parsed files
*.sage.py

# Spyder project settings
.spyderproject
.spyproject

# Rope project settings
.ropeproject

# mkdocs documentation
/site

# mypy
.mypy_cache/
.dmypy.json
dmypy.json

# Pyre type checker
.pyre/

# === General ===
# macOS
.DS_Store
.AppleDouble
.LSOverride

# Windows
Thumbs.db
Thumbs.db:encryptable
ehthumbs.db
ehthumbs_vista.db
Desktop.ini
$RECYCLE.BIN/
*.cab
*.msi
*.msix
*.msm
*.msp
*.lnk

# Linux
*~

# Logs and temp
*.log
*.tmp
*.swp
*.swo
*.bak
*.backup
# *~ # –£–∂–µ –µ—Å—Ç—å –≤—ã—à–µ

# VSCode / JetBrains IDEs
.vscode/
.idea/
# *.swp # –£–∂–µ –µ—Å—Ç—å –≤—ã—à–µ
# *.swo # –£–∂–µ –µ—Å—Ç—å –≤—ã—à–µ

# === Database ===
*.db
*.sqlite
*.sqlite3

# === Environment ===
.env
.env.local
.env.*.local


======================================================================

------------------------------ FILE: requirements.txt ------------------------------
# requirements.txt
# Core Aiogram and Bot functionality
aiogram # –†–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é 3.x, –Ω–∞–ø—Ä–∏–º–µ—Ä, 3.7.0 –∏–ª–∏ –Ω–æ–≤–µ–µ
python-dotenv

# Configuration
pydantic # –ò—Å–ø–æ–ª—å–∑—É–µ–º Pydantic v2
pydantic-settings
pydantic-extra-types # –î–ª—è DSN –∏ –¥—Ä—É–≥–∏—Ö –¥–æ–ø. —Ç–∏–ø–æ–≤
PyYAML>=6.0

# Database (SQLAlchemy & Alembic)
SQLAlchemy[asyncio] # [asyncio] –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –¥—Ä–∞–π–≤–µ—Ä–æ–≤
alembic

# Async Database Drivers (–≤—ã–±–µ—Ä–∏ –∏–ª–∏ –æ—Å—Ç–∞–≤—å –≤—Å–µ, –µ—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—à—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ)
aiosqlite                 # –î–ª—è SQLite
psycopg[binary]    # –î–ª—è PostgreSQL (–±–∏–Ω–∞—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–º–ø–∏–ª—è—Ü–∏–µ–π)
# asyncpg>=0.27.0           # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä –¥–ª—è PostgreSQL, –µ—Å–ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ—à—å –µ–≥–æ psycopg
aiomysql           # –î–ª—è MySQL

# Logging
loguru
parsedatetime
apscheduler

# CLI
typer[all] # [all] –≤–∫–ª—é—á–∞–µ—Ç rich –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏

# HTTP Client
aiohttp

# Version comparison (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ModuleLoader)
packaging

# Cache (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è MemoryCache —Å TTLCache)
cachetools
rich # –î–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ CLI

# System Information (–¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏)
psutil


======================================================================

------------------------------ FILE: sdb.py ------------------------------
# sdb.py

import asyncio
import sys
import os
import subprocess
import time
from pathlib import Path

current_script_path = Path(__file__).resolve()
project_root = current_script_path.parent
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

try:
    import typer
    from rich.console import Console
    from rich.panel import Panel
    from loguru import logger as global_logger 
except ImportError as e:
    print(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (Typer, Rich, Loguru) –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. {e}", file=sys.stderr)
    print(f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ requirements.txt –∏–ª–∏ requirements-dev.txt:", file=sys.stderr)
    print(f"  pip install -r requirements.txt", file=sys.stderr)
    sys.exit(1)

sdb_console = Console()

try:
    from cli_commands.setup_cmd import config_app
    from cli_commands.db_cmd import db_app
    from cli_commands.module_cmd import module_app
    from cli_commands.user_cmd import user_app
    from cli_commands.backup_cmd import backup_app
    from cli_commands.system_cmd import system_app
    from cli_commands.control_cmd import control_app, PID_FILENAME 
    from cli_commands.bot_cmd import bot_app 
    from core.bot_entrypoint import run_sdb_bot 
except ImportError as e:
    sdb_console.print(f"[bold red]–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:[/]\n –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã SDB CLI –∏–ª–∏ —è–¥—Ä–∞: {e}")
    sdb_console.print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã —è–¥—Ä–∞ –∏ CLI –Ω–∞ –º–µ—Å—Ç–µ –∏ PYTHONPATH –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.")
    sdb_console.print_exception(show_locals=False)
    sys.exit(1)
except Exception as e:
    sdb_console.print(f"[bold red]–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SDB CLI (–≤–æ –≤—Ä–µ–º—è –∏–º–ø–æ—Ä—Ç–æ–≤):[/]\n {e}")
    sdb_console.print_exception(show_locals=True)
    sys.exit(1)

cli_main_app = typer.Typer(
    name="sdb",
    help="üöÄ [bold cyan]SwiftDevBot CLI[/] - –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–∏–º SDB!",
    rich_markup_mode="rich",
    add_completion=False,
    no_args_is_help=True,
    context_settings={"help_option_names": ["-h", "--help"]}
)

cli_main_app.add_typer(config_app, name="config", help="üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π SDB (init, info).")
cli_main_app.add_typer(db_app, name="db", help="üóÑÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ Alembic.")
cli_main_app.add_typer(module_app, name="module", help="üß© –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ SDB (–ø–ª–∞–≥–∏–Ω–∞–º–∏).")
cli_main_app.add_typer(user_app, name="user", help="üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ä–æ–ª—è–º–∏ (RBAC).")
cli_main_app.add_typer(backup_app, name="backup", help="üíæ –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ë–î.")
cli_main_app.add_typer(system_app, name="system", help="üõ†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è–¥—Ä–∞, –æ—Ç–∫–∞—Ç –∏ –¥—Ä.).")
cli_main_app.add_typer(control_app, name="control", help="üö¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º –±–æ—Ç–∞ (stop, status, restart).") 
cli_main_app.add_typer(bot_app, name="bot", help="ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram-–±–æ—Ç–æ–º SDB (–∫–æ–º–∞–Ω–¥—ã, —Å—Ç–∞—Ç—É—Å).") 

@cli_main_app.command(name="start", help="üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å Telegram –±–æ—Ç–∞ SDB.")
def start_bot_command(
    debug: bool = typer.Option(
        False, "--debug", "-d", 
        help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏ (—É–≤–µ–ª–∏—á–∏—Ç —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ DEBUG)."
    ),
    background: bool = typer.Option(
        False, "--background", "-b",
        help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (–¥–µ–º–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å)."
    )
):
    from core.app_settings import settings 
    pid_file_path = settings.core.project_data_path / PID_FILENAME

    if pid_file_path.exists():
        try:
            with open(pid_file_path, "r") as f:
                pid = int(f.read().strip())
            if sys.platform != "win32":
                os.kill(pid, 0) 
                sdb_console.print(f"[yellow]SDB –±–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω (PID: {pid}). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ './sdb control stop' –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.[/yellow]")
                raise typer.Exit(code=1)
            else: 
                 sdb_console.print(f"[yellow]PID-—Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (PID: {pid}). –ï—Å–ª–∏ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º.[/yellow]")
        except (OSError, ValueError): 
            sdb_console.print(f"[yellow]–û–±–Ω–∞—Ä—É–∂–µ–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π PID-—Ñ–∞–π–ª ({pid_file_path}). –£–¥–∞–ª–µ–Ω–∏–µ...[/yellow]")
            pid_file_path.unlink(missing_ok=True)
        except Exception as e_pid_check:
             sdb_console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ PID-—Ñ–∞–π–ª–∞: {e_pid_check}[/red]")

    if debug:
        sdb_console.print(Panel(f"[bold yellow]–ó–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ DEBUG.[/]", 
                                title="SDB Start (Debug Mode Requested)", expand=False, border_style="yellow"))
        os.environ["SDB_LAUNCH_DEBUG_MODE"] = "true"
        # SDB_CLI_DEBUG_MODE_FOR_LOGGING —Ç–µ–ø–µ—Ä—å –Ω–µ –Ω—É–∂–µ–Ω –∑–¥–µ—Å—å, 
        # —Ç.–∫. app_settings.py —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–∏–ª –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π –ª–æ–≥.
        # –ï—Å–ª–∏ –æ—á–µ–Ω—å –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π –ª–æ–≥ *–∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –≤—ã–∑–æ–≤–∞ sdb start*,
        # —Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å reload app_settings —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π SDB_CLI_DEBUG_MODE_FOR_LOGGING.
        # –ù–æ –ø—Ä–æ—â–µ –ø–æ–ª–æ–∂–∏—Ç—å—Å—è –Ω–∞ —Ç–æ, —á—Ç–æ SDB_LAUNCH_DEBUG_MODE –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤ bot_entrypoint.
    else:
        os.environ["SDB_LAUNCH_DEBUG_MODE"] = "false"
        # os.environ["SDB_CLI_DEBUG_MODE_FOR_LOGGING"] = "false" # –£–∂–µ –Ω–µ —Ç–∞–∫ –≤–∞–∂–Ω–æ –∑–¥–µ—Å—å

    if background:
        if sys.platform == "win32":
            sdb_console.print("[bold red]–§–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º (-b/--background) –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ Windows —á–µ—Ä–µ–∑ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.[/bold red]")
            sdb_console.print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –±–µ–∑ —Ñ–ª–∞–≥–∞ -b –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–ª—è –¥–µ–º–æ–Ω–∏–∑–∞—Ü–∏–∏.")
            raise typer.Exit(code=1)

        sdb_console.print(Panel("[bold blue]–ó–∞–ø—É—Å–∫ SDB –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ...[/]", 
                                title="SDB Start (Background)", expand=False, border_style="blue"))
        
        run_bot_script_path = project_root / "run_bot.py"
        
        env_for_subprocess = os.environ.copy()
        env_for_subprocess["SDB_SHOULD_WRITE_PID"] = "true"
        
        try:
            process = subprocess.Popen(
                [sys.executable, str(run_bot_script_path)],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
                start_new_session=True, 
                env=env_for_subprocess
            )
            sdb_console.print(f"–ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ (—Å–∏—Å—Ç–µ–º–Ω—ã–π PID: {process.pid}).")
            sdb_console.print(f"–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è PID-—Ñ–∞–π–ª–∞ '{PID_FILENAME}' (–¥–æ 10 —Å–µ–∫—É–Ω–¥)...")
            
            pid_file_created_successfully = False
            for i in range(10): 
                time.sleep(1)
                if pid_file_path.exists():
                    try:
                        actual_pid_from_file_str = pid_file_path.read_text().strip()
                        if actual_pid_from_file_str.isdigit():
                            actual_pid_from_file = int(actual_pid_from_file_str)
                            sdb_console.print(f"[green]PID-—Ñ–∞–π–ª {pid_file_path} —Å–æ–∑–¥–∞–Ω. PID –±–æ—Ç–∞: {actual_pid_from_file}.[/green]")
                            sdb_console.print("–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: [cyan]./sdb control status[/cyan]")
                            sdb_console.print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: [cyan]./sdb control stop[/cyan]")
                            pid_file_created_successfully = True
                            break
                        else:
                            sdb_console.print(f"[yellow]PID-—Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: '{actual_pid_from_file_str}'. –ü–æ–ø—ã—Ç–∫–∞ {i+1}/10.[/yellow]")
                    except ValueError:
                        sdb_console.print(f"[yellow]PID-—Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –ü–æ–ø—ã—Ç–∫–∞ {i+1}/10.[/yellow]")
                    except Exception as e_read_pid:
                         sdb_console.print(f"[yellow]–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è PID –∏–∑ —Ñ–∞–π–ª–∞ ({e_read_pid}). –ü–æ–ø—ã—Ç–∫–∞ {i+1}/10.[/yellow]")

            if not pid_file_created_successfully:
                sdb_console.print(f"[yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: PID-—Ñ–∞–π–ª –Ω–µ –±—ã–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–∑–¥–∞–Ω/–ø—Ä–æ—á–∏—Ç–∞–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥.[/yellow]")
                sdb_console.print(f"  –í–æ–∑–º–æ–∂–Ω–æ, –±–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ —Ñ–æ–Ω–µ –∏–ª–∏ –Ω–µ —Å–º–æ–≥ –∑–∞–ø–∏—Å–∞—Ç—å PID. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞.")
                sdb_console.print(f"  –°–∏—Å—Ç–µ–º–Ω—ã–π PID –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞: {process.pid}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ —Å—Ç–∞—Ç—É—Å –≤—Ä—É—á–Ω—É—é.")

        except Exception as e_popen:
            sdb_console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ: {e_popen}[/bold red]")
            sdb_console.print_exception(show_locals=True)
            raise typer.Exit(code=1)
    else:
        if not debug: 
             sdb_console.print(Panel("[bold green]–ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ SDB...[/]", 
                                title="SDB Start", expand=False, border_style="green"))
        try:
            os.environ["SDB_SHOULD_WRITE_PID"] = "false" 
            
            bot_coroutine = run_sdb_bot() 
            exit_code = asyncio.run(bot_coroutine)
            
            if exit_code != 0:
                sdb_console.print(f"[bold red]–ë–æ—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏: {exit_code}[/]")
                sys.exit(exit_code)
            else:
                if not (os.environ.get("SDB_SHOULD_WRITE_PID", "false").lower() == "true"):
                    sdb_console.print("[bold green]–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Å–≤–æ—é —Ä–∞–±–æ—Ç—É (—à—Ç–∞—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ).[/]")
                
        except KeyboardInterrupt:
            sdb_console.print("\n[bold orange_red1]ü§ñ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C). –í—ã—Ö–æ–¥.[/]")
            sys.exit(0) 
        except Exception as e:
            sdb_console.print(Panel(f"[bold red]–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–ª–∏ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞:[/]\n{e}", 
                                    title="SDB Runtime Error", border_style="red", expand=True))
            global_logger.opt(exception=e).critical("–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ sdb.py start_bot_command")
            sdb_console.print_exception(show_locals=True) 
            sys.exit(1)

if __name__ == "__main__":
    try:
        if sys.platform != "win32":
            if not os.access(__file__, os.X_OK):
                current_mode = os.stat(__file__).st_mode
                os.chmod(__file__, current_mode | 0o111) 
                sdb_console.print("[dim green]–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è sdb.py[/dim]")
    except Exception as e_chmod:
        sdb_console.print(f"[dim yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è sdb.py: {e_chmod}[/dim]")

    cli_main_app()


======================================================================

------------------------------ FILE: .env.example ------------------------------
# .env.example
# –ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è SwiftDevBot.
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ .env –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–≤–æ–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
# –°—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å #, —è–≤–ª—è—é—Ç—Å—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.

# --- Telegram Bot ---
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram –±–æ—Ç–∞. –ü–æ–ª—É—á–∏—Ç—å —É @BotFather.
BOT_TOKEN="–í–ê–®_–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù"

# –¢–∞–π–º–∞—É—Ç –¥–ª—è long polling (—Å–µ–∫—É–Ω–¥—ã). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 30 (–∏–∑ AppSettings)
# SDB_TELEGRAM_POLLING_TIMEOUT=30


# --- –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö ---
# –¢–∏–ø –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: "sqlite", "postgresql", "mysql"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "sqlite" (–∏–∑ AppSettings)
SDB_DB_TYPE="sqlite"

# –î–ª—è SQLite:
# –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É SQLite (–æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ project_data_path).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "project_data/Database_files/swiftdevbot.db" (–∏–∑ AppSettings)
# SDB_DB_SQLITE_PATH="project_data/Database_files/sdb_prod.db"

# –î–ª—è PostgreSQL:
# DSN (Data Source Name) –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL.
# –§–æ—Ä–º–∞—Ç: postgresql+<–¥—Ä–∞–π–≤–µ—Ä>://<user>:<password>@<host>:<port>/<dbname>
# –î—Ä–∞–π–≤–µ—Ä—ã: asyncpg, psycopg (–¥–ª—è psycopg SQLAlchemy 2.0 –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å psycopg[binary])
# –ü—Ä–∏–º–µ—Ä: SDB_DB_PG_DSN="postgresql+psycopg://sdb_user:sdb_pass@localhost:5432/sdb_pg_database"
# SDB_DB_PG_DSN=""

# –î–ª—è MySQL:
# DSN –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL.
# –§–æ—Ä–º–∞—Ç: mysql+<–¥—Ä–∞–π–≤–µ—Ä>://<user>:<password>@<host>:<port>/<dbname>
# –î—Ä–∞–π–≤–µ—Ä—ã: aiomysql, asyncmy
# –ü—Ä–∏–º–µ—Ä: SDB_DB_MYSQL_DSN="mysql+aiomysql://sdb_user:sdb_pass@localhost:3306/sdb_mysql_database?charset=utf8mb4"
# SDB_DB_MYSQL_DSN=""

# –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã SQLAlchemy (—É—Ä–æ–≤–µ–Ω—å DEBUG). true/false
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: false (–∏–∑ AppSettings)
# SDB_DB_ECHO_SQL="false"


# --- –ö—ç—à ---
# –¢–∏–ø –∫—ç—à–∞: "memory", "redis"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "memory" (–∏–∑ AppSettings)
SDB_CACHE_TYPE="memory"

# –î–ª—è Redis:
# URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis.
# –§–æ—Ä–º–∞—Ç: redis://[:<password>@]<host>:<port>/<db_number>
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "redis://localhost:6379/0" (–∏–∑ AppSettings)
# SDB_CACHE_REDIS_URL="redis://localhost:6379/0"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ø–¥—Ä–∞ (Core) ---
# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞ (–ª–æ–≥–∏, –ë–î, –∫–æ–Ω—Ñ–∏–≥–∏ –º–æ–¥—É–ª–µ–π).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "./project_data" (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞, –∏–∑ AppSettings)
# SDB_CORE_PROJECT_DATA_PATH="./my_sdb_data"

# –°–ø–∏—Å–æ–∫ Telegram ID —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.
# –ü—Ä–∏–º–µ—Ä: SDB_CORE_SUPER_ADMINS="12345678,98765432"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (–∏–∑ AppSettings)
SDB_CORE_SUPER_ADMINS=""

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Config/enabled_modules.json" (–∏–∑ AppSettings)
# SDB_CORE_ENABLED_MODULES_CONFIG_PATH="Config/active_plugins.json"

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ø–¥—Ä–∞ ---
# –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: TRACE, DEBUG, INFO, WARNING, ERROR, CRITICAL
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "INFO" (–∏–∑ AppSettings)
SDB_CORE_LOG_LEVEL="INFO"

# –ü–∏—Å–∞—Ç—å –ª–∏ –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª. true/false
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: true (–∏–∑ AppSettings)
# SDB_CORE_LOG_TO_FILE="true"

# –ë–∞–∑–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ project_data_path).
# –§–∞–π–ª—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö YYYY/MM-MonthName/DD/HH_sdb.log
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Logs" (–∏–∑ AppSettings)
# SDB_CORE_LOG_STRUCTURED_DIR="MyBotLogs"

# –†–æ—Ç–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ –ª–æ–≥–∞ –ø–æ —Ä–∞–∑–º–µ—Ä—É.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "100 MB" (–∏–∑ AppSettings)
# SDB_CORE_LOG_ROTATION_SIZE="50 MB"

# –ö–∞–∫ –¥–æ–ª–≥–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "30 days", "3 months").
# –†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ–π –æ—á–∏—Å—Ç–∫–∏ –≤–Ω—É—Ç—Ä–∏ –±–æ—Ç–∞.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "3 months" (–∏–∑ AppSettings)
# SDB_CORE_LOG_RETENTION_PERIOD_STRUCTURED="1 month"

# –í–µ—Ä—Å–∏—è —è–¥—Ä–∞ SDB (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –æ–±—ã—á–Ω–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –∑–¥–µ—Å—å).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "0.1.0" (–∏–∑ AppSettings)
# SDB_CORE_SDB_VERSION="0.1.1-beta"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ "–ú–∞–≥–∞–∑–∏–Ω–∞" –ú–æ–¥—É–ª–µ–π ---
# URL –∫ JSON-–∏–Ω–¥–µ–∫—Å—É –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π SDB.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "https://raw.githubusercontent.com/soverxos/SwiftDevBot-Modules/main/modules_index.json" (–∏–∑ AppSettings)
# SDB_MODULE_REPO_INDEX_URL="https://my.private.repo/modules_index.json"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (i18n) –Ø–¥—Ä–∞ ---
# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "locales" (–∏–∑ AppSettings)
# SDB_I18N_LOCALES_DIR="translations"

# –ò–º—è –¥–æ–º–µ–Ω–∞ –¥–ª—è gettext (–æ–±—ã—á–Ω–æ –∏–º—è .po/.mo —Ñ–∞–π–ª–æ–≤).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "bot" (–∏–∑ AppSettings)
# SDB_I18N_DOMAIN="sdb_core"

# –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "en" (–∏–∑ AppSettings)
# SDB_I18N_DEFAULT_LOCALE="en"

# –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —è–∑—ã–∫–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "en,ua,de").
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "en,ua" (–∏–∑ AppSettings)
# SDB_I18N_AVAILABLE_LOCALES="en,ua,ru"


======================================================================

------------------------------ FILE: alembic.ini ------------------------------
# alembic.ini
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª Alembic –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ SwiftDevBot (SDB)

[alembic]
# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ —Å–∫—Ä–∏–ø—Ç–∞–º–∏ –º–∏–≥—Ä–∞—Ü–∏–π (env.py, versions/)
# –£–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è —ç—Ç–æ–≥–æ .ini —Ñ–∞–π–ª–∞.
script_location = alembic_migrations

# –®–∞–±–ª–æ–Ω –¥–ª—è –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Ä–µ–≤–∏–∑–∏–π.
# %%(rev)s - ID —Ä–µ–≤–∏–∑–∏–∏, %%(slug)s - —á–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è (message) —Ä–µ–≤–∏–∑–∏–∏.
file_template = %%(rev)s_%%(slug)s

# URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
# –í–ê–ñ–ù–û: –≠—Ç–æ—Ç URL –±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ alembic_migrations/env.py
# –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ core.app_settings.settings.
# –ü–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ –ø—É—Å—Ç—ã–º –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º.
# sqlalchemy.url = driver://user:pass@localhost/dbname
#sqlalchemy.url = sqlite:///./default_sdb_for_alembic_init.db # –ü—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–ª—è `alembic init`

# --- –û–ø—Ü–∏–∏, –≤–∞–∂–Ω—ã–µ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã —Å SDB ---

# –ì–æ–≤–æ—Ä–∏—Ç Alembic –≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å env.py –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ–≤–∏–∑–∏–∏.
# –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —Ç–∞–∫ –∫–∞–∫ env.py –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª–∏ –∏ URL –ë–î.
revision_environment = true

# –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ–º .pyc —Ñ–∞–π–ª–æ–≤ –±–µ–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö .py –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π.
# –û–±—ã—á–Ω–æ False. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ True –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞ –≤ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞—è—Ö,
# –Ω–æ –¥–ª—è SDB –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫—Ä–∏—Ç–∏—á–Ω–æ–π. –û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª.
sourceless = true 

# –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π, –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–π.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é UTF-8 –æ–±—ã—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç.
# file_encoding = utf-8

# --- –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ---

# –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–ª—è version_locations (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–º–∏, —Ç–∞–∫ –∫–∞–∫ script_location –æ–¥–∏–Ω)
# version_path_separator = os # (–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º, —Ç–∞–∫ –∫–∞–∫ –Ω–µ –Ω—É–∂–Ω–æ)

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö (–Ω–µ –Ω–∞—à —Å–ª—É—á–∞–π –¥–ª—è –æ–¥–Ω–æ–≥–æ Alembic –æ–∫—Ä—É–∂–µ–Ω–∏—è)
# [alembic:engine_myapp]
# sqlalchemy.url = ...

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Alembic.
# –ú–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å –∏–ª–∏ –¥–æ–ø–æ–ª–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Loguru, –µ—Å–ª–∏ SDB –∏—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç.
# –û–±—ã—á–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–¥–µ—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç Alembic.
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
# –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è SQLAlchemy (–Ω–∞–ø—Ä–∏–º–µ—Ä, WARN, INFO, DEBUG –¥–ª—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤)
level = WARN 
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
# –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–∞–º–æ–≥–æ Alembic
level = INFO 
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S


======================================================================

------------------------------ FILE: .env ------------------------------
# .env.example
# –ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è SwiftDevBot.
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ .env –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–≤–æ–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
# –°—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å #, —è–≤–ª—è—é—Ç—Å—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.

# --- Telegram Bot ---
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram –±–æ—Ç–∞. –ü–æ–ª—É—á–∏—Ç—å —É @BotFather.
BOT_TOKEN=7811011757:AAEKl00KS3g7_gSqiuSAPZZF0IkS5v1P50w
SDB_TELEGRAM_POLLING_TIMEOUT=30


# --- –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö ---
# –¢–∏–ø –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: "sqlite", "postgresql", "mysql"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "sqlite" (–∏–∑ AppSettings)

 SDB_DB_TYPE="sqlite"
 SDB_DB_SQLITE_PATH="Database_files/sdb_clean_test.db" 

# –î–ª—è SQLite:
# SDB_DB_TYPE="sqlite"
# –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É SQLite (–æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ project_data_path).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Database_files/swiftdevbot.db" (–∏–∑ AppSettings)
# SDB_DB_SQLITE_PATH="Database_files/sdb_prod.db"

# –î–ª—è PostgreSQL:
# SDB_DB_TYPE="postgresql"
# DSN (Data Source Name) –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL.
# –§–æ—Ä–º–∞—Ç: postgresql+<–¥—Ä–∞–π–≤–µ—Ä>://<user>:<password>@<host>:<port>/<dbname>
# –î—Ä–∞–π–≤–µ—Ä—ã: asyncpg, psycopg (–¥–ª—è psycopg SQLAlchemy 2.0 –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å psycopg[binary])
# –ü—Ä–∏–º–µ—Ä: SDB_DB_PG_DSN="postgresql+psycopg://sdb_user:sdb_pass@localhost:5432/sdb_pg_database"
# SDB_DB_PG_DSN="postgresql+psycopg://soverx:Sova3568@192.168.31.3:2345/sdb_database"

# –î–ª—è MySQL:
# SDB_DB_TYPE="mysql"
# DSN –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL.
# –§–æ—Ä–º–∞—Ç: mysql+<–¥—Ä–∞–π–≤–µ—Ä>://<user>:<password>@<host>:<port>/<dbname>
# –î—Ä–∞–π–≤–µ—Ä—ã: aiomysql, asyncmy
# –ü—Ä–∏–º–µ—Ä: SDB_DB_MYSQL_DSN="mysql+aiomysql://sdb_user:sdb_pass@localhost:3306/sdb_mysql_database?charset=utf8mb4"
# SDB_DB_MYSQL_DSN="mysql+aiomysql://root:Sova3568@192.168.31.3:33066/sdb_mysql_db?charset=utf8mb4"

# –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã SQLAlchemy (—É—Ä–æ–≤–µ–Ω—å DEBUG). true/false
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: false (–∏–∑ AppSettings)
# SDB_DB_ECHO_SQL="false"


# --- –ö—ç—à ---
# –¢–∏–ø –∫—ç—à–∞: "memory", "redis"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "memory" (–∏–∑ AppSettings)
SDB_CACHE_TYPE="memory"

# –î–ª—è Redis:
# SDB_CACHE_TYPE="redis"
# URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis.
# –§–æ—Ä–º–∞—Ç: redis://[:<password>@]<host>:<port>/<db_number>
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "redis://localhost:6379/0" (–∏–∑ AppSettings)
# SDB_CACHE_REDIS_URL="redis://192.168.31.3:6379/0"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ø–¥—Ä–∞ (Core) ---
# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞ (–ª–æ–≥–∏, –ë–î, –∫–æ–Ω—Ñ–∏–≥–∏ –º–æ–¥—É–ª–µ–π).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "./project_data" (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞, –∏–∑ AppSettings)
# SDB_CORE_PROJECT_DATA_PATH="./my_sdb_data"

# –°–ø–∏—Å–æ–∫ Telegram ID —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.
# –ü—Ä–∏–º–µ—Ä: SDB_CORE_SUPER_ADMINS="12345678,98765432"
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (–∏–∑ AppSettings)
SDB_CORE_SUPER_ADMINS="7847397229"

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Config/enabled_modules.json" (–∏–∑ AppSettings)
# SDB_CORE_ENABLED_MODULES_CONFIG_PATH="Config/active_plugins.json"

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ø–¥—Ä–∞ ---
# –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: TRACE, DEBUG, INFO, WARNING, ERROR, CRITICAL
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "INFO" (–∏–∑ AppSettings)
SDB_CORE_LOG_LEVEL="INFO"

# –ü–∏—Å–∞—Ç—å –ª–∏ –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª. true/false
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: true (–∏–∑ AppSettings)
# SDB_CORE_LOG_TO_FILE="true"

# –®–∞–±–ª–æ–Ω –ø—É—Ç–∏ –∫ –ª–æ–≥-—Ñ–∞–π–ª–∞–º (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞).
# {time} - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å –¥–ª—è Loguru.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Logs/sdb_{time:YYYY-MM-DD_HH-mm-ss_SSSSSS}.log" (–∏–∑ AppSettings)
# SDB_CORE_LOG_FILE_PATH_TEMPLATE="MyLogs/bot_{time}.log"

# –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ (—Ä–∞–∑–º–µ—Ä –∏–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª). –ü—Ä–∏–º–µ—Ä—ã: "500 MB", "1 week", "00:00" (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "10 MB" (–∏–∑ AppSettings)
# SDB_CORE_LOG_ROTATION="100 MB"

# –•—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤ (–∫–∞–∫ –¥–æ–ª–≥–æ –∏–ª–∏ —Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤). –ü—Ä–∏–º–µ—Ä—ã: "1 month", "10 files".
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "7 days" (–∏–∑ AppSettings)
# SDB_CORE_LOG_RETENTION="30 days"

# –í–µ—Ä—Å–∏—è —è–¥—Ä–∞ SDB (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –æ–±—ã—á–Ω–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –∑–¥–µ—Å—å).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "0.1.0" (–∏–∑ AppSettings)
# SDB_CORE_SDB_VERSION="0.1.1-beta"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ "–ú–∞–≥–∞–∑–∏–Ω–∞" –ú–æ–¥—É–ª–µ–π ---
# URL –∫ JSON-–∏–Ω–¥–µ–∫—Å—É –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π SDB.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "https://raw.githubusercontent.com/soverxos/SwiftDevBot-Modules/main/modules_index.json" (–∏–∑ AppSettings)
# SDB_MODULE_REPO_INDEX_URL="https://my.private.repo/modules_index.json"


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (i18n) –Ø–¥—Ä–∞ ---
# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "locales" (–∏–∑ AppSettings)
# SDB_I18N_LOCALES_DIR="translations"

# –ò–º—è –¥–æ–º–µ–Ω–∞ –¥–ª—è gettext (–æ–±—ã—á–Ω–æ –∏–º—è .po/.mo —Ñ–∞–π–ª–æ–≤).
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "bot" (–∏–∑ AppSettings)
# SDB_I18N_DOMAIN="sdb_core"

# –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "en" (–∏–∑ AppSettings)
# SDB_I18N_DEFAULT_LOCALE="en"

# –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —è–∑—ã–∫–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "en,uk,de").
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "en,uk" (–∏–∑ AppSettings)
# SDB_I18N_AVAILABLE_LOCALES="en,uk,ru"


======================================================================

------------------------------ FILE: run_bot.py ------------------------------
# run_bot.py
# –≠—Ç–æ—Ç —Ñ–∞–π–ª —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Telegram-–±–æ—Ç–∞ SwiftDevBot.

import asyncio
import sys
from pathlib import Path
import os

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ sys.path –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ 'core' –∏ –¥—Ä—É–≥–∏—Ö –ø–∞–∫–µ—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ ---
current_script_dir = Path(__file__).resolve().parent
if str(current_script_dir) not in sys.path:
    sys.path.insert(0, str(current_script_dir))

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏–∑ —è–¥—Ä–∞
try:
    from core.bot_entrypoint import run_sdb_bot 
except ImportError as e:
    print(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ 'core.bot_entrypoint'.", file=sys.stderr)
    print(f"–û—à–∏–±–∫–∞: {e}", file=sys.stderr)
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤–µ—Ä–Ω–∞ –∏ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —è–¥—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.", file=sys.stderr)
    print(f"–¢–µ–∫—É—â–∏–π sys.path: {sys.path}", file=sys.stderr)
    sys.exit(2)

if __name__ == "__main__":
    exit_code: int = 1 

    try:
        exit_code = asyncio.run(run_sdb_bot())
        
        if exit_code == 0:
            if os.environ.get("SDB_SHOULD_WRITE_PID", "false").lower() != "true":
                print("–ë–æ—Ç SwiftDevBot —à—Ç–∞—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Å–≤–æ—é —Ä–∞–±–æ—Ç—É.")
        else:
            if os.environ.get("SDB_SHOULD_WRITE_PID", "false").lower() != "true":
                print(f"–ë–æ—Ç SwiftDevBot –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏: {exit_code}", file=sys.stderr)

    except KeyboardInterrupt:
        if os.environ.get("SDB_SHOULD_WRITE_PID", "false").lower() != "true":
            print("\nü§ñ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C). –í—ã—Ö–æ–¥...", file=sys.stderr)
        exit_code = 0 
    except ImportError as e_runtime_import:
        print(f"–û–®–ò–ë–ö–ê –ò–ú–ü–û–†–¢–ê –í–û –í–†–ï–ú–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø: {e_runtime_import}", file=sys.stderr)
        print("–í–æ–∑–º–æ–∂–Ω–æ, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π.", file=sys.stderr)
        exit_code = 3
    except Exception as e_global:
        print(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ù–ï–û–ë–†–ê–ë–û–¢–ê–ù–ù–ê–Ø –û–®–ò–ë–ö–ê –ù–ê –í–ï–†–•–ù–ï–ú –£–†–û–í–ù–ï: {type(e_global).__name__}: {e_global}", file=sys.stderr)
        print("–°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–±–µ–∫–∞ –æ—à–∏–±–∫–∏.", file=sys.stderr)
        exit_code = 1
    finally:
        pass

    sys.exit(exit_code)


======================================================================

------------------------------ FILE: sdb ------------------------------
#!/usr/bin/env python3

import asyncio
import sys
import os
import subprocess
import time
from pathlib import Path

current_script_path = Path(__file__).resolve()
project_root = current_script_path.parent
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

try:
    import typer
    from rich.console import Console
    from rich.panel import Panel
    from loguru import logger as global_logger 
except ImportError as e:
    print(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (Typer, Rich, Loguru) –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. {e}", file=sys.stderr)
    print(f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ requirements.txt –∏–ª–∏ requirements-dev.txt:", file=sys.stderr)
    print(f"  pip install -r requirements.txt", file=sys.stderr)
    sys.exit(1)

sdb_console = Console()

try:
    from cli_commands.setup_cmd import config_app
    from cli_commands.db_cmd import db_app
    from cli_commands.module_cmd import module_app
    from cli_commands.user_cmd import user_app
    from cli_commands.backup_cmd import backup_app
    from cli_commands.system_cmd import system_app
    from cli_commands.control_cmd import control_app, PID_FILENAME 
    from cli_commands.bot_cmd import bot_app 
    from core.bot_entrypoint import run_sdb_bot 
except ImportError as e:
    sdb_console.print(f"[bold red]–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:[/]\n –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã SDB CLI –∏–ª–∏ —è–¥—Ä–∞: {e}")
    sdb_console.print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã —è–¥—Ä–∞ –∏ CLI –Ω–∞ –º–µ—Å—Ç–µ –∏ PYTHONPATH –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.")
    sdb_console.print_exception(show_locals=False)
    sys.exit(1)
except Exception as e:
    sdb_console.print(f"[bold red]–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SDB CLI (–≤–æ –≤—Ä–µ–º—è –∏–º–ø–æ—Ä—Ç–æ–≤):[/]\n {e}")
    sdb_console.print_exception(show_locals=True)
    sys.exit(1)

cli_main_app = typer.Typer(
    name="sdb",
    help="üöÄ [bold cyan]SwiftDevBot CLI[/] - –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–∏–º SDB!",
    rich_markup_mode="rich",
    add_completion=False,
    no_args_is_help=True,
    context_settings={"help_option_names": ["-h", "--help"]}
)

cli_main_app.add_typer(config_app, name="config", help="üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π SDB (init, info).")
cli_main_app.add_typer(db_app, name="db", help="üóÑÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ Alembic.")
cli_main_app.add_typer(module_app, name="module", help="üß© –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ SDB (–ø–ª–∞–≥–∏–Ω–∞–º–∏).")
cli_main_app.add_typer(user_app, name="user", help="üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ä–æ–ª—è–º–∏ (RBAC).")
cli_main_app.add_typer(backup_app, name="backup", help="üíæ –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ë–î.")
cli_main_app.add_typer(system_app, name="system", help="üõ†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è–¥—Ä–∞, –æ—Ç–∫–∞—Ç –∏ –¥—Ä.).")
cli_main_app.add_typer(control_app, name="control", help="üö¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º –±–æ—Ç–∞ (stop, status, restart).") 
cli_main_app.add_typer(bot_app, name="bot", help="ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram-–±–æ—Ç–æ–º SDB (–∫–æ–º–∞–Ω–¥—ã, —Å—Ç–∞—Ç—É—Å).") 

@cli_main_app.command(name="start", help="üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å Telegram –±–æ—Ç–∞ SDB.")
def start_bot_command(
    debug: bool = typer.Option(
        False, "--debug", "-d", 
        help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏ (—É–≤–µ–ª–∏—á–∏—Ç —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ DEBUG)."
    ),
    background: bool = typer.Option(
        False, "--background", "-b",
        help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (–¥–µ–º–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å)."
    )
):
    from core.app_settings import settings 
    pid_file_path = settings.core.project_data_path / PID_FILENAME

    if pid_file_path.exists():
        try:
            with open(pid_file_path, "r") as f:
                pid = int(f.read().strip())
            if sys.platform != "win32":
                os.kill(pid, 0) 
                sdb_console.print(f"[yellow]SDB –±–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω (PID: {pid}). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ './sdb control stop' –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.[/yellow]")
                raise typer.Exit(code=1)
            else: 
                 sdb_console.print(f"[yellow]PID-—Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (PID: {pid}). –ï—Å–ª–∏ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º.[/yellow]")
        except (OSError, ValueError): 
            sdb_console.print(f"[yellow]–û–±–Ω–∞—Ä—É–∂–µ–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π PID-—Ñ–∞–π–ª ({pid_file_path}). –£–¥–∞–ª–µ–Ω–∏–µ...[/yellow]")
            pid_file_path.unlink(missing_ok=True)
        except Exception as e_pid_check:
             sdb_console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ PID-—Ñ–∞–π–ª–∞: {e_pid_check}[/red]")

    if debug:
        sdb_console.print(Panel(f"[bold yellow]–ó–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ DEBUG.[/]", 
                                title="SDB Start (Debug Mode Requested)", expand=False, border_style="yellow"))
        os.environ["SDB_LAUNCH_DEBUG_MODE"] = "true"
        # SDB_CLI_DEBUG_MODE_FOR_LOGGING —Ç–µ–ø–µ—Ä—å –Ω–µ –Ω—É–∂–µ–Ω –∑–¥–µ—Å—å, 
        # —Ç.–∫. app_settings.py —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–∏–ª –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π –ª–æ–≥.
        # –ï—Å–ª–∏ –æ—á–µ–Ω—å –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π –ª–æ–≥ *–∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –≤—ã–∑–æ–≤–∞ sdb start*,
        # —Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å reload app_settings —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π SDB_CLI_DEBUG_MODE_FOR_LOGGING.
        # –ù–æ –ø—Ä–æ—â–µ –ø–æ–ª–æ–∂–∏—Ç—å—Å—è –Ω–∞ —Ç–æ, —á—Ç–æ SDB_LAUNCH_DEBUG_MODE –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤ bot_entrypoint.
    else:
        os.environ["SDB_LAUNCH_DEBUG_MODE"] = "false"
        # os.environ["SDB_CLI_DEBUG_MODE_FOR_LOGGING"] = "false" # –£–∂–µ –Ω–µ —Ç–∞–∫ –≤–∞–∂–Ω–æ –∑–¥–µ—Å—å

    if background:
        if sys.platform == "win32":
            sdb_console.print("[bold red]–§–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º (-b/--background) –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ Windows —á–µ—Ä–µ–∑ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.[/bold red]")
            sdb_console.print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –±–µ–∑ —Ñ–ª–∞–≥–∞ -b –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–ª—è –¥–µ–º–æ–Ω–∏–∑–∞—Ü–∏–∏.")
            raise typer.Exit(code=1)

        sdb_console.print(Panel("[bold blue]–ó–∞–ø—É—Å–∫ SDB –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ...[/]", 
                                title="SDB Start (Background)", expand=False, border_style="blue"))
        
        run_bot_script_path = project_root / "run_bot.py"
        
        env_for_subprocess = os.environ.copy()
        env_for_subprocess["SDB_SHOULD_WRITE_PID"] = "true"
        
        try:
            process = subprocess.Popen(
                [sys.executable, str(run_bot_script_path)],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
                start_new_session=True, 
                env=env_for_subprocess
            )
            sdb_console.print(f"–ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ (—Å–∏—Å—Ç–µ–º–Ω—ã–π PID: {process.pid}).")
            sdb_console.print(f"–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è PID-—Ñ–∞–π–ª–∞ '{PID_FILENAME}' (–¥–æ 10 —Å–µ–∫—É–Ω–¥)...")
            
            pid_file_created_successfully = False
            for i in range(10): 
                time.sleep(1)
                if pid_file_path.exists():
                    try:
                        actual_pid_from_file_str = pid_file_path.read_text().strip()
                        if actual_pid_from_file_str.isdigit():
                            actual_pid_from_file = int(actual_pid_from_file_str)
                            sdb_console.print(f"[green]PID-—Ñ–∞–π–ª {pid_file_path} —Å–æ–∑–¥–∞–Ω. PID –±–æ—Ç–∞: {actual_pid_from_file}.[/green]")
                            sdb_console.print("–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: [cyan]./sdb control status[/cyan]")
                            sdb_console.print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: [cyan]./sdb control stop[/cyan]")
                            pid_file_created_successfully = True
                            break
                        else:
                            sdb_console.print(f"[yellow]PID-—Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: '{actual_pid_from_file_str}'. –ü–æ–ø—ã—Ç–∫–∞ {i+1}/10.[/yellow]")
                    except ValueError:
                        sdb_console.print(f"[yellow]PID-—Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –ü–æ–ø—ã—Ç–∫–∞ {i+1}/10.[/yellow]")
                    except Exception as e_read_pid:
                         sdb_console.print(f"[yellow]–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è PID –∏–∑ —Ñ–∞–π–ª–∞ ({e_read_pid}). –ü–æ–ø—ã—Ç–∫–∞ {i+1}/10.[/yellow]")

            if not pid_file_created_successfully:
                sdb_console.print(f"[yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: PID-—Ñ–∞–π–ª –Ω–µ –±—ã–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–∑–¥–∞–Ω/–ø—Ä–æ—á–∏—Ç–∞–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥.[/yellow]")
                sdb_console.print(f"  –í–æ–∑–º–æ–∂–Ω–æ, –±–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ —Ñ–æ–Ω–µ –∏–ª–∏ –Ω–µ —Å–º–æ–≥ –∑–∞–ø–∏—Å–∞—Ç—å PID. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞.")
                sdb_console.print(f"  –°–∏—Å—Ç–µ–º–Ω—ã–π PID –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞: {process.pid}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ —Å—Ç–∞—Ç—É—Å –≤—Ä—É—á–Ω—É—é.")

        except Exception as e_popen:
            sdb_console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ: {e_popen}[/bold red]")
            sdb_console.print_exception(show_locals=True)
            raise typer.Exit(code=1)
    else:
        if not debug: 
             sdb_console.print(Panel("[bold green]–ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ SDB...[/]", 
                                title="SDB Start", expand=False, border_style="green"))
        try:
            os.environ["SDB_SHOULD_WRITE_PID"] = "false" 
            
            bot_coroutine = run_sdb_bot() 
            exit_code = asyncio.run(bot_coroutine)
            
            if exit_code != 0:
                sdb_console.print(f"[bold red]–ë–æ—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏: {exit_code}[/]")
                sys.exit(exit_code)
            else:
                if not (os.environ.get("SDB_SHOULD_WRITE_PID", "false").lower() == "true"):
                    sdb_console.print("[bold green]–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Å–≤–æ—é —Ä–∞–±–æ—Ç—É (—à—Ç–∞—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ).[/]")
                
        except KeyboardInterrupt:
            sdb_console.print("\n[bold orange_red1]ü§ñ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C). –í—ã—Ö–æ–¥.[/]")
            sys.exit(0) 
        except Exception as e:
            sdb_console.print(Panel(f"[bold red]–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–ª–∏ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞:[/]\n{e}", 
                                    title="SDB Runtime Error", border_style="red", expand=True))
            global_logger.opt(exception=e).critical("–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ sdb.py start_bot_command")
            sdb_console.print_exception(show_locals=True) 
            sys.exit(1)

if __name__ == "__main__":
    try:
        if sys.platform != "win32":
            if not os.access(__file__, os.X_OK):
                current_mode = os.stat(__file__).st_mode
                os.chmod(__file__, current_mode | 0o111) 
                sdb_console.print("[dim green]–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è sdb.py[/dim]")
    except Exception as e_chmod:
        sdb_console.print(f"[dim yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è sdb.py: {e_chmod}[/dim]")

    cli_main_app()


======================================================================

------------------------------ FILE: babel.cfg ------------------------------
# Mapping from filename patterns to extractor callables
[python: **.py]
[python: core/**.py]
[python: modules/**.py]
[python: cli_commands/**.py]

# Extraction method mapping
[extractors]
# –î–ª—è Python —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —ç–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä Babel
python = babel.messages.extract:extract_python


======================================================================

------------------------------ FILE: modules/.gitkeep ------------------------------



======================================================================

------------------------------ FILE: modules/Create_modules.md ------------------------------

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–∫–∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –º–æ–¥—É–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `modules/my_universal_module/`)**

```
my_universal_module/
‚îú‚îÄ‚îÄ __init__.py                   # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª—è
‚îú‚îÄ‚îÄ manifest.yaml                 # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è
‚îú‚îÄ‚îÄ handlers.py                   # –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –û—Å–Ω–æ–≤–Ω—ã–µ —Ö—ç–Ω–¥–ª–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–æ–ª–±—ç–∫–æ–≤
‚îú‚îÄ‚îÄ keyboards.py                  # –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä
‚îú‚îÄ‚îÄ callback_data.py              # –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –§–∞–±—Ä–∏–∫–∏ CallbackData –¥–ª—è –º–æ–¥—É–ª—è
‚îú‚îÄ‚îÄ permissions.py                # –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª—è
‚îú‚îÄ‚îÄ states.py                     # –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –°–æ—Å—Ç–æ—è–Ω–∏—è FSM, –µ—Å–ª–∏ –º–æ–¥—É–ª—å –∏—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
‚îú‚îÄ‚îÄ models.py                     # –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –ú–æ–¥–µ–ª–∏ SQLAlchemy, –µ—Å–ª–∏ –º–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ë–î
‚îú‚îÄ‚îÄ module_settings_defaults.yaml # –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –§–∞–π–ª —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –º–æ–¥—É–ª—è
‚îî‚îÄ‚îÄ services.py                   # –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏–ª–∏ –ª–æ–≥–∏–∫–∞ –º–æ–¥—É–ª—è
```

---

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏:**

**1. `modules/my_universal_module/manifest.yaml` (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)**

```yaml
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –º–æ–¥—É–ª—è –≤ snake_case. –î–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –ø–∞–ø–∫–∏.
name: "my_universal_module" 

# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –º–æ–¥—É–ª—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
display_name: "–ú–æ–π –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ú–æ–¥—É–ª—å"

# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –í–µ—Ä—Å–∏—è –º–æ–¥—É–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ SemVer (–Ω–∞–ø—Ä–∏–º–µ—Ä, "0.1.0", "1.0.0-beta.1").
version: "0.1.0"

# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è.
description: "–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥—É–ª–µ–π SwiftDevBot."

# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ò–º—è –∏–ª–∏ –Ω–∏–∫ –∞–≤—Ç–æ—Ä–∞/–∫–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.
author: "–í–∞—à–µ –ò–º—è / –ù–∞–∑–≤–∞–Ω–∏–µ –ö–æ–º–∞–Ω–¥—ã"

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –°–ø–∏—Å–æ–∫ Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç—Å—è —ç—Ç–æ–º—É –º–æ–¥—É–ª—é.
# –≠—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ.
# –§–æ—Ä–º–∞—Ç: –∫–∞–∫ –≤ requirements.txt (–Ω–∞–ø—Ä–∏–º–µ—Ä, "requests>=2.20.0", "beautifulsoup4")
python_requirements:
  # - "some_package==1.2.3"

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –°–ø–∏—Å–æ–∫ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π SDB, –æ—Ç –∫–æ—Ç–æ—Ä—ã—Ö –∑–∞–≤–∏—Å–∏—Ç —ç—Ç–æ—Ç –º–æ–¥—É–ª—å.
# –Ø–¥—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç –∏—Ö –Ω–∞–ª–∏—á–∏–µ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è.
# –£–∫–∞–∑—ã–≤–∞—é—Ç—Å—è 'name' –º–æ–¥—É–ª–µ–π-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
sdb_module_dependencies:
  # - "another_sdb_module_name"

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –°–ø–∏—Å–æ–∫ –ø–æ–ª–Ω—ã—Ö –ø—É—Ç–µ–π –∫ –∫–ª–∞—Å—Å–∞–º –º–æ–¥–µ–ª–µ–π SQLAlchemy, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –≤ —ç—Ç–æ–º –º–æ–¥—É–ª–µ.
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CLI –∫–æ–º–∞–Ω–¥–æ–π 'sdb module clean-tables' –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è.
# –ü—Ä–∏–º–µ—Ä: "modules.my_universal_module.models.MyTableModel"
model_definitions:
  # - "modules.my_universal_module.models.MyFirstTable"
  # - "modules.my_universal_module.models.MySecondTable"

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–æ–¥—É–ª—å.
# –ë—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ–±—â–µ–µ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ (–µ—Å–ª–∏ admin_only=false).
commands:
  - command: "universal_hello" # –°–∞–º–∞ –∫–æ–º–∞–Ω–¥–∞ (–±–µ–∑ "/")
    description: "–°–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç –æ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –º–æ–¥—É–ª—è" # –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è /help
    icon: "üëã" # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–∫–æ–Ω–∫–∞
    category: "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ" # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
    admin_only: false # –¢—Ä–µ–±—É–µ—Ç –ª–∏ –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–¥–ª—è –ø–æ–∫–∞–∑–∞ –≤ /help)
                      # –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ö—ç–Ω–¥–ª–µ—Ä–µ!
  # - command: "universal_admin_action"
  #   description: "–í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –º–æ–¥—É–ª—è"
  #   icon: "üõ†Ô∏è"
  #   category: "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ (–ê–¥–º–∏–Ω)"
  #   admin_only: true # –ù–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –≤ /help –æ–±—ã—á–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –†–∞–∑—Ä–µ—à–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä—è–≤–ª—è–µ—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç –º–æ–¥—É–ª—å.
# –ò–º–µ–Ω–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ "module_name.permission_key".
# –û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø—Ä–∞–≤ —Ä–æ–ª—è–º.
permissions:
  - name: "my_universal_module.access" # –ë–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–æ –Ω–∞ –¥–æ—Å—Ç—É–ø/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è
    description: "–î–æ—Å—Ç—É–ø –∫ –æ—Å–Ω–æ–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ú–æ–¥—É–ª—è."
  - name: "my_universal_module.view_sensitive_data"
    description: "–ü—Ä–æ—Å–º–æ—Ç—Ä —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º –ú–æ–¥—É–ª–µ."
  - name: "my_universal_module.perform_special_action"
    description: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –≤ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º –ú–æ–¥—É–ª–µ."
  # - name: "my_universal_module.admin_manage"
  #   description: "[–ê–î–ú–ò–ù] –ü–æ–ª–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º –ú–æ–¥—É–ª–µ–º."

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å.
# –ö–ª—é—á —Å–ª–æ–≤–∞—Ä—è (–∑–¥–µ—Å—å 'greeting_message') –±—É–¥–µ—Ç –∏–º–µ–Ω–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
settings:
  greeting_message:
    type: "string" # –¢–∏–ø—ã: string, int, float, bool, choice, multichoice, text
    label: "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    description: "–°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–¥—É–ª—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è." # –û–ø–∏—Å–∞–Ω–∏–µ
    default: "–ü—Ä–∏–≤–µ—Ç –æ—Ç –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ú–æ–¥—É–ª—è!" # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    required: false # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (–µ—Å–ª–∏ true, default –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω)
  # enable_feature_x:
  #   type: "bool"
  #   label: "–í–∫–ª—é—á–∏—Ç—å –§—É–Ω–∫—Ü–∏—é X"
  #   default: true
  # item_limit:
  #   type: "int"
  #   label: "–õ–∏–º–∏—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤"
  #   default: 10
  #   min_value: 1
  #   max_value: 100
  # theme_color:
  #   type: "choice"
  #   label: "–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞"
  #   default: "blue"
  #   options:
  #     - value: "blue"
  #       display_name: "–°–∏–Ω—è—è"
  #     - value: "green"
  #       display_name: "–ó–µ–ª–µ–Ω–∞—è"
  #     - "red" # –ú–æ–∂–Ω–æ –∏ —Ç–∞–∫, –µ—Å–ª–∏ display_name –Ω–µ –Ω—É–∂–µ–Ω
  # admin_email:
  #   type: "string"
  #   label: "Email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –º–æ–¥—É–ª—è"
  #   regex_validator: "^[\\w\\.-]+@[\\w\\.-]+\\.\\w+$" # –ü—Ä–∏–º–µ—Ä –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email
  #   required: true # default –∑–¥–µ—Å—å –Ω–µ –Ω—É–∂–µ–Ω, –µ—Å–ª–∏ required –∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤–≤–æ–¥ –æ—Ç –∞–¥–º–∏–Ω–∞

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö, –µ—Å–ª–∏ –º–æ–¥—É–ª—å –∏—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç.
# 'entry_point' - –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–¥–∞—á–∏.
# 'schedule' - cron-–ø–æ–¥–æ–±–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è).
background_tasks:
  # daily_cleanup:
  #   entry_point: "modules.my_universal_module.tasks.run_daily_cleanup"
  #   schedule: "0 3 * * *" # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00
  #   description: "–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –º–æ–¥—É–ª—è."

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥—É–ª–µ.
metadata:
  homepage: "https://example.com/my_universal_module" # URL –¥–æ–º–∞—à–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–æ–¥—É–ª—è
  license: "MIT" # –õ–∏—Ü–µ–Ω–∑–∏—è –º–æ–¥—É–ª—è
  tags: ["universal", "template", "example"] # –¢–µ–≥–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞/–∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏
  min_sdb_core_version: "0.1.0" # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è –≤–µ—Ä—Å–∏—è —è–¥—Ä–∞ SDB
  assign_default_access_to_user_role: true # –ï—Å–ª–∏ true, –ø—Ä–∞–≤–æ '{module_name}.access' –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–æ–ª–∏ 'User'
                                           # –ò–º—è –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å '{module_name}.access_user_features' –∏–ª–∏ '{module_name}.access'
                                           # –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ "my_universal_module.access" (—Å–º. permissions –≤—ã—à–µ)
```

---

**2. `modules/my_universal_module/__init__.py` (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)**

```python
# modules/my_universal_module/__init__.py

from aiogram import Dispatcher, Bot, Router
from loguru import logger

# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–æ—É—Ç–µ—Ä –º–æ–¥—É–ª—è
from .handlers import universal_module_router 
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è –º–æ–¥—É–ª—è (–¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å 'name' –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ)
from .permissions import MODULE_NAME 
# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑–æ–≤–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è UI —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞
from .permissions import PERM_ACCESS_USER_FEATURES 

from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from core.module_loader import ModuleInfo # –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥—É–ª–µ

async def setup_module(dp: Dispatcher, bot: Bot, services: 'BotServicesProvider'):
    """
    –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —è–¥—Ä–æ–º –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥—É–ª—è.
    –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤, UI-—Ç–æ—á–µ–∫ –≤—Ö–æ–¥–∞, –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏ —Ç.–¥.
    """
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥—É–ª–µ (–≤–∫–ª—é—á–∞—è –º–∞–Ω–∏—Ñ–µ—Å—Ç –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
    module_info: Optional['ModuleInfo'] = services.modules.get_module_info(MODULE_NAME)
    
    if not module_info or not module_info.manifest:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–ª–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç –¥–ª—è –º–æ–¥—É–ª—è '{MODULE_NAME}'. "
                     "–ú–æ–¥—É–ª—å –Ω–µ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
        return

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è
    display_name = module_info.manifest.display_name
    version = module_info.manifest.version
    logger.info(f"[{MODULE_NAME}] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥—É–ª—è: '{display_name}' v{version}...")

    # 1. –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤ (—Ä–æ—É—Ç–µ—Ä–æ–≤) —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
    if isinstance(universal_module_router, Router):
        # –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –Ω–∞ –≤–µ—Å—å —Ä–æ—É—Ç–µ—Ä –º–æ–¥—É–ª—è,
        # –Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö –∏–ª–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –ø—Ä–∞–≤–æ–º.
        # universal_module_router.message.filter(F.chat.type == "private") 
        dp.include_router(universal_module_router)
        logger.info(f"[{MODULE_NAME}] –†–æ—É—Ç–µ—Ä '{universal_module_router.name}' —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.")
    else:
        logger.error(f"[{MODULE_NAME}] –û—à–∏–±–∫–∞: 'universal_module_router' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º aiogram.Router.")

    # 2. –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è UI-—Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª—è –≤ UIRegistry —è–¥—Ä–∞
    # –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –º–æ–¥—É–ª—é –ø–æ—è–≤–∏—Ç—å—Å—è –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ "–ú–æ–¥—É–ª–∏" –≤ UI —è–¥—Ä–∞.
    # Callback_data –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –º–æ–¥—É–ª—å –±—É–¥–µ—Ç ModuleMenuEntry(module_name=MODULE_NAME).pack()
    # –•—ç–Ω–¥–ª–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ callback_data –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ handlers.py.
    
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–±—Ä–∏–∫—É ModuleMenuEntry –∏–∑ —è–¥—Ä–∞
    from core.ui.callback_data_factories import ModuleMenuEntry 

    entry_cb_data = ModuleMenuEntry(module_name=MODULE_NAME).pack()
    
    # –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –ò–∫–æ–Ω–∫–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é "–ú–æ–¥—É–ª–∏"
    icon = "‚ú®" # –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∏–∫–æ–Ω–∫–∞
    # –ü–æ–ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∫–æ–Ω–∫—É –∏–∑ –ø–µ—Ä–≤–æ–π –∫–æ–º–∞–Ω–¥—ã –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if module_info.manifest.commands:
        primary_command_name = MODULE_NAME # –ò–ª–∏ –¥—Ä—É–≥–æ–µ –∏–º—è –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—É—é —Å—á–∏—Ç–∞–µ–º –≥–ª–∞–≤–Ω–æ–π
        main_command_manifest = next((cmd for cmd in module_info.manifest.commands if cmd.command == primary_command_name), None)
        if not main_command_manifest and module_info.manifest.commands: # –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã —Å –∏–º–µ–Ω–µ–º –º–æ–¥—É–ª—è, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é
             main_command_manifest = module_info.manifest.commands[0]
        
        if main_command_manifest and main_command_manifest.icon:
            icon = main_command_manifest.icon

    description_for_ui = module_info.manifest.description or f"–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –º–æ–¥—É–ª—è {display_name}"

    services.ui_registry.register_module_entry(
        module_name=MODULE_NAME, 
        display_name=display_name,
        entry_callback_data=entry_cb_data, 
        icon=icon,
        description=description_for_ui,
        order=100, # –ü–æ—Ä—è–¥–æ–∫ –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ –º–æ–¥—É–ª–µ–π (–º–µ–Ω—å—à–µ - –≤—ã—à–µ)
        # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ—Å—Ç—É–ø –∫ –∫–Ω–æ–ø–∫–µ –º–æ–¥—É–ª—è –≤ –æ–±—â–µ–º –º–µ–Ω—é "–ú–æ–¥—É–ª–∏"
        # –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —è–¥—Ä–æ–º:
        required_permission_to_view=PERM_ACCESS_USER_FEATURES 
    )
    logger.info(f"[{MODULE_NAME}] UI-—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –º–æ–¥—É–ª—è '{display_name}' –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ UIRegistry.")

    # 3. –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è –º–æ–¥—É–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–ª–∏ –∑–∞–¥–∞—á
    # if hasattr(self, 'my_module_service'): # –ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤–æ–π —Å–µ—Ä–≤–∏—Å
    #     await self.my_module_service.initialize(services_provider=services)
    #     logger.info(f"[{MODULE_NAME}] –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–µ—Ä–≤–∏—Å MyModuleService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    # 4. –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è —è–¥—Ä–∞ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
    # async def handle_user_registered_event(user_id: int, source_module: str):
    #     logger.info(f"[{MODULE_NAME}] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ 'sdb:user:registered'. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id} –∏–∑ {source_module}")
    # services.events.subscribe("sdb:user:registered", handle_user_registered_event)
    # logger.info(f"[{MODULE_NAME}] –ü–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —Å–æ–±—ã—Ç–∏–µ 'sdb:user:registered'.")

    # 5. –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –º–æ–¥—É–ª—è, –µ—Å–ª–∏ —ç—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
    # await services.events.publish(f"{MODULE_NAME}:initialized", module_version=version)

    logger.success(f"‚úÖ –ú–æ–¥—É–ª—å '{MODULE_NAME}' ({display_name} v{version}) —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
```

---

**3. `modules/my_universal_module/permissions.py` (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)**

```python
# modules/my_universal_module/permissions.py

# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –º–æ–¥—É–ª—è, –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –ø–∞–ø–∫–∏ –∏ 'name' –≤ manifest.yaml
MODULE_NAME = "my_universal_module"

# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ë–∞–∑–æ–≤–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –∏ –æ—Å–Ω–æ–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º –º–æ–¥—É–ª—è.
# –ï–≥–æ –º–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞—Ç—å —Ä–æ–ª–∏ 'User', –µ—Å–ª–∏ –≤ manifest.yaml metadata.assign_default_access_to_user_role: true
PERM_ACCESS_USER_FEATURES = f"{MODULE_NAME}.access_user_features"

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –ü—Ä–∏–º–µ—Ä—ã –¥—Ä—É–≥–∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
PERM_VIEW_SENSITIVE_DATA = f"{MODULE_NAME}.view_sensitive_data"
PERM_PERFORM_SPECIAL_ACTION = f"{MODULE_NAME}.perform_special_action"

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è
PERM_ADMIN_MANAGE_SETTINGS = f"{MODULE_NAME}.admin_manage_settings"
PERM_ADMIN_VIEW_ALL_DATA = f"{MODULE_NAME}.admin_view_all_data"

# –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –º–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–æ–¥—É–ª—è –≤ –æ–¥–∏–Ω —Å–ø–∏—Å–æ–∫ –∏–ª–∏ —Å–ª–æ–≤–∞—Ä—å,
# –Ω–æ —ç—Ç–æ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –±—É–¥—É—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞.
ALL_MODULE_PERMISSIONS = {
    PERM_ACCESS_USER_FEATURES: "–î–æ—Å—Ç—É–ø –∫ –æ—Å–Ω–æ–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ú–æ–¥—É–ª—è.",
    PERM_VIEW_SENSITIVE_DATA: "–ü—Ä–æ—Å–º–æ—Ç—Ä —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º –ú–æ–¥—É–ª–µ.",
    PERM_PERFORM_SPECIAL_ACTION: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –≤ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º –ú–æ–¥—É–ª–µ.",
    PERM_ADMIN_MANAGE_SETTINGS: "[–ê–î–ú–ò–ù] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ú–æ–¥—É–ª—è.",
    PERM_ADMIN_VIEW_ALL_DATA: "[–ê–î–ú–ò–ù] –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ú–æ–¥—É–ª—è.",
}
# –≠—Ç–æ—Ç —Å–ª–æ–≤–∞—Ä—å ALL_MODULE_PERMISSIONS –∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞,
# –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ manifest.yaml.
```

---

**4. `modules/my_universal_module/handlers.py` (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)**

```python
# modules/my_universal_module/handlers.py

from aiogram import Router, types, F, Bot
from aiogram.filters import Command
from aiogram.utils.markdown import hbold
from loguru import logger

# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ò–º–ø–æ—Ä—Ç —Ñ–∞–±—Ä–∏–∫ –∫–æ–ª–±—ç–∫–æ–≤ —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è –∏ —Ñ–∞–±—Ä–∏–∫ —è–¥—Ä–∞ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
from .callback_data import MyUniversalModuleAction
from core.ui.callback_data_factories import ModuleMenuEntry 

# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
from .keyboards import get_universal_module_main_menu_keyboard

# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
from .permissions import (
    MODULE_NAME,
    PERM_ACCESS_USER_FEATURES,
    PERM_VIEW_SENSITIVE_DATA,
    PERM_PERFORM_SPECIAL_ACTION
)

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –ò–º–ø–æ—Ä—Ç FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
# from .states import MyFSMState

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession # –î–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø—Ä–∞–≤

# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
universal_module_router = Router(name=f"sdb_{MODULE_NAME}_handlers")

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—â–µ–π –¥–ª—è –º–æ–¥—É–ª—è) ---
async def check_module_permission(
    user_id: int, 
    permission_name: str, 
    services: 'BotServicesProvider', 
    session: 'AsyncSession' # –ü–µ—Ä–µ–¥–∞–µ–º —Å–µ—Å—Å–∏—é —è–≤–Ω–æ
) -> bool:
    has_perm = await services.rbac.user_has_permission(session, user_id, permission_name)
    if not has_perm:
        logger.warning(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–æ–ø—ã—Ç–∞–ª—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ, —Ç—Ä–µ–±—É—é—â–µ–µ –ø—Ä–∞–≤–∞ "
                       f"'{permission_name}', –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –µ–≥–æ.")
    return has_perm

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –≤—Ö–æ–¥–∞ –≤ –º–æ–¥—É–ª—å (–ø—Ä–∏–º–µ—Ä) ---
@universal_module_router.message(Command(MODULE_NAME)) # –ö–æ–º–∞–Ω–¥–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏–º–µ–Ω–µ–º –º–æ–¥—É–ª—è
async def cmd_universal_module_entry(message: types.Message, services_provider: 'BotServicesProvider'):
    user_id = message.from_user.id
    logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤—ã–∑–≤–∞–ª –∫–æ–º–∞–Ω–¥—É /{MODULE_NAME}.")

    async with services_provider.db.get_session() as session:
        if not await check_module_permission(user_id, PERM_ACCESS_USER_FEATURES, services_provider, session):
            await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –º–æ–¥—É–ª—é.")
            return
    
    module_info = services_provider.modules.get_module_info(MODULE_NAME)
    display_name = module_info.manifest.display_name if module_info and module_info.manifest else MODULE_NAME

    text = f"üåü –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ {hbold(display_name)}!"
    async with services_provider.db.get_session() as session: # –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        keyboard = await get_universal_module_main_menu_keyboard(services_provider, user_id, session)
    await message.answer(text, reply_markup=keyboard)

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞ –≤ –º–µ–Ω—é –º–æ–¥—É–ª—è —á–µ—Ä–µ–∑ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π ---
@universal_module_router.callback_query(ModuleMenuEntry.filter(F.module_name == MODULE_NAME))
async def cq_universal_module_main_menu(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider'
):
    user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤–æ—à–µ–ª –≤ –º–µ–Ω—é –º–æ–¥—É–ª—è '{MODULE_NAME}'.")
    
    async with services_provider.db.get_session() as session:
        if not await check_module_permission(user_id, PERM_ACCESS_USER_FEATURES, services_provider, session):
            await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –º–µ–Ω—é.", show_alert=True)
            return

        module_info = services_provider.modules.get_module_info(MODULE_NAME)
        display_name = module_info.manifest.display_name if module_info and module_info.manifest else MODULE_NAME
        text = f"–ú–µ–Ω—é –º–æ–¥—É–ª—è {hbold(display_name)}. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
        keyboard = await get_universal_module_main_menu_keyboard(services_provider, user_id, session)

        if query.message:
            try:
                await query.message.edit_text(text, reply_markup=keyboard)
            except TelegramBadRequest as e:
                if "message is not modified" not in str(e).lower():
                    logger.warning(f"[{MODULE_NAME}] –û—à–∏–±–∫–∞ edit_text –≤ –º–µ–Ω—é –º–æ–¥—É–ª—è: {e}")
            await query.answer()

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –º–æ–¥—É–ª—è ---
@universal_module_router.callback_query(MyUniversalModuleAction.filter(F.action == "view_data"))
async def cq_view_module_data(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    async with services_provider.db.get_session() as session:
        # –î–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–µ—Ü. —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, —Ç–æ–ª—å–∫–æ PERM_ACCESS_USER_FEATURES (—É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –º–µ–Ω—é)
        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        # –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –º–æ–¥—É–ª—å —Ö—Ä–∞–Ω–∏—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        # –î–æ—Å—Ç—É–ø –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –º–æ–¥—É–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã
        module_settings = services_provider.modules.get_module_settings(MODULE_NAME)
        greeting = module_settings.get("greeting_message", "–ü—Ä–∏–≤–µ—Ç!") if module_settings else "–ü—Ä–∏–≤–µ—Ç!"

        await query.answer(f"{greeting} –í–æ—Ç –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ –º–æ–¥—É–ª—è!", show_alert=False)
        logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ.")

@universal_module_router.callback_query(MyUniversalModuleAction.filter(F.action == "view_sensitive"))
async def cq_view_sensitive_data(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    async with services_provider.db.get_session() as session:
        if not await check_module_permission(user_id, PERM_VIEW_SENSITIVE_DATA, services_provider, session):
            await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.", show_alert=True)
            return
    await query.answer("–≠—Ç–æ –æ—á–µ–Ω—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!", show_alert=True)
    logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.")


@universal_module_router.callback_query(MyUniversalModuleAction.filter(F.action == "special_action"))
async def cq_do_special_action(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    async with services_provider.db.get_session() as session:
        if not await check_module_permission(user_id, PERM_PERFORM_SPECIAL_ACTION, services_provider, session):
            await query.answer("–≠—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–µ –≤—Å–µ–º.", show_alert=True)
            return
    await query.answer("‚ú® –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! ‚ú®", show_alert=True)
    logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤—ã–ø–æ–ª–Ω–∏–ª —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.")

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –•—ç–Ω–¥–ª–µ—Ä—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –º–æ–¥—É–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
# @universal_module_router.message(Command("universal_admin_manage"))
# async def cmd_admin_manage_module(message: types.Message, services_provider: 'BotServicesProvider'):
#     user_id = message.from_user.id
#     async with services_provider.db.get_session() as session:
#         if not await check_module_permission(user_id, PERM_ADMIN_MANAGE_MODULE, services_provider, session):
#             await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è.")
#             return
#     await message.answer("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ú–æ–¥—É–ª—è!")
```

---

**5. `modules/my_universal_module/keyboards.py` (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)**

```python
# modules/my_universal_module/keyboards.py

from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder

# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ò–º–ø–æ—Ä—Ç —Ñ–∞–±—Ä–∏–∫ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
from .callback_data import MyUniversalModuleAction
# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ò–º–ø–æ—Ä—Ç —Ñ–∞–±—Ä–∏–∫ —è–¥—Ä–∞ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–Ω–∞–∑–∞–¥ –∏ —Ç.–¥.)
from core.ui.callback_data_factories import CoreMenuNavigate 
# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫
from .permissions import PERM_VIEW_SENSITIVE_DATA, PERM_PERFORM_SPECIAL_ACTION

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession


async def get_universal_module_main_menu_keyboard(
    services: 'BotServicesProvider', 
    user_id: int, 
    session: 'AsyncSession' # –ù—É–∂–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
) -> InlineKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –º–æ–¥—É–ª—è.
    –ö–Ω–æ–ø–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    builder = InlineKeyboardBuilder()
    
    # –ö–Ω–æ–ø–∫–∞ 1: –ü—Ä–æ—Å—Ç–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ, –¥–æ—Å—Ç—É–ø–Ω–æ–µ —Å –±–∞–∑–æ–≤—ã–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º (PERM_ACCESS_USER_FEATURES)
    # –ü—Ä–∞–≤–æ PERM_ACCESS_USER_FEATURES —É–∂–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º —ç—Ç–æ–≥–æ –º–µ–Ω—é.
    builder.button(
        text="üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ",
        callback_data=MyUniversalModuleAction(action="view_data").pack()
    )

    # –ö–Ω–æ–ø–∫–∞ 2: –î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è PERM_VIEW_SENSITIVE_DATA
    if await services.rbac.user_has_permission(session, user_id, PERM_VIEW_SENSITIVE_DATA):
        builder.button(
            text="üîí –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
            callback_data=MyUniversalModuleAction(action="view_sensitive").pack()
        )

    # –ö–Ω–æ–ø–∫–∞ 3: –î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è PERM_PERFORM_SPECIAL_ACTION
    if await services.rbac.user_has_permission(session, user_id, PERM_PERFORM_SPECIAL_ACTION):
        builder.button(
            text="üöÄ –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ",
            callback_data=MyUniversalModuleAction(action="special_action").pack()
        )

    # –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –∏–∑ "–æ—Å–Ω–æ–≤–Ω—ã—Ö" –∫–Ω–æ–ø–æ–∫ –Ω–µ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ (–∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø—Ä–∞–≤),
    # –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É.
    if not builder.export(): # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞–∫–∏–µ-–ª–∏–±–æ –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ
         builder.button(text="ü§∑‚Äç‚ôÇÔ∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π", callback_data="my_universal_module:no_actions_dummy")


    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤ –æ–±—â–µ–µ –º–µ–Ω—é –º–æ–¥—É–ª–µ–π SDB
    builder.button(
        text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª–µ–π",
        callback_data=CoreMenuNavigate(target_menu="modules_list", page=1).pack() 
    )
    
    builder.adjust(1) # –ö–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ
    return builder.as_markup()
```

---

**6. `modules/my_universal_module/callback_data.py` (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)**

```python
# modules/my_universal_module/callback_data.py

from aiogram.filters.callback_data import CallbackData
from typing import Optional

# –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –∫–æ–ª–±—ç–∫–æ–≤ —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
MY_UNIVERSAL_MODULE_PREFIX = "muniv" 

class MyUniversalModuleAction(CallbackData, prefix=MY_UNIVERSAL_MODULE_PREFIX):
    # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ü–æ–ª–µ 'action' –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –¥–µ–π—Å—Ç–≤–∏—è
    action: str 
    
    # –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
    item_id: Optional[int] = None
    page: Optional[int] = None
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
```

---

**7. `modules/my_universal_module/states.py` (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)**

```python
# modules/my_universal_module/states.py

from aiogram.fsm.state import State, StatesGroup

# –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –∑–¥–µ—Å—å —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM, –µ—Å–ª–∏ –≤–∞—à –º–æ–¥—É–ª—å –∏—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç.
class MyUniversalModuleFSM(StatesGroup):
    first_step = State()
    second_step = State()
    # ... –¥—Ä—É–≥–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
```

---

**8. `modules/my_universal_module/models.py` (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)**
(–ú—ã —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∏ `UserNote` –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø—Ä–∏–º–µ—Ä–µ, –∑–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –º–æ–¥–µ–ª–µ–π)

```python
# modules/my_universal_module/models.py
from sqlalchemy import String, Integer, ForeignKey, Text, Boolean 
from sqlalchemy.orm import Mapped, mapped_column, relationship
from core.database.base import SDBBaseModel 
from typing import Optional

# –ü—Ä–∏–º–µ—Ä –º–æ–¥–µ–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
class MyFirstTable(SDBBaseModel): 
    __tablename__ = "mod_universal_my_first_table" # –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –ü—Ä–µ—Ñ–∏–∫—Å mod_{module_name}_
    
    name: Mapped[str] = mapped_column(String(100), nullable=False)
    value: Mapped[Optional[int]] = mapped_column(Integer)

    def __repr__(self):
        return f"<MyFirstTable(id={self.id}, name='{self.name}')>"

# –ù–µ –∑–∞–±—É–¥—å—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å "modules.my_universal_module.models.MyFirstTable"
# –≤ 'model_definitions' –≤ manifest.yaml, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã CLI –º–æ–≥ –µ–µ —á–∏—Å—Ç–∏—Ç—å.
```

---

**9. `modules/my_universal_module/module_settings_defaults.yaml` (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)**

–§–∞–π–ª —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –º–æ–¥—É–ª—è. –ò–º–µ–Ω–∞ –∫–ª—é—á–µ–π –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º–∏, —á—Ç–æ –æ–ø–∏—Å–∞–Ω—ã –≤ —Å–µ–∫—Ü–∏–∏ `settings` —Ñ–∞–π–ª–∞ `manifest.yaml`.

```yaml
# modules/my_universal_module/module_settings_defaults.yaml

greeting_message: "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—Å (–∏–∑ —Ñ–∞–π–ª–∞ –¥–µ—Ñ–æ–ª—Ç–æ–≤)!"
enable_feature_x: false
item_limit: 5
# theme_color: "green" # –ï—Å–ª–∏ —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å—Ç—å –≤ options –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ
# admin_email: # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –±–µ–∑ default –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–¥–∞–Ω—ã –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –∫–æ–Ω—Ñ–∏–≥–µ
```

---

**10. `modules/my_universal_module/services.py` (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)**

–ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã, —Ñ—É–Ω–∫—Ü–∏–∏, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è.

```python
# modules/my_universal_module/services.py

from loguru import logger
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession

class UniversalModuleHelperService:
    def __init__(self, services: 'BotServicesProvider', module_name: str):
        self.services = services
        self.module_name = module_name
        self.logger = logger.bind(service=f"{module_name}_helper")
        self.logger.info("UniversalModuleHelperService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    async def get_user_specific_data(self, user_id: int, session: 'AsyncSession') -> str:
        # –ü—Ä–∏–º–µ—Ä: –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        module_settings = self.services.modules.get_module_settings(self.module_name)
        max_items = module_settings.get("item_limit", 10) if module_settings else 10
        
        # –ó–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –ë–î –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        # user_items = await session.execute(select(SomeModel).where(SomeModel.user_id == user_id).limit(max_items))
        # items = list(user_items.scalars().all())
        
        self.logger.debug(f"–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å –ª–∏–º–∏—Ç–æ–º {max_items}.")
        return f"–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ (–¥–æ {max_items} —à—Ç.) –∏–∑ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ú–æ–¥—É–ª—è!"

    async def perform_complex_action(self, user_id: int, data: dict) -> bool:
        self.logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–æ–∂–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏: {data}")
        # ... –ª–æ–≥–∏–∫–∞ —Å–ª–æ–∂–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è ...
        # await self.services.events.publish(f"{self.module_name}:complex_action_done", user_id=user_id, result="success")
        return True

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –≤ __init__.py –º–æ–¥—É–ª—è:
# from .services import UniversalModuleHelperService
# ...
# async def setup_module(dp, bot, services):
#     module_name = "my_universal_module"
#     helper = UniversalModuleHelperService(services, module_name)
#     services.ext.register_module_service(module_name, "helper", helper) 
#     # services.ext - —ç—Ç–æ –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–æ—Å–æ–± —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –º–æ–¥—É–ª—è
#     # –õ–∏–±–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å helper –≤ —Ö—ç–Ω–¥–ª–µ—Ä—ã —á–µ—Ä–µ–∑ data['module_helper'] = helper –≤ __init__
# ...
```

---

**–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –º–æ–¥—É–ª—è:**

*   **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ**: –°—Ç–∞—Ä–∞–π—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `snake_case` –¥–ª—è –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, —Ñ—É–Ω–∫—Ü–∏–π. –ò–º—è –º–æ–¥—É–ª—è (`name` –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ) –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –ø–∞–ø–∫–∏.
*   **–†–∞–∑—Ä–µ—à–µ–Ω–∏—è**:
    *   –í—Å–µ–≥–¥–∞ –æ–±—ä—è–≤–ª—è–π —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–≤–æ–π –º–æ–¥—É–ª—å, –≤ `manifest.yaml` –≤ —Å–µ–∫—Ü–∏–∏ `permissions`. –ò–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `–∏–º—è_–º–æ–¥—É–ª—è.`.
    *   –í —Ö—ç–Ω–¥–ª–µ—Ä–∞—Ö –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –∏–ª–∏ –ø–æ–∫–∞–∑–æ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    *   –î–ª—è UI-—Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª—è (–∫–Ω–æ–ø–∫–∏ –≤ –æ–±—â–µ–º –º–µ–Ω—é "–ú–æ–¥—É–ª–∏") —É–∫–∞–∑—ã–≤–∞–π `required_permission_to_view` –≤ `services.ui_registry.register_module_entry`, —á—Ç–æ–±—ã —è–¥—Ä–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–ª–æ –∫–Ω–æ–ø–∫—É –æ—Ç —Ç–µ—Ö, —É –∫–æ–≥–æ –Ω–µ—Ç —ç—Ç–æ–≥–æ –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–∞–≤–∞.
    *   –ï—Å–ª–∏ –º–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —É—Å—Ç–∞–Ω–æ–≤–∏ `metadata.assign_default_access_to_user_role: true` –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –∏ —É–±–µ–¥–∏—Å—å, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤–∏–¥–∞ `–∏–º—è_–º–æ–¥—É–ª—è.access_user_features`.
*   **–ù–∞—Å—Ç—Ä–æ–π–∫–∏**:
    *   –û–ø–∏—Å—ã–≤–∞–π –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è –≤ —Å–µ–∫—Ü–∏–∏ `settings` –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞.
    *   –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π —Ñ–∞–π–ª `module_settings_defaults.yaml` —Å —Ä–∞–∑—É–º–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
    *   –í –∫–æ–¥–µ –º–æ–¥—É–ª—è –ø–æ–ª—É—á–∞–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ `services.modules.get_module_settings(MODULE_NAME)`.
*   **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**:
    *   –í—Å–µ –º–æ–¥–µ–ª–∏ SQLAlchemy –¥–æ–ª–∂–Ω—ã –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç `core.database.base.SDBBaseModel`.
    *   –ò–º–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä, `mod_{module_name}_`.
    *   –£–∫–∞–∑—ã–≤–∞–π –ø–æ–ª–Ω—ã–µ –ø—É—Ç–∏ –∫ –∫–ª–∞—Å—Å–∞–º –º–æ–¥–µ–ª–µ–π –≤ `model_definitions` –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞.
    *   –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î –≤ —Ö—ç–Ω–¥–ª–µ—Ä–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π `async with services_provider.db.get_session() as session:`.
*   **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π `logger` –∏–∑ `loguru`, –∫–æ—Ç–æ—Ä—ã–π –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ `services.logger` –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –±–∏–Ω–¥–∏—Ç—å –ª–æ–≥–≥–µ—Ä –∫ –∏–º–µ–Ω–∏ –º–æ–¥—É–ª—è: `logger.bind(module=MODULE_NAME)`.
*   **–ò–∑–æ–ª—è—Ü–∏—è**: –°—Ç–∞—Ä–∞–π—Å—è –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏–∑ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π (–∫—Ä–æ–º–µ —è–¥—Ä–∞). –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –º–µ–∂–º–æ–¥—É–ª—å–Ω–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏—Å—Ç–µ–º—É —Å–æ–±—ã—Ç–∏–π (`services.events`).
*   **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: –í—Å–µ —Ö—ç–Ω–¥–ª–µ—Ä—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å I/O (–ë–î, —Å–µ—Ç—å, —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞), –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ (`async def`).
*   **–ß–∏—Å—Ç–æ—Ç–∞ –∫–æ–¥–∞**: –°–ª–µ–¥—É–π PEP 8, –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –ø–∏—à–∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∫–æ–¥.

–≠—Ç–æ—Ç —à–∞–±–ª–æ–Ω –¥–æ–ª–∂–µ–Ω –ø–æ–∫—Ä—ã—Ç—å –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤. –ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏–ª–∏ –∏–¥–µ–∏ –ø–æ –µ–≥–æ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—é, –¥–∞–π –∑–Ω–∞—Ç—å!


======================================================================

------------------------------ FILE: modules/__init__.py ------------------------------



======================================================================

------------------------------ FILE: project_data/.gitignore ------------------------------
*
!.gitignore
!*/
!.gitkeep



======================================================================

------------------------------ FILE: cli_commands/db_cmd.py ------------------------------
# cli_commands/db_cmd.py

import typer
from rich.console import Console
from rich.panel import Panel
import subprocess
import sys
import os
from pathlib import Path
import asyncio

console = Console()

db_app = typer.Typer(
    name="db",
    help="üóÑÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ Alembic.",
    rich_markup_mode="rich",
    no_args_is_help=True  # <--- –î–û–ë–ê–í–õ–ï–ù–û
)

# –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞ (__file__)
# cli_commands/db_cmd.py -> cli_commands/ -> PROJECT_ROOT
PROJECT_ROOT_FROM_DB_CMD = Path(__file__).resolve().parent.parent
ALEMBIC_INI_PATH_STR = str(PROJECT_ROOT_FROM_DB_CMD / "alembic.ini")


def _run_alembic_command(args: list[str], suppress_success_output: bool = False) -> bool:
    try:
        alembic_ini_actual_path = Path(ALEMBIC_INI_PATH_STR)
        if not alembic_ini_actual_path.is_file():
            console.print(f"[bold red]–û—à–∏–±–∫–∞: –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Alembic '{ALEMBIC_INI_PATH_STR}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]")
            console.print(f"  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ –ø—É—Ç—å –∫ alembic.ini –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.")
            return False

        command = ["alembic", "-c", ALEMBIC_INI_PATH_STR] + args
        
        env = os.environ.copy()
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ PYTHONPATH, —á—Ç–æ–±—ã Alembic –º–æ–≥ –Ω–∞–π—Ç–∏ core –∏ modules
        # –≠—Ç–æ –≤–∞–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ env.py –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã SDB
        existing_python_path = env.get("PYTHONPATH", "")
        project_root_str = str(PROJECT_ROOT_FROM_DB_CMD)
        
        if existing_python_path:
            # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ project_root_str –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å
            path_parts = existing_python_path.split(os.pathsep)
            if project_root_str not in path_parts:
                env["PYTHONPATH"] = f"{project_root_str}{os.pathsep}{existing_python_path}"
            else: # –£–∂–µ –µ—Å—Ç—å, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
                env["PYTHONPATH"] = existing_python_path
        else:
            env["PYTHONPATH"] = project_root_str
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ sys.path –ø–µ—Ä–µ–¥–∞–Ω –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
        # (–û–±—ã—á–Ω–æ PYTHONPATH –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
        # current_sys_path_str = os.pathsep.join(s.strip() for s in sys.path if s.strip())
        # env["PYTHONPATH"] = f"{current_sys_path_str}{os.pathsep}{env.get('PYTHONPATH', '')}"


        process = subprocess.run(
            command,
            capture_output=True,
            text=True,
            encoding='utf-8',
            env=env,
            cwd=str(PROJECT_ROOT_FROM_DB_CMD) # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
        )

        if process.stdout and not (process.returncode == 0 and suppress_success_output):
            console.print(process.stdout.strip())

        if process.stderr:
            is_actual_error_in_stderr = "error" in process.stderr.lower() or \
                                        "fail" in process.stderr.lower() or \
                                        "traceback" in process.stderr.lower() or \
                                        "critical" in process.stderr.lower()

            if process.returncode != 0 or is_actual_error_in_stderr:
                console.print(f"[bold red]Alembic STDERR:[/]\n{process.stderr.strip()}")
            elif not (process.returncode == 0 and suppress_success_output):
                 console.print(f"[dim yellow]Alembic STDERR (info/warnings):[/]\n{process.stderr.strip()}")

        if process.returncode != 0:
            console.print(f"[bold red]–ö–æ–º–∞–Ω–¥–∞ Alembic –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: {process.returncode}). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ –≤—ã—à–µ.[/]")
            return False
        return True

    except FileNotFoundError:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ö–æ–º–∞–Ω–¥–∞ 'alembic' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.[/]")
        console.print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Alembic —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –≤–∞—à–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º PATH.")
        console.print(f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ: [cyan]pip install alembic[/]")
        return False
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã Alembic: {e}[/]")
        return False

@db_app.command(name="upgrade", help="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ 'head', —Ç.–µ. –ø–æ—Å–ª–µ–¥–Ω–µ–π).")
def db_upgrade_cmd(
    revision: str = typer.Argument("head", help="ID —Ä–µ–≤–∏–∑–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'head', 'base', specific_id, '+1', '-2').")
):
    console.print(f"–ó–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π Alembic –¥–æ —Ä–µ–≤–∏–∑–∏–∏: [cyan]{revision}[/]...")
    if not _run_alembic_command(["upgrade", revision]):
        raise typer.Exit(code=1)
    console.print(f"[bold green]–ö–æ–º–∞–Ω–¥–∞ 'db upgrade {revision}' —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.[/]")

@db_app.command(name="downgrade", help="–û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic.")
def db_downgrade_cmd(
    revision: str = typer.Argument(
        "1", 
        help="ID —Ä–µ–≤–∏–∑–∏–∏ –¥–ª—è –æ—Ç–∫–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'base', specific_id) –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–≤–∏–∑–∏–π –¥–ª—è –æ—Ç–∫–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '1' –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π, '2' –¥–ª—è –¥–≤—É—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö). –î–ª—è –æ—Ç–∫–∞—Ç–∞ –Ω–∞ –æ–¥–Ω—É —Ä–µ–≤–∏–∑–∏—é –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ —É–∫–∞–∑–∞—Ç—å '-1'."
    )
):
    target_revision = revision
    if revision.isdigit():
        target_revision = f"-{revision}" 
        description_log = f"–Ω–∞ {revision} —Ä–µ–≤–∏–∑–∏—é(–∏) –Ω–∞–∑–∞–¥ (–¥–æ {target_revision})"
    else:
        description_log = f"–¥–æ —Ä–µ–≤–∏–∑–∏–∏ '{revision}'"

    console.print(f"–ó–∞–ø—É—Å–∫ –æ—Ç–∫–∞—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–π Alembic {description_log}...")
    if typer.confirm(f"–í—ã [bold red]–£–í–ï–†–ï–ù–´[/], —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ {description_log}? –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö.", abort=True):
        if not _run_alembic_command(["downgrade", revision]):
            raise typer.Exit(code=1)
        console.print(f"[bold green]–ö–æ–º–∞–Ω–¥–∞ 'db downgrade {revision}' —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.[/]")

@db_app.command(name="revision", help="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic.")
def db_revision_cmd(
    message: str = typer.Option(..., "-m", "--message", help="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –Ω–æ–≤–æ–π —Ä–µ–≤–∏–∑–∏–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)."),
    autogenerate: bool = typer.Option(True, "--autogenerate/--no-autogenerate",
                                     help="–ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–¥–µ–ª—è—Ö (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è).")
):
    args = ["revision"]
    if autogenerate:
        args.append("--autogenerate")
    args.extend(["-m", message])

    console.print(f"–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–µ–≤–∏–∑–∏–∏ Alembic —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º: '[cyan]{message}[/]' (autogenerate: {autogenerate})...")
    if not _run_alembic_command(args):
        raise typer.Exit(code=1)
    console.print(f"[bold green]–ö–æ–º–∞–Ω–¥–∞ 'db revision' —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –ù–æ–≤—ã–π —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –≤ 'alembic_migrations/versions/'.[/]")

@db_app.command(name="status", help="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π –∏ –∏—Å—Ç–æ—Ä–∏—é.")
def db_status_cmd(
    verbose: bool = typer.Option(False, "--verbose", "-v", help="–ü–æ–∫–∞–∑–∞—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥.")
):
    console.print(Panel("[bold blue]–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π Alembic (–∫–æ–º–∞–Ω–¥–∞ 'current')[/]", expand=False, border_style="blue"))
    current_args = ["current"]
    if verbose:
        current_args.append("--verbose")

    success_current = _run_alembic_command(current_args, suppress_success_output=verbose)
    if not success_current:
        console.print("[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å Alembic (Alembic current).[/yellow]")

    console.print(Panel("[bold blue]–ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π Alembic (–∫–æ–º–∞–Ω–¥–∞ 'history')[/]", expand=False, border_style="blue", style="blue"))
    history_args = ["history"]
    if not _run_alembic_command(history_args):
        console.print("[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π Alembic (Alembic history).[/yellow]")

@db_app.command(name="init-core", help="[–û–ü–ê–°–ù–û] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ –∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ä–æ–ª–∏ –Ω–∞–ø—Ä—è–º—É—é, –º–∏–Ω—É—è Alembic.")
def db_init_core_cmd():
    console.print(Panel("[bold yellow]–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü —è–¥—Ä–∞ SDB –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π –Ω–∞–ø—Ä—è–º—É—é[/]", expand=False, border_style="yellow"))
    console.print("[bold red]–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï:[/bold red] –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ –∏ —Ä–æ–ª–∏ –Ω–∞–ø—Ä—è–º—É—é, –∏–≥–Ω–æ—Ä–∏—Ä—É—è Alembic.")
    if typer.confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–æ–ª–∏ –Ω–∞–ø—Ä—è–º—É—é?", abort=True):
        try:
            from core.app_settings import settings
            from core.database.manager import DBManager
            from core.rbac.service import RBACService

            async def _init_core_data_task_runner():
                nonlocal settings
                console.print(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ë–î: {settings.db.type} (URL —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫).")
                db_m = DBManager(db_settings=settings.db, app_settings=settings)
                try:
                    await db_m.initialize()

                    console.print("–í—ã–∑–æ–≤ DBManager.create_all_core_tables() –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü —è–¥—Ä–∞...")
                    await db_m.create_all_core_tables()
                    console.print("[bold green]–¢–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã (–∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏).[/]")

                    console.print("–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π...")
                    rbac_s = RBACService(db_manager=db_m) # –ü–µ—Ä–µ–¥–∞–µ–º DBManager
                    async with db_m.get_session() as session:
                        roles_created_count = await rbac_s.ensure_default_roles_exist(session)
                        if roles_created_count > 0:
                            console.print(f"[bold green]–£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ –∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ {roles_created_count} —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π.[/bold green]")
                        else:
                            console.print("[dim]–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–æ–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏ –∏–ª–∏ –Ω–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ RBACService).[/dim]")
                except Exception as e_task:
                    console.print(f"[bold red]–û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e_task}[/]")
                    raise
                finally:
                    await db_m.dispose()

            asyncio.run(_init_core_data_task_runner())
            console.print("\n[bold green]–ö–æ–º–∞–Ω–¥–∞ 'db init-core' —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.[/]")
            console.print("[yellow]–í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ Alembic —Ä–∞–Ω–µ–µ, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º.[/]")
            console.print("  [yellow]–í–æ–∑–º–æ–∂–Ω–æ, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å 'sdb db stamp head', —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å Alembic —Å —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–æ–π –ë–î.[/]")
            console.print("  [yellow]–î–µ–ª–∞–π—Ç–µ —ç—Ç–æ, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ç–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ –ë–î —è–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª–µ–≤–æ–π '–≥–æ–ª–æ–≤–æ–π'.[/]")

        except ImportError as e_imp:
             console.print(f"[bold red]–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —è–¥—Ä–∞ –¥–ª—è 'db init-core': {e_imp}[/]")
             raise typer.Exit(code=1)
        except Exception as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ 'db init-core': {e}[/]")
            raise typer.Exit(code=1)

@db_app.command(name="stamp", help="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ–≤–∏–∑–∏—é Alembic –≤ –ë–î, –Ω–µ –ø—Ä–∏–º–µ–Ω—è—è –º–∏–≥—Ä–∞—Ü–∏–∏.")
def db_stamp_cmd(
    revision: str = typer.Argument(..., help="ID —Ä–µ–≤–∏–∑–∏–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'head', 'base', specific_id)."),
    purge: bool = typer.Option(False, "--purge", help="–û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤–µ—Ä—Å–∏–π Alembic –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤–æ–π —Ä–µ–≤–∏–∑–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é!).")
):
    console.print(f"–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–≤–∏–∑–∏–∏ Alembic: [cyan]{revision}[/]" + ("[bold yellow] —Å –æ—á–∏—Å—Ç–∫–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤–µ—Ä—Å–∏–π[/]" if purge else ""))
    if purge:
        if not typer.confirm(f"[bold red]–í–ù–ò–ú–ê–ù–ò–ï: –û–ø—Ü–∏—è --purge –£–î–ê–õ–ò–¢ –í–°–ï –ó–ê–ü–ò–°–ò –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –≤–µ—Ä—Å–∏–π Alembic –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ä–µ–≤–∏–∑–∏–∏ '{revision}'. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –∏—Å—Ç–æ—Ä–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π –≤ –ë–î. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?", abort=True):
            return
    
    args = ["stamp"]
    if purge:
        args.append("--purge")
    args.append(revision)
    
    if not _run_alembic_command(args):
        raise typer.Exit(code=1)
    console.print(f"[bold green]–ö–æ–º–∞–Ω–¥–∞ 'db stamp {revision}{' --purge' if purge else ''}' —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.[/]")


======================================================================

------------------------------ FILE: cli_commands/bot_cmd.py ------------------------------
import typer
import asyncio
from rich.console import Console
from rich.panel import Panel
from rich.table import Table
from loguru import logger
from aiogram import Bot
from aiogram.types import BotCommand
from pathlib import Path
from core.services_provider import BotServicesProvider
from .cli_utils import get_sdb_services_for_cli
from core.module_loader import ModuleLoader

console = Console()
bot_app = typer.Typer(
    name="bot",
    help="ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ Telegram-–±–æ—Ç–∞.",
    rich_markup_mode="rich",
    no_args_is_help=True  # <--- –î–û–ë–ê–í–õ–ï–ù–û
)

@bot_app.command(name="delete-commands", help="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ Telegram.")
def delete_commands():
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ Telegram."""
    async def _delete_commands_async():
        settings_obj, _, _ = await get_sdb_services_for_cli(init_db=False, init_rbac=False)
        if not settings_obj:
            console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞.[/]")
            logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã delete-commands")
            raise typer.Exit(code=1)

        try:
            bot_token = settings_obj.telegram.token
            if not bot_token:
                console.print("[bold red]–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.[/]")
                logger.error("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö")
                raise typer.Exit(code=1)

            bot = Bot(token=bot_token)
            await bot.delete_my_commands()
            await bot.session.close()
            console.print(Panel("[bold green]–í—Å–µ –∫–æ–º–∞–Ω–¥—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –º–µ–Ω—é Telegram![/]", expand=False, border_style="green"))
            logger.success("–í—Å–µ –∫–æ–º–∞–Ω–¥—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ –º–µ–Ω—é Telegram")
        except AttributeError as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}[/]")
            logger.error(f"–û—à–∏–±–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}")
            raise typer.Exit(code=1)
        except Exception as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥: {e}[/]")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥: {e}")
            raise typer.Exit(code=1)

    try:
        asyncio.run(_delete_commands_async())
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/]")
        logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ delete-commands: {e}")
        raise typer.Exit(code=1)

@bot_app.command(name="set-commands", help="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ –º–µ–Ω—é Telegram –∏–∑ –º–æ–¥—É–ª–µ–π –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫.")
def set_commands():
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≤ –º–µ–Ω—é Telegram."""
    async def _set_commands_async():
        settings_obj, _, _ = await get_sdb_services_for_cli(init_db=False, init_rbac=False)
        if not settings_obj:
            console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞.[/]")
            logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã set-commands")
            raise typer.Exit(code=1)

        try:
            bot_token = settings_obj.telegram.token
            if not bot_token:
                console.print("[bold red]–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.[/]")
                logger.error("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö")
                raise typer.Exit(code=1)

            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ModuleLoader
            temp_bsp = BotServicesProvider(settings=settings_obj)
            loader = ModuleLoader(settings=settings_obj, services_provider=temp_bsp)
            loader.scan_all_available_modules()
            if hasattr(loader, '_load_enabled_plugin_names'):
                loader._load_enabled_plugin_names()

            # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–æ–¥—É–ª–µ–π
            commands = []
            for module_info in loader.available_modules.values():
                if module_info.manifest and module_info.name in loader.enabled_plugin_names:
                    for cmd in module_info.manifest.commands or []:
                        if cmd.get('command') and cmd.get('description'):
                            commands.append(BotCommand(command=cmd['command'].lstrip('/'), description=cmd['description']))

            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –∏–∑ core_settings.yaml (–µ—Å–ª–∏ –µ—Å—Ç—å)
            core_commands_path = settings_obj.core.project_data_path / 'Config' / 'bot_commands.yaml'
            if core_commands_path.exists():
                import yaml
                with core_commands_path.open('r', encoding='utf-8') as f:
                    core_commands = yaml.safe_load(f) or []
                for cmd in core_commands:
                    if cmd.get('command') and cmd.get('description'):
                        commands.append(BotCommand(command=cmd['command'].lstrip('/'), description=cmd['description']))

            if not commands:
                console.print("[yellow]–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–º–∞–Ω–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏.[/]")
                logger.warning("–ù–µ—Ç –∫–æ–º–∞–Ω–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –º–µ–Ω—é Telegram")
                return

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
            bot = Bot(token=bot_token)
            await bot.set_my_commands(commands)
            await bot.session.close()

            # –í—ã–≤–æ–¥–∏–º —Ç–∞–±–ª–∏—Ü—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
            table = Table(title="[bold cyan]–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã[/]", show_header=True, header_style="bold magenta")
            table.add_column("–ö–æ–º–∞–Ω–¥–∞", style="cyan")
            table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ", style="green")
            for cmd in commands:
                table.add_row(f"/{cmd.command}", cmd.description)
            console.print(table)
            console.print(Panel("[bold green]–ö–æ–º–∞–Ω–¥—ã —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –º–µ–Ω—é Telegram![/]", expand=False, border_style="green"))
            logger.success(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {len(commands)} –∫–æ–º–∞–Ω–¥ –≤ –º–µ–Ω—é Telegram")
        except AttributeError as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}[/]")
            logger.error(f"–û—à–∏–±–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}")
            raise typer.Exit(code=1)
        except Exception as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–º–∞–Ω–¥: {e}[/]")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–º–∞–Ω–¥: {e}")
            raise typer.Exit(code=1)

    try:
        asyncio.run(_set_commands_async())
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/]")
        logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ set-commands: {e}")
        raise typer.Exit(code=1)

@bot_app.command(name="status", help="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞.")
def status():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ –±–æ—Ç."""
    async def _status_async():
        settings_obj, _, _ = await get_sdb_services_for_cli(init_db=False, init_rbac=False)
        if not settings_obj:
            console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞.[/]")
            logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã status")
            raise typer.Exit(code=1)

        try:
            bot_token = settings_obj.telegram.token
            if not bot_token:
                console.print("[bold red]–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.[/]")
                logger.error("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö")
                raise typer.Exit(code=1)

            bot = Bot(token=bot_token)
            bot_info = await bot.get_me()
            await bot.session.close()
            console.print(Panel(f"[bold green]–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω! ID: {bot_info.id}, –ò–º—è: @{bot_info.username}[/]", expand=False, border_style="green"))
            logger.success(f"–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω: @{bot_info.username}")
        except AttributeError as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}[/]")
            logger.error(f"–û—à–∏–±–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ CoreAppSettings: {e}")
            raise typer.Exit(code=1)
        except Exception as e:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞: {e}[/]")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞: {e}")
            raise typer.Exit(code=1)

    try:
        asyncio.run(_status_async())
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/]")
        logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ status: {e}")
        raise typer.Exit(code=1)

if __name__ == "__main__":
    bot_app()


======================================================================

------------------------------ FILE: cli_commands/system_cmd.py ------------------------------
# cli_commands/system_cmd.py

import typer
from rich.console import Console
from rich.panel import Panel
import shutil
import subprocess
from pathlib import Path
import sys
import tarfile
from datetime import datetime
import os
from typing import Optional, List

# –°–æ–∑–¥–∞–µ–º —Å–≤–æ—é –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
console = Console()

# Typer-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–∞–Ω–¥ –≥—Ä—É–ø–ø—ã 'system'
system_app = typer.Typer(
    name="system", 
    help="üõ†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã SDB (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è–¥—Ä–∞, –æ—Ç–∫–∞—Ç, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ).",
    rich_markup_mode="rich"
    # no_args_is_help=True  # <-- –£–ë–ò–†–ê–ï–ú –≠–¢–û–¢ –ü–ê–†–ê–ú–ï–¢–†
)

# --- –ù–û–í–´–ô –ë–õ–û–ö ---
# –î–æ–±–∞–≤–ª—è–µ–º callback –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–∑–æ–≤–∞ `sdb system` –±–µ–∑ –ø–æ–¥–∫–æ–º–∞–Ω–¥
@system_app.callback(invoke_without_command=True)
def system_main(ctx: typer.Context):
    """
    –í—ã–≤–æ–¥–∏—Ç —Å–ø—Ä–∞–≤–∫—É, –µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ `system` –≤—ã–∑–≤–∞–Ω–∞ –±–µ–∑ –ø–æ–¥–∫–æ–º–∞–Ω–¥.
    """
    if ctx.invoked_subcommand is None:
        console.print(ctx.get_help())
        raise typer.Exit()
# --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---


# --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π ---
# –ü—É—Ç–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —á–µ—Ä–µ–∑ AppSettings –≤ –±—É–¥—É—â–µ–º
CORE_BACKUP_DIR_NAME_IN_PROJECT_DATA = "core_backups" # –ò–º—è –ø–∞–ø–∫–∏ –¥–ª—è –±—ç–∫–∞–ø–æ–≤ —è–¥—Ä–∞

# URL –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è SDB (–ø—Ä–∏–º–µ—Ä, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π)
SDB_OFFICIAL_REPO_URL = "https://github.com/soverxos/SwiftDevBot.git" 
# –ò–ª–∏ URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –±—É–¥—É—Ç –≤ ZIP/TAR.GZ


@system_app.command(name="info", help="–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º–µ SDB.")
def system_info_cmd():
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏ SDB, –ø—É—Ç—è—Ö –∏ –¥—Ä—É–≥–∏—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö."""
    console.print(Panel("[bold cyan]–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è SwiftDevBot[/]", expand=False, border_style="cyan"))
    try:
        from core.app_settings import settings, PROJECT_ROOT_DIR
        from aiogram import __version__ as aiogram_version
        import platform

        console.print(f"[bold]–í–µ—Ä—Å–∏—è SwiftDevBot (SDB Core):[/bold] {settings.core.sdb_version}")
        console.print(f"[bold]–ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ SDB:[/bold] {PROJECT_ROOT_DIR}")
        console.print(f"[bold]–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞:[/bold] {settings.core.project_data_path}")
        console.print(f"[bold]–í–µ—Ä—Å–∏—è Aiogram:[/bold] {aiogram_version}")
        console.print(f"[bold]–í–µ—Ä—Å–∏—è Python:[/bold] {sys.version.split()[0]}")
        console.print(f"[bold]–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:[/bold] {platform.system()} {platform.release()} ({platform.machine()})")
        
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ë–î (–ø–æ—Å–ª–µ–¥–Ω—è—è –º–∏–≥—Ä–∞—Ü–∏—è), –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö –∏ —Ç.–¥.
        # –≠—Ç–æ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ DBManager –∏ ModuleLoader.
        
    except ImportError:
        console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å 'core.app_settings'.[/]")
    except Exception as e:
        console.print(f"[bold red]–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {e}[/]")


@system_app.command(name="core-update", help="–û–±–Ω–æ–≤–∏—Ç—å —è–¥—Ä–æ SDB –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∏–ª–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏.")
def core_update_cmd(
    version: Optional[str] = typer.Option(
        None, "--version", "-v", 
        help="–£–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é/—Ç–µ–≥/–≤–µ—Ç–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, '1.2.0', 'latest', 'dev'). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è."
    ),
    source_repo: str = typer.Option(
        SDB_OFFICIAL_REPO_URL, "--source", "-s",
        help="URL Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–¥—Ä–∞ SDB."
    ),
    yes_to_all: bool = typer.Option(False, "--yes", "-y", help="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–≤–µ—á–∞—Ç—å '–¥–∞' –Ω–∞ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–û–ü–ê–°–ù–û).")
):
    """
    [bold yellow]–≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢–ê–õ–¨–ù–ê–Ø –ö–û–ú–ê–ù–î–ê![/bold yellow]
    –ü—ã—Ç–∞–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã —è–¥—Ä–∞ SwiftDevBot –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞.
    –≠—Ç–æ —Å–ª–æ–∂–Ω–∞—è –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è.

    –®–∞–≥–∏ (–ø–ª–∞–Ω):
    1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ Git –∏ –¥–æ—Å—Ç—É–ø –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é.
    2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é –∏ —Ü–µ–ª–µ–≤—É—é –≤–µ—Ä—Å–∏–∏.
    3. –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 'core/' –∏ –≤–∞–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
    4. –°–∫–∞—á–∞—Ç—å/—Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å/–ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–µ—Ç–∫—É –Ω–∞ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é.
    5. –ó–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª—ã –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 'core/'.
    6. –û–±–Ω–æ–≤–∏—Ç—å 'requirements.txt', –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é `pip install -r`.
    7. –°–æ–æ–±—â–∏—Ç—å –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (`sdb db upgrade head`).
    8. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ—Ç–∫–∞—Ç, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫.
    """
    console.print(Panel(f"[bold yellow]–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è–¥—Ä–∞ SwiftDevBot[/]", expand=False, border_style="yellow"))
    console.print("[bold red]–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è![/]")
    console.print("–ü–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –Ω–∞—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (`sdb backup create --name pre_core_update`).")

    if not yes_to_all:
        if not typer.confirm(f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —è–¥—Ä–æ SDB –∏–∑ '{source_repo}'?", abort=True):
            return
    
    # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–¥—Ä–∞.
    # –≠—Ç–æ –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.
    # - –†–∞–±–æ—Ç–∞ —Å Git (clone, fetch, checkout, diff)
    # - –ó–∞–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
    # - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
    # - –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î —è–¥—Ä–∞
    # - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Ç–∫–∞—Ç–∞

    console.print(f"[yellow]–ö–æ–º–∞–Ω–¥–∞ 'system core-update' (–≤–µ—Ä—Å–∏—è: {version if version else '–ø–æ—Å–ª–µ–¥–Ω—è—è'}, –∏—Å—Ç–æ—á–Ω–∏–∫: {source_repo}) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.[/]")
    console.print("[yellow]–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è–¥—Ä–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ.[/]")
    console.print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ —Ä—É—á–Ω–æ–º—É –∏–ª–∏ –±—É–¥—É—â–µ–º—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é.")
    
    # –ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ core
    try:
        from core.app_settings import settings, PROJECT_ROOT_DIR
        core_dir_path = PROJECT_ROOT_DIR / "core"
        if core_dir_path.is_dir():
            backup_base_dir = settings.core.project_data_path / CORE_BACKUP_DIR_NAME_IN_PROJECT_DATA
            backup_base_dir.mkdir(parents=True, exist_ok=True)
            
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            core_backup_name = f"core_backup_before_update_{timestamp}"
            core_backup_archive = backup_base_dir / f"{core_backup_name}.tar.gz"

            console.print(f"\n–°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 'core/' –≤ '{core_backup_archive}'...")
            with tarfile.open(core_backup_archive, "w:gz") as tar:
                tar.add(str(core_dir_path), arcname="core") # –°–æ—Ö—Ä–∞–Ω—è–µ–º 'core' –≤ –∫–æ—Ä–Ω–µ –∞—Ä—Ö–∏–≤–∞
            console.print(f"[green]–ë—ç–∫–∞–ø –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 'core/' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: {core_backup_archive}[/]")
            console.print(f"[dim]–î–ª—è –æ—Ç–∫–∞—Ç–∞ (–≤ —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º) –≤—ã –º–æ–∂–µ—Ç–µ –≤—Ä—É—á–Ω—É—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–ø–∫—É 'core' –∏–∑ —ç—Ç–æ–≥–æ –∞—Ä—Ö–∏–≤–∞.[/dim]")
        else:
            console.print(f"[yellow]–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è 'core' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ '{PROJECT_ROOT_DIR}'. –ë—ç–∫–∞–ø –Ω–µ —Å–æ–∑–¥–∞–Ω.[/]")
    except Exception as e_backup_core:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–∞–ø–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 'core': {e_backup_core}[/]")


@system_app.command(name="core-rollback", help="[–û–ü–ê–°–ù–û] –û—Ç–∫–∞—Ç–∏—Ç—å —è–¥—Ä–æ SDB –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –∏–∑ –±—ç–∫–∞–ø–∞.")
def core_rollback_cmd(
    backup_name: Optional[str] = typer.Option(
        None, "--from-backup", "-b", 
        help="–ò–º—è —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞ —è–¥—Ä–∞ (tar.gz) –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–∏–∑ –ø–∞–ø–∫–∏ core_backups). –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π."
    )
):
    """
    [bold red]–ö–†–ê–ô–ù–ï –û–ü–ê–°–ù–ê–Ø –ö–û–ú–ê–ù–î–ê![/bold red]
    –ü—ã—Ç–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é 'core/' –∏–∑ —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞.
    –ù–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î –∏–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    """
    console.print(Panel(f"[bold red]–û—Ç–∫–∞—Ç —è–¥—Ä–∞ SwiftDevBot[/]", expand=False, border_style="red"))
    console.print("[bold red]–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–∏–µ —Ñ–∞–π–ª—ã —è–¥—Ä–∞ SDB —Ñ–∞–π–ª–∞–º–∏ –∏–∑ –±—ç–∫–∞–ø–∞![/]")
    
    if not typer.confirm(f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–∫–∞—Ç–∏—Ç—å —è–¥—Ä–æ SDB?", abort=True):
        return

    # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –æ—Ç–∫–∞—Ç–∞:
    # 1. –ù–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞ (–ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π).
    # 2. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—É—Ç—å –∫ –±—ç–∫–∞–ø—É.
    # 3. –†–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å –∞—Ä—Ö–∏–≤ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é.
    # 4. –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é 'core/' —Ñ–∞–π–ª–∞–º–∏ –∏–∑ –±—ç–∫–∞–ø–∞ (—Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –±—ç–∫–∞–ø–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π).
    # 5. –°–æ–æ–±—â–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä—É—á–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –µ—Å–ª–∏ —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

    console.print(f"[yellow]–ö–æ–º–∞–Ω–¥–∞ 'system core-rollback' (–∏–∑ –±—ç–∫–∞–ø–∞: {backup_name if backup_name else '–ø–æ—Å–ª–µ–¥–Ω–∏–π'}) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.[/]")
    console.print("[yellow]–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç —è–¥—Ä–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.[/]")
    console.print("–î–ª—è —Ä—É—á–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞: –Ω–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–π .tar.gz –∞—Ä—Ö–∏–≤ –≤ 'project_data/core_backups/', "
                  "—Ä–∞—Å–ø–∞–∫—É–π—Ç–µ –µ–≥–æ –∏ –∑–∞–º–µ–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ 'core/' –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.")
    console.print("[bold yellow]–ù–µ –∑–∞–±—É–¥—å—Ç–µ —Ç–∞–∫–∂–µ –æ—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (`sdb db downgrade ...`) –∏ Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ![/bold yellow]")


======================================================================

------------------------------ FILE: cli_commands/cli_utils.py ------------------------------
# cli_commands/cli_utils.py

from typing import Optional, Any, Tuple
from pathlib import Path
import asyncio
import typer # –î–ª—è typer.confirm
from rich.console import Console # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –≤—ã–≤–æ–¥–∞, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è

# console_cli_utils = Console() # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω —Å–≤–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è —É—Ç–∏–ª–∏—Ç

async def get_sdb_services_for_cli(
    init_db: bool = False,
    init_rbac: bool = False,
) -> Tuple[Optional[Any], Optional[Any], Optional[Any]]: # (settings, db_manager, rbac_service)
    """
    –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ SDB,
    –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–Ω–æ–≥–∏—Ö CLI –∫–æ–º–∞–Ω–¥.
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç DBManager "–Ω–∞ –ª–µ—Ç—É" –∏, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, RBACService.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ (settings, db_manager, rbac_service).
    DBManager –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ await db_manager.dispose().
    """
    settings_instance: Optional[Any] = None
    db_manager_instance: Optional[Any] = None
    rbac_service_instance: Optional[Any] = None

    try:
        from core.app_settings import settings # –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        settings_instance = settings

        if init_db or init_rbac: # DBManager –Ω—É–∂–µ–Ω –¥–ª—è RBAC
            from core.database.manager import DBManager
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º app_settings=settings, —á—Ç–æ–±—ã DBManager –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä–æ–∏–ª –ø—É—Ç–∏ –∏ —Ç.–¥.
            db_m = DBManager(db_settings=settings.db, app_settings=settings)
            await db_m.initialize()
            db_manager_instance = db_m

            if init_rbac and db_manager_instance:
                from core.rbac.service import RBACService
                rbac_service_instance = RBACService(db_manager=db_manager_instance) # –ü–µ—Ä–µ–¥–∞–µ–º DBManager

        return settings_instance, db_manager_instance, rbac_service_instance

    except ImportError as e_imp:
        # –û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤ –≤—ã–∑—ã–≤–∞—é—â–µ–º –∫–æ–¥–µ, –∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º
        # Console().print(f"[bold red]–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –≤ get_sdb_services_for_cli: {e_imp}[/]")
        raise
    except Exception as e_init:
        # Console().print(f"[bold red]–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ get_sdb_services_for_cli: {e_init}[/]")
        if db_manager_instance: # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–∫—Ä—ã—Ç—å, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–æ–∑–¥–∞–ª–æ—Å—å –¥–æ –æ—à–∏–±–∫–∏
            await db_manager_instance.dispose()
        raise


def confirm_action(prompt_message: str, default_choice: bool = False, abort_on_false: bool = True) -> bool:
    """
    –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Typer.
    –ï—Å–ª–∏ abort_on_false=True –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç "–Ω–µ—Ç", –≤—ã–∑—ã–≤–∞–µ—Ç typer.Abort().
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª "–¥–∞".
    """
    confirmed = typer.confirm(prompt_message, default=default_choice, abort=abort_on_false)
    # –ï—Å–ª–∏ abort_on_false=True –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª "–Ω–µ—Ç", typer.confirm —É–∂–µ –≤—ã–∑–æ–≤–µ—Ç typer.Abort().
    # –ï—Å–ª–∏ abort_on_false=False –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª "–Ω–µ—Ç", –≤–µ—Ä–Ω–µ—Ç—Å—è False.
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª "–¥–∞", –≤–µ—Ä–Ω–µ—Ç—Å—è True.
    return confirmed


def format_size(size_bytes: int) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥ (KB, MB, GB)."""
    if size_bytes < 1024:
        return f"{size_bytes} B"
    elif size_bytes < 1024**2:
        return f"{size_bytes/1024:.2f} KB"
    elif size_bytes < 1024**3:
        return f"{size_bytes/(1024**2):.2f} MB"
    else:
        return f"{size_bytes/(1024**3):.2f} GB"


======================================================================

------------------------------ FILE: cli_commands/backup_cmd.py ------------------------------
# cli_commands/backup_cmd.py

import typer
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
import shutil
import subprocess
from pathlib import Path
import sys
from datetime import datetime
import tarfile
import os
from typing import Optional, List, Tuple as TypingTuple 
from urllib.parse import urlparse 

console = Console()
backup_app = typer.Typer(
    name="backup", 
    help="üíæ –°–æ–∑–¥–∞–Ω–∏–µ, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤ SwiftDevBot.", 
    rich_markup_mode="rich",
    no_args_is_help=True  # <--- –î–û–ë–ê–í–õ–ï–ù–û
)

DB_BACKUP_DIR_NAME = "database"
DATA_FILES_BACKUP_DIR_NAME = "project_data_files"
DATA_ARCHIVE_EXTENSION = ".tar.gz"
POSTGRES_BACKUP_FILENAME = "sdb_postgres_backup.dump" 
MYSQL_BACKUP_FILENAME = "sdb_mysql_backup.sql"       
USER_CONFIG_DIR_NAME_FOR_BACKUP_DEFAULT = "Config"

def _get_backup_base_dir() -> Optional[Path]:
    try:
        from core.app_settings import settings
        backup_dir = settings.core.project_data_path / "sdb_backups" 
        backup_dir.mkdir(parents=True, exist_ok=True)
        return backup_dir
    except ImportError:
        console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—É—Ç–∏ –∫ –±—ç–∫–∞–ø–∞–º.[/]")
        return None
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–¥–æ—Å—Ç—É–ø–µ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ç–∫–∞–ø–æ–≤: {e}[/]")
        return None

def _find_system_utility(name: str) -> Optional[str]:
    return shutil.which(name)

def _execute_system_command(command: List[str], env_vars: Optional[dict] = None, input_data: Optional[str] = None, show_stdout_on_success: bool = False) -> bool:
    full_env = os.environ.copy()
    if env_vars:
        full_env.update(env_vars)
    
    try:
        process = subprocess.run(
            command,
            capture_output=True,
            text=True,
            encoding='utf-8',
            env=full_env,
            input=input_data, 
            check=False 
        )
        if process.returncode == 0:
            if show_stdout_on_success and process.stdout:
                 console.print(f"[dim cyan]  --- STDOUT ---[/]\n{process.stdout.strip()}")
            return True
        else:
            console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã (–∫–æ–¥: {process.returncode}): {' '.join(command)}[/]")
            if process.stdout:
                console.print(f"[yellow]  --- STDOUT ---[/]\n{process.stdout.strip()}")
            if process.stderr:
                console.print(f"[red]  --- STDERR ---[/]\n{process.stderr.strip()}")
            return False
    except FileNotFoundError:
        console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞: –ö–æ–º–∞–Ω–¥–∞ '{command[0]}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Ç–∏–ª–∏—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ PATH.[/]")
        return False
    except Exception as e:
        console.print(f"[bold red]  ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã '{command[0]}': {e}[/]")
        return False

@backup_app.command(name="create", help="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö –∏/–∏–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SDB.")
def create_backup_cmd(
    name: Optional[str] = typer.Option( None, "--name", "-n", help="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∏–º—è –¥–ª—è —ç—Ç–æ–≥–æ –±—ç–∫–∞–ø–∞ (–∏–Ω–∞—á–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ –¥–∞—Ç–µ –∏ –≤—Ä–µ–º–µ–Ω–∏)."),
    include_db: bool = typer.Option(True, "--db/--no-db", help="–í–∫–ª—é—á–∏—Ç—å –ª–∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤ –±—ç–∫–∞–ø."),
    include_data_dirs: Optional[List[str]] = typer.Option( None, "--data-dir", "-dd", help=(f"–ö–∞–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏–∑ 'project_data/' –≤–∫–ª—é—á–∏—Ç—å –≤ –±—ç–∫–∞–ø (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ 'project_data/'). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: ['{USER_CONFIG_DIR_NAME_FOR_BACKUP_DEFAULT}'] (–ø–∞–ø–∫–∞ Config). –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ–ø—Ü–∏—é. –ü—Ä–∏–º–µ—Ä: -dd Config -dd ModulesData")),
    compress_data: bool = typer.Option(True, "--compress/--no-compress", help="–°–∂–∏–º–∞—Ç—å –ª–∏ –±—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö –≤ –∞—Ä—Ö–∏–≤ (.tar.gz).")
):
    from core.app_settings import settings 

    if include_data_dirs is None: 
        include_data_dirs = [USER_CONFIG_DIR_NAME_FOR_BACKUP_DEFAULT]

    backup_base_dir = _get_backup_base_dir()
    if not backup_base_dir: 
        raise typer.Exit(code=1)

    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    backup_name = name if name else f"sdb_backup_{timestamp}"
    
    current_backup_path = backup_base_dir / backup_name
    if current_backup_path.exists():
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è/—Ñ–∞–π–ª –±—ç–∫–∞–ø–∞ —Å –∏–º–µ–Ω–µ–º '{backup_name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.[/]")
        raise typer.Exit(code=1)
    
    try:
        current_backup_path.mkdir(parents=True)
    except Exception as e_mkdir:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –±—ç–∫–∞–ø–∞ '{current_backup_path}': {e_mkdir}[/]")
        raise typer.Exit(code=1)
        
    console.print(Panel(f"[bold cyan]–°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞: {backup_name}[/]", expand=False, border_style="cyan", subtitle=f"–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: {current_backup_path}"))

    db_backup_successful = False
    data_backup_successful = False

    if include_db:
        console.print("\n[bold blue]1. –ë—ç–∫–∞–ø –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö[/]")
        db_settings = settings.db
        db_backup_target_dir = current_backup_path / DB_BACKUP_DIR_NAME
        db_backup_target_dir.mkdir()

        if db_settings.type == "sqlite":
            sqlite_file_path = Path(db_settings.sqlite_path) 
            if sqlite_file_path.exists() and sqlite_file_path.is_file():
                try:
                    backup_db_file = db_backup_target_dir / sqlite_file_path.name
                    shutil.copy2(sqlite_file_path, backup_db_file)
                    console.print(f"[green]  ‚úÖ –ë—ç–∫–∞–ø SQLite –ë–î —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: '{backup_db_file}'[/]")
                    db_backup_successful = True
                except Exception as e_sqlite:
                    console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞ SQLite –ë–î: {e_sqlite}[/]")
            else:
                console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª SQLite –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏ '{sqlite_file_path}'[/]")
        
        elif db_settings.type == "postgresql":
            pg_dump_path = _find_system_utility("pg_dump")
            if not pg_dump_path: console.print("[bold red]  ‚ùå –£—Ç–∏–ª–∏—Ç–∞ 'pg_dump' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ë—ç–∫–∞–ø PostgreSQL –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.[/]")
            elif not db_settings.pg_dsn: console.print("[bold red]  ‚ùå DSN –¥–ª—è PostgreSQL (pg_dsn) –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ë—ç–∫–∞–ø –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.[/]")
            else:
                parsed_url = urlparse(str(db_settings.pg_dsn))
                pg_host = parsed_url.hostname if parsed_url.hostname else "localhost"
                pg_port = str(parsed_url.port) if parsed_url.port is not None else "5432"
                pg_user = parsed_url.username if parsed_url.username else ""
                pg_password = parsed_url.password if parsed_url.password else ""
                pg_database = parsed_url.path.lstrip('/') if parsed_url.path else ""
                backup_file = db_backup_target_dir / POSTGRES_BACKUP_FILENAME
                cmd = [ pg_dump_path ]
                if pg_host: cmd.extend(["-h", pg_host])
                if pg_port: cmd.extend(["-p", pg_port])
                if pg_user: cmd.extend(["-U", pg_user])
                if not pg_database: console.print("[bold red]  ‚ùå –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DSN PostgreSQL. –ë—ç–∫–∞–ø –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.[/]")
                else:
                    cmd.extend(["-d", pg_database, "-F", "c", "-f", str(backup_file)])
                    env = {}
                    if pg_password: env["PGPASSWORD"] = pg_password
                    console.print(f"  –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ pg_dump –¥–ª—è PostgreSQL –≤ '{backup_file}'...")
                    if _execute_system_command(cmd, env_vars=env):
                        console.print(f"[green]  ‚úÖ –ë—ç–∫–∞–ø PostgreSQL —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: '{backup_file}'[/]")
                        db_backup_successful = True
                    else: console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–∞–ø–∞ PostgreSQL.[/]")
        
        elif db_settings.type == "mysql":
            mysqldump_path = _find_system_utility("mysqldump")
            if not mysqldump_path: console.print("[bold red]  ‚ùå –£—Ç–∏–ª–∏—Ç–∞ 'mysqldump' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ë—ç–∫–∞–ø MySQL –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.[/]")
            elif not db_settings.mysql_dsn: console.print("[bold red]  ‚ùå DSN –¥–ª—è MySQL (mysql_dsn) –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ë—ç–∫–∞–ø –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.[/]")
            else:
                parsed_url = urlparse(str(db_settings.mysql_dsn))
                mysql_host = parsed_url.hostname if parsed_url.hostname else "localhost"
                mysql_port = str(parsed_url.port) if parsed_url.port is not None else "3306"
                mysql_user = parsed_url.username if parsed_url.username else ""
                mysql_password = parsed_url.password if parsed_url.password else ""
                mysql_database = parsed_url.path.lstrip('/') if parsed_url.path else ""
                backup_file = db_backup_target_dir / MYSQL_BACKUP_FILENAME
                cmd = [ mysqldump_path ]
                if mysql_host: cmd.extend(["-h", mysql_host])
                if mysql_port: cmd.extend(["-P", mysql_port])
                if mysql_user: cmd.extend(["-u", mysql_user])
                cmd.append("--column-statistics=0") 
                if not mysql_database: console.print("[bold red]  ‚ùå –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DSN MySQL. –ë—ç–∫–∞–ø –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.[/]")
                else:
                    cmd.extend(["--databases", mysql_database]) # –≠—Ç–∞ –æ–ø—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç CREATE DATABASE IF NOT EXISTS
                    cmd.append(f"--result-file={backup_file}")
                    env = {}
                    if mysql_password: env["MYSQL_PWD"] = mysql_password
                    console.print(f"  –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ mysqldump –¥–ª—è MySQL –≤ '{backup_file}'...")
                    if _execute_system_command(cmd, env_vars=env):
                        console.print(f"[green]  ‚úÖ –ë—ç–∫–∞–ø MySQL —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: '{backup_file}'[/]")
                        db_backup_successful = True
                    else: console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–∞–ø–∞ MySQL.[/]")
        else: console.print(f"[bold red]  ‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –ë–î –¥–ª—è –±—ç–∫–∞–ø–∞: {db_settings.type}[/]")
    else: console.print("\n[dim blue]1. –ë—ç–∫–∞–ø –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö –ø—Ä–æ–ø—É—â–µ–Ω (—Å–æ–≥–ª–∞—Å–Ω–æ –æ–ø—Ü–∏–∏).[/dim]")

    if include_data_dirs: 
        console.print(f"\n[bold blue]2. –ë—ç–∫–∞–ø –î–∞–Ω–Ω—ã—Ö –ü—Ä–æ–µ–∫—Ç–∞ (–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {', '.join(include_data_dirs)})[/]")
        project_data_root_path = settings.core.project_data_path
        data_to_archive_paths: List[TypingTuple[Path, str]] = []
        for dir_name_rel in include_data_dirs:
            source_dir_abs = (project_data_root_path / dir_name_rel).resolve()
            if source_dir_abs.exists() and source_dir_abs.is_dir(): data_to_archive_paths.append((source_dir_abs, dir_name_rel))
            else: console.print(f"[yellow]  ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö '{source_dir_abs}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π. –ü—Ä–æ–ø—É—â–µ–Ω–∞.[/]")
        if data_to_archive_paths:
            data_backup_target_dir = current_backup_path / DATA_FILES_BACKUP_DIR_NAME
            data_backup_target_dir.mkdir(exist_ok=True)
            archive_filename_stem = f"project_data_backup_{timestamp}"
            archive_file_path = data_backup_target_dir / (archive_filename_stem + (DATA_ARCHIVE_EXTENSION if compress_data else ".tar"))
            try:
                mode = "w:gz" if compress_data else "w"
                with tarfile.open(archive_file_path, mode) as tar:
                    for source_path, arcname_prefix in data_to_archive_paths:
                        tar.add(str(source_path), arcname=arcname_prefix) 
                        console.print(f"[green]    –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è '{source_path.relative_to(project_data_root_path.parent)}' –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤.[/]")
                console.print(f"[green]  ‚úÖ –ë—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: '{archive_file_path}'[/]")
                data_backup_successful = True
            except Exception as e_tar: console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞: {e_tar}[/]")
        elif not include_data_dirs: console.print("[yellow]  –ù–µ —É–∫–∞–∑–∞–Ω—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –±—ç–∫–∞–ø–∞ –¥–∞–Ω–Ω—ã—Ö.[/]")
        else: console.print("[yellow]  –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—ç–∫–∞–ø–∞ (–≤—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã).[/]")
    else: console.print("\n[dim blue]2. –ë—ç–∫–∞–ø –î–∞–Ω–Ω—ã—Ö –ü—Ä–æ–µ–∫—Ç–∞ –ø—Ä–æ–ø—É—â–µ–Ω (–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã).[/dim]")
    
    console.print("\n[bold underline]–ò—Ç–æ–≥–∏ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞:[/]")
    if include_db:
        if db_backup_successful: console.print("[bold green]  –ë–î: –£–°–ü–ï–®–ù–û[/]")
        else: console.print("[bold red]  –ë–î: –û–®–ò–ë–ö–ê[/]")
    if include_data_dirs: 
        if data_backup_successful: console.print("[bold green]  –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞: –£–°–ü–ï–®–ù–û[/]")
        elif data_to_archive_paths: console.print("[bold red]  –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞: –û–®–ò–ë–ö–ê[/]") 
    if not (include_db or (include_data_dirs and data_to_archive_paths)):
        console.print("[yellow]  –ù–µ –±—ã–ª–æ –≤—ã–±—Ä–∞–Ω–æ –∏–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è –±—ç–∫–∞–ø–∞.[/]")
        try:
            if current_backup_path.is_dir(): shutil.rmtree(current_backup_path)
            console.print(f"[dim]–ü—É—Å—Ç–∞—è/–Ω–µ–ø–æ–ª–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±—ç–∫–∞–ø–∞ '{current_backup_path}' —É–¥–∞–ª–µ–Ω–∞.[/dim]")
        except Exception as e_rm: console.print(f"[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—É—Å—Ç—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±—ç–∫–∞–ø–∞: {e_rm}[/yellow]")
    elif not db_backup_successful and include_db or (include_data_dirs and data_to_archive_paths and not data_backup_successful):
        console.print("[bold red]–°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–∞–º–∏ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.[/]")
    else: console.print(f"\n[bold green]üéâ –ë—ç–∫–∞–ø '{backup_name}' —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω.[/]")

@backup_app.command(name="list", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤ SDB.")
def list_backups_cmd():
    backup_base_dir = _get_backup_base_dir()
    if not backup_base_dir: return typer.Exit(code=1)
    backups = [d for d in backup_base_dir.iterdir() if d.is_dir()] 
    if not backups:
        console.print(f"[yellow]–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ '{backup_base_dir}'.[/]")
        return
    table = Table(title="[bold cyan]–î–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã SwiftDevBot[/]", show_header=True, header_style="bold magenta")
    table.add_column("–ò–º—è –ë—ç–∫–∞–ø–∞", style="cyan", min_width=25)
    table.add_column("–î–∞—Ç–∞ –°–æ–∑–¥–∞–Ω–∏—è (–∏–∑ –∏–º–µ–Ω–∏)", min_width=20)
    table.add_column("–°–æ–¥–µ—Ä–∂–∏—Ç –ë–î?", justify="center")
    table.add_column("–°–æ–¥–µ—Ä–∂–∏—Ç –î–∞–Ω–Ω—ã–µ?", justify="center")
    table.add_column("–†–∞–∑–º–µ—Ä (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)", justify="right")
    for backup_dir_path in sorted(backups, key=lambda p: p.name, reverse=True):
        backup_name = backup_dir_path.name
        date_from_name = "N/A"
        if backup_name.startswith("sdb_backup_") and len(backup_name.split("_")[-1]) == 15: 
            try:
                ts_str = backup_name.split("_")[-1]
                dt_obj = datetime.strptime(ts_str, '%Y%m%d_%H%M%S')
                date_from_name = dt_obj.strftime('%Y-%m-%d %H:%M:%S')
            except ValueError: pass
        has_db_backup_dir = (backup_dir_path / DB_BACKUP_DIR_NAME).is_dir()
        db_files_exist = any((backup_dir_path / DB_BACKUP_DIR_NAME).iterdir()) if has_db_backup_dir else False
        has_data_backup_dir = (backup_dir_path / DATA_FILES_BACKUP_DIR_NAME).is_dir()
        data_files_exist = any((backup_dir_path / DATA_FILES_BACKUP_DIR_NAME).iterdir()) if has_data_backup_dir else False
        total_size = 0
        try:
            for f_item in backup_dir_path.rglob('*'):
                if f_item.is_file(): total_size += f_item.stat().st_size
            size_str = f"{total_size / (1024*1024):.2f} MB" if total_size > (1024*512) else f"{total_size / 1024:.1f} KB"
        except Exception: size_str = "N/A"
        table.add_row(backup_name, date_from_name, "‚úÖ" if db_files_exist else "‚ùå" if has_db_backup_dir else "-", "‚úÖ" if data_files_exist else "‚ùå" if has_data_backup_dir else "-", size_str)
    console.print(table)

@backup_app.command(name="restore", help="[–û–ü–ê–°–ù–û!] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É SDB –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞.")
def restore_backup_cmd(
    backup_name: str = typer.Argument(..., help="–ò–º—è –±—ç–∫–∞–ø–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–∏–∑ –∫–æ–º–∞–Ω–¥—ã 'sdb backup list')."),
    restore_db: bool = typer.Option(True, "--db/--no-db", help="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±—ç–∫–∞–ø–∞."),
    restore_data_dirs: bool = typer.Option(True, "--data/--no-data", help="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ –±—ç–∫–∞–ø–∞.")
):
    from core.app_settings import settings 

    console.print(Panel(f"[bold red]–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ò–ó –ë–≠–ö–ê–ü–ê: {backup_name}[/]", expand=False, border_style="red"))
    console.print("[bold red]–í–ù–ò–ú–ê–ù–ò–ï: –≠–¢–ê –û–ü–ï–†–ê–¶–ò–Ø –ü–ï–†–ï–ó–ê–ü–ò–®–ï–¢ –¢–ï–ö–£–©–£–Æ –ë–ê–ó–£ –î–ê–ù–ù–´–• –ò/–ò–õ–ò –î–ê–ù–ù–´–ï –ü–†–û–ï–ö–¢–ê![/]")
    console.print("[bold yellow]–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Telegram-–±–æ—Ç SDB –û–°–¢–ê–ù–û–í–õ–ï–ù –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.[/]")
    
    if not (restore_db or restore_data_dirs):
        console.print("[yellow]–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–Ω–∏ –ë–î, –Ω–∏ –¥–∞–Ω–Ω—ã–µ). –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.[/yellow]")
        raise typer.Exit()

    base_backup_dir = _get_backup_base_dir()
    if not base_backup_dir: raise typer.Exit(code=1)
    
    target_backup_path = base_backup_dir / backup_name
    if not target_backup_path.is_dir():
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±—ç–∫–∞–ø–∞ '{target_backup_path}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.[/]")
        raise typer.Exit(code=1)

    if not typer.confirm(f"–í—ã –ê–ë–°–û–õ–Æ–¢–ù–û —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –∏–∑ –±—ç–∫–∞–ø–∞ '{backup_name}'?", abort=True):
        return 
    if not typer.confirm(f"–ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ?", default=False, abort=True):
        return

    db_restore_successful = False
    data_restore_successful = False
    timestamp_for_files = datetime.now().strftime('%Y%m%d%H%M%S')

    if restore_db:
        console.print("\n[bold blue]1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö[/]")
        db_settings = settings.db
        backup_db_content_path = target_backup_path / DB_BACKUP_DIR_NAME
        
        if not backup_db_content_path.is_dir() or not any(backup_db_content_path.iterdir()):
            console.print(f"[yellow]  –ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã –±—ç–∫–∞–ø–∞ –ë–î –≤ '{backup_db_content_path}'. –ü—Ä–æ–ø—É—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î.[/yellow]")
        else:
            if db_settings.type == "sqlite":
                sqlite_backup_files = list(backup_db_content_path.glob("*.db")) or \
                                      list(backup_db_content_path.glob("*.sqlite")) or \
                                      list(backup_db_content_path.glob("*.sqlite3"))
                if sqlite_backup_files:
                    source_db_file_in_backup = sqlite_backup_files[0]
                    target_current_db_file = Path(db_settings.sqlite_path)
                    console.print(f"  –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é SQLite –∏–∑ '{source_db_file_in_backup}' –≤ '{target_current_db_file}'...")
                    if target_current_db_file.exists():
                        current_db_backup_path = target_current_db_file.with_suffix(f"{target_current_db_file.suffix}.before_restore_{timestamp_for_files}")
                        try:
                            shutil.copy2(target_current_db_file, current_db_backup_path)
                            console.print(f"[dim]    –¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª –ë–î —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: '{current_db_backup_path}'[/dim]")
                        except Exception as e_backup_current: console.print(f"[yellow]    –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞ –ë–î: {e_backup_current}[/yellow]")
                    try:
                        shutil.copy2(source_db_file_in_backup, target_current_db_file)
                        console.print(f"[green]  ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –±—ç–∫–∞–ø–∞.[/]")
                        db_restore_successful = True
                    except Exception as e_restore_sqlite: console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ SQLite: {e_restore_sqlite}[/]")
                else: console.print(f"[yellow]  –ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞ SQLite (.db, .sqlite, .sqlite3) –≤ '{backup_db_content_path}'.[/yellow]")

            elif db_settings.type == "postgresql":
                pg_restore_path = _find_system_utility("pg_restore")
                backup_file_in_archive = backup_db_content_path / POSTGRES_BACKUP_FILENAME
                if not pg_restore_path: console.print("[bold red]  ‚ùå –£—Ç–∏–ª–∏—Ç–∞ 'pg_restore' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ PostgreSQL –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.[/]")
                elif not db_settings.pg_dsn: console.print("[bold red]  ‚ùå DSN –¥–ª—è PostgreSQL (pg_dsn) –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.[/]")
                elif not backup_file_in_archive.is_file(): console.print(f"[bold red]  ‚ùå –§–∞–π–ª –±—ç–∫–∞–ø–∞ '{POSTGRES_BACKUP_FILENAME}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ '{backup_db_content_path}'.[/]")
                else:
                    parsed_url = urlparse(str(db_settings.pg_dsn))
                    pg_host = parsed_url.hostname if parsed_url.hostname else "localhost"
                    pg_port = str(parsed_url.port) if parsed_url.port is not None else "5432"
                    pg_user = parsed_url.username if parsed_url.username else ""
                    pg_password = parsed_url.password if parsed_url.password else ""
                    pg_database = parsed_url.path.lstrip('/') if parsed_url.path else ""
                    cmd = [ pg_restore_path ]
                    if pg_host: cmd.extend(["-h", pg_host])
                    if pg_port: cmd.extend(["-p", pg_port])
                    if pg_user: cmd.extend(["-U", pg_user])
                    if not pg_database: console.print("[bold red]  ‚ùå –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DSN PostgreSQL. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.[/]")
                    else:
                        cmd.extend(["-d", pg_database, "--clean", "--if-exists", str(backup_file_in_archive)])
                        env = {}
                        if pg_password: env["PGPASSWORD"] = pg_password
                        console.print(f"  –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ pg_restore –¥–ª—è PostgreSQL –∏–∑ '{backup_file_in_archive}' –≤ –ë–î '{pg_database}'...")
                        if _execute_system_command(cmd, env_vars=env, show_stdout_on_success=True):
                            console.print(f"[green]  ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.[/]")
                            db_restore_successful = True
                        else: console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ PostgreSQL.[/]")
            
            elif db_settings.type == "mysql":
                mysql_path = _find_system_utility("mysql")
                backup_file_in_archive = backup_db_content_path / MYSQL_BACKUP_FILENAME
                if not mysql_path: console.print("[bold red]  ‚ùå –£—Ç–∏–ª–∏—Ç–∞ 'mysql' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ MySQL –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.[/]")
                elif not db_settings.mysql_dsn: console.print("[bold red]  ‚ùå DSN –¥–ª—è MySQL (mysql_dsn) –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.[/]")
                elif not backup_file_in_archive.is_file(): console.print(f"[bold red]  ‚ùå –§–∞–π–ª –±—ç–∫–∞–ø–∞ '{MYSQL_BACKUP_FILENAME}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ '{backup_db_content_path}'.[/]")
                else:
                    parsed_url = urlparse(str(db_settings.mysql_dsn))
                    mysql_host = parsed_url.hostname if parsed_url.hostname else "localhost"
                    mysql_port = str(parsed_url.port) if parsed_url.port is not None else "3306"
                    mysql_user = parsed_url.username if parsed_url.username else ""
                    mysql_password = parsed_url.password if parsed_url.password else ""
                    mysql_database = parsed_url.path.lstrip('/') if parsed_url.path else ""
                    cmd = [ mysql_path ]
                    if mysql_host: cmd.extend(["-h", mysql_host])
                    if mysql_port: cmd.extend(["-P", mysql_port])
                    if mysql_user: cmd.extend(["-u", mysql_user])
                    if not mysql_database: console.print("[bold red]  ‚ùå –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DSN MySQL. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.[/]")
                    else:
                        cmd.append(mysql_database) 
                        env = {}
                        if mysql_password: env["MYSQL_PWD"] = mysql_password
                        try:
                            sql_dump_content = backup_file_in_archive.read_text(encoding='utf-8')
                            console.print(f"  –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è MySQL –∏–∑ '{backup_file_in_archive}' –≤ –ë–î '{mysql_database}'...")
                            if _execute_system_command(cmd, env_vars=env, input_data=sql_dump_content, show_stdout_on_success=True):
                                console.print(f"[green]  ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö MySQL —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.[/]")
                                db_restore_successful = True
                            else: console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ MySQL.[/]")
                        except Exception as e_read_sql: console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è SQL-–¥–∞–º–ø–∞ '{backup_file_in_archive}': {e_read_sql}[/]")
            else:
                console.print(f"[bold red]  ‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –ë–î –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: {db_settings.type}[/]")
    else:
        console.print("\n[dim blue]1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö –ø—Ä–æ–ø—É—â–µ–Ω–æ.[/dim]")

    if restore_data_dirs:
        console.print(f"\n[bold blue]2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –î–∞–Ω–Ω—ã—Ö –ü—Ä–æ–µ–∫—Ç–∞[/]")
        backup_data_archive_dir = target_backup_path / DATA_FILES_BACKUP_DIR_NAME
        target_project_data_dir = settings.core.project_data_path
        if not backup_data_archive_dir.is_dir() or not any(backup_data_archive_dir.iterdir()):
            console.print(f"[yellow]  –ù–µ –Ω–∞–π–¥–µ–Ω—ã –∞—Ä—Ö–∏–≤—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤ '{backup_data_archive_dir}'. –ü—Ä–æ–ø—É—Å–∫.[/yellow]")
        else:
            data_archives = list(backup_data_archive_dir.glob(f"*{DATA_ARCHIVE_EXTENSION}")) or list(backup_data_archive_dir.glob("*.tar"))
            if data_archives:
                source_data_archive = data_archives[0] 
                console.print(f"  –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞ –¥–∞–Ω–Ω—ã—Ö '{source_data_archive}' –≤ '{target_project_data_dir}'...")
                try:
                    temp_extract_path = target_project_data_dir.parent / f"__{target_project_data_dir.name}_restore_temp_{timestamp_for_files}"
                    temp_extract_path.mkdir(parents=True, exist_ok=True)
                    with tarfile.open(source_data_archive, "r:*") as tar: tar.extractall(path=str(temp_extract_path))
                    console.print(f"[dim]    –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–æ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É: {temp_extract_path}[/dim]")
                    console.print(f"[dim]    –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ/–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ü–µ–ª–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: {target_project_data_dir} ...[/dim]")
                    for item_in_temp in temp_extract_path.iterdir():
                        target_item_path = target_project_data_dir / item_in_temp.name
                        if item_in_temp.is_dir():
                            if target_item_path.exists(): shutil.rmtree(target_item_path)
                            shutil.move(str(item_in_temp), str(target_item_path))
                        elif item_in_temp.is_file(): shutil.move(str(item_in_temp), str(target_item_path)) 
                    shutil.rmtree(temp_extract_path) 
                    console.print(f"[green]  ‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ –∞—Ä—Ö–∏–≤–∞.[/]")
                    data_restore_successful = True
                except tarfile.ReadError as e_tar_read: console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–∞ –¥–∞–Ω–Ω—ã—Ö '{source_data_archive}': {e_tar_read}[/]")
                except Exception as e_restore_data:
                    console.print(f"[bold red]  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞: {e_restore_data}[/]")
                    if 'temp_extract_path' in locals() and temp_extract_path.exists():
                         try: shutil.rmtree(temp_extract_path)
                         except Exception: pass
            else: console.print(f"[yellow]  –ù–µ –Ω–∞–π–¥–µ–Ω –∞—Ä—Ö–∏–≤ –¥–∞–Ω–Ω—ã—Ö (.tar.gz –∏–ª–∏ .tar) –≤ '{backup_data_archive_dir}'.[/yellow]")
    else: console.print("\n[dim blue]2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –î–∞–Ω–Ω—ã—Ö –ü—Ä–æ–µ–∫—Ç–∞ –ø—Ä–æ–ø—É—â–µ–Ω–æ.[/dim]")

    console.print("\n[bold underline]–ò—Ç–æ–≥–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:[/]")
    if restore_db:
        if db_restore_successful: console.print("[bold green]  –ë–î: –£–°–ü–ï–®–ù–û[/]")
        else: console.print("[bold red]  –ë–î: –û–®–ò–ë–ö–ê –∏–ª–∏ –ù–ï –í–´–ü–û–õ–ù–ï–ù–û[/]")
    if restore_data_dirs:
        if data_restore_successful: console.print("[bold green]  –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞: –£–°–ü–ï–®–ù–û[/]")
        else: console.print("[bold red]  –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞: –û–®–ò–ë–ö–ê –∏–ª–∏ –ù–ï –í–´–ü–û–õ–ù–ï–ù–û[/]")
    if not db_restore_successful and restore_db or (not data_restore_successful and restore_data_dirs):
        console.print("[bold red]–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–∞–º–∏ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.[/]")
    elif not restore_db and not restore_data_dirs: pass 
    else:
        console.print(f"\n[bold green]üéâ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞ '{backup_name}' —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.[/]")
        console.print("[yellow]–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏, –≤–æ–∑–º–æ–∂–Ω–æ, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞–ø—É—â–µ–Ω –≤–æ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.[/yellow]")
        console.print("[yellow]–ï—Å–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∞—Å—å –ë–î, –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è `alembic stamp head` –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π.[/yellow]")


======================================================================

------------------------------ FILE: cli_commands/control_cmd.py ------------------------------
# cli_commands/control_cmd.py

import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table
from rich.columns import Columns 
from rich.text import Text
import os
import signal
import time
import subprocess
from pathlib import Path
import sys
import asyncio
from typing import Optional, List, Tuple as TypingTuple, Any 

try:
    import psutil
except ImportError:
    psutil = None

from datetime import datetime, timedelta

from .cli_utils import get_sdb_services_for_cli

console = Console()
PID_FILENAME = "sdb_bot.pid"
control_app = typer.Typer(
    name="control", 
    help="üö¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º Telegram-–±–æ—Ç–∞ SDB.", 
    rich_markup_mode="rich",
    no_args_is_help=True  # <--- –î–û–ë–ê–í–õ–ï–ù–û
)

def _get_pid_file_path() -> Path:
    from core.app_settings import settings
    project_data_dir = Path(settings.core.project_data_path)
    return project_data_dir / PID_FILENAME

def _read_pid_from_file(pid_file: Path) -> Optional[int]:
    if not pid_file.is_file(): return None
    try:
        with open(pid_file, "r") as f: pid_str = f.read().strip()
        if not pid_str.isdigit():
            sys.stderr.write(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: PID-—Ñ–∞–π–ª {pid_file} —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: '{pid_str}'.\n")
            return None
        return int(pid_str)
    except Exception as e:
        sys.stderr.write(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è PID –∏–∑ —Ñ–∞–π–ª–∞ {pid_file}: {e}\n")
        return None

def _is_process_running(pid: int) -> bool:
    if psutil:
        try: return psutil.pid_exists(pid)
        except Exception: pass
            
    if sys.platform != "win32":
        try:
            os.kill(pid, 0)
            return True
        except OSError: 
            return False
    else: 
        try:
            result = subprocess.run(
                ['tasklist', '/FI', f'PID eq {pid}'], 
                capture_output=True, text=True, check=False, 
                creationflags=getattr(subprocess, 'CREATE_NO_WINDOW', 0)
            )
            return str(pid) in result.stdout
        except FileNotFoundError:
            return False 
        except Exception:
            return False

async def _get_total_users_count_cli() -> Optional[int]:
    settings_obj, db_m, _ = None, None, None
    try:
        settings_obj, db_m, _ = await get_sdb_services_for_cli(init_db=True)
        if not db_m:
            return None
        
        from core.database.core_models import User
        from sqlalchemy import select, func as sql_func

        async with db_m.get_session() as session:
            count_stmt = select(sql_func.count(User.id))
            total_users_result = await session.execute(count_stmt)
            return total_users_result.scalar_one_or_none() or 0
    except Exception: 
        return None
    finally:
        if db_m:
            await db_m.dispose()

@control_app.command()
def status():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ SDB –±–æ—Ç–µ."""
    from core.app_settings import settings 
    from aiogram import __version__ as aiogram_version

    pid_file = _get_pid_file_path()
    pid = _read_pid_from_file(pid_file)

    status_text_elements: List[Text] = [] 
    process_info_data: Optional[List[TypingTuple[str, str]]] = None 

    is_running_flag = False
    if pid and _is_process_running(pid):
        is_running_flag = True
        status_text_elements.append(Text.assemble(("‚óè SDB –±–æ—Ç –∑–∞–ø—É—â–µ–Ω ", "green"), (f"(PID: {pid})", "green bold")))
        if psutil:
            try:
                p = psutil.Process(pid)
                process_info_data = [] 
                with p.oneshot(): 
                    create_time = datetime.fromtimestamp(p.create_time())
                    uptime_delta = datetime.now() - create_time
                    days, remainder = divmod(uptime_delta.total_seconds(), 86400)
                    hours, remainder = divmod(remainder, 3600)
                    minutes, seconds = divmod(remainder, 60)
                    uptime_str_parts = []
                    if days > 0: uptime_str_parts.append(f"{int(days)}–¥")
                    if hours > 0: uptime_str_parts.append(f"{int(hours)}—á")
                    if minutes > 0: uptime_str_parts.append(f"{int(minutes)}–º")
                    uptime_str_parts.append(f"{int(seconds)}—Å")
                    
                    process_info_data.append(("–ó–∞–ø—É—â–µ–Ω:", create_time.strftime("%Y-%m-%d %H:%M:%S")))
                    process_info_data.append(("–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:", " ".join(uptime_str_parts) or "0—Å"))
                    process_info_data.append(("CPU –Ω–∞–≥—Ä—É–∑–∫–∞:", f"{p.cpu_percent(interval=0.1):.1f}%"))
                    rss_mb = p.memory_info().rss / (1024 * 1024)
                    process_info_data.append(("–ü–∞–º—è—Ç—å (RSS):", f"{rss_mb:.2f} MB"))
                    try: process_info_data.append(("–ö–æ–ª-–≤–æ –ø–æ—Ç–æ–∫–æ–≤:", str(p.num_threads())))
                    except (psutil.Error, AttributeError, NotImplementedError): pass
                    process_info_data.append(("–°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞:", str(p.status())))
                    try: process_info_data.append(("–ó–∞–ø—É—â–µ–Ω –æ—Ç:", str(p.username())))
                    except (psutil.Error, AttributeError, NotImplementedError): pass
            except psutil.NoSuchProcess:
                is_running_flag = False 
                status_text_elements.clear() 
                status_text_elements.append(Text(f"‚ö† PID-—Ñ–∞–π–ª ({pid_file}) –¥–ª—è PID {pid} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø—Ä–æ—Ü–µ—Å—Å —É–∂–µ –Ω–µ –Ω–∞–π–¥–µ–Ω (—É—Å—Ç–∞—Ä–µ–ª).", style="yellow"))
                if pid_file.is_file(): status_text_elements.append(Text(f"  –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å PID-—Ñ–∞–π–ª: rm {pid_file}", style="cyan"))
            except psutil.AccessDenied:
                status_text_elements.append(Text(f"‚úó –û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ PID {pid}.", style="red"))
            except Exception as e_psutil:
                status_text_elements.append(Text(f"‚úó –û—à–∏–±–∫–∞ psutil –¥–ª—è PID {pid}: {e_psutil}", style="red"))
        else: 
             status_text_elements.append(Text("(–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ 'psutil' –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ)", style="dim"))
    elif pid: 
        status_text_elements.append(Text(f"‚ö† SDB –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω (PID-—Ñ–∞–π–ª {pid_file} (PID {pid}) —É—Å—Ç–∞—Ä–µ–ª).", style="yellow"))
        if pid_file.is_file(): status_text_elements.append(Text(f"  –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å PID-—Ñ–∞–π–ª: rm {pid_file}", style="cyan"))
    else: 
        status_text_elements.append(Text("‚óé SDB –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω (PID-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω).", style="red"))

    status_panel_content = Text("\n").join(status_text_elements)
    status_panel = Panel(status_panel_content, title="[bold green]–°—Ç–∞—Ç—É—Å –ë–æ—Ç–∞[/bold green]", border_style="green", expand=False, padding=(1,2))
    
    process_panel_renderable = None
    if process_info_data and is_running_flag: 
        proc_table = Table(show_header=False, box=None, padding=(0, 1), show_edge=False)
        proc_table.add_column(style="dim blue", justify="right", min_width=18, max_width=20) 
        proc_table.add_column(min_width=20)
        for key, value in process_info_data:
            proc_table.add_row(key, value)
        process_panel_renderable = Panel(proc_table, title="[bold blue]–ü—Ä–æ—Ü–µ—Å—Å SDB[/bold blue]", border_style="blue", expand=False, padding=1)

    sdb_info_data_list: List[TypingTuple[str, Any]] = []
    sdb_info_data_list.append(("–í–µ—Ä—Å–∏—è SDB Core:", settings.core.sdb_version))
    sdb_info_data_list.append(("–í–µ—Ä—Å–∏—è Aiogram:", aiogram_version))
    sdb_info_data_list.append(("–¢–∏–ø –ë–î:", settings.db.type.upper()))
    sdb_info_data_list.append(("–¢–∏–ø –∫—ç—à–∞:", settings.cache.type.capitalize()))
    
    try:
        from core.module_loader import ModuleLoader
        from core.services_provider import BotServicesProvider 
        temp_bsp = BotServicesProvider(settings=settings)
        loader = ModuleLoader(settings=settings, services_provider=temp_bsp)
        loader.scan_all_available_modules()
        loader._load_enabled_plugin_names() 
        sdb_info_data_list.append(("–ù–∞–π–¥–µ–Ω–æ –º–æ–¥—É–ª–µ–π:", str(len(loader.available_modules))))
        sdb_info_data_list.append(("–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π:", str(len(loader.enabled_plugin_names))))
    except Exception: 
        sdb_info_data_list.append(("–ú–æ–¥—É–ª–∏:", Text("–û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞", style="yellow")))
    
    total_users = asyncio.run(_get_total_users_count_cli()) 
    user_count_text_val = str(total_users) if total_users is not None else Text("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å", style="yellow")
    sdb_info_data_list.append(("–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î:", user_count_text_val))

    sdb_info_table = Table(show_header=False, box=None, padding=(0,1), show_edge=False)
    sdb_info_table.add_column(style="dim magenta", justify="right", min_width=26) 
    sdb_info_table.add_column(min_width=25)
    for key, value in sdb_info_data_list:
        sdb_info_table.add_row(key, value)
    sdb_info_panel = Panel(sdb_info_table, title="[bold magenta]–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SDB[/bold magenta]", border_style="magenta", expand=False, padding=1)

    console.print(status_panel) 
    
    columns_content = []
    if process_panel_renderable:
        columns_content.append(process_panel_renderable)
    columns_content.append(sdb_info_panel)
        
    if columns_content: 
        console.print(Columns(columns_content, expand=True, equal=False, padding=(0,2), column_first=False))


@control_app.command()
def stop(
    force: bool = typer.Option(False, "--force", "-f", help="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (SIGKILL), –µ—Å–ª–∏ SIGTERM –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª (–û–ü–ê–°–ù–û)."),
    timeout: int = typer.Option(5, "--timeout", "-t", help="–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (—Å–µ–∫) –ø–æ—Å–ª–µ SIGTERM –ø–µ—Ä–µ–¥ SIGKILL (–µ—Å–ª–∏ --force).", min=1, max=60)
):
    """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SDB –±–æ—Ç–∞."""
    pid_file = _get_pid_file_path()
    pid = _read_pid_from_file(pid_file)

    if not pid:
        console.print("[yellow]SDB –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω (PID-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω).[/yellow]")
        return 

    if not _is_process_running(pid):
        console.print(f"[yellow]SDB –±–æ—Ç (PID: {pid} –∏–∑ —Ñ–∞–π–ª–∞) —É–∂–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω.[/yellow]")
        if pid_file.is_file(): 
            try:
                pid_file.unlink()
                console.print(f"–£—Å—Ç–∞—Ä–µ–≤—à–∏–π PID-—Ñ–∞–π–ª {pid_file} —É–¥–∞–ª–µ–Ω.")
            except Exception as e_unlink:
                console.print(f"[red]–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–π PID-—Ñ–∞–π–ª {pid_file}: {e_unlink}[/red]")
        return

    console.print(f"–ü–æ–ø—ã—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SDB –±–æ—Ç–∞ (PID: {pid})...")
    
    if sys.platform == "win32":
        console.print("[yellow]–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è Windows –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –≤—Ä—É—á–Ω—É—é (taskkill /F /PID {pid}).[/yellow]")
        raise typer.Exit(code=1) 

    try:
        os.kill(pid, signal.SIGTERM) 
        console.print(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–∏–≥–Ω–∞–ª SIGTERM –ø—Ä–æ—Ü–µ—Å—Å—É {pid}.")
        
        for i in range(timeout):
            time.sleep(1) 
            if not _is_process_running(pid):
                console.print(f"[green]SDB –±–æ—Ç (PID: {pid}) —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—á–µ—Ä–µ–∑ {i+1} —Å–µ–∫).[/green]")
                if pid_file.is_file(): pid_file.unlink(missing_ok=True) 
                return 
        
        if _is_process_running(pid):
            if force:
                console.print(f"[yellow]–ü—Ä–æ—Ü–µ—Å—Å {pid} –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω –ø–æ—Å–ª–µ {timeout} —Å–µ–∫. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ (SIGKILL)...[/yellow]")
                os.kill(pid, signal.SIGKILL)
                time.sleep(0.1) 
                if not _is_process_running(pid):
                    console.print(f"[green]SDB –±–æ—Ç (PID: {pid}) –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (SIGKILL).[/green]")
                else: 
                    console.print(f"[red]‚úó SDB –±–æ—Ç (PID: {pid}) –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ SIGKILL. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é.[/red]")
                    raise typer.Exit(code=1) 
                if pid_file.is_file(): pid_file.unlink(missing_ok=True)
            else:
                console.print(f"[red]‚úó SDB –±–æ—Ç (PID: {pid}) –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –ø–æ—Å–ª–µ SIGTERM ({timeout} —Å–µ–∫).[/red]")
                console.print(f"  –ü–æ–ø—Ä–æ–±—É–π—Ç–µ './sdb control stop --force' –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –≤—Ä—É—á–Ω—É—é (kill {pid}).")
                raise typer.Exit(code=1) 
        else: 
            console.print(f"[green]SDB –±–æ—Ç (PID: {pid}) —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.[/green]")
            if pid_file.is_file(): pid_file.unlink(missing_ok=True)

    except ProcessLookupError: 
        console.print(f"[green]SDB –±–æ—Ç (PID: {pid}) —É–∂–µ –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.[/green]")
        if pid_file.is_file(): pid_file.unlink(missing_ok=True)
    except typer.Exit: 
        raise 
    except Exception as e:
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞: {e}[/red]")
        raise typer.Exit(code=1)


@control_app.command()
def restart(
    force_stop: bool = typer.Option(False, "--force-stop", help="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å --force –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º."),
    stop_timeout: int = typer.Option(5, "--stop-timeout", help="–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (—Å–µ–∫) –¥–ª—è –∫–æ–º–∞–Ω–¥—ã stop.", min=1, max=60),
    background: bool = typer.Option(True, "--background/--no-background", "-b", help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞."),
    debug: bool = typer.Option(False, "--debug", "-d", help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.")
):
    """–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å SDB –±–æ—Ç–∞: –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω) –∏ –∑–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ—Ç."""
    console.print(Panel("[blue]–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ SDB –±–æ—Ç–∞...[/blue]", expand=False))
    
    console.print("\n[cyan]–®–∞–≥ 1: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)...[/cyan]")
    stop_failed = False
    
    sdb_executable_str: Optional[str] = None
    if Path(sys.argv[0]).is_absolute():
        sdb_executable_str = sys.argv[0]
    else:
        sdb_script_in_bin = Path(sys.executable).parent / Path(sys.argv[0]).name
        if sdb_script_in_bin.exists() and (os.access(sdb_script_in_bin, os.X_OK) or str(sdb_script_in_bin).endswith(".py")):
            sdb_executable_str = str(sdb_script_in_bin)
        else: 
            sdb_py_in_cwd = Path.cwd() / "sdb.py"
            sdb_in_cwd = Path.cwd() / "sdb"
            if sdb_py_in_cwd.exists():
                sdb_executable_str = str(sdb_py_in_cwd)
            elif sdb_in_cwd.exists() and os.access(sdb_in_cwd, os.X_OK):
                sdb_executable_str = str(sdb_in_cwd)
    
    if not sdb_executable_str:
        console.print(f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª SDB CLI. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ sys.argv[0]: {sys.argv[0]}[/bold red]")
        raise typer.Exit(1)

    try:
        stop_command_args = [str(sys.executable), sdb_executable_str, "control", "stop", f"--timeout={stop_timeout}"]
        if force_stop:
            stop_command_args.append("--force")
        
        console.print(f"[dim]–í—ã–∑–æ–≤ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: {' '.join(stop_command_args)}[/dim]")
        stop_process_result = subprocess.run(stop_command_args, capture_output=True, text=True, encoding='utf-8')

        # –ü–µ—á–∞—Ç–∞–µ–º stdout –∏ stderr –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, Rich —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π –≤–Ω—É—Ç—Ä–∏ –Ω–∏—Ö
        if stop_process_result.stdout:
            console.print(f"[dim cyan]–í—ã–≤–æ–¥ 'stop':[/]\n{stop_process_result.stdout.strip()}")
        if stop_process_result.stderr:
            console.print(f"[dim yellow]–û—à–∏–±–∫–∏ –æ—Ç 'stop':[/]\n{stop_process_result.stderr.strip()}")

        if stop_process_result.returncode != 0:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –Ω–∞ —Ñ–∞–∑–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∫–æ–¥: {stop_process_result.returncode}).[/bold red]")
            if not typer.confirm("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –∑–∞–ø—É—Å–∫–∞, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏?", default=False):
                console.print("[bold yellow]–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.[/bold yellow]")
                raise typer.Exit(code=1)
            console.print("[yellow]–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏...[/yellow]")
            stop_failed = True
        else:
            console.print("[green]–§–∞–∑–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω).[/green]")

    except Exception as e_stop_wrapper:
        console.print(Text.assemble(("[bold red]–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å–∞ 'stop': ", "bold red"), Text(str(e_stop_wrapper))))
        if not typer.confirm("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –∑–∞–ø—É—Å–∫–∞, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É?", default=False):
            console.print("[bold yellow]–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.[/bold yellow]")
            raise typer.Exit(code=1)
        console.print("[yellow]–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞...[/yellow]")
        stop_failed = True

    if not stop_failed:
        console.print("[dim]–û–∂–∏–¥–∞–Ω–∏–µ 1 —Å–µ–∫—É–Ω–¥–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º...[/dim]")
        time.sleep(1)

    console.print("\n[cyan]–®–∞–≥ 2: –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞...[/cyan]")
    try:
        start_command_args = [str(sys.executable), sdb_executable_str, "start"]
        if background:
            start_command_args.append("--background")
        if debug:
            start_command_args.append("--debug")

        console.print(f"[dim]–í—ã–∑–æ–≤ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞: {' '.join(start_command_args)}[/dim]")
        
        if background:
            subprocess.Popen(start_command_args)
            console.print("[green]–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.[/green]")
        else:
            start_process_result = subprocess.run(start_command_args, capture_output=True, text=True, encoding='utf-8')
            if start_process_result.stdout:
                 console.print(f"[dim cyan]–í—ã–≤–æ–¥ 'start':[/]\n{start_process_result.stdout.strip()}")
            if start_process_result.stderr: 
                 console.print(f"[dim yellow]–í—ã–≤–æ–¥ (–≤–æ–∑–º–æ–∂–Ω–æ, –æ—à–∏–±–∫–∏) –æ—Ç 'start':[/]\n{start_process_result.stderr.strip()}")
            if start_process_result.returncode != 0:
                console.print(f"[bold red]–û—à–∏–±–∫–∞ –Ω–∞ —Ñ–∞–∑–µ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (–∫–æ–¥: {start_process_result.returncode}).[/bold red]")
                raise typer.Exit(code=1)
            console.print("[green]–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–∑–≤–∞–Ω–∞ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º).[/green]")

    except Exception as e_start_wrapper:
        console.print(Text.assemble(("[bold red]–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —ç—Ç–∞–ø–µ –∑–∞–ø—É—Å–∫–∞: ", "bold red"), Text(str(e_start_wrapper))))
        raise typer.Exit(code=1)

    console.print("\n[bold green]–ö–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.[/bold green]")
    if background:
        console.print("  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ —á–µ—Ä–µ–∑: [cyan]./sdb control status[/cyan]")


======================================================================

------------------------------ FILE: cli_commands/setup_cmd.py ------------------------------
# cli_commands/setup_cmd.py

import typer
from rich.console import Console
from rich.panel import Panel
from rich.syntax import Syntax # –î–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞ –∫–æ–Ω—Ñ–∏–≥–∞
import yaml # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å YAML —Ñ–∞–π–ª–∞–º–∏
import json # –î–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ –≤ JSON
import shutil # –î–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
from pathlib import Path
import sys
from datetime import datetime

# –°–æ–∑–¥–∞–µ–º —Å–≤–æ—é –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
console = Console()

# Typer-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–∞–Ω–¥ –≥—Ä—É–ø–ø—ã 'config' (—Ä–∞–Ω–µ–µ setup_app)
# –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª setup_app –≤ config_app –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏, —á—Ç–æ —ç—Ç–æ –≥—Ä—É–ø–ø–∞ –∫–æ–º–∞–Ω–¥ "config"
config_app = typer.Typer(
    name="config", 
    help="üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π SwiftDevBot (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –ø—Ä–æ—Å–º–æ—Ç—Ä).",
    rich_markup_mode="rich",
    no_args_is_help=True  # <--- –î–û–ë–ê–í–õ–ï–ù–û
)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
# cli_commands/setup_cmd.py -> cli_commands -> SDB_ROOT
PROJECT_ROOT = Path(__file__).resolve().parent.parent
DEFAULT_CONFIG_TEMPLATE_NAME = "config.yaml" # –®–∞–±–ª–æ–Ω –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
USER_CONFIG_DIR_NAME_IN_PROJECT_DATA = "Config" # –ò–º—è –ø–∞–ø–∫–∏ Config –≤–Ω—É—Ç—Ä–∏ project_data
USER_CONFIG_FILENAME = "core_settings.yaml" # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞

@config_app.command(name="init", help="–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
def setup_config_cmd(
    force: bool = typer.Option(False, "--force", "-f", help="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ñ–∏–≥ (—Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –±—ç–∫–∞–ø–∞).")
):
    """
    –°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ 'core_settings.yaml'
    –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 'project_data/Config/' –Ω–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–∞ 'config.yaml' –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞.
    """
    console.print(Panel("[bold cyan]–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SwiftDevBot[/]", expand=False, border_style="cyan"))

    try:
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SDB, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—É—Ç—å –∫ project_data
        from core.app_settings import settings, PROJECT_ROOT_DIR # settings —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –µ—Å–ª–∏ sdb.py –∏—Ö –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª
        
        project_data_path = settings.core.project_data_path
        user_config_dir = project_data_path / USER_CONFIG_DIR_NAME_IN_PROJECT_DATA
        user_config_file_path = user_config_dir / USER_CONFIG_FILENAME
        template_config_path = PROJECT_ROOT_DIR / DEFAULT_CONFIG_TEMPLATE_NAME

        user_config_dir.mkdir(parents=True, exist_ok=True) # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç

        if not template_config_path.exists():
            console.print(f"[bold red]–û—à–∏–±–∫–∞: –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ '{template_config_path}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]")
            console.print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª 'config.yaml' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.")
            raise typer.Exit(code=1)

        if user_config_file_path.exists():
            console.print(f"[yellow]–û–±–Ω–∞—Ä—É–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: '{user_config_file_path}'[/]")
            if force:
                should_overwrite = True
                console.print("[yellow]–û–ø—Ü–∏—è --force: —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ñ–∏–≥ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω (—Å –±—ç–∫–∞–ø–æ–º).[/]")
            else:
                # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ –¥–µ–ª–∞—Ç—å
                # TODO: –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏—é "–æ–±–Ω–æ–≤–∏—Ç—å/–¥–æ–ø–æ–ª–Ω–∏—Ç—å" (—Å–ª–∏—è–Ω–∏–µ YAML) - —ç—Ç–æ —Å–ª–æ–∂–Ω–µ–µ.
                # –ü–æ–∫–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å.
                overwrite_options = ["–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å (—Å–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø)", "–û—Ç–º–µ–Ω–∞"]
                # –≠—Ç–æ –ø—Å–µ–≤–¥–æ-–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è Typer, —Ä–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–ª–æ–∂–Ω–µ–µ.
                # –ü—Ä–æ—â–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å typer.confirm
                # choice = typer.prompt(f"–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?", type=typer.Choice(overwrite_options), default=overwrite_options[1])
                # if choice == overwrite_options[1]: # –û—Ç–º–µ–Ω–∞
                if not typer.confirm(f"–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª '{user_config_file_path}' (—Å—Ç–∞—Ä—ã–π –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ .bak)?", default=False):
                    console.print("[bold green]–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.[/]")
                    raise typer.Exit()
                should_overwrite = True
            
            if should_overwrite:
                backup_path = user_config_file_path.with_suffix(f".{datetime.now().strftime('%Y%m%d_%H%M%S')}.bak")
                try:
                    shutil.copy2(user_config_file_path, backup_path) # copy2 —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                    console.print(f"[green]–°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞: '{backup_path}'[/]")
                except Exception as e_backup:
                    console.print(f"[bold red]–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞ –¥–ª—è '{user_config_file_path}': {e_backup}[/]")
                    if not typer.confirm("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å –±–µ–∑ –±—ç–∫–∞–ø–∞?", default=False):
                        raise typer.Exit()
                
                # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∞–≤–∞–º–∏/—Å–ª–∏—è–Ω–∏–µ–º
                user_config_file_path.unlink(missing_ok=True) 
        
        # –ö–æ–ø–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ñ–∏–≥
        try:
            shutil.copy2(template_config_path, user_config_file_path)
            console.print(f"[bold green]–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω: '{user_config_file_path}'[/]")
            console.print(f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª, —É–∫–∞–∑–∞–≤ –≤–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ BOT_TOKEN, –µ—Å–ª–∏ –æ–Ω –Ω–µ –≤ .env).")
            console.print(f"–ù–µ –∑–∞–±—É–¥—å—Ç–µ —Ç–∞–∫–∂–µ —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª '.env' –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —É–∫–∞–∑–∞—Ç—å –≤ –Ω–µ–º BOT_TOKEN.")
        except Exception as e_copy:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞ '{template_config_path}' –≤ '{user_config_file_path}': {e_copy}[/]")
            raise typer.Exit(code=1)

    except ImportError:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å 'core.app_settings'.[/]")
        console.print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SDB —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞.")
        raise typer.Exit(code=1)
    except Exception as e:
        console.print(f"[bold red]–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}[/]")
        console.print_exception(show_locals=False)
        raise typer.Exit(code=1)

@config_app.command(name="info", help="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –∞–∫—Ç–∏–≤–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é SDB.")
def show_info_cmd(
    show_defaults: bool = typer.Option(False, "--show-defaults", help="–í–∫–ª—é—á–∏—Ç—å –≤ –≤—ã–≤–æ–¥ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è Pydantic –º–æ–¥–µ–ª–µ–π)."),
    output_format: str = typer.Option("yaml", "--format", "-fmt", help="–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: 'yaml' –∏–ª–∏ 'json'.", 
                                       case_sensitive=False, show_choices=True, 
                                       # typer.Choice –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ typer.Option –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö,
                                       # –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å callback –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å.
                                       ) 
):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é SwiftDevBot, –æ–±—ä–µ–¥–∏–Ω—è—è –∑–Ω–∞—á–µ–Ω–∏—è
    –∏–∑ —Ñ–∞–π–ª–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –¥–µ—Ñ–æ–ª—Ç–æ–≤.
    """
    console.print(Panel("[bold cyan]–¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SwiftDevBot[/]", expand=False, border_style="cyan"))
    output_format = output_format.lower()
    if output_format not in ["yaml", "json"]:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ '{output_format}'. –î–æ—Å—Ç—É–ø–Ω—ã: 'yaml', 'json'.[/]")
        raise typer.Exit(code=1)

    try:
        from core.app_settings import settings # –ó–∞–≥—Ä—É–∂–∞–µ–º —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º model_dump() –∏–∑ Pydantic V2 –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–æ–≤–∞—Ä—è
        # mode='json' –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (Path, HttpUrl –∏ —Ç.–¥.) –±—É–¥—É—Ç —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω—ã
        # –≤ JSON-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Ç–∏–ø—ã (—Å—Ç—Ä–æ–∫–∏).
        # exclude_defaults=not show_defaults - –µ—Å–ª–∏ show_defaults=False (–¥–µ—Ñ–æ–ª—Ç), —Ç–æ exclude_defaults=True
        config_dict = settings.model_dump(mode='json', exclude_defaults=not show_defaults)

        if output_format == "yaml":
            try:
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ Path –æ–±—Ä–∞—Ç–Ω–æ –≤ Path –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞ YAML (–µ—Å–ª–∏ PyYAML —ç—Ç–æ —É–º–µ–µ—Ç)
                # –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–ª–∏—à–Ω–∏–º, –µ—Å–ª–∏ model_dump(mode='json') —É–∂–µ –≤—Å–µ —Å–¥–µ–ª–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
                # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å, PyYAML –¥–æ–ª–∂–µ–Ω —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏.
                yaml_output_str = yaml.dump(config_dict, indent=2, allow_unicode=True, sort_keys=False)
                syntax = Syntax(yaml_output_str, "yaml", theme="native", line_numbers=True, word_wrap=True)
                console.print(syntax)
            except ImportError:
                console.print("[yellow]PyYAML –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –í—ã–≤–æ–¥ –±—É–¥–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.[/]")
                output_format = "json" # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ JSON
            except Exception as e_yaml:
                console.print(f"[red]–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–≤–æ–¥–∞ –≤ YAML: {e_yaml}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ JSON.[/]")
                output_format = "json" # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ JSON
        
        if output_format == "json": # –ï—Å–ª–∏ –±—ã–ª –≤—ã–±—Ä–∞–Ω JSON –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ YAML
            json_output_str = json.dumps(config_dict, indent=2, ensure_ascii=False)
            syntax = Syntax(json_output_str, "json", theme="native", line_numbers=True, word_wrap=True)
            console.print(syntax)
            
        console.print(f"\n[dim]–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å —É—á–µ—Ç–æ–º –¥–µ—Ñ–æ–ª—Ç–æ–≤, '{USER_CONFIG_FILENAME}', –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.[/dim]")
        if not show_defaults:
            console.print("[dim]–ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ –ø–æ–∫–∞–∑–∞–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --show-defaults –¥–ª—è –∏—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.[/dim]")

    except ImportError:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å 'core.app_settings'.[/]")
        raise typer.Exit(code=1)
    except Exception as e:
        console.print(f"[bold red]–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}[/]")
        console.print_exception(show_locals=False)
        raise typer.Exit(code=1)


======================================================================

------------------------------ FILE: cli_commands/module_cmd.py ------------------------------
import typer
import shutil
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from rich.text import Text
from rich.syntax import Syntax
import json
from pathlib import Path
import sys
import asyncio
import importlib
from typing import List, Dict, Any, Optional, Type

from .cli_utils import get_sdb_services_for_cli, confirm_action
from core.database.base import Base as SDBBaseAlchemyModel 

console = Console()
module_app = typer.Typer(
    name="module",
    help="üß© –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ (–ø–ª–∞–≥–∏–Ω–∞–º–∏) SwiftDevBot.",
    rich_markup_mode="rich",
    no_args_is_help=True  # <--- –î–û–ë–ê–í–õ–ï–ù–û
)

async def _get_module_loader_instance_async() -> Optional[Any]: 
    settings_obj, _, _ = await get_sdb_services_for_cli(init_db=False, init_rbac=False)
    if not settings_obj:
        console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SDB –¥–ª—è ModuleLoader (–∏–∑ CLI).[/]")
        return None
    try:
        from core.module_loader import ModuleLoader
        from core.services_provider import BotServicesProvider
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π BotServicesProvider —Ç–æ–ª—å–∫–æ –¥–ª—è ModuleLoader,
        # —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –∑–¥–µ—Å—å –Ω–µ –Ω—É–∂–Ω–∞ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª–≥–æ–π.
        # ModuleLoader –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç settings –∏ —Å–∞–º–æ–≥–æ —Å–µ–±—è (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ services.logger).
        # –≠—Ç–æ –Ω–µ –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –Ω–æ –¥–ª—è CLI –∫–æ–º–∞–Ω–¥, –≥–¥–µ –Ω–∞–º –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ ModuleLoader, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–µ–º–ª–µ–º–æ.
        # –õ–∏–±–æ ModuleLoader –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–¥–µ–ª–∞–Ω, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ–≥–æ BSP –¥–ª—è —Ç–∞–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.
        # –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º —Ç–∞–∫, –Ω–æ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º.
        temp_bsp = BotServicesProvider(settings=settings_obj)
        # –ù–µ –≤—ã–∑—ã–≤–∞–µ–º temp_bsp.setup_services(), —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –¥–ª—è —Ä–∞–Ω—Ç–∞–π–º–∞ –±–æ—Ç–∞.
        # ModuleLoader –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å settings –∏ –ª–æ–≥–≥–µ—Ä–æ–º.
        
        loader = ModuleLoader(settings=settings_obj, services_provider=temp_bsp) # –ü–µ—Ä–µ–¥–∞–µ–º temp_bsp
        
        # –ò–ó–ú–ï–ù–ï–ù–û –ó–î–ï–°–¨
        if hasattr(loader, 'scan_all_available_modules'):
            loader.scan_all_available_modules()
        else:
            console.print("[bold red]–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ú–µ—Ç–æ–¥ 'scan_all_available_modules' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ModuleLoader.[/]")
            return None
            
        if hasattr(loader, '_load_enabled_plugin_names'):
            getattr(loader, '_load_enabled_plugin_names')()
        else:
            console.print("[yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ú–µ—Ç–æ–¥ '_load_enabled_plugin_names' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ModuleLoader –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–∑ CLI.[/yellow]")
        
        return loader
    except ImportError as e_imp:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —è–¥—Ä–∞ SDB –¥–ª—è ModuleLoader (–∏–∑ CLI): {e_imp}[/]")
        return None
    except Exception as e_load:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ModuleLoader (–∏–∑ CLI): {e_load}[/]")
        console.print_exception(show_locals=False) # –î–æ–±–∞–≤–∏–º –≤—ã–≤–æ–¥ —Ç—Ä–µ–π—Å–±–µ–∫–∞
        return None

def _get_module_loader_sync() -> Optional[Any]: 
    try:
        return asyncio.run(_get_module_loader_instance_async())
    except Exception as e:
        # –õ–æ–≥ –æ—à–∏–±–∫–∏ —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ _get_module_loader_instance_async
        # console.print(f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ModuleLoader —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ: {e}[/]")
        return None

def _save_enabled_modules(module_names: List[str], config_path: Path) -> bool:
    try:
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞
        unique_module_names = sorted(list(set(name.strip() for name in module_names if name.strip())))
        data_to_save = {"active_modules": unique_module_names, "disabled_modules": []} # disabled_modules –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ
        
        config_path.parent.mkdir(parents=True, exist_ok=True)
        with open(config_path, 'w', encoding='utf-8') as f:
            json.dump(data_to_save, f, indent=2, ensure_ascii=False)
        return True
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –≤ {config_path}: {e}[/]")
        return False

@module_app.command(name="create", help="–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è.")
def create_module_cmd(name: str = typer.Argument(..., help="–ò–º—è –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, '_').")):
    """–°–æ–∑–¥–∞—ë—Ç —à–∞–±–ª–æ–Ω –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è."""
    from loguru import logger  # –õ–æ–∫–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å rich

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏
    if not name.isidentifier():
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ò–º—è –º–æ–¥—É–ª—è '{name}' –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ '_', –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤.[/]")
        raise typer.Exit(code=1)

    module_dir = Path("modules") / name
    if module_dir.exists():
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ {module_dir}.[/]")
        raise typer.Exit(code=1)

    console.print(Panel(f"[bold cyan]–°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥—É–ª—è: {name}[/]", expand=False, border_style="cyan"))
    try:
        module_dir.mkdir(parents=True)
        
        # –°–æ–∑–¥–∞—ë–º manifest.yaml
        manifest_content = f"""\
name: {name}
version: 0.1.0
display_name: {name.title()}
description: –ú–æ–¥—É–ª—å {name} –¥–ª—è SwiftDevBot
commands:
  - command: /{name}
    description: –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–¥—É–ª—å {name}
permissions:
  - {name}.use: –ü—Ä–∞–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å
  - {name}.admin: –ü—Ä–∞–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å
model_definitions: []
"""
        (module_dir / "manifest.yaml").write_text(manifest_content, encoding="utf-8")
        console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / 'manifest.yaml'}[/]")

        # –°–æ–∑–¥–∞—ë–º __init__.py
        init_content = f"""\
from aiogram import Router
from core.services.ui_registry import register_module_entry
from core.services_provider import BotServicesProvider

router = Router(name="{name}")

def setup_module(services: BotServicesProvider):
    register_module_entry(
        services=services,
        module_name="{name}",
        title="{{{{_('{name.title()}')}}}}",
        description="{{{{_('–ú–æ–¥—É–ª—å {name.title()}')}}}}",
        icon="üîß",
        entry_command="/{name}",
        required_permission="{name}.use",
    )
    services.routers.append(router)
"""
        (module_dir / "__init__.py").write_text(init_content, encoding="utf-8")
        console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / '__init__.py'}[/]")

        # –°–æ–∑–¥–∞—ë–º handlers.py
        handlers_content = f"""\
from aiogram import types, Router
from aiogram.filters import Command
from core.services_provider import BotServicesProvider

router = Router(name="{name}_handlers")

@router.message(Command("{name}"))
async def cmd_{name}(message: types.Message, services: BotServicesProvider):
    if not await services.rbac.user_has_permission(services.db_session, message.from_user.id, "{name}.use"):
        await message.answer("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    await message.answer("–ü—Ä–∏–≤–µ—Ç –æ—Ç –º–æ–¥—É–ª—è {name}!")
"""
        (module_dir / "handlers.py").write_text(handlers_content, encoding="utf-8")
        console.print(f"[green]–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {module_dir / 'handlers.py'}[/]")

        # –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—ã–µ –ø–∞–ø–∫–∏ –∏ __init__.py
        (module_dir / "keyboards").mkdir()
        (module_dir / "keyboards" / "__init__.py").touch()
        console.print(f"[green]–°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞: {module_dir / 'keyboards'}[/]")
        (module_dir / "models").mkdir()
        (module_dir / "models" / "__init__.py").touch()
        console.print(f"[green]–°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞: {module_dir / 'models'}[/]")

        console.print(f"[bold green]–ú–æ–¥—É–ª—å '{name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤ {module_dir}![/]")
        console.print(f"[yellow]–î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:[/]")
        console.print(f"1. –î–æ–±–∞–≤—å—Ç–µ –º–æ–¥—É–ª—å –≤ core_settings.yaml:")
        console.print(Syntax(f"""modules:
  enabled:
    - {name}
""", "yaml", theme="fruity"))
        console.print(f"2. –í–∫–ª—é—á–∏—Ç–µ –º–æ–¥—É–ª—å: [cyan]./sdb.py module enable {name}[/]")
        console.print(f"3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç: [cyan]./sdb.py control restart[/]")
        logger.success(f"–ú–æ–¥—É–ª—å {name} —Å–æ–∑–¥–∞–Ω –≤ {module_dir}")
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–æ–¥—É–ª—è '{name}': {e}[/]")
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥—É–ª—è {name}: {e}")
        shutil.rmtree(module_dir, ignore_errors=True)
        raise typer.Exit(code=1)

@module_app.command(name="list", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å.")
def list_modules_cmd():
    loader = _get_module_loader_sync()
    if not loader: 
        # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—ã–≤–µ–¥–µ–Ω–æ –∏–∑ _get_module_loader_sync –∏–ª–∏ _get_module_loader_instance_async
        raise typer.Exit(code=1)
        
    table = Table(title="[bold cyan]–ú–æ–¥—É–ª–∏ SwiftDevBot[/]", show_header=True, header_style="bold magenta")
    table.add_column("–ò–º—è –ú–æ–¥—É–ª—è (name)", style="dim cyan", min_width=20)
    table.add_column("–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –ò–º—è", min_width=25)
    table.add_column("–í–µ—Ä—Å–∏—è", style="yellow")
    table.add_column("–¢–∏–ø", style="blue") # –î–æ–±–∞–≤–∏–º —Ç–∏–ø
    table.add_column("–°—Ç–∞—Ç—É—Å", style="green")
    table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ", max_width=50, overflow="fold")

    if not loader.available_modules:
        console.print("[yellow]–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –º–æ–¥—É–ª—è (–≤ modules/ –∏–ª–∏ core/sys_modules/).[/]")
        return
        
    sorted_modules = sorted(loader.available_modules.values(), key=lambda m_info: (m_info.is_system_module, m_info.name))
    
    for module_info in sorted_modules:
        module_type = "–°–∏—Å—Ç–µ–º–Ω—ã–π" if module_info.is_system_module else "–ü–ª–∞–≥–∏–Ω"
        
        # –°—Ç–∞—Ç—É—Å –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç enabled_plugin_names
        # –°—Ç–∞—Ç—É—Å –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö - –æ–Ω–∏ "–≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏" (–Ω–æ –º–æ–≥—É—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫)
        if module_info.is_system_module:
            status_text = Text("–ê–∫—Ç–∏–≤–µ–Ω (—Å–∏—Å—Ç–µ–º–Ω—ã–π)", style="green") # –∏–ª–∏ "–ó–∞–≥—Ä—É–∂–µ–Ω", –µ—Å–ª–∏ –µ—Å—Ç—å is_loaded_successfully
            if module_info.is_loaded_successfully:
                status_text = Text("–ó–∞–≥—Ä—É–∂–µ–Ω ‚úÖ (—Å–∏—Å—Ç.)", style="green")
            elif module_info.error:
                 status_text = Text(f"–û—à–∏–±–∫–∞ ‚ö†Ô∏è (—Å–∏—Å—Ç.)", style="red")

        else: # –≠—Ç–æ –ø–ª–∞–≥–∏–Ω
            status_text = Text("–ê–∫—Ç–∏–≤–µ–Ω ‚úÖ", style="green") if module_info.name in loader.enabled_plugin_names else Text("–ù–µ–∞–∫—Ç–∏–≤–µ–Ω ‚ùå", style="red")
            if module_info.name in loader.enabled_plugin_names and module_info.is_loaded_successfully:
                status_text = Text("–ó–∞–≥—Ä—É–∂–µ–Ω ‚úÖ", style="green")
            elif module_info.name in loader.enabled_plugin_names and module_info.error:
                status_text = Text(f"–û—à–∏–±–∫–∞ ‚ö†Ô∏è", style="red")

        version_str = module_info.manifest.version if module_info.manifest else "[N/A]"
        display_name_str = module_info.manifest.display_name if module_info.manifest else module_info.name # fallback –Ω–∞ –∏–º—è –ø–∞–ø–∫–∏
        description_str = module_info.manifest.description if module_info.manifest and module_info.manifest.description else "-"
        
        table.add_row(module_info.name, display_name_str, version_str, module_type, status_text, description_str)
    console.print(table)

@module_app.command(name="info", help="–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥—É–ª–µ (–∏–∑ manifest).")
def info_module_cmd(module_name: str = typer.Argument(..., help="–ò–º—è –º–æ–¥—É–ª—è (–∏–∑ manifest.name –∏–ª–∏ –∏–º—è –ø–∞–ø–∫–∏).")):
    loader = _get_module_loader_sync()
    if not loader: raise typer.Exit(code=1)
    
    module_info = loader.get_module_info(module_name)
    
    if not module_info:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]")
        raise typer.Exit(code=1)
        
    if not module_info.manifest:
        console.print(f"[yellow]–ú–æ–¥—É–ª—å '{module_name}' –Ω–∞–π–¥–µ–Ω, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ (–∏–ª–∏ –æ–Ω –Ω–µ –±—ã–ª —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω).[/yellow]")
        console.print(f"  –ü—É—Ç—å –∫ –º–æ–¥—É–ª—é: {module_info.path}")
        console.print(f"  –¢–∏–ø: {'–°–∏—Å—Ç–µ–º–Ω—ã–π' if module_info.is_system_module else '–ü–ª–∞–≥–∏–Ω'}")
        if module_info.error: console.print(f"  –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞: {module_info.error}")
        raise typer.Exit(code=1)

    display_name_header = module_info.manifest.display_name or module_info.name
    console.print(Panel(f"[bold cyan]–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥—É–ª–µ: {display_name_header} ({module_name})[/]", expand=False, border_style="cyan"))
    
    try:
        import yaml
        manifest_str = yaml.dump(module_info.manifest.model_dump(mode='json'), indent=2, allow_unicode=True, sort_keys=False)
        syntax = Syntax(manifest_str, "yaml", theme="fruity", line_numbers=True, background_color="default")
    except ImportError:
        manifest_str = json.dumps(module_info.manifest.model_dump(mode='json'), indent=2, ensure_ascii=False)
        syntax = Syntax(manifest_str, "json", theme="fruity", line_numbers=True, background_color="default")
    except Exception as e_dump:
        console.print(f"[yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –∫—Ä–∞—Å–∏–≤–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç: {e_dump}. –í—ã–≤–æ–¥ –∫–∞–∫ —Å–ª–æ–≤–∞—Ä—å:[/]")
        console.print(module_info.manifest.model_dump())
        raise typer.Exit(code=1)
    console.print(syntax)

@module_app.command(name="enable", help="–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω (–¥–æ–±–∞–≤–∏—Ç—å –≤ enabled_modules.json).")
def enable_module_cmd(module_name: str = typer.Argument(..., help="–ò–º—è –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.")):
    loader = _get_module_loader_sync()
    if not loader: raise typer.Exit(code=1)

    module_info = loader.get_module_info(module_name)
    if not module_info:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ä–µ–¥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–º—è.[/]")
        console.print(f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø–ª–∞–≥–∏–Ω—ã): {[m.name for m in loader.available_modules.values() if not m.is_system_module]}")
        raise typer.Exit(code=1)

    if module_info.is_system_module:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ ('{module_name}') –Ω–µ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ enable/disable. –û–Ω–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —è–¥—Ä–æ–º.[/]")
        raise typer.Exit(code=1)

    enabled_modules_file_path = loader._settings.core.enabled_modules_config_path
    
    if module_name in loader.enabled_plugin_names:
        console.print(f"[yellow]–ü–ª–∞–≥–∏–Ω '{module_name}' —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω.[/]")
        return

    new_enabled_list = loader.enabled_plugin_names + [module_name]
    if _save_enabled_modules(new_enabled_list, enabled_modules_file_path):
        console.print(f"[bold green]–ü–ª–∞–≥–∏–Ω '{module_name}' —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω![/]")
        console.print(f"–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø—è—Ç –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (`./sdb control restart`).")
    else:
        console.print(f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ '{enabled_modules_file_path}'.[/]")
        raise typer.Exit(code=1)

@module_app.command(name="disable", help="–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω (—É–¥–∞–ª–∏—Ç—å –∏–∑ enabled_modules.json).")
def disable_module_cmd(module_name: str = typer.Argument(..., help="–ò–º—è –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏.")):
    loader = _get_module_loader_sync()
    if not loader: raise typer.Exit(code=1)

    module_info = loader.get_module_info(module_name)
    if not module_info:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]")
        raise typer.Exit(code=1)

    if module_info.is_system_module:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ ('{module_name}') –Ω–µ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ enable/disable.[/]")
        raise typer.Exit(code=1)

    enabled_modules_file_path = loader._settings.core.enabled_modules_config_path
    
    if module_name not in loader.enabled_plugin_names:
        console.print(f"[yellow]–ü–ª–∞–≥–∏–Ω '{module_name}' –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω.[/]")
        return
    
    new_enabled_list = [m for m in loader.enabled_plugin_names if m != module_name]
    if _save_enabled_modules(new_enabled_list, enabled_modules_file_path):
        console.print(f"[bold green]–ü–ª–∞–≥–∏–Ω '{module_name}' —É—Å–ø–µ—à–Ω–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω![/]")
        console.print(f"–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø—è—Ç –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (`./sdb control restart`).")
    else:
        console.print(f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ '{enabled_modules_file_path}'.[/]")
        raise typer.Exit(code=1)

async def _clean_tables_module_async_internal(module_name: str, loader: Any, called_from_uninstall: bool = False) -> bool:
    if not called_from_uninstall:
        console.print(Panel(f"[bold red]–£–î–ê–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶ –ú–û–î–£–õ–Ø: {module_name}[/]", expand=False, border_style="red"))

    module_info = loader.get_module_info(module_name)
    if not module_info: # –ú–∞–Ω–∏—Ñ–µ—Å—Ç –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —É —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –º–æ–¥—É–ª—è
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]")
        return False
        
    if not module_info.manifest:
         console.print(f"[yellow]–ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –∏–º–µ–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.[/yellow]")
         return True # –°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—à–Ω—ã–º, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å

    model_definitions_paths = module_info.manifest.model_definitions
    if not model_definitions_paths:
        console.print(f"[yellow]–ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –¥–µ–∫–ª–∞—Ä–∏—Ä—É–µ—Ç –º–æ–¥–µ–ª–∏ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ ('model_definitions'). –£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.[/]")
        return True

    if not called_from_uninstall:
        console.print(f"–ú–æ–¥—É–ª—å '{module_name}' –¥–µ–∫–ª–∞—Ä–∏—Ä—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø—É—Ç–∏ –∫ –º–æ–¥–µ–ª—è–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü:")
        for path_str in model_definitions_paths: console.print(f"  - {path_str}")
        if not confirm_action(f"–í—ã –ê–ë–°–û–õ–Æ–¢–ù–û —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –º–æ–¥–µ–ª–µ–π –º–æ–¥—É–ª—è '{module_name}'? –≠—Ç–æ [bold red]–ù–ï–û–ë–†–ê–¢–ò–ú–û[/]!", default_choice=False, abort_on_false=True):
            return False

    models_to_drop: List[Type[SDBBaseAlchemyModel]] = []
    failed_imports: List[str] = []
    console.print(f"\n–ò–º–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–æ–≤ –º–æ–¥–µ–ª–µ–π –¥–ª—è '{module_name}'...")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –º–æ–¥—É–ª—è
    # –≠—Ç–æ –≤–∞–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ model_definitions –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º–∏ (—Ö–æ—Ç—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–ª–Ω—ã–µ)
    # –ù–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –ø–æ–∫–∞ –æ–∂–∏–¥–∞–µ–º –ø–æ–ª–Ω—ã–µ –ø—É—Ç–∏ —Ç–∏–ø–∞ "modules.my_plugin.models.MyTable"
    # –∏–ª–∏ "core.sys_modules.my_sys_mod.models.SysTable"
    
    for import_path_str in model_definitions_paths:
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ—á–∫–∞ –≤ –ø—É—Ç–∏, –∏–Ω–∞—á–µ —ç—Ç–æ –Ω–µ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
            if '.' not in import_path_str:
                failed_imports.append(import_path_str)
                console.print(f"  [yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:[/yellow] '{import_path_str}' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –ø—É—Ç–µ–º –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ Python-–º–æ–¥–µ–ª–∏.")
                continue

            module_path_part, class_name = import_path_str.rsplit('.', 1)
            imported_py_module = importlib.import_module(module_path_part)
            model_class_obj = getattr(imported_py_module, class_name) # –ü–æ–ª—É—á–∞–µ–º —Å–∞–º –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫–ª–∞—Å—Å –∏ –æ–Ω –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç SDBBaseAlchemyModel
            if isinstance(model_class_obj, type) and issubclass(model_class_obj, SDBBaseAlchemyModel) and hasattr(model_class_obj, '__table__'):
                models_to_drop.append(model_class_obj) # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å, –∞ –Ω–µ —ç–∫–∑–µ–º–ø–ª—è—Ä
                console.print(f"  [green]–£—Å–ø–µ—Ö:[/green] {import_path_str} (—Ç–∞–±–ª–∏—Ü–∞: {model_class_obj.__tablename__})")
            else:
                failed_imports.append(import_path_str)
                console.print(f"  [yellow]–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:[/yellow] '{import_path_str}' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –º–æ–¥–µ–ª—å—é SQLAlchemy, –Ω–∞—Å–ª–µ–¥—É–µ–º–æ–π –æ—Ç SDBBaseModel.")
        except Exception as e_import:
            failed_imports.append(import_path_str)
            console.print(f"  [red]–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–ª—è '{import_path_str}':[/red] {type(e_import).__name__} - {e_import}")

    if failed_imports:
        console.print(f"\n[bold yellow]–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å {len(failed_imports)} –∏–∑ {len(model_definitions_paths)} –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è '{module_name}'.[/]")
        if not models_to_drop: # –ï—Å–ª–∏ –í–û–û–ë–©–ï –Ω–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
            console.print("[bold red]–ù–µ—Ç —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π. –û–ø–µ—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü –ø—Ä–µ—Ä–≤–∞–Ω–∞.[/]")
            return False
        # –ï—Å–ª–∏ —á–∞—Å—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∞—Å—å, –∞ —á–∞—Å—Ç—å –Ω–µ—Ç - —Å–ø—Ä–∞—à–∏–≤–∞–µ–º, –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ª–∏ —Å —Ç–µ–º, —á—Ç–æ –µ—Å—Ç—å
        if not called_from_uninstall and not confirm_action(f"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –¥–ª—è {len(models_to_drop)} —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π?", default_choice=False, abort_on_false=True):
            return False
        elif called_from_uninstall: # –ï—Å–ª–∏ —ç—Ç–æ —á–∞—Å—Ç—å –¥–µ–∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏, —Ç–æ –ª—É—á—à–µ –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å —á–∞—Å—Ç–∏—á–Ω—ã–º —É–¥–∞–ª–µ–Ω–∏–µ–º
            console.print("[bold yellow]–ò–∑-–∑–∞ –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –ø—Ä–∏ –¥–µ–∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏ –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ. "
                          "–£–¥–∞–ª–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.[/]")
            return False # –°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º, —á—Ç–æ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –±—ã–ª–æ –ø–æ–ª–Ω—ã–º/—É—Å–ø–µ—à–Ω—ã–º

    if not models_to_drop: # –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
        console.print(f"[bold yellow]–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü –¥–ª—è –º–æ–¥—É–ª—è '{module_name}'.[/]")
        return True # –°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—à–Ω—ã–º, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—á–µ–≥–æ –±—ã–ª–æ —É–¥–∞–ª—è—Ç—å

    if not called_from_uninstall: # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —á–∞—Å—Ç—å uninstall
        console.print("\n[bold blue]–°–ª–µ–¥—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã SQLAlchemy –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏–∑ –ë–î:[/]")
        for model_cls_to_drop in models_to_drop: console.print(f"  - [cyan]{model_cls_to_drop.__tablename__}[/cyan]")
        if not confirm_action(f"–ü–û–°–õ–ï–î–ù–ï–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï: –£–¥–∞–ª–∏—Ç—å {len(models_to_drop)} —Ç–∞–±–ª–∏—Ü –¥–ª—è '{module_name}'?", default_choice=False, abort_on_false=True):
            return False

    settings_obj, db_m, _ = await get_sdb_services_for_cli(init_db=True)
    if not (settings_obj and db_m):
        console.print("[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å DBManager –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü.[/]")
        return False
    try:
        console.print(f"\n[magenta]–£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –¥–ª—è '{module_name}'...[/magenta]")
        await db_m.drop_specific_module_tables(models_to_drop) # –ü–µ—Ä–µ–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –ö–õ–ê–°–°–û–í –º–æ–¥–µ–ª–µ–π
        console.print(f"[bold green]–¢–∞–±–ª–∏—Ü—ã –¥–ª—è '{module_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã.[/]")
        if not called_from_uninstall:
            console.print("[yellow]–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: Alembic –Ω–µ –∑–Ω–∞–µ—Ç –æ–± —ç—Ç–æ–º —É–¥–∞–ª–µ–Ω–∏–∏. "
                          "–ï—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —ç—Ç–∏—Ö —Ç–∞–±–ª–∏—Ü –≤ –±—É–¥—É—â–µ–º, "
                          "–≤–∞–º –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–µ–≤–∏–∑–∏—é –∏–ª–∏ '–∑–∞—à—Ç–∞–º–ø–æ–≤–∞—Ç—å' —Å–æ—Å—Ç–æ—è–Ω–∏–µ Alembic.[/yellow]")
        return True
    except Exception as e_drop:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü –¥–ª—è '{module_name}': {e_drop}[/]")
        return False
    finally:
        if db_m: await db_m.dispose()

@module_app.command(name="clean-tables", help="[–û–ü–ê–°–ù–û] –£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è –∏–∑ –ë–î (—Å–æ–≥–ª–∞—Å–Ω–æ manifest).")
def clean_tables_module_cmd_wrapper(module_name: str = typer.Argument(..., help="–ò–º—è –º–æ–¥—É–ª—è, —á—å–∏ —Ç–∞–±–ª–∏—Ü—ã —É–¥–∞–ª–∏—Ç—å.")):
    try:
        loader = asyncio.run(_get_module_loader_instance_async())
        if not loader: raise typer.Exit(code=1)
        if not asyncio.run(_clean_tables_module_async_internal(module_name=module_name, loader=loader)):
            raise typer.Exit(code=1)
    except typer.Exit: raise
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –≤ 'module clean-tables': {e}[/]")
        raise typer.Exit(code=1)

@module_app.command(name="uninstall", help="[–û–ü–ê–°–ù–û] –£–¥–∞–ª–∏—Ç—å –º–æ–¥—É–ª—å (—Ñ–∞–π–ª—ã –∏, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ–≥–æ –¥–∞–Ω–Ω—ã–µ).")
def uninstall_module_cmd_wrapper(
    module_name: str = typer.Argument(..., help="–ò–º—è –º–æ–¥—É–ª—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è."),
    remove_data: bool = typer.Option(False, "--remove-data/--keep-data",
                                   help="–£–¥–∞–ª–∏—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª—è (—Ç–∞–±–ª–∏—Ü—ã –ë–î). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –î–ê–ù–ù–´–ï –°–û–•–†–ê–ù–Ø–Æ–¢–°–Ø.")
):
    try:
        asyncio.run(_uninstall_module_async(module_name=module_name, remove_data=remove_data))
    except typer.Exit: raise
    except Exception as e:
        console.print(f"[bold red]–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ 'module uninstall': {e}[/]")
        raise typer.Exit(code=1)

async def _uninstall_module_async(module_name: str, remove_data: bool):
    console.print(Panel(f"[bold red]–£–î–ê–õ–ï–ù–ò–ï –ú–û–î–£–õ–Ø: {module_name}[/]", expand=False, border_style="red"))

    loader = await _get_module_loader_instance_async()
    if not loader: raise typer.Exit(code=1)

    module_info = loader.get_module_info(module_name)
    if not module_info:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å.[/]")
        raise typer.Exit(code=1)

    if module_info.is_system_module:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å ('{module_name}') –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω —á–µ—Ä–µ–∑ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.[/]")
        raise typer.Exit(code=1)

    console.print(f"–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: [cyan]{module_info.path}[/]")
    if not confirm_action(f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ –§–ê–ô–õ–´ –ø–ª–∞–≥–∏–Ω–∞ '{module_name}'?", default_choice=False, abort_on_false=True):
        return

    data_cleaned_successfully = True # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
    if remove_data:
        console.print(f"\n–ó–∞–ø—Ä–æ—à–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞ '{module_name}'.")
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á—Ç–æ —É–¥–∞–ª—è—Ç—å (–¥–µ–∫–ª–∞—Ä–∏—Ä–æ–≤–∞–Ω—ã –ª–∏ –º–æ–¥–µ–ª–∏)
        if module_info.manifest and module_info.manifest.model_definitions:
            if confirm_action(f"–£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–∞ '{module_name}' –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ [bold red]–ü–û–¢–ï–†–ï –í–°–ï–• –ï–ì–û –¢–ê–ë–õ–ò–¶ –í –ë–î[/]. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?", default_choice=False, abort_on_false=True):
                data_cleaned_successfully = await _clean_tables_module_async_internal(module_name, loader, called_from_uninstall=True)
                if not data_cleaned_successfully:
                    console.print(f"[bold red]–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–∞ '{module_name}'.[/]")
                    if not confirm_action("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–ª–∞–≥–∏–Ω–∞, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö?", default_choice=False, abort_on_false=True):
                        console.print("[bold yellow]–£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–º–µ–Ω–µ–Ω–æ.[/bold yellow]")
                        raise typer.Exit(code=1)
            else: # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è —É–¥–∞–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ
                data_cleaned_successfully = False # –î–∞–Ω–Ω—ã–µ –Ω–µ —É–¥–∞–ª–µ–Ω—ã –ø–æ —Ä–µ—à–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                console.print("[yellow]–£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–º–µ–Ω–µ–Ω–æ. –§–∞–π–ª—ã –ø–ª–∞–≥–∏–Ω–∞ –≤—Å–µ –µ—â–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã (–µ—Å–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ).[/yellow]")
        else: # –ù–µ—Ç –º–æ–¥–µ–ª–µ–π –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ
             console.print(f"[dim]–ü–ª–∞–≥–∏–Ω '{module_name}' –Ω–µ –¥–µ–∫–ª–∞—Ä–∏—Ä—É–µ—Ç –º–æ–¥–µ–ª–∏ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ. –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–±–ª–∏—Ü) –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.[/dim]")
             # data_cleaned_successfully –æ—Å—Ç–∞–µ—Ç—Å—è True
    else:
        console.print(f"\n[yellow]–î–∞–Ω–Ω—ã–µ –ø–ª–∞–≥–∏–Ω–∞ '{module_name}' (—Ç–∞–±–ª–∏—Ü—ã –ë–î) –Ω–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã (–æ–ø—Ü–∏—è --keep-data).[/yellow]")
        data_cleaned_successfully = False # –î–∞–Ω–Ω—ã–µ –Ω–µ —É–¥–∞–ª—è–ª–∏—Å—å

    console.print(f"\n–î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞ '{module_name}' (—É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ enabled_modules.json)...")
    enabled_modules_file_path = loader._settings.core.enabled_modules_config_path
    if module_name in loader.enabled_plugin_names:
        new_enabled_list = [m for m in loader.enabled_plugin_names if m != module_name]
        if _save_enabled_modules(new_enabled_list, enabled_modules_file_path):
            console.print(f"[green]–ü–ª–∞–≥–∏–Ω '{module_name}' —É—Å–ø–µ—à–Ω–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.[/]")
        else:
            console.print(f"[bold red]–û—à–∏–±–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–ª–∞–≥–∏–Ω–∞ '{module_name}' (–Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å enabled_modules.json).[/]")
            if not confirm_action("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–ª–∞–≥–∏–Ω–∞, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏?", default_choice=False, abort_on_false=True):
                console.print("[bold yellow]–£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–º–µ–Ω–µ–Ω–æ.[/bold yellow]")
                raise typer.Exit(code=1)
    else:
        console.print(f"[dim]–ü–ª–∞–≥–∏–Ω '{module_name}' –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω.[/dim]")

    module_dir_path = module_info.path
    console.print(f"\n–£–¥–∞–ª–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–ª–∞–≥–∏–Ω–∞: [cyan]{module_dir_path}[/]")
    if not confirm_action(f"[bold red]–ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –£–¥–∞–ª–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é '{module_dir_path}'? –≠—Ç–æ –ù–ï–û–ë–†–ê–¢–ò–ú–û.[/bold red]", default_choice=False, abort_on_false=True):
        return

    try:
        shutil.rmtree(module_dir_path)
        console.print(f"[bold green]–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø–ª–∞–≥–∏–Ω–∞ '{module_dir_path}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.[/]")
    except Exception as e_rmtree:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ '{module_dir_path}': {e_rmtree}[/]")
        raise typer.Exit(code=1)

    console.print(f"\n[bold green]–ü–ª–∞–≥–∏–Ω '{module_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.[/]")
    if remove_data and not data_cleaned_successfully: # –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –æ–Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å
         console.print("[bold yellow]–û–¥–Ω–∞–∫–æ, –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–∞ (—Ç–∞–±–ª–∏—Ü) –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.[/bold yellow]")
    elif not remove_data: # –ï—Å–ª–∏ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        console.print("[dim](–î–∞–Ω–Ω—ã–µ –ø–ª–∞–≥–∏–Ω–∞ –Ω–µ —É–¥–∞–ª—è–ª–∏—Å—å).[/dim]")
    console.print("–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∏–ª–∏ –≤ —Å–∏–ª—É.")

SHOP_COMMANDS_WIP_MSG = "[yellow]–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è '–º–∞–≥–∞–∑–∏–Ω–∞' –º–æ–¥—É–ª–µ–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.[/]"
SYNC_DEPS_WIP_MSG = """
[yellow]–ö–æ–º–∞–Ω–¥–∞ 'module sync-deps' –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.[/]
[yellow]–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `pip-tools` –¥–ª—è —Å–±–æ—Ä–∞ –∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π.[/]
"""
@module_app.command(name="list-available", help="–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥—É–ª–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û).")
def list_available_modules_cmd(): console.print(SHOP_COMMANDS_WIP_MSG)
@module_app.command(name="install", help="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û).")
def install_module_cmd(module_name: str = typer.Argument(..., help="–ò–º—è –º–æ–¥—É–ª—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏.")): console.print(SHOP_COMMANDS_WIP_MSG)
@module_app.command(name="update", help="–û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–ù–ï –†E–ê–õ–ò–ó–û–í–ê–ù–û).")
def update_module_cmd(module_name: str = typer.Argument(..., help="–ò–º—è –º–æ–¥—É–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∏–ª–∏ '--all'."), force: bool = typer.Option(False, "--force", help="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.")): console.print(SHOP_COMMANDS_WIP_MSG)
@module_app.command(name="sync-deps", help="–°–æ–±—Ä–∞—Ç—å Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–æ–¥—É–ª–µ–π (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û).")
def sync_deps_cmd(): console.print(SYNC_DEPS_WIP_MSG)

if __name__ == "__main__":
    module_app()


======================================================================

------------------------------ FILE: cli_commands/user_cmd.py ------------------------------
# cli_commands/user_cmd.py


import typer
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from rich.text import Text # –î–ª—è –±–æ–ª–µ–µ –≥–∏–±–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
import asyncio
from typing import Optional, List, Any, Tuple

from .cli_utils import get_sdb_services_for_cli # –ù–∞—à–∞ —É—Ç–∏–ª–∏—Ç–∞

console = Console()
user_app = typer.Typer(
    name="user",
    help="üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ SDB –∏ –∏—Ö —Ä–æ–ª—è–º–∏ (RBAC).",
    rich_markup_mode="rich",
    no_args_is_help=True  # <--- –î–û–ë–ê–í–õ–ï–ù–û
)

# --- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–æ–º–∞–Ω–¥ ---

async def _list_users_cmd_async(limit: int, offset: int, sort_by: str, sort_desc: bool):
    panel_title = "[bold blue]–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π SwiftDevBot[/]"
    settings, db_m, _ = None, None, None # rbac_s –∑–¥–µ—Å—å –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞
    try:
        settings, db_m, _ = await get_sdb_services_for_cli(init_db=True, init_rbac=False)
        if not (settings and db_m):
            console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å DBManager –¥–ª—è –∫–æ–º–∞–Ω–¥—ã 'user list'.[/]")
            raise typer.Exit(code=1)

        async with db_m.get_session() as session:
            from core.database.core_models import User
            from sqlalchemy import select, func as sql_func, desc, asc
            from sqlalchemy.orm import selectinload

            count_stmt = select(sql_func.count(User.id))
            total_users_result = await session.execute(count_stmt)
            total_users = total_users_result.scalar_one_or_none() or 0

            if total_users == 0:
                console.print(Panel("[yellow]–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.[/yellow]", title=panel_title))
                return

            # –õ–æ–≥–∏–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            order_column = getattr(User, sort_by, User.id) # –î–µ—Ñ–æ–ª—Ç –ø–æ id, –µ—Å–ª–∏ –∞—Ç—Ä–∏–±—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
            order_expression = desc(order_column) if sort_desc else asc(order_column)

            stmt = (
                select(User)
                .options(selectinload(User.roles))
                .order_by(order_expression)
                .limit(limit)
                .offset(offset)
            )
            result = await session.execute(stmt)
            users: List[User] = list(result.scalars().all())

            if not users and total_users > 0 : # –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –Ω–æ –Ω–µ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                console.print(Panel(
                    f"[yellow]–ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (—Å–º–µ—â–µ–Ω–∏–µ {offset}, –ª–∏–º–∏—Ç {limit}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç, –Ω–æ –≤—Å–µ–≥–æ –≤ –ë–î: {total_users}.[/yellow]",
                    title=panel_title
                ))
                return
            elif not users: # –≠—Ç–æ —É—Å–ª–æ–≤–∏–µ —É–∂–µ –ø–æ–∫—Ä—ã—Ç–æ –≤—ã—à–µ, –Ω–æ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
                console.print(Panel("[yellow]–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.[/yellow]", title=panel_title))
                return


            table_title = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ SDB (–ü–æ–∫–∞–∑–∞–Ω–æ: {len(users)} –∏–∑ {total_users}, –õ–∏–º–∏—Ç: {limit}, –°–º–µ—â–µ–Ω–∏–µ: {offset}, –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: {sort_by} {'DESC' if sort_desc else 'ASC'})"
            table = Table(title=table_title, show_header=True, header_style="bold magenta", expand=True)
            table.add_column("DB ID", style="dim cyan", justify="right", no_wrap=True)
            table.add_column("TG ID", style="cyan", justify="right", no_wrap=True)
            table.add_column("–ü–æ–ª–Ω–æ–µ –ò–º—è", min_width=20)
            table.add_column("Username", style="yellow", no_wrap=True)
            table.add_column("–†–æ–ª–∏", min_width=15)
            table.add_column("–Ø–∑—ã–∫", justify="center", no_wrap=True)
            table.add_column("–ê–∫—Ç–∏–≤–µ–Ω", justify="center", no_wrap=True)
            table.add_column("–ë–æ—Ç –±–ª–æ–∫.", justify="center", no_wrap=True)
            table.add_column("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", no_wrap=True)
            table.add_column("–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", no_wrap=True)

            for user_obj in users:
                roles_str = ", ".join(sorted([role.name for role in user_obj.roles])) if user_obj.roles else "-"
                active_str = "‚úÖ" if user_obj.is_active else "‚ùå"
                blocked_str = "üö´" if user_obj.is_bot_blocked else "‚úÖ"
                created_at_str = user_obj.created_at.strftime('%Y-%m-%d %H:%M') if user_obj.created_at else "-"
                last_activity_str = user_obj.last_activity_at.strftime('%Y-%m-%d %H:%M') if user_obj.last_activity_at else "-"

                table.add_row(
                    str(user_obj.id), str(user_obj.telegram_id), user_obj.full_name,
                    f"@{user_obj.username}" if user_obj.username else "-",
                    roles_str,
                    user_obj.preferred_language_code or "-",
                    active_str,
                    blocked_str,
                    created_at_str,
                    last_activity_str
                )
            console.print(Panel(table, title=panel_title, border_style="blue", padding=(1,1)))
    finally:
        if db_m: await db_m.dispose()

async def _find_user_interactive(session: Any, identifier: str) -> Optional[Any]: # User
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID –∏–ª–∏ username."""
    from core.database.core_models import User
    from sqlalchemy import select
    from sqlalchemy.orm import selectinload

    user: Optional[User] = None
    if identifier.isdigit():
        user_id_int = int(identifier)
        stmt = select(User).options(selectinload(User.roles)).where(User.telegram_id == user_id_int)
        result = await session.execute(stmt)
        user = result.scalars().first()
        if user: return user
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ TG ID, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ DB ID
        stmt_db_id = select(User).options(selectinload(User.roles)).where(User.id == user_id_int)
        result_db_id = await session.execute(stmt_db_id)
        user = result_db_id.scalars().first()
        if user: return user

    # –ï—Å–ª–∏ –Ω–µ —á–∏—Å–ª–æ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ ID, –∏—â–µ–º –ø–æ username (–±–µ–∑ @)
    username_to_search = identifier.lstrip('@')
    stmt_uname = select(User).options(selectinload(User.roles)).where(User.username_lower == username_to_search.lower())
    # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å –∫–æ–ª–æ–Ω–∫–∞ username_lower –∏–ª–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å ILIKE –¥–ª—è PostgreSQL/–¥—Ä—É–≥–∏—Ö –ë–î
    # –î–ª—è SQLite —ç—Ç–æ –±—É–¥–µ—Ç WHERE lower(username) = lower(:username_to_search)
    # –ß—Ç–æ–±—ã —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ –∫—Ä–æ—Å—Å-–°–£–ë–î –±–µ–∑ ILIKE, –ª—É—á—à–µ –∏–º–µ—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ username_lower –∏–ª–∏ –¥–µ–ª–∞—Ç—å lower() –≤ –∑–∞–ø—Ä–æ—Å–µ
    # stmt_uname = select(User).options(selectinload(User.roles)).where(func.lower(User.username) == username_to_search.lower())
    result_uname = await session.execute(stmt_uname)
    user = result_uname.scalars().first()
    return user


async def _info_user_cmd_async(user_identifier: str):
    settings, db_m, _ = None, None, None # rbac_s –∑–¥–µ—Å—å –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –∏–Ω—Ñ–æ
    try:
        settings, db_m, _ = await get_sdb_services_for_cli(init_db=True, init_rbac=False)
        if not (settings and db_m):
            console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å DBManager –¥–ª—è –∫–æ–º–∞–Ω–¥—ã 'user info'.[/]")
            raise typer.Exit(code=1)

        async with db_m.get_session() as session:
            user = await _find_user_interactive(session, user_identifier)

            if not user:
                console.print(f"[bold red]–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º '{user_identifier}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.[/]")
                raise typer.Exit(code=1)
            
            panel_title = f"[bold blue]–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: {user.full_name} (TG ID: {user.telegram_id})[/]"
            info_text = Text()
            info_text.append(f"DB ID: {user.id}\n", style="bold")
            info_text.append(f"Telegram ID: {user.telegram_id}\n", style="bold")
            info_text.append(f"–ü–æ–ª–Ω–æ–µ –∏–º—è: {user.full_name}\n")
            info_text.append(f"Username: @{user.username}\n" if user.username else "Username: -\n")
            info_text.append(f"–Ø–∑—ã–∫ –±–æ—Ç–∞: {user.preferred_language_code or '(–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)'}\n")
            info_text.append(f"–ê–∫—Ç–∏–≤–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ: {'–î–∞ ‚úÖ' if user.is_active else '–ù–µ—Ç ‚ùå'}\n")
            info_text.append(f"–ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {'–î–∞ üö´' if user.is_bot_blocked else '–ù–µ—Ç ‚úÖ'}\n")
            created_at_str = user.created_at.strftime('%Y-%m-%d %H:%M:%S %Z') if user.created_at and user.created_at.tzinfo else (user.created_at.strftime('%Y-%m-%d %H:%M:%S') if user.created_at else '-')
            updated_at_str = user.updated_at.strftime('%Y-%m-%d %H:%M:%S %Z') if user.updated_at and user.updated_at.tzinfo else (user.updated_at.strftime('%Y-%m-%d %H:%M:%S') if user.updated_at else '-')
            last_activity_str = user.last_activity_at.strftime('%Y-%m-%d %H:%M:%S %Z') if user.last_activity_at and user.last_activity_at.tzinfo else (user.last_activity_at.strftime('%Y-%m-%d %H:%M:%S') if user.last_activity_at else ' (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)')
            info_text.append(f"–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {created_at_str}\n")
            info_text.append(f"–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {updated_at_str}\n")
            info_text.append(f"–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {last_activity_str}\n")
            roles_str = ", ".join(sorted([role.name for role in user.roles])) if user.roles else " (–Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π)"
            info_text.append(f"–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {roles_str}\n", style="bold")
            
            console.print(Panel(info_text, title=panel_title, border_style="blue", padding=1))
    finally:
        if db_m: await db_m.dispose()

async def _list_roles_cmd_async():
    panel_title = "[bold blue]–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–æ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ SDB[/]"
    settings, db_m, rbac_s = None, None, None
    try:
        settings, db_m, rbac_s = await get_sdb_services_for_cli(init_db=True, init_rbac=True)
        if not (settings and db_m and rbac_s):
            console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å DBManager –∏ RBACService –¥–ª—è –∫–æ–º–∞–Ω–¥—ã 'user roles'.[/]")
            raise typer.Exit(code=1)

        async with db_m.get_session() as session:
            from core.database.core_models import Role # Role —É–∂–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ RBACService
            all_roles: List[Role] = await rbac_s.get_all_roles(session)

            if not all_roles:
                console.print(Panel("[yellow]–í —Å–∏—Å—Ç–µ–º–µ –Ω–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π.[/yellow]", title=panel_title))
                return

            table = Table(title="–°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–æ–ª–∏ SDB", show_header=True, header_style="bold magenta", expand=True)
            table.add_column("DB ID", style="dim cyan", justify="right", no_wrap=True)
            table.add_column("–ò–º—è –†–æ–ª–∏", style="cyan", min_width=15)
            table.add_column("–û–ø–∏—Å–∞–Ω–∏–µ", min_width=30, max_width=70, overflow="fold")
            
            for role_obj in all_roles:
                table.add_row(
                    str(role_obj.id), role_obj.name,
                    role_obj.description if role_obj.description else "-"
                )
            console.print(Panel(table, title=panel_title, border_style="blue", padding=(1,1)))
    finally:
        if db_m: await db_m.dispose()

async def _assign_role_cmd_async(user_identifier: str, role_name: str):
    console.print(f"–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å [cyan]'{role_name}'[/] –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é [cyan]'{user_identifier}'[/]...")
    settings, db_m, rbac_s = None, None, None
    try:
        settings, db_m, rbac_s = await get_sdb_services_for_cli(init_db=True, init_rbac=True)
        if not (settings and db_m and rbac_s):
            console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è 'user assign-role'.[/]")
            raise typer.Exit(code=1)

        async with db_m.get_session() as session:
            user_obj = await _find_user_interactive(session, user_identifier)
            if not user_obj:
                console.print(f"[bold red]–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{user_identifier}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]")
                raise typer.Exit(code=1)
            
            if await rbac_s.assign_role_to_user(session, user_obj, role_name):
                await session.commit()
                console.print(f"[bold green]–†–æ–ª—å '{role_name}' —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_obj.telegram_id} (@{user_obj.username}).[/]")
            else:
                # RBACService –¥–æ–ª–∂–µ–Ω –±—ã–ª –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏
                console.print(f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å '{role_name}' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_obj.telegram_id}. "
                              "–í–æ–∑–º–æ–∂–Ω–æ, —Ä–æ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ (—Å–º. –ª–æ–≥–∏).[/]")
                # –ù–µ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å rollback –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ assign_role_to_user –º–æ–≥ –¥–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å –≤ —Å–µ—Å—Å–∏—é, –Ω–æ –Ω–µ UserRole
                raise typer.Exit(code=1)
    finally:
        if db_m: await db_m.dispose()

async def _remove_role_cmd_async(user_identifier: str, role_name: str):
    console.print(f"–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å —Ä–æ–ª—å [cyan]'{role_name}'[/] —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [cyan]'{user_identifier}'[/]...")
    settings, db_m, rbac_s = None, None, None
    try:
        settings, db_m, rbac_s = await get_sdb_services_for_cli(init_db=True, init_rbac=True)
        if not (settings and db_m and rbac_s):
            console.print("[bold red]–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è 'user remove-role'.[/]")
            raise typer.Exit(code=1)

        async with db_m.get_session() as session:
            user_obj = await _find_user_interactive(session, user_identifier)
            if not user_obj:
                console.print(f"[bold red]–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{user_identifier}' –Ω–µ –Ω–∞–π–¥–µ–Ω.[/]")
                raise typer.Exit(code=1)

            if await rbac_s.remove_role_from_user(session, user_obj, role_name):
                await session.commit()
                console.print(f"[bold green]–†–æ–ª—å '{role_name}' —É—Å–ø–µ—à–Ω–æ —Å–Ω—è—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_obj.telegram_id} (@{user_obj.username}).[/]")
            else:
                console.print(f"[bold red]–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å —Ä–æ–ª—å '{role_name}' —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_obj.telegram_id}. "
                              "–í–æ–∑–º–æ–∂–Ω–æ, —Ä–æ–ª—å –Ω–µ –±—ã–ª–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ (—Å–º. –ª–æ–≥–∏).[/]")
                raise typer.Exit(code=1)
    finally:
        if db_m: await db_m.dispose()


# --- –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–±–µ—Ä—Ç–∫–∏ –¥–ª—è Typer ---

@user_app.command(name="list", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π SDB –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")
def list_users_cmd_wrapper(
    limit: int = typer.Option(20, "--limit", "-l", help="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.", min=1, max=200),
    offset: int = typer.Option(0, "--offset", "-o", help="–°–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.", min=0),
    sort_by: str = typer.Option("id", "--sort-by", help="–ü–æ–ª–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (id, telegram_id, username, first_name, last_name, created_at, last_activity_at).", case_sensitive=False),
    desc: bool = typer.Option(False, "--desc", help="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–±—ã–≤–∞–Ω–∏—é.")
):
    valid_sort_fields = ["id", "telegram_id", "username", "first_name", "last_name", "created_at", "last_activity_at"]
    if sort_by.lower() not in valid_sort_fields:
        console.print(f"[bold red]–û—à–∏–±–∫–∞: –ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è --sort-by: '{sort_by}'.[/]")
        console.print(f"–î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: {', '.join(valid_sort_fields)}")
        raise typer.Exit(code=1)
    try:
        asyncio.run(_list_users_cmd_async(limit=limit, offset=offset, sort_by=sort_by.lower(), sort_desc=desc))
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã 'user list': {type(e).__name__} - {e}[/]")
        # console.print_exception(show_locals=True) # –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        raise typer.Exit(code=1)

@user_app.command(name="info", help="–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø–æ –µ–≥–æ Telegram ID, DB ID –∏–ª–∏ Username.")
def info_user_cmd_wrapper(user_identifier: str = typer.Argument(..., help="Telegram ID, DB ID –∏–ª–∏ Username (@–Ω–∏–∫) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")):
    try:
        asyncio.run(_info_user_cmd_async(user_identifier=user_identifier))
    except typer.Exit: # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º Exit, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        raise
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã 'user info': {type(e).__name__} - {e}[/]")
        raise typer.Exit(code=1)

@user_app.command(name="roles", help="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–æ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ.")
def list_roles_cmd_wrapper():
    try:
        asyncio.run(_list_roles_cmd_async())
    except Exception as e:
        console.print(f"[bold red]–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã 'user roles': {type(e).__name__} - {e}[/]")
        raise typer.Exit(code=1)

@user_app.command(name="assign-role", help="–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.")
def assign_role_cmd_wrapper(
    user_identifier: str = typer.Argument(..., help="Telegram ID, DB ID –∏–ª–∏ Username (@–Ω–∏–∫) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."),
    role_name: str = typer.Argument(..., help="–ò–º—è —Ä–æ–ª–∏ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'Admin', 'User').")
):
    try:
        asyncio.run(_assign_role_cmd_async(user_identifier=user_identifier, role_name=role_name))
    except typer.Exit: raise
    except Exception as e:
        # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —É–∂–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ _assign_role_cmd_async
        raise typer.Exit(code=1)

@user_app.command(name="remove-role", help="–°–Ω—è—Ç—å —Ä–æ–ª—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
def remove_role_cmd_wrapper(
    user_identifier: str = typer.Argument(..., help="Telegram ID, DB ID –∏–ª–∏ Username (@–Ω–∏–∫) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."),
    role_name: str = typer.Argument(..., help="–ò–º—è —Ä–æ–ª–∏ –¥–ª—è —Å–Ω—è—Ç–∏—è.")
):
    try:
        asyncio.run(_remove_role_cmd_async(user_identifier=user_identifier, role_name=role_name))
    except typer.Exit: raise
    except Exception as e:
        raise typer.Exit(code=1)


======================================================================

------------------------------ FILE: cli_commands/__init__.py ------------------------------
# cli_commands/__init__.py
# –î–µ–ª–∞–µ—Ç cli_commands –ø–∞–∫–µ—Ç–æ–º


======================================================================

------------------------------ FILE: core/services_provider.py ------------------------------
# core/services_provider.py

from typing import Optional, TYPE_CHECKING

from loguru import logger as global_logger 

if TYPE_CHECKING:
    from core.app_settings import AppSettings
    from core.database.manager import DBManager
    from core.cache.manager import CacheManager
    from core.http_client.manager import HTTPClientManager
    from core.module_loader import ModuleLoader
    from core.events.dispatcher import EventDispatcher
    from core.ui.registry_ui import UIRegistry
    from core.rbac.service import RBACService
    from core.users.service import UserService


class BotServicesProvider:
    def __init__(self, settings: 'AppSettings'):
        self._settings: 'AppSettings' = settings
        self._logger = global_logger.bind(service="BotServicesProvider")

        self._db_manager: Optional['DBManager'] = None
        self._cache_manager: Optional['CacheManager'] = None
        self._http_client_manager: Optional['HTTPClientManager'] = None
        self._module_loader: Optional['ModuleLoader'] = None
        self._event_dispatcher: Optional['EventDispatcher'] = None
        self._ui_registry: Optional['UIRegistry'] = None
        self._rbac_service: Optional['RBACService'] = None
        self._user_service: Optional['UserService'] = None

        self._logger.info(f"BotServicesProvider —Å–æ–∑–¥–∞–Ω (–≤–µ—Ä—Å–∏—è SDB: {settings.core.sdb_version}). –û–∂–∏–¥–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤.")

    async def setup_services(self) -> None:
        self._logger.info("–ù–∞—á–∞–ª–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ SDB...")
        
        from core.database.manager import DBManager 
        try:
            self._db_manager = DBManager(db_settings=self._settings.db, app_settings=self._settings)
            await self._db_manager.initialize() 
            self._logger.success("–°–µ—Ä–≤–∏—Å DBManager —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
        except Exception as e:
            self._logger.critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ DBManager: {e}", exc_info=True)
            raise

        # –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ModuleLoader, —Ç–∞–∫ –∫–∞–∫ RBACService –º–æ–∂–µ—Ç –æ—Ç –Ω–µ–≥–æ –∑–∞–≤–∏—Å–µ—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π
        from core.module_loader import ModuleLoader 
        try:
            self._module_loader = ModuleLoader(settings=self._settings, services_provider=self)
            self._module_loader.scan_all_available_modules() 
            self._module_loader._load_enabled_plugin_names() 
            self._logger.success(f"–°–µ—Ä–≤–∏—Å ModuleLoader –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–Ω–∞–π–¥–µ–Ω–æ {len(self._module_loader.available_modules)} –º–æ–¥—É–ª–µ–π, "
                                 f"–∞–∫—Ç–∏–≤–Ω–æ –ø–ª–∞–≥–∏–Ω–æ–≤ {len(self._module_loader.enabled_plugin_names)}).")
        except Exception as e_mod_load:
            self._logger.critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ModuleLoader: {e_mod_load}", exc_info=True)
            raise 

        from core.rbac.service import RBACService 
        try:
            # –ü–µ—Ä–µ–¥–∞–µ–º self (BotServicesProvider) –≤ RBACService
            self._rbac_service = RBACService(services=self) # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨
            if self._db_manager and self._rbac_service:
                try:
                    async with self._db_manager.get_session() as db_session:
                        # –í—ã–∑—ã–≤–∞–µ–º ensure_default_entities_exist
                        roles_c, core_perms_c, mod_perms_c = await self._rbac_service.ensure_default_entities_exist(db_session) # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨
                        self._logger.info(f"RBACService.ensure_default_entities_exist –æ—Ç—Ä–∞–±–æ—Ç–∞–ª. "
                                          f"–†–æ–ª–µ–π —Å–æ–∑–¥–∞–Ω–æ: {roles_c}, –†–∞–∑—Ä–µ—à–µ–Ω–∏–π —è–¥—Ä–∞: {core_perms_c}, –†–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π: {mod_perms_c}")
                except Exception as e_roles:
                    self._logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö RBAC —Å—É—â–Ω–æ—Å—Ç–µ–π: {e_roles}", exc_info=True)
            self._logger.success("–°–µ—Ä–≤–∏—Å RBACService —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
        except ValueError as e_rbac_val: # –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ DBManager –Ω–µ –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ RBACService (–≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å DBManager –∏–ª–∏ ModuleLoader): {e_rbac_val}")
            self._rbac_service = None
        except Exception as e_rbac:
            self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å RBACService: {e_rbac}", exc_info=True)
            self._rbac_service = None 

        from core.users.service import UserService
        try:
            self._user_service = UserService(services_provider=self) 
            self._logger.success("–°–µ—Ä–≤–∏—Å UserService —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
        except Exception as e_user_svc:
            self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å UserService: {e_user_svc}", exc_info=True)
            self._user_service = None
        
        from core.cache.manager import CacheManager 
        try:
            self._cache_manager = CacheManager(cache_settings=self._settings.cache)
            await self._cache_manager.initialize()
            if self._cache_manager.is_available():
                 self._logger.success(f"–°–µ—Ä–≤–∏—Å CacheManager ({self._settings.cache.type}) —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
            else:
                 self._logger.warning(f"CacheManager ({self._settings.cache.type}) –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–æ –∫—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
        except ImportError as e_cache_imp: 
             self._logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å CacheManager: {e_cache_imp}")
        except Exception as e_cache:
            self._logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CacheManager: {e_cache}", exc_info=True)
            self._cache_manager = None

        from core.http_client.manager import HTTPClientManager 
        try:
            self._http_client_manager = HTTPClientManager(app_settings=self._settings) 
            await self._http_client_manager.initialize()
            if self._http_client_manager.is_available():
                self._logger.success("–°–µ—Ä–≤–∏—Å HTTPClientManager —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
            else:
                self._logger.warning("HTTPClientManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–æ HTTP-–∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
        except ImportError as e_http_imp: 
            self._logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å HTTPClientManager: {e_http_imp}")
        except Exception as e_http:
            self._logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ HTTPClientManager: {e_http}", exc_info=True)
            self._http_client_manager = None

        from core.events.dispatcher import EventDispatcher 
        try:
            self._event_dispatcher = EventDispatcher()
            self._logger.success("–°–µ—Ä–≤–∏—Å EventDispatcher —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e_event:
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ EventDispatcher: {e_event}", exc_info=True)
            self._event_dispatcher = None

        from core.ui.registry_ui import UIRegistry 
        try:
            self._ui_registry = UIRegistry()
            self._logger.success("–°–µ—Ä–≤–∏—Å UIRegistry —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        except Exception as e_ui_reg:
            self._logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ UIRegistry: {e_ui_reg}", exc_info=True)
            self._ui_registry = None
        
        # ModuleLoader —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤—ã—à–µ

        self._logger.info("‚úÖ –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ SDB –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")


    async def close_services(self) -> None:
        self._logger.info("–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∑–∞–∫—Ä—ã—Ç–∏—è –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤ SDB...")
        
        if self._module_loader: self._logger.debug("ModuleLoader –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        if self._ui_registry:
            try: await self._ui_registry.dispose(); self._logger.info("UIRegistry —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã.")
            except Exception as e: self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ UIRegistry: {e}", exc_info=True)
        if self._event_dispatcher:
            try: await self._event_dispatcher.dispose(); self._logger.info("EventDispatcher —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã.")
            except Exception as e: self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ EventDispatcher: {e}", exc_info=True)
        if self._http_client_manager:
            try: await self._http_client_manager.dispose(); self._logger.info("HTTPClientManager —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã.")
            except Exception as e: self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ HTTPClientManager: {e}", exc_info=True)
        if self._cache_manager:
            try: await self._cache_manager.dispose(); self._logger.info("CacheManager —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã.")
            except Exception as e: self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ CacheManager: {e}", exc_info=True)
        
        if self._user_service: self._logger.debug("UserService –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        if self._rbac_service: self._logger.debug("RBACService –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ dispose().")
        
        if self._db_manager:
            try: await self._db_manager.dispose(); self._logger.info("DBManager —Ä–µ—Å—É—Ä—Å—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã.")
            except Exception as e: self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ DBManager: {e}", exc_info=True)
        
        self._logger.info("üèÅ –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ SDB –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
    
    @property
    def config(self) -> 'AppSettings':
        return self._settings

    @property
    def logger(self):
        return global_logger 

    @property
    def db(self) -> 'DBManager':
        if self._db_manager is None:
            msg = "DBManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ë–î –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ."
            self._logger.critical(msg)
            raise RuntimeError(msg)
        return self._db_manager

    @property
    def rbac(self) -> 'RBACService':
        if self._rbac_service is None:
            msg = "RBACService –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –§—É–Ω–∫—Ü–∏–∏ RBAC –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."
            self._logger.error(msg) 
            raise AttributeError(msg) 
        return self._rbac_service
    
    @property
    def user_service(self) -> 'UserService':
        if self._user_service is None:
            msg = "UserService –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."
            self._logger.error(msg)
            raise AttributeError(msg)
        return self._user_service

    @property
    def cache(self) -> 'CacheManager':
        if self._cache_manager is None or not self._cache_manager.is_available():
            # msg = "CacheManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –∫—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!" # –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å, –µ—Å–ª–∏ –∫—ç—à –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω
            # self._logger.warning(msg)
            raise AttributeError("CacheManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –∫—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω! –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π –∫—ç—à.")
        return self._cache_manager

    @property
    def http(self) -> 'HTTPClientManager': 
        if self._http_client_manager is None or not self._http_client_manager.is_available():
            raise AttributeError("HTTPClientManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ HTTP-–∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω! –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π HTTP-–∫–ª–∏–µ–Ω—Ç.")
        return self._http_client_manager

    @property
    def modules(self) -> 'ModuleLoader': 
        if self._module_loader is None:
            msg = "ModuleLoader –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!" 
            self._logger.critical(msg)
            raise RuntimeError(msg)
        return self._module_loader

    @property
    def events(self) -> 'EventDispatcher':
        if self._event_dispatcher is None:
            msg = "EventDispatcher –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            self._logger.error(msg) 
            raise AttributeError(msg)
        return self._event_dispatcher
    
    @property
    def ui_registry(self) -> 'UIRegistry':
        if self._ui_registry is None:
            msg = "UIRegistry –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!"
            self._logger.error(msg)
            raise AttributeError(msg)
        return self._ui_registry


======================================================================

------------------------------ FILE: core/module_loader.py ------------------------------
# core/module_loader.py

import importlib
import importlib.util
import json
import sys
import asyncio
import shutil 
import re 
from pathlib import Path
from typing import Dict, List, Optional, Tuple, Type, Callable, Any, TYPE_CHECKING

import yaml # type: ignore
from aiogram import Dispatcher, Bot
from loguru import logger
from pydantic import ValidationError, BaseModel as PydanticBaseModel

# –î–æ–±–∞–≤–ª—è–µ–º PermissionManifest –≤ –∏–º–ø–æ—Ä—Ç—ã
from .schemas.module_manifest import ModuleManifest, SettingManifest, PermissionManifest 

if TYPE_CHECKING:
    from .app_settings import AppSettings, CoreAppSettings
    from .services_provider import BotServicesProvider

MANIFEST_YAML_NAME = "manifest.yaml"
MANIFEST_JSON_NAME = "manifest.json"
MODULE_ENTRY_POINT_FILENAME = "__init__.py"
SETUP_FUNCTION_NAME = "setup_module"
USER_MODULES_SETTINGS_DIR_NAME = "modules_settings"
MODULE_DEFAULT_SETTINGS_FILENAME = "module_settings.yaml" 


class ModuleInfo:
    def __init__(self, name: str, path: Path, manifest: Optional[ModuleManifest] = None, is_enabled: bool = False, error: Optional[str] = None, is_system_module: bool = False):
        self.name: str = name
        self.path: Path = path
        self.manifest: Optional[ModuleManifest] = manifest
        self.is_enabled: bool = is_enabled
        self.is_loaded_successfully: bool = False
        self.error: Optional[str] = error
        self.imported_py_module: Optional[Any] = None
        self.is_system_module: bool = is_system_module
        self.current_settings: Dict[str, Any] = {} 

    def __repr__(self) -> str:
        status_parts = []
        if self.is_system_module: status_parts.append("system")
        if self.is_enabled or self.is_system_module: status_parts.append("active_target")
        if self.is_loaded_successfully: status_parts.append("loaded")
        if self.current_settings: status_parts.append("settings_loaded")
        if self.error: status_parts.append(f"error='{self.error[:30]}...'")
        status_str = ", ".join(status_parts) if status_parts else "discovered"
        return f"<ModuleInfo name='{self.name}' ({status_str})>"

class ModuleLoader:
    def __init__(self, settings: 'AppSettings', services_provider: 'BotServicesProvider'):
        self._settings: 'AppSettings' = settings
        self._services: 'BotServicesProvider' = services_provider
        self._core_settings: 'CoreAppSettings' = self._settings.core
        
        self.plugins_root_dir: Path = settings.core.project_data_path.parent / "modules"
        self.core_sys_modules_root_dir: Path = settings.core.project_data_path.parent / "core" / "sys_modules"
        
        self.user_module_settings_base_path: Path = self._core_settings.project_data_path / "Config" / USER_MODULES_SETTINGS_DIR_NAME
        self.user_module_settings_base_path.mkdir(parents=True, exist_ok=True)

        self.available_modules: Dict[str, ModuleInfo] = {}
        self.enabled_plugin_names: List[str] = []

        self._logger = logger.bind(service="ModuleLoader")
        self._logger.info(f"ModuleLoader –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. "
                          f"–ü–ª–∞–≥–∏–Ω—ã: {self.plugins_root_dir.resolve()}, "
                          f"–°–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏: {self.core_sys_modules_root_dir.resolve()}, "
                          f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª–µ–π: {self.user_module_settings_base_path.resolve()}")

    def _parse_manifest_file(self, module_path: Path, module_name_override: Optional[str] = None) -> Optional[ModuleManifest]:
        yaml_manifest_path = module_path / MANIFEST_YAML_NAME
        json_manifest_path = module_path / MANIFEST_JSON_NAME
        manifest_file_to_parse: Optional[Path] = None
        parser_type: Optional[str] = None

        if yaml_manifest_path.is_file():
            manifest_file_to_parse = yaml_manifest_path
            parser_type = "yaml"
            if json_manifest_path.is_file():
                self._logger.warning(f"–í –º–æ–¥—É–ª–µ '{module_path.name}' –Ω–∞–π–¥–µ–Ω—ã –∏ YAML, –∏ JSON –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è YAML.")
        elif json_manifest_path.is_file():
            manifest_file_to_parse = json_manifest_path
            parser_type = "json"
        
        if not manifest_file_to_parse:
            is_plugin = not (module_path.parent.name == "sys_modules" and module_path.parent.parent.name == "core")
            log_func = self._logger.warning if is_plugin else self._logger.debug
            log_func(f"–ú–∞–Ω–∏—Ñ–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –º–æ–¥—É–ª—è '{module_path.name}'.")
            return None
        try:
            with open(manifest_file_to_parse, 'r', encoding='utf-8') as f:
                data = yaml.safe_load(f) if parser_type == "yaml" else json.load(f)
            if not data:
                self._logger.error(f"–ú–∞–Ω–∏—Ñ–µ—Å—Ç {manifest_file_to_parse.name} –≤ –º–æ–¥—É–ª–µ {module_path.name} –ø—É—Å—Ç."); return None
            
            if module_name_override and 'name' not in data:
                data['name'] = module_name_override
            elif 'name' in data and module_name_override and data['name'] != module_name_override:
                 self._logger.warning(f"–ò–º—è –º–æ–¥—É–ª—è –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ ('{data['name']}') –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∏–º–µ–Ω–∏ –ø–∞–ø–∫–∏ ('{module_name_override}') "
                                      f"–¥–ª—è {manifest_file_to_parse.name}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–º—è –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞: '{data['name']}'.")
            
            manifest = ModuleManifest(**data) 
            return manifest
        except Exception as e:
            self._logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞/–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ {manifest_file_to_parse.name} –≤ {module_path.name}: {e}", exc_info=True)
        return None

    def _scan_directory_for_modules(self, directory: Path, is_system_dir: bool) -> None:
        if not directory.is_dir():
            self._logger.warning(f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è {'—Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π' if is_system_dir else '–ø–ª–∞–≥–∏–Ω–æ–≤'} {directory} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return

        for module_dir_path in directory.iterdir():
            if module_dir_path.is_dir() and not module_dir_path.name.startswith(('.', '_')):
                module_name_from_path = module_dir_path.name
                manifest = self._parse_manifest_file(module_dir_path, module_name_override=module_name_from_path if is_system_dir else None)
                
                actual_module_name = manifest.name if manifest and manifest.name else module_name_from_path
                
                if actual_module_name in self.available_modules:
                    self._logger.warning(f"–î—É–±–ª–∏—Ä—É—é—â–µ–µ—Å—è –∏–º—è –º–æ–¥—É–ª—è '{actual_module_name}' (–∏–∑ –ø–∞–ø–∫–∏ '{module_dir_path.name}', "
                                         f"—Ç–∏–ø: {'—Å–∏—Å—Ç–µ–º–Ω—ã–π' if is_system_dir else '–ø–ª–∞–≥–∏–Ω'}). "
                                         f"–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥—É–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω –≤ —Å–ø–∏—Å–∫–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö.")
                
                module_info = ModuleInfo(
                    name=actual_module_name,
                    path=module_dir_path,
                    manifest=manifest,
                    is_system_module=is_system_dir,
                    is_enabled=is_system_dir 
                )
                
                if manifest and manifest.settings: 
                    self._load_and_validate_module_settings(module_info)

                self.available_modules[actual_module_name] = module_info
                log_msg_type = "—Å–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å" if is_system_dir else "–ø–ª–∞–≥–∏–Ω"
                log_msg_details = f"v{manifest.version}" if manifest and manifest.version else "–±–µ–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞/–≤–µ—Ä—Å–∏–∏"
                self._logger.info(f"–ù–∞–π–¥–µ–Ω {log_msg_type} '{actual_module_name}' ({log_msg_details}) –≤ '{module_dir_path.name}'.")

    def _load_and_validate_module_settings(self, module_info: ModuleInfo) -> None:
        module_name = module_info.name
        manifest = module_info.manifest 
        module_info.current_settings = {} 
        
        if not manifest or not manifest.settings: 
            return

        module_default_config_file = module_info.path / MODULE_DEFAULT_SETTINGS_FILENAME 
        user_module_config_file = self.user_module_settings_base_path / f"{module_name}.yaml"

        final_settings: Dict[str, Any] = {}
        for key, setting_mft_def in manifest.settings.items():
            final_settings[key] = setting_mft_def.default

        module_defaults_from_file: Dict[str, Any] = {}
        if module_default_config_file.is_file():
            try:
                with open(module_default_config_file, 'r', encoding='utf-8') as f:
                    module_defaults_from_file = yaml.safe_load(f) or {}
                final_settings.update(module_defaults_from_file)
                self._logger.trace(f"–ó–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ —Ñ–∞–π–ª–∞ –º–æ–¥—É–ª—è '{module_name}': {module_default_config_file}")
            except Exception as e:
                self._logger.warning(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ '{module_default_config_file}' –¥–ª—è –º–æ–¥—É–ª—è '{module_name}': {e}.")
        
        if not user_module_config_file.exists():
            self._logger.info(f"–§–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω ({user_module_config_file}).")
            source_for_user_config = final_settings.copy() 
            
            if source_for_user_config:
                try:
                    user_module_config_file.parent.mkdir(parents=True, exist_ok=True)
                    with open(user_module_config_file, 'w', encoding='utf-8') as f:
                        yaml.dump(source_for_user_config, f, indent=2, sort_keys=False, allow_unicode=True)
                    self._logger.info(f"–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è '{module_name}' –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–µ—Ñ–æ–ª—Ç–æ–≤: {user_module_config_file}")
                except Exception as e_create_user_cfg:
                    self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è '{module_name}': {e_create_user_cfg}.")
            else:
                 self._logger.info(f"–î–ª—è –º–æ–¥—É–ª—è '{module_name}' –Ω–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞. –§–∞–π–ª –Ω–µ —Å–æ–∑–¥–∞–Ω.")
        else: 
            try:
                with open(user_module_config_file, 'r', encoding='utf-8') as f:
                    user_settings_from_file = yaml.safe_load(f) or {}
                self._logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' –∏–∑: {user_module_config_file}")
                final_settings.update(user_settings_from_file)
            except Exception as e_load_user:
                self._logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ '{user_module_config_file}' –¥–ª—è '{module_name}': {e_load_user}.")
        
        validated_settings: Dict[str, Any] = {}
        validation_errors: List[str] = []

        for key, setting_mft_def in manifest.settings.items():
            value_to_validate = final_settings.get(key) 

            if value_to_validate is None:
                if setting_mft_def.required:
                    validation_errors.append(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ '{setting_mft_def.label}' ({key}) –º–æ–¥—É–ª—è '{module_name}'.")
                    continue
                else:
                    validated_settings[key] = None
                    continue
            
            try:
                validated_value = value_to_validate
                if setting_mft_def.type == "bool":
                    if isinstance(value_to_validate, str):
                        validated_value = value_to_validate.lower() in ['true', '1', 'yes', 'on', 't']
                    else:
                        validated_value = bool(value_to_validate)
                elif setting_mft_def.type == "int": validated_value = int(value_to_validate)
                elif setting_mft_def.type == "float": validated_value = float(value_to_validate)
                elif setting_mft_def.type in ["string", "text"]: validated_value = str(value_to_validate)
                
                key_specific_errors = False
                if setting_mft_def.type == "string" and setting_mft_def.regex_validator:
                    if not re.fullmatch(setting_mft_def.regex_validator, str(validated_value)):
                        validation_errors.append(f"–ó–Ω–∞—á–µ–Ω–∏–µ '{validated_value}' –¥–ª—è '{key}' –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç regex: {setting_mft_def.regex_validator}"); key_specific_errors = True
                if setting_mft_def.type in ["int", "float"]:
                    if setting_mft_def.min_value is not None and validated_value < setting_mft_def.min_value: # type: ignore
                        validation_errors.append(f"–ó–Ω–∞—á–µ–Ω–∏–µ {validated_value} –¥–ª—è '{key}' < min ({setting_mft_def.min_value})"); key_specific_errors = True
                    if setting_mft_def.max_value is not None and validated_value > setting_mft_def.max_value: # type: ignore
                        validation_errors.append(f"–ó–Ω–∞—á–µ–Ω–∏–µ {validated_value} –¥–ª—è '{key}' > max ({setting_mft_def.max_value})"); key_specific_errors = True
                if setting_mft_def.type == "choice" and setting_mft_def.options:
                    option_values = [opt.value if isinstance(opt, PydanticBaseModel) else opt for opt in setting_mft_def.options]
                    if validated_value not in option_values:
                        validation_errors.append(f"–ó–Ω–∞—á–µ–Ω–∏–µ '{validated_value}' –¥–ª—è '{key}' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–æ–ø—É—Å—Ç–∏–º—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º ({option_values})."); key_specific_errors = True
                
                if not key_specific_errors:
                    validated_settings[key] = validated_value

            except (ValueError, TypeError) as e_val:
                validation_errors.append(f"–û—à–∏–±–∫–∞ —Ç–∏–ø–∞/–∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è '{key}' ('{value_to_validate}'): –æ–∂–∏–¥–∞–ª—Å—è {setting_mft_def.type}. {e_val}")
            except Exception as e_unknown_val:
                 validation_errors.append(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è '{key}': {e_unknown_val}")

        if validation_errors:
            error_message = f"–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–æ–¥—É–ª—è '{module_name}': {'; '.join(validation_errors)}"
            if module_info.error: module_info.error += f"; {error_message}"
            else: module_info.error = error_message
            self._logger.error(error_message)
        
        module_info.current_settings = validated_settings
        if validated_settings or not manifest.settings:
            self._logger.info(f"–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã.")
            if validated_settings: self._logger.debug(f"–ò—Ç–æ–≥–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è '{module_name}': {validated_settings}")
        else:
            self._logger.warning(f"–î–ª—è –º–æ–¥—É–ª—è '{module_name}' –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å/–ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Ö–æ—Ç—è –æ–Ω–∏ –æ–ø–∏—Å–∞–Ω—ã –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ.")

    def scan_all_available_modules(self) -> None:
        self.available_modules.clear()
        self._logger.info("–ù–∞—á–∞–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π...")
        self._scan_directory_for_modules(self.plugins_root_dir, is_system_dir=False)
        self._scan_directory_for_modules(self.core_sys_modules_root_dir, is_system_dir=True)
        self._logger.info(f"–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: {len(self.available_modules)}")

    def _load_enabled_plugin_names(self) -> None:
        config_file = self._core_settings.enabled_modules_config_path
        self.enabled_plugin_names.clear()
        if config_file.is_file():
            try:
                with open(config_file, 'r', encoding='utf-8') as f: data = json.load(f)
                if isinstance(data, list):
                    self.enabled_plugin_names = [m_name for m_name in data if isinstance(m_name, str)]
                elif isinstance(data, dict) and "active_modules" in data and isinstance(data["active_modules"], list):
                     self.enabled_plugin_names = [m_name for m_name in data["active_modules"] if isinstance(m_name, str)]
                else:
                    self._logger.error(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ {config_file}. –û–∂–∏–¥–∞–ª—Å—è —Å–ø–∏—Å–æ–∫ –∏–ª–∏ {{'active_modules': [...]}}.")
                
                for name, module_info in self.available_modules.items():
                    if not module_info.is_system_module:
                        module_info.is_enabled = name in self.enabled_plugin_names
                self._logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –∏–∑ {config_file}: {self.enabled_plugin_names}")
            except Exception as e:
                self._logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –∏–∑ {config_file}: {e}", exc_info=True)
        else:
            self._logger.warning(f"–§–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ {config_file} –Ω–µ –Ω–∞–π–¥–µ–Ω.")

    def _check_module_dependencies(self, module_info: ModuleInfo) -> bool:
        if not module_info.manifest: return True 
        if module_info.manifest.metadata and module_info.manifest.metadata.min_sdb_core_version:
            from packaging.version import parse as parse_version
            current_sdb_version_str = self._settings.core.sdb_version
            try:
                if parse_version(current_sdb_version_str) < parse_version(module_info.manifest.metadata.min_sdb_core_version):
                    module_info.error = (f"–¢—Ä–µ–±—É–µ—Ç—Å—è —è–¥—Ä–æ SDB v >= {module_info.manifest.metadata.min_sdb_core_version}, "
                                         f"—Ç–µ–∫—É—â–∞—è: {current_sdb_version_str}.")
                    self._logger.error(f"–ú–æ–¥—É–ª—å '{module_info.name}': {module_info.error}")
                    return False
            except Exception as e_ver:
                self._logger.error(f"–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π —è–¥—Ä–∞ –¥–ª—è '{module_info.name}': {e_ver}")
                module_info.error = "–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤–µ—Ä—Å–∏–∏ —è–¥—Ä–∞."
                return False
        
        if module_info.manifest.sdb_module_dependencies:
            for dep_name in module_info.manifest.sdb_module_dependencies:
                dep_info = self.available_modules.get(dep_name)
                if not dep_info or not (dep_info.is_enabled or dep_info.is_system_module) or not dep_info.is_loaded_successfully:
                    new_error_msg = f"–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–π –∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å '{dep_name}'."
                    module_info.error = (module_info.error + "; " if module_info.error else "") + new_error_msg
                    self._logger.error(f"–ú–æ–¥—É–ª—å '{module_info.name}': {new_error_msg}")
                    return False
        return True

    async def _setup_single_module(self, module_info: ModuleInfo, dp: Dispatcher, bot: Bot, import_base_path: str) -> None:
        if not module_info.manifest and not module_info.is_system_module: 
            module_info.error = "–ú–∞–Ω–∏—Ñ–µ—Å—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."; self._logger.error(f"–ü–ª–∞–≥–∏–Ω '{module_info.name}': {module_info.error}"); return
        
        if module_info.error: 
            self._logger.error(f"–ú–æ–¥—É–ª—å '{module_info.name}' –Ω–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑-–∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –æ—à–∏–±–∫–∏: {module_info.error}")
            return

        if not self._check_module_dependencies(module_info): return
        
        entry_point_py_file = module_info.path / MODULE_ENTRY_POINT_FILENAME
        if not entry_point_py_file.is_file():
            module_info.error = f"–§–∞–π–ª —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ '{MODULE_ENTRY_POINT_FILENAME}' –Ω–µ –Ω–∞–π–¥–µ–Ω."; self._logger.error(f"–ú–æ–¥—É–ª—å '{module_info.name}': {module_info.error}"); return
        try:
            import_path_str = f"{import_base_path}.{module_info.path.name}"
            self._logger.debug(f"–ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è '{module_info.name}' —á–µ—Ä–µ–∑ '{import_path_str}'...")
            loaded_py_module = importlib.import_module(import_path_str)
            module_info.imported_py_module = loaded_py_module
            if not hasattr(loaded_py_module, SETUP_FUNCTION_NAME):
                module_info.error = f"–§—É–Ω–∫—Ü–∏—è '{SETUP_FUNCTION_NAME}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."; self._logger.error(f"–ú–æ–¥—É–ª—å '{module_info.name}': {module_info.error}"); return
            
            setup_function: Callable = getattr(loaded_py_module, SETUP_FUNCTION_NAME)
            self._logger.info(f"–í—ã–∑–æ–≤ {SETUP_FUNCTION_NAME}() –¥–ª—è –º–æ–¥—É–ª—è '{module_info.name}'...")
            if asyncio.iscoroutinefunction(setup_function): await setup_function(dp=dp, bot=bot, services=self._services)
            else: setup_function(dp=dp, bot=bot, services=self._services)
            module_info.is_loaded_successfully = True
            self._logger.success(f"‚úÖ –ú–æ–¥—É–ª—å '{module_info.name}' —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
        except Exception as e:
            module_info.error = f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏: {e}"; self._logger.error(f"–ú–æ–¥—É–ª—å '{module_info.name}': {module_info.error}", exc_info=True)

    async def initialize_and_setup_modules(self, dp: Dispatcher, bot: Bot) -> None:
        self.scan_all_available_modules() 
        self._load_enabled_plugin_names()
        
        # –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ —è–¥—Ä–∞
        self._logger.info("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —è–¥—Ä–∞...")
        for module_name, module_info in self.available_modules.items():
            if module_info.is_system_module:
                if module_info.error:
                    self._logger.error(f"–°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å '{module_name}' –Ω–µ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–∑-–∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –æ—à–∏–±–∫–∏: {module_info.error}")
                    continue
                await self._setup_single_module(module_info, dp, bot, import_base_path=self.core_sys_modules_root_dir.parent.name + "." + self.core_sys_modules_root_dir.name)
        self._logger.info("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —è–¥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
        
        if not self.enabled_plugin_names: self._logger.info("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.")
        else:
            self._logger.info(f"–ù–∞—Å—Ç—Ä–æ–π–∫–∞ {len(self.enabled_plugin_names)} –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤...")
            for plugin_name in self.enabled_plugin_names:
                module_info = self.available_modules.get(plugin_name)
                if not module_info: self._logger.error(f"–ê–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–≥–∏–Ω '{plugin_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫."); continue
                if module_info.is_system_module: self._logger.warning(f"–ú–æ–¥—É–ª—å '{plugin_name}' —Å–∏—Å—Ç–µ–º–Ω—ã–π, –Ω–æ –≤ —Å–ø–∏—Å–∫–µ –ø–ª–∞–≥–∏–Ω–æ–≤. –ü—Ä–æ–ø—É—Å–∫."); continue
                if module_info.error: 
                    self._logger.error(f"–ú–æ–¥—É–ª—å '{plugin_name}' –Ω–µ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–∑-–∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –æ—à–∏–±–∫–∏: {module_info.error}")
                    continue
                await self._setup_single_module(module_info, dp, bot, import_base_path=self.plugins_root_dir.name)
            self._logger.info("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

    def get_module_info(self, module_name: str) -> Optional[ModuleInfo]:
        return self.available_modules.get(module_name)

    def get_all_modules_info(self) -> List[ModuleInfo]:
        return list(self.available_modules.values())

    def get_loaded_modules_info(self, include_system: bool = True, include_plugins: bool = True) -> List[ModuleInfo]:
        loaded = []
        for info in self.available_modules.values():
            if info.is_loaded_successfully:
                if (info.is_system_module and include_system) or \
                   (not info.is_system_module and include_plugins):
                    loaded.append(info)
        return loaded
    
    def get_module_settings(self, module_name: str) -> Optional[Dict[str, Any]]:
        module_info = self.get_module_info(module_name)
        if module_info : 
            if module_info.current_settings:
                 return module_info.current_settings
            elif module_info.manifest and module_info.manifest.settings:
                 manifest_defaults = {
                     k: v.default for k, v in module_info.manifest.settings.items() 
                     if v.default is not None 
                 }
                 if manifest_defaults:
                    self._logger.debug(f"current_settings –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' –ø—É—Å—Ç—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç—ã –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞.")
                    return manifest_defaults
                 else: 
                    self._logger.debug(f"–ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –∏–º–µ–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ.")
                    return {} # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å, –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∏ current_settings, –Ω–∏ –¥–µ—Ñ–æ–ª—Ç–æ–≤ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ
            else: 
                self._logger.debug(f"–ú–æ–¥—É–ª—å '{module_name}' –Ω–µ –∏–º–µ–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ.")
                return {} # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å
        self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –º–æ–¥—É–ª—è '{module_name}'.")
        return None

    def get_all_declared_permissions_from_active_modules(self) -> List[PermissionManifest]:
        """
        –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö
        (enabled) –ø–ª–∞–≥–∏–Ω–æ–≤, –∞ —Ç–∞–∫–∂–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π.
        –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –º–æ–¥—É–ª–∏ –±–µ–∑ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞.
        """
        all_perms: Dict[str, PermissionManifest] = {} 

        modules_to_check: List[ModuleInfo] = []
        # –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã
        for module_name in self.enabled_plugin_names:
            module_info = self.available_modules.get(module_name)
            if module_info and not module_info.is_system_module and not module_info.error:
                modules_to_check.append(module_info)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏
        for module_info in self.available_modules.values():
            if module_info.is_system_module and not module_info.error:
                if module_info not in modules_to_check: # –ò–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å –∫–∞–∫-—Ç–æ –ø–æ–ø–∞–ª –≤ enabled_plugin_names
                    modules_to_check.append(module_info)

        for module_info in modules_to_check:
            if module_info.manifest and module_info.manifest.declared_permissions:
                for perm_mft in module_info.manifest.declared_permissions:
                    if perm_mft.name not in all_perms:
                        all_perms[perm_mft.name] = perm_mft
                    else:
                        self._logger.warning(f"–î—É–±–ª–∏—Ä—É—é—â–µ–µ—Å—è –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{perm_mft.name}' "
                                             f"–æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ (–º–æ–¥—É–ª—å: '{module_info.name}'). –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø–µ—Ä–≤–æ–µ –≤—Å—Ç—Ä–µ—á–µ–Ω–Ω–æ–µ.")
                                             
        num_perms = len(all_perms)
        if num_perms > 0:
            self._logger.info(f"–°–æ–±—Ä–∞–Ω–æ {num_perms} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã–º–∏/—Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –º–æ–¥—É–ª—è–º–∏.")
        else:
            self._logger.info("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö/—Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö.")
        return list(all_perms.values())


======================================================================

------------------------------ FILE: core/logging_manager.py ------------------------------
# core/logging_manager.py
import asyncio
import shutil
from pathlib import Path
from datetime import datetime, timedelta, timezone
from typing import Optional, Any, TYPE_CHECKING

from loguru import logger as global_logger 
import parsedatetime as pdt 
from apscheduler.schedulers.asyncio import AsyncIOScheduler 
from apscheduler.triggers.cron import CronTrigger

if TYPE_CHECKING:
    from core.app_settings import AppSettings

class LoggingManager:
    def __init__(self, app_settings: 'AppSettings'):
        self._settings = app_settings.core
        self._app_settings_ref = app_settings 
        self._current_log_handler_id: Optional[int] = None
        self._current_log_file_path: Optional[Path] = None
        self._scheduler: Optional[AsyncIOScheduler] = None
        self._is_initialized = False

        self._logger = global_logger.bind(service="LoggingManager")
        self._logger.info("LoggingManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    def _get_log_file_path_for_current_hour(self) -> Path:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—É—Ç—å –∫ –ª–æ–≥-—Ñ–∞–π–ª—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏."""
        now = datetime.now(timezone.utc)
        year_str = now.strftime("%Y")
        month_num_str = now.strftime("%m")
        month_name_str = now.strftime("%B") # –ò–º—è –º–µ—Å—è—Ü–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ª–æ–∫–∞–ª–∏ —Å–∏—Å—Ç–µ–º—ã
        day_str = now.strftime("%d")
        hour_str = now.strftime("%H")

        base_logs_dir = self._app_settings_ref.core.project_data_path / self._settings.log_structured_dir
        
        target_dir = base_logs_dir / year_str / f"{month_num_str}-{month_name_str}" / day_str
        target_dir.mkdir(parents=True, exist_ok=True)
        
        return target_dir / f"{hour_str}_sdb.log"

    def _setup_loguru_file_sink(self) -> None: 
        """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç (–∏–ª–∏ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç) —Ñ–∞–π–ª–æ–≤—ã–π sink –¥–ª—è Loguru."""
        if self._current_log_handler_id is not None:
            try:
                global_logger.remove(self._current_log_handler_id)
                self._logger.trace(f"–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–∞–π–ª–æ–≤—ã–π —Ö–µ–Ω–¥–ª–µ—Ä (ID: {self._current_log_handler_id}) —É–¥–∞–ª–µ–Ω.")
            except ValueError:
                self._logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–∞–π–ª–æ–≤—ã–π —Ö–µ–Ω–¥–ª–µ—Ä ID: {self._current_log_handler_id} (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —É–¥–∞–ª–µ–Ω).")
            self._current_log_handler_id = None
            self._current_log_file_path = None

        if not self._settings.log_to_file:
            self._logger.info("–ó–∞–ø–∏—Å—å –ª–æ–≥–æ–≤ –≤ —Ñ–∞–π–ª –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.")
            return

        new_log_file_path = self._get_log_file_path_for_current_hour()
        
        # --- –ñ–ï–°–¢–ö–û –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –£–†–û–í–ï–ù–¨ –î–õ–Ø –§–ê–ô–õ–û–í–û–ì–û –õ–û–ì–ê ---
        log_level_for_file = "DEBUG"  # –ò—Å–ø–æ–ª—å–∑—É–µ–º DEBUG –¥–ª—è —Ñ–∞–π–ª–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω TRACE, –∏–∑–º–µ–Ω–∏ –∑–¥–µ—Å—å:
        # log_level_for_file = "TRACE" 
        # ---------------------------------------------------------
        
        try:
            handler_id = global_logger.add(
                sink=str(new_log_file_path),
                level=log_level_for_file, 
                rotation=self._settings.log_rotation_size, 
                compression="zip",
                format="{time:YYYY-MM-DD HH:mm:ss.SSS} | {level: <8} | {name}:{function}:{line} - {message}",
                encoding="utf-8",
                enqueue=True,
                backtrace=True,
                diagnose=True 
            )
            self._current_log_handler_id = handler_id
            self._current_log_file_path = new_log_file_path
            self._logger.success(f"–§–∞–π–ª–æ–≤—ã–π –ª–æ–≥–≥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –£—Ä–æ–≤–µ–Ω—å: {log_level_for_file}. –§–∞–π–ª: {new_log_file_path}")
        except Exception as e:
            self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞ –¥–ª—è '{new_log_file_path}': {e}", exc_info=True)
            self._current_log_handler_id = None
            self._current_log_file_path = None

    async def _hourly_log_rotation_check(self) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ —Ä–æ—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥-—Ñ–∞–π–ª (–Ω–∞—á–∞–ª—Å—è –Ω–æ–≤—ã–π —á–∞—Å)."""
        self._logger.trace("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –µ–∂–µ—á–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤...")
        if not self._is_initialized or not self._settings.log_to_file:
            self._logger.trace("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –ø—Ä–æ–ø—É—â–µ–Ω–∞: –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª –æ—Ç–∫–ª—é—á–µ–Ω–æ.")
            return

        expected_log_file = self._get_log_file_path_for_current_hour()
        if self._current_log_file_path != expected_log_file:
            self._logger.info(f"–ù–∞—á–∞–ª—Å—è –Ω–æ–≤—ã–π —á–∞—Å. –ü–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞ –Ω–∞: {expected_log_file}")
            self._setup_loguru_file_sink() 
        else:
            self._logger.trace(f"–†–æ—Ç–∞—Ü–∏—è –ª–æ–≥-—Ñ–∞–π–ª–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª: {self._current_log_file_path}")

    async def _cleanup_old_logs(self) -> None:
        """–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ log_retention_period_structured."""
        self._logger.info("–ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤...")
        if not self._settings.log_to_file:
            self._logger.info("–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–∞: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª –æ—Ç–∫–ª—é—á–µ–Ω–æ.")
            return

        retention_str = self._settings.log_retention_period_structured
        cal = pdt.Calendar()
        
        now_dt = datetime.now(timezone.utc)
        past_target_dt, parse_status = cal.parseDT(f"{retention_str} ago", sourceTime=now_dt) # type: ignore
        
        if parse_status == 0 or not past_target_dt:
            self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –ø–µ—Ä–∏–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤: '{retention_str}'. –û—á–∏—Å—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
            return
        
        cutoff_date = past_target_dt 
        self._logger.info(f"–û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ —Å—Ç–∞—Ä—à–µ {cutoff_date.strftime('%Y-%m-%d %H:%M:%S %Z')} (–ø–µ—Ä–∏–æ–¥: '{retention_str}').")

        structured_logs_root = self._app_settings_ref.core.project_data_path / self._settings.log_structured_dir
        if not structured_logs_root.is_dir():
            return

        deleted_dirs_count = 0
        for year_dir in structured_logs_root.iterdir():
            if year_dir.is_dir() and year_dir.name.isdigit():
                if int(year_dir.name) < cutoff_date.year:
                    try:
                        shutil.rmtree(year_dir)
                        self._logger.info(f"–£–¥–∞–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (–≥–æ–¥): {year_dir}")
                        deleted_dirs_count += 1
                    except Exception as e_rm_year:
                        self._logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤ '{year_dir}': {e_rm_year}")
                    continue 

                if int(year_dir.name) == cutoff_date.year:
                    for month_dir in year_dir.iterdir():
                        if month_dir.is_dir() and "-" in month_dir.name:
                            try:
                                month_num_str = month_dir.name.split("-")[0]
                                if month_num_str.isdigit() and int(month_num_str) < cutoff_date.month:
                                    shutil.rmtree(month_dir)
                                    self._logger.info(f"–£–¥–∞–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (–º–µ—Å—è—Ü): {month_dir}")
                                    deleted_dirs_count +=1
                                    continue
                                
                                if int(month_num_str) == cutoff_date.month:
                                    for day_dir in month_dir.iterdir():
                                        if day_dir.is_dir() and day_dir.name.isdigit():
                                            if int(day_dir.name) < cutoff_date.day:
                                                shutil.rmtree(day_dir)
                                                self._logger.info(f"–£–¥–∞–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (–¥–µ–Ω—å): {day_dir}")
                                                deleted_dirs_count += 1
                            except Exception as e_rm_month_day:
                                self._logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤ '{month_dir}' –∏–ª–∏ –µ–µ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {e_rm_month_day}")
        if deleted_dirs_count > 0:
            self._logger.success(f"–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£–¥–∞–ª–µ–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π: {deleted_dirs_count}.")
        else:
            self._logger.info("–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–µ –Ω–∞–π–¥–µ–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")


    async def initialize_logging(self) -> None: 
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –≤–∫–ª—é—á–∞—è —Ñ–∞–π–ª–æ–≤—ã–π sink –∏ –∑–∞–¥–∞—á–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é."""
        if self._is_initialized:
            self._logger.info("LoggingManager —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
            return

        self._logger.info("–ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ LoggingManager...")
        
        self._setup_loguru_file_sink() 
        
        self._scheduler = AsyncIOScheduler(timezone=str(timezone.utc))
        self._scheduler.add_job(self._hourly_log_rotation_check, CronTrigger(minute=0)) 
        self._logger.info("–ó–∞–¥–∞—á–∞ _hourly_log_rotation_check –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (–µ–∂–µ—á–∞—Å–Ω–æ).")
        self._scheduler.add_job(self._cleanup_old_logs, CronTrigger(hour=3, minute=30)) 
        self._logger.info("–ó–∞–¥–∞—á–∞ _cleanup_old_logs –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:30 UTC).")
        
        try:
            self._scheduler.start()
            self._logger.success("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á LoggingManager —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω.")
        except Exception as e_scheduler_start:
            self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á LoggingManager: {e_scheduler_start}", exc_info=True)
            self._scheduler = None 

        self._is_initialized = True
        self._logger.info("LoggingManager —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    async def shutdown_logging(self) -> None:
        """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É."""
        self._logger.info("–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ LoggingManager...")
        if self._scheduler and self._scheduler.running:
            try:
                self._scheduler.shutdown(wait=False) 
                self._logger.info("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á LoggingManager –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
            except Exception as e_scheduler_shutdown:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ LoggingManager: {e_scheduler_shutdown}", exc_info=True)
        
        if self._current_log_handler_id is not None:
            try:
                global_logger.remove(self._current_log_handler_id)
                self._logger.info(f"–§–∞–π–ª–æ–≤—ã–π —Ö–µ–Ω–¥–ª–µ—Ä (ID: {self._current_log_handler_id}) —É–¥–∞–ª–µ–Ω –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ.")
            except ValueError:
                pass 
        
        self._is_initialized = False
        self._logger.info("LoggingManager –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")


======================================================================

------------------------------ FILE: core/__init__.py ------------------------------



======================================================================

------------------------------ FILE: core/app_settings.py ------------------------------
# core/app_settings.py

import os
import sys
import yaml
from pathlib import Path
from typing import List, Optional, Literal, Any, Dict 
from pydantic import BaseModel, Field, field_validator, HttpUrl, ValidationInfo, AliasChoices

try:
    from loguru import logger as global_logger 
except ImportError:
    import logging
    global_logger = logging.getLogger("sdb_app_settings_fallback")
    global_logger.warning("Loguru –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π logging. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Loguru.")

from dotenv import load_dotenv, find_dotenv
from pydantic.networks import PostgresDsn, MySQLDsn, AnyUrl 
from pydantic_settings import BaseSettings, SettingsConfigDict

PROJECT_ROOT_DIR = Path(__file__).resolve().parent.parent
ENV_FILENAME = ".env"
DEFAULT_PROJECT_DATA_DIR_NAME = "project_data" 
USER_CONFIG_DIR_NAME = "Config" 
USER_CONFIG_FILENAME = "core_settings.yaml"
ENABLED_MODULES_FILENAME = "enabled_modules.json" 
ROOT_CONFIG_TEMPLATE_FILENAME = "config.yaml" 
STRUCTURED_LOGS_ROOT_DIR_NAME = "Logs" 

env_file_path_for_dotenv = find_dotenv(filename=ENV_FILENAME, usecwd=True, raise_error_if_not_found=False)
BOT_TOKEN_FROM_DOTENV: Optional[str] = None
if env_file_path_for_dotenv and Path(env_file_path_for_dotenv).exists():
    global_logger.info(f"–ù–∞–π–¥–µ–Ω .env —Ñ–∞–π–ª –¥–ª—è python-dotenv: {env_file_path_for_dotenv}")
    load_dotenv(dotenv_path=env_file_path_for_dotenv, override=True)
    BOT_TOKEN_FROM_DOTENV = os.getenv("BOT_TOKEN")
    if BOT_TOKEN_FROM_DOTENV:
        global_logger.info(f"BOT_TOKEN ('****{BOT_TOKEN_FROM_DOTENV[-4:]}') –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ .env —Ñ–∞–π–ª–∞.")
    else:
        global_logger.warning(f"BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ {env_file_path_for_dotenv} –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ python-dotenv/os.getenv.")
else:
    env_file_at_root = PROJECT_ROOT_DIR / ENV_FILENAME
    if env_file_at_root.exists() and env_file_at_root.is_file():
        global_logger.info(f"–ù–∞–π–¥–µ–Ω .env —Ñ–∞–π–ª –¥–ª—è python-dotenv (–≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞): {env_file_at_root}")
        load_dotenv(dotenv_path=env_file_at_root, override=True)
        BOT_TOKEN_FROM_DOTENV = os.getenv("BOT_TOKEN")
        if BOT_TOKEN_FROM_DOTENV:
            global_logger.info(f"BOT_TOKEN ('****{BOT_TOKEN_FROM_DOTENV[-4:]}') —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω (–≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞).")
        else:
            global_logger.warning(f"BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ {env_file_at_root} (–≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞).")
    else:
        global_logger.warning(f".env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω python-dotenv. BOT_TOKEN –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å—Å—è –≤ YAML –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.")

class DBSettings(BaseModel):
    type: Literal["sqlite", "postgresql", "mysql"] = Field(default="sqlite", description="–¢–∏–ø –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")
    sqlite_path: str = Field(
        default=f"Database_files/swiftdevbot.db", 
        description="–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É SQLite (–æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ project_data_path)."
    )
    pg_dsn: Optional[PostgresDsn] = Field(default=None, description="DSN –¥–ª—è PostgreSQL.")
    mysql_dsn: Optional[MySQLDsn] = Field(default=None, description="DSN –¥–ª—è MySQL.")
    echo_sql: bool = Field(default=False, description="–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã SQLAlchemy (—É—Ä–æ–≤–µ–Ω—å DEBUG).")

    @field_validator('pg_dsn', mode='before')
    @classmethod
    def check_pg_dsn(cls, v: Optional[PostgresDsn], info: ValidationInfo) -> Optional[PostgresDsn]:
        if info.data.get('type') == "postgresql" and not v:
            raise ValueError("pg_dsn –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –¥–ª—è —Ç–∏–ø–∞ –ë–î 'postgresql'.")
        return v

    @field_validator('mysql_dsn', mode='before')
    @classmethod
    def check_mysql_dsn(cls, v: Optional[MySQLDsn], info: ValidationInfo) -> Optional[MySQLDsn]:
        if info.data.get('type') == "mysql" and not v:
            raise ValueError("mysql_dsn –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –¥–ª—è —Ç–∏–ø–∞ –ë–î 'mysql'.")
        return v

class CacheSettings(BaseModel):
    type: Literal["memory", "redis"] = Field(default="memory", description="–¢–∏–ø –∫—ç—à–∞.")
    redis_url: Optional[str] = Field(default="redis://localhost:6379/0", description="URL –¥–ª—è Redis.")

    @field_validator('redis_url', mode='before')
    @classmethod
    def check_redis_url(cls, v: Optional[str], info: ValidationInfo) -> Optional[str]:
        cache_type = info.data.get('type') if info.data else None
        if cache_type == "redis" and not v:
            raise ValueError("redis_url –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –¥–ª—è —Ç–∏–ø–∞ –∫—ç—à–∞ 'redis'.")
        return v

class TelegramSettings(BaseModel):
    token: str = Field(description="–¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–∫–∞–∑—ã–≤–∞—Ç—å –≤ .env).")
    polling_timeout: int = Field(default=30, ge=1, description="–¢–∞–π–º–∞—É—Ç long polling (—Å–µ–∫—É–Ω–¥—ã).")

class ModuleRepoSettings(BaseModel):
    index_url: Optional[HttpUrl] = Field(
        default=HttpUrl("https://raw.githubusercontent.com/soverxos/SwiftDevBot-Modules/main/modules_index.json"),
        description="URL –∫ JSON-–∏–Ω–¥–µ–∫—Å—É –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π SDB."
    )

class I18nSettings(BaseModel):
    locales_dir: Path = Field(default=PROJECT_ROOT_DIR / "locales", description="–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤.")
    domain: str = Field(default="bot", description="–ò–º—è –¥–æ–º–µ–Ω–∞ –¥–ª—è gettext.")
    default_locale: str = Field(default="en", description="–Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.")
    available_locales: List[str] = Field(default_factory=lambda: ["en", "ua"], description="–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —è–∑—ã–∫–æ–≤.")

class CoreAppSettings(BaseModel):
    project_data_path: Path = Field(
        default=PROJECT_ROOT_DIR / DEFAULT_PROJECT_DATA_DIR_NAME,
        description="–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞."
    )
    super_admins: List[int] = Field(default_factory=list, description="–°–ø–∏—Å–æ–∫ Telegram ID —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.")
    enabled_modules_config_path: Path = Field(
        default=Path(f"{USER_CONFIG_DIR_NAME}/{ENABLED_MODULES_FILENAME}"), 
        description="–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö)."
    )
    
    log_level: Literal["TRACE", "DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"] = Field(default="INFO")
    log_to_file: bool = Field(default=True)
    log_structured_dir: str = Field(
        default=STRUCTURED_LOGS_ROOT_DIR_NAME, 
        description="–ë–∞–∑–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥-—Ñ–∞–π–ª–æ–≤ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ project_data_path)."
    )
    log_rotation_size: str = Field(
        default="100 MB", 
        description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ –ª–æ–≥-—Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ —Ä–æ—Ç–∞—Ü–∏–µ–π (e.g., '100 MB')."
    ) 
    log_retention_period_structured: str = Field(
        default="3 months", 
        description="–ö–∞–∫ –¥–æ–ª–≥–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '30 days', '3 months', '1 year'). "
                    "–†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ–π –æ—á–∏—Å—Ç–∫–∏."
    )
    
    sdb_version: str = Field(default="0.1.0", pattern=r"^\d+\.\d+\.\d+([\w.-]*[\w])?(\+[\w.-]+)?$",
                             description="–í–µ—Ä—Å–∏—è —è–¥—Ä–∞ SwiftDevBot (SemVer-—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è).")
    
    setup_bot_commands_on_startup: bool = Field(default=True, description="–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.")
    i18n: I18nSettings = Field(default_factory=I18nSettings)

class EnvironmentSettings(BaseSettings):
    CORE_PROJECT_DATA_PATH: Optional[Path] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_PROJECT_DATA_PATH', 'CORE_PROJECT_DATA_PATH'))
    CORE_SUPER_ADMINS: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_SUPER_ADMINS', 'CORE_SUPER_ADMINS'))
    CORE_ENABLED_MODULES_CONFIG_PATH: Optional[Path] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_ENABLED_MODULES_CONFIG_PATH', 'CORE_ENABLED_MODULES_CONFIG_PATH'))
    CORE_LOG_LEVEL: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_LOG_LEVEL', 'CORE_LOG_LEVEL'))
    CORE_LOG_TO_FILE: Optional[bool] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_LOG_TO_FILE', 'CORE_LOG_TO_FILE'))
    
    SDB_CORE_LOG_STRUCTURED_DIR: Optional[str] = Field(default=None)
    SDB_CORE_LOG_ROTATION_SIZE: Optional[str] = Field(default=None)
    SDB_CORE_LOG_RETENTION_PERIOD_STRUCTURED: Optional[str] = Field(default=None)

    CORE_SDB_VERSION: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_CORE_SDB_VERSION', 'CORE_SDB_VERSION'))
    
    DB_TYPE: Optional[Literal["sqlite", "postgresql", "mysql"]] = Field(default=None, validation_alias=AliasChoices('SDB_DB_TYPE', 'DB_TYPE'))
    DB_SQLITE_PATH: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_DB_SQLITE_PATH', 'DB_SQLITE_PATH'))
    DB_PG_DSN: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_DB_PG_DSN', 'DB_PG_DSN')) 
    DB_MYSQL_DSN: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_DB_MYSQL_DSN', 'DB_MYSQL_DSN')) 
    DB_ECHO_SQL: Optional[bool] = Field(default=None, validation_alias=AliasChoices('SDB_DB_ECHO_SQL', 'DB_ECHO_SQL'))

    CACHE_TYPE: Optional[Literal["memory", "redis"]] = Field(default=None, validation_alias=AliasChoices('SDB_CACHE_TYPE', 'CACHE_TYPE'))
    CACHE_REDIS_URL: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_CACHE_REDIS_URL', 'CACHE_REDIS_URL'))
    
    TELEGRAM_POLLING_TIMEOUT: Optional[int] = Field(default=None, validation_alias=AliasChoices('SDB_TELEGRAM_POLLING_TIMEOUT', 'TELEGRAM_POLLING_TIMEOUT'))
    MODULE_REPO_INDEX_URL: Optional[HttpUrl] = Field(default=None, validation_alias=AliasChoices('SDB_MODULE_REPO_INDEX_URL', 'MODULE_REPO_INDEX_URL'))

    SDB_I18N_LOCALES_DIR: Optional[Path] = Field(default=None, validation_alias=AliasChoices('SDB_I18N_LOCALES_DIR', 'I18N_LOCALES_DIR'))
    SDB_I18N_DOMAIN: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_I18N_DOMAIN', 'I18N_DOMAIN'))
    SDB_I18N_DEFAULT_LOCALE: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_I18N_DEFAULT_LOCALE', 'I18N_DEFAULT_LOCALE'))
    SDB_I18N_AVAILABLE_LOCALES: Optional[str] = Field(default=None, validation_alias=AliasChoices('SDB_I18N_AVAILABLE_LOCALES', 'I18N_AVAILABLE_LOCALES'))

    model_config = SettingsConfigDict(
        env_file=None, 
        extra='ignore',
    )

class AppSettings(BaseModel):
    db: DBSettings = Field(default_factory=DBSettings)
    cache: CacheSettings = Field(default_factory=CacheSettings)
    telegram: TelegramSettings
    module_repo: ModuleRepoSettings = Field(default_factory=ModuleRepoSettings)
    core: CoreAppSettings = Field(default_factory=CoreAppSettings)
    model_config = {"validate_assignment": True}

_loaded_settings_cache: Optional[AppSettings] = None
_loguru_console_configured_flag = False

def load_app_settings() -> AppSettings:
    global _loaded_settings_cache, _loguru_console_configured_flag
    if _loaded_settings_cache is not None:
        return _loaded_settings_cache

    global_logger.debug(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SDB. –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞: {PROJECT_ROOT_DIR}")
    
    env_s = EnvironmentSettings()
    
    if BOT_TOKEN_FROM_DOTENV:
        global_logger.info(f"BOT_TOKEN ('****{BOT_TOKEN_FROM_DOTENV[-4:]}') –±—ã–ª –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.")
    else:
        global_logger.warning("BOT_TOKEN –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ .env. –ë—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å—Å—è –≤ YAML.")
    
    pdp_val_from_env = env_s.CORE_PROJECT_DATA_PATH
    core_app_defaults = CoreAppSettings.model_fields
    
    if pdp_val_from_env:
        effective_project_data_path = Path(pdp_val_from_env)
        if not effective_project_data_path.is_absolute():
            effective_project_data_path = (PROJECT_ROOT_DIR / effective_project_data_path).resolve()
    else: 
        default_pdp_model = core_app_defaults["project_data_path"].default
        effective_project_data_path = Path(default_pdp_model) if default_pdp_model else (PROJECT_ROOT_DIR / DEFAULT_PROJECT_DATA_DIR_NAME)
        if not effective_project_data_path.is_absolute():
             effective_project_data_path = (PROJECT_ROOT_DIR / effective_project_data_path).resolve()

    user_config_file_path = effective_project_data_path / USER_CONFIG_DIR_NAME / USER_CONFIG_FILENAME
    yaml_data: Dict[str, Any] = {}
    if user_config_file_path.is_file():
        try:
            with open(user_config_file_path, 'r', encoding='utf-8') as f: yaml_data = yaml.safe_load(f) or {}
            global_logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ YAML: {user_config_file_path}")
        except Exception as e_yaml: global_logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ YAML –∏–∑ {user_config_file_path}: {e_yaml}.")
    else:
        global_logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π YAML –∫–æ–Ω—Ñ–∏–≥ {user_config_file_path} –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç—ã –∏ .env.")

    tg_token_from_yaml = yaml_data.get("telegram", {}).get("token")
    final_tg_token = BOT_TOKEN_FROM_DOTENV or tg_token_from_yaml
    if not final_tg_token:
        raise ValueError(f"–ö–†–ò–¢–ò–ß–ù–û: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env –∏ YAML ({user_config_file_path}).")
    
    telegram_s = TelegramSettings(
        token=final_tg_token,
        polling_timeout=env_s.TELEGRAM_POLLING_TIMEOUT or \
                        yaml_data.get("telegram", {}).get("polling_timeout", TelegramSettings.model_fields["polling_timeout"].default)
    )

    db_yaml = yaml_data.get("db", {})
    db_s = DBSettings(
        type=env_s.DB_TYPE or db_yaml.get("type", DBSettings.model_fields["type"].default),
        sqlite_path=env_s.DB_SQLITE_PATH or db_yaml.get("sqlite_path", DBSettings.model_fields["sqlite_path"].default),
        pg_dsn=env_s.DB_PG_DSN or db_yaml.get("pg_dsn"),
        mysql_dsn=env_s.DB_MYSQL_DSN or db_yaml.get("mysql_dsn"),
        echo_sql=env_s.DB_ECHO_SQL if env_s.DB_ECHO_SQL is not None else \
                 db_yaml.get("echo_sql", DBSettings.model_fields["echo_sql"].default)
    )

    cache_yaml = yaml_data.get("cache", {})
    cache_s = CacheSettings(
        type=env_s.CACHE_TYPE or cache_yaml.get("type", CacheSettings.model_fields["type"].default),
        redis_url=env_s.CACHE_REDIS_URL or cache_yaml.get("redis_url", CacheSettings.model_fields["redis_url"].default)
    )

    module_repo_yaml = yaml_data.get("module_repo", {})
    module_repo_s = ModuleRepoSettings(
        index_url=env_s.MODULE_REPO_INDEX_URL or \
                  HttpUrl(str(module_repo_yaml.get("index_url") or ModuleRepoSettings.model_fields["index_url"].default))
    )
    
    core_yaml = yaml_data.get("core", {})
    
    s_admins_str_env = env_s.CORE_SUPER_ADMINS
    s_admins_list_yaml = core_yaml.get("super_admins")
    s_admins_final_list: List[int] = []
    if s_admins_str_env:
        try: s_admins_final_list = [int(x.strip()) for x in s_admins_str_env.split(',') if x.strip().isdigit()]
        except ValueError: global_logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ CORE_SUPER_ADMINS –∏–∑ env: '{s_admins_str_env}'")
    elif isinstance(s_admins_list_yaml, list):
        s_admins_final_list = [int(x) for x in s_admins_list_yaml if isinstance(x, (int, str)) and str(x).isdigit()]

    emcp_from_env_val = env_s.CORE_ENABLED_MODULES_CONFIG_PATH
    emcp_from_yaml_val = core_yaml.get("enabled_modules_config_path")
    emcp_default_relative = CoreAppSettings.model_fields["enabled_modules_config_path"].default 
    
    emcp_to_resolve = emcp_from_env_val or (Path(emcp_from_yaml_val) if emcp_from_yaml_val else emcp_default_relative)
    emcp_path_resolved = (effective_project_data_path / emcp_to_resolve).resolve() if not Path(emcp_to_resolve).is_absolute() else Path(emcp_to_resolve).resolve()

    log_structured_dir_final = env_s.SDB_CORE_LOG_STRUCTURED_DIR or core_yaml.get("log_structured_dir", CoreAppSettings.model_fields["log_structured_dir"].default)
    log_rotation_size_final = env_s.SDB_CORE_LOG_ROTATION_SIZE or core_yaml.get("log_rotation_size", CoreAppSettings.model_fields["log_rotation_size"].default)
    log_retention_period_structured_final = env_s.SDB_CORE_LOG_RETENTION_PERIOD_STRUCTURED or core_yaml.get("log_retention_period_structured", CoreAppSettings.model_fields["log_retention_period_structured"].default)

    i18n_yaml = core_yaml.get("i18n", {})
    i18n_model_defaults = I18nSettings.model_fields
    
    available_locales_env_str = env_s.SDB_I18N_AVAILABLE_LOCALES
    available_locales_yaml = i18n_yaml.get("available_locales")
    final_available_locales: List[str]
    if available_locales_env_str:
        final_available_locales = [loc.strip() for loc in available_locales_env_str.split(',')]
    elif isinstance(available_locales_yaml, list):
        final_available_locales = available_locales_yaml
    else:
        final_available_locales = i18n_model_defaults["available_locales"].default_factory() # type: ignore

    locales_dir_env = env_s.SDB_I18N_LOCALES_DIR
    locales_dir_yaml = i18n_yaml.get("locales_dir")
    locales_dir_default = i18n_model_defaults["locales_dir"].default
    
    locales_dir_to_resolve = locales_dir_env or (Path(locales_dir_yaml) if locales_dir_yaml else locales_dir_default)
    resolved_locales_dir = Path(locales_dir_to_resolve)
    if not resolved_locales_dir.is_absolute():
        resolved_locales_dir = (PROJECT_ROOT_DIR / resolved_locales_dir).resolve()

    i18n_s = I18nSettings(
        locales_dir=resolved_locales_dir,
        domain=env_s.SDB_I18N_DOMAIN or i18n_yaml.get("domain", i18n_model_defaults["domain"].default),
        default_locale=env_s.SDB_I18N_DEFAULT_LOCALE or i18n_yaml.get("default_locale", i18n_model_defaults["default_locale"].default),
        available_locales=final_available_locales
    )

    core_s = CoreAppSettings(
        project_data_path=effective_project_data_path,
        super_admins=s_admins_final_list,
        enabled_modules_config_path=emcp_path_resolved,
        log_level=(env_s.CORE_LOG_LEVEL or core_yaml.get("log_level", CoreAppSettings.model_fields["log_level"].default)).upper(), # type: ignore
        log_to_file=env_s.CORE_LOG_TO_FILE if env_s.CORE_LOG_TO_FILE is not None \
                    else core_yaml.get("log_to_file", CoreAppSettings.model_fields["log_to_file"].default),
        log_structured_dir=log_structured_dir_final,
        log_rotation_size=log_rotation_size_final,
        log_retention_period_structured=log_retention_period_structured_final,
        sdb_version=env_s.CORE_SDB_VERSION or core_yaml.get("sdb_version", CoreAppSettings.model_fields["sdb_version"].default),
        setup_bot_commands_on_startup=core_yaml.get("setup_bot_commands_on_startup", CoreAppSettings.model_fields["setup_bot_commands_on_startup"].default), # type: ignore
        i18n=i18n_s
    )
    
    final_settings = AppSettings(db=db_s, cache=cache_s, telegram=telegram_s, module_repo=module_repo_s, core=core_s)

    final_settings.core.project_data_path.mkdir(parents=True, exist_ok=True)
    final_settings.core.enabled_modules_config_path.parent.mkdir(parents=True, exist_ok=True)
    
    structured_logs_root_abs_path = final_settings.core.project_data_path / final_settings.core.log_structured_dir
    structured_logs_root_abs_path.mkdir(parents=True, exist_ok=True)
    
    final_settings.core.i18n.locales_dir.mkdir(parents=True, exist_ok=True)
    
    if final_settings.db.type == "sqlite":
        sqlite_file_abs = Path(final_settings.db.sqlite_path)
        if not sqlite_file_abs.is_absolute():
            if DEFAULT_PROJECT_DATA_DIR_NAME in sqlite_file_abs.parts:
                 sqlite_file_abs = (PROJECT_ROOT_DIR / sqlite_file_abs).resolve()
            else:
                 sqlite_file_abs = (final_settings.core.project_data_path / sqlite_file_abs).resolve()
        final_settings.db.sqlite_path = str(sqlite_file_abs)
        sqlite_file_abs.parent.mkdir(parents=True, exist_ok=True)

    if not _loguru_console_configured_flag:
        try:
            if hasattr(global_logger, '_core') and global_logger._core.handlers:
                for handler_id_to_remove in list(global_logger._core.handlers.keys()):
                    try: global_logger.remove(handler_id_to_remove)
                    except ValueError: pass
            
            log_format_console = ("<green>{time:YYYY-MM-DD HH:mm:ss.SSS}</green> | <level>{level: <8}</level> | "
                                  "<cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>")
            
            console_log_level_str = final_settings.core.log_level.upper()
            
            cli_debug_env_var = os.environ.get("SDB_CLI_DEBUG_MODE_FOR_LOGGING", "false").lower()
            if cli_debug_env_var == "true":
                console_log_level_str = "DEBUG"
                global_logger.info("Loguru (app_settings): –£—Ä–æ–≤–µ–Ω—å –∫–æ–Ω—Å–æ–ª—å–Ω–æ–≥–æ –ª–æ–≥–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ DEBUG –∏–∑-–∑–∞ SDB_CLI_DEBUG_MODE_FOR_LOGGING.")

            global_logger.add(sys.stderr, level=console_log_level_str, format=log_format_console, colorize=True)
            global_logger.info(f"Loguru (app_settings): –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –£—Ä–æ–≤–µ–Ω—å: {console_log_level_str}")
            _loguru_console_configured_flag = True
        except Exception as e_log_setup_console:
            print(f"CRITICAL ERROR in app_settings during Loguru console setup: {e_log_setup_console}", file=sys.stderr)

    global_logger.success("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ SDB —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã!")
    _loaded_settings_cache = final_settings
    return final_settings

try:
    settings: AppSettings = load_app_settings()
except (ImportError, ValueError) as e: 
    print(f"CRITICAL ERROR during SDB settings load/validation: {e}", file=sys.stderr)
    if hasattr(global_logger, 'opt') and callable(global_logger.opt): 
        global_logger.opt(exception=True).critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê Pydantic/SDB –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫: {e}")
    sys.exit(1)
except Exception as e:
    print(f"UNEXPECTED CRITICAL ERROR during initial settings load: {e}", file=sys.stderr)
    if hasattr(global_logger, 'opt') and callable(global_logger.opt):
        global_logger.opt(exception=True).critical(f"–ù–ï–ü–†–ï–î–í–ò–î–ï–ù–ù–ê–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫: {e}")
    sys.exit(1)


======================================================================

------------------------------ FILE: core/bot_entrypoint.py ------------------------------
# core/bot_entrypoint.py

import asyncio
import sys
import os
from pathlib import Path
from typing import Optional, Union, List, Dict, Any, TYPE_CHECKING
from datetime import datetime, timezone

from loguru import logger as global_logger

if not (hasattr(global_logger, '_core') and hasattr(global_logger._core, 'handlers') and global_logger._core.handlers):
    try:
        global_logger.remove()
        global_logger.add(sys.stderr, level="DEBUG")
        print("!!! [SDB bot_entrypoint WARNING] Loguru handlers –±—ã–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –¥–æ–±–∞–≤–ª–µ–Ω stderr –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. !!!", file=sys.stderr)
    except Exception as e_loguru_init_fallback_entry:
        print(f"!!! [SDB bot_entrypoint CRITICAL] Loguru handlers –ø—É—Å—Ç –∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å stderr: {e_loguru_init_fallback_entry} !!!", file=sys.stderr)


from aiogram import Bot, Dispatcher, __version__ as aiogram_version
from aiogram.types import BotCommand
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.fsm.storage.memory import MemoryStorage
# <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–î–ê–õ–ï–ù –ò–ú–ü–û–†–¢ RedisStorage –û–¢–°–Æ–î–ê ---
# from aiogram.fsm.storage.redis import RedisStorage
from aiogram.exceptions import TelegramRetryAfter

from core.app_settings import settings
from core.services_provider import BotServicesProvider
from core.module_loader import ModuleLoader
from core.ui.handlers_core_ui import core_ui_router
from core.i18n.middleware import I18nMiddleware
from core.i18n.translator import Translator
from core.users.middleware import UserStatusMiddleware
from core.logging_manager import LoggingManager

if TYPE_CHECKING:
    from aiogram.fsm.storage.redis import RedisStorage # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò–º–ø–æ—Ä—Ç –¥–ª—è type hinting

PID_FILENAME = "sdb_bot.pid"
CORE_COMMANDS_DESCRIPTIONS = {
    "start": "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ / –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
    "help": "‚ùì –ü–æ–º–æ—â—å –∏ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞",
}

try:
    from core.admin import admin_router
    ADMIN_ROUTER_AVAILABLE = True
    global_logger.info("–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω-—Ä–æ—É—Ç–µ—Ä (core.admin.admin_router) —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω.")
except ImportError:
    admin_router = None
    ADMIN_ROUTER_AVAILABLE = False
    global_logger.info("–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω-—Ä–æ—É—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±—É–¥–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞.")


async def _setup_bot_commands(bot: Bot, services: 'BotServicesProvider', admin_router_available: bool):
    module_name_for_log = "CoreBotSetup"
    global_logger.debug(f"[{module_name_for_log}] –ù–∞—á–∞–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ –≤ Telegram...")

    final_commands_dict: Dict[str, str] = {}

    for cmd_name, cmd_desc in CORE_COMMANDS_DESCRIPTIONS.items():
        if cmd_name not in final_commands_dict:
            final_commands_dict[cmd_name] = cmd_desc
    global_logger.trace(f"[{module_name_for_log}] –î–æ–±–∞–≤–ª–µ–Ω—ã –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã —è–¥—Ä–∞: {list(CORE_COMMANDS_DESCRIPTIONS.keys())}")

    all_loaded_plugin_modules_info = services.modules.get_loaded_modules_info(include_system=False, include_plugins=True)
    for module_info in all_loaded_plugin_modules_info:
        if module_info.manifest and module_info.manifest.commands:
            global_logger.trace(f"[{module_name_for_log}] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥ –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞: {module_info.name}")
            for cmd_manifest in module_info.manifest.commands:
                if not cmd_manifest.admin_only:
                    if cmd_manifest.command not in final_commands_dict:
                        final_commands_dict[cmd_manifest.command] = cmd_manifest.description

    if admin_router_available:
        admin_panel_commands = {"admin": "üõ† –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"}

        for cmd_name, cmd_desc in admin_panel_commands.items():
            if cmd_name not in final_commands_dict:
                 final_commands_dict[cmd_name] = cmd_desc
        global_logger.trace(f"[{module_name_for_log}] –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: {list(admin_panel_commands.keys())}")

    final_bot_commands = [
        BotCommand(command=name, description=desc) for name, desc in final_commands_dict.items()
    ]

    if final_bot_commands:
        try:
            await bot.set_my_commands(final_bot_commands)
            global_logger.success(f"[{module_name_for_log}] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {len(final_bot_commands)} –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ –≤ Telegram: "
                                  f"{[cmd.command for cmd in final_bot_commands]}")
        except Exception as e:
            global_logger.error(f"[{module_name_for_log}] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞: {e}", exc_info=True)
    else:
        global_logger.warning(f"[{module_name_for_log}] –ù–µ—Ç –∫–æ–º–∞–Ω–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ Telegram.")


async def run_sdb_bot() -> int:
    current_process_start_time = datetime.now(timezone.utc)
    sdb_version = settings.core.sdb_version

    logging_manager = LoggingManager(app_settings=settings)
    await logging_manager.initialize_logging()

    global_logger.info(f"–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. "
                       f"–£—Ä–æ–≤–µ–Ω—å –∫–æ–Ω—Å–æ–ª—å–Ω–æ–≥–æ –ª–æ–≥–∞: {settings.core.log_level.upper()} (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω SDB_CLI_DEBUG_MODE_FOR_LOGGING). "
                       f"–£—Ä–æ–≤–µ–Ω—å —Ñ–∞–π–ª–æ–≤–æ–≥–æ –ª–æ–≥–∞ –≤—Å–µ–≥–¥–∞ DEBUG (–∏–ª–∏ TRACE, –µ—Å–ª–∏ —Ç–∞–∫ –∑–∞–¥–∞–Ω–æ –≤ LoggingManager).")

    global_logger.info(f"üöÄ –ó–∞–ø—É—Å–∫ SwiftDevBot (SDB) v{sdb_version} –≤ {current_process_start_time.strftime('%Y-%m-%d %H:%M:%S %Z')}...")
    global_logger.info(f"üêç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Python v{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}")
    global_logger.info(f"ü§ñ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Aiogram v{aiogram_version}")
    global_logger.debug(f"–ö–∞—Ç–∞–ª–æ–≥ –∑–∞–ø—É—Å–∫–∞ (CWD): {Path.cwd()}")
    global_logger.debug(f"–ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞: {settings.core.project_data_path.parent}")
    global_logger.debug(f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞: {settings.core.project_data_path}")

    pid_file_actual_path = settings.core.project_data_path / PID_FILENAME
    bot: Optional[Bot] = None
    services: Optional[BotServicesProvider] = None
    exit_code_internal = 1

    if pid_file_actual_path.exists():
        try:
            old_pid = int(pid_file_actual_path.read_text().strip())
            if sys.platform != "win32":
                os.kill(old_pid, 0)
                global_logger.error(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π PID-—Ñ–∞–π–ª ({pid_file_actual_path}) –¥–ª—è —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ PID {old_pid}. "
                                   f"–ù–æ–≤—ã–π –∑–∞–ø—É—Å–∫ SDB (PID: {os.getpid()}) –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä.")
                if logging_manager: await logging_manager.shutdown_logging()
                return 1
        except (OSError, ValueError):
            global_logger.info(f"–£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ PID-—Ñ–∞–π–ª–∞: {pid_file_actual_path}")
            pid_file_actual_path.unlink(missing_ok=True)
        except Exception as e_pid_precheck:
             global_logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ PID-—Ñ–∞–π–ª–∞: {e_pid_precheck}")

    try:
        pid_file_actual_path.parent.mkdir(parents=True, exist_ok=True)
        with open(pid_file_actual_path, "w") as f:
            f.write(str(os.getpid()))
        global_logger.info(f"PID {os.getpid()} –∑–∞–ø–∏—Å–∞–Ω –≤ {pid_file_actual_path}")
    except Exception as e_pid_write:
        global_logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å/–∑–∞–ø–∏—Å–∞—Ç—å PID-—Ñ–∞–π–ª {pid_file_actual_path}: {e_pid_write}. "
                           "–ë–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É, –Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PID-—Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Ä—É—à–µ–Ω–æ.")
    try:
        services = BotServicesProvider(settings=settings)
        await services.setup_services()
        global_logger.success("‚úÖ BotServicesProvider –∏ –≤—Å–µ –µ–≥–æ –±–∞–∑–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.")

        bot = Bot(
            token=services.config.telegram.token,
            default=DefaultBotProperties(parse_mode=ParseMode.HTML)
        )
        me = await bot.get_me()
        global_logger.info(f"ü§ñ –≠–∫–∑–µ–º–ø–ª—è—Ä Telegram Bot —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: @{me.username} (ID: {me.id})")

        # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–°–õ–û–í–ù–´–ô –ò–ú–ü–û–†–¢ –ò –°–û–ó–î–ê–ù–ò–ï –•–†–ê–ù–ò–õ–ò–©–ê ---
        storage: Union[MemoryStorage, "RedisStorage"]

        if services.config.cache.type == "redis" and services.cache.is_available():
            try:
                # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º RedisStorage —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å
                from aiogram.fsm.storage.redis import RedisStorage
                
                redis_client_instance = await services.cache.get_redis_client_instance()
                if redis_client_instance:
                    storage = RedisStorage(redis=redis_client_instance)
                    global_logger.info("FSM Storage: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è RedisStorage.")
                else:
                    global_logger.warning("Redis —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–æ –∫–ª–∏–µ–Ω—Ç Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è FSM. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MemoryStorage.")
                    storage = MemoryStorage()
            except ImportError:
                global_logger.critical("–í—ã–±—Ä–∞–Ω —Ç–∏–ø –∫—ç—à–∞/FSM 'redis', –Ω–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'redis' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–µ: pip install redis")
                global_logger.warning("FSM Storage: –§–æ–ª–ª–±—ç–∫ –Ω–∞ MemoryStorage –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ redis.")
                storage = MemoryStorage()
        else:
            storage = MemoryStorage()
            if services.config.cache.type == "redis":
                global_logger.warning("Redis –±—ã–ª –≤—ã–±—Ä–∞–Ω –¥–ª—è –∫—ç—à–∞, –Ω–æ CacheManager –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MemoryStorage –¥–ª—è FSM.")
            global_logger.info("FSM Storage: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MemoryStorage.")
        # <--- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

        dp = Dispatcher(storage=storage, services_provider=services)
        global_logger.info("üö¶ Dispatcher –∏ FSM Storage –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.")

        translator = Translator(
            locales_dir=settings.core.i18n.locales_dir,
            domain=settings.core.i18n.domain,
            default_locale=settings.core.i18n.default_locale,
            available_locales=settings.core.i18n.available_locales
        )
        dp.update.outer_middleware(I18nMiddleware(translator))
        global_logger.info("I18nMiddleware –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö Update.")

        dp.update.outer_middleware(UserStatusMiddleware())
        global_logger.info("UserStatusMiddleware –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö Update.")

        dp.include_router(core_ui_router)
        global_logger.info(f"–ë–∞–∑–æ–≤—ã–π UI-—Ä–æ—É—Ç–µ—Ä —è–¥—Ä–∞ '{core_ui_router.name}' –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.")

        if ADMIN_ROUTER_AVAILABLE and admin_router:
            try:
                dp.include_router(admin_router)
                global_logger.critical(f"‚úÖ –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω-—Ä–æ—É—Ç–µ—Ä '{admin_router.name}' —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")
            except Exception as e:
                global_logger.critical(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-—Ä–æ—É—Ç–µ—Ä–∞: {e}", exc_info=True)
        else:
            global_logger.critical(f"‚ùå –ê–¥–º–∏–Ω-—Ä–æ—É—Ç–µ—Ä –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ADMIN_ROUTER_AVAILABLE={ADMIN_ROUTER_AVAILABLE}, admin_router={'—Å—É—â–µ—Å—Ç–≤—É–µ—Ç' if admin_router else '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}")

        module_loader: ModuleLoader = services.modules
        await module_loader.initialize_and_setup_modules(dp=dp, bot=bot)

        num_enabled_plugins = len(module_loader.enabled_plugin_names)
        num_loaded_plugins = sum(1 for mi in module_loader.get_loaded_modules_info(include_system=False, include_plugins=True) if mi.is_enabled)

        global_logger.info(
            f"üß© –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤ –∏–∑ 'modules/': {num_loaded_plugins} –∏–∑ {num_enabled_plugins} –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ."
        )
        if num_loaded_plugins < num_enabled_plugins:
            global_logger.warning("‚ö†Ô∏è –ù–µ –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ.")

        global_logger.debug("–í—Å–µ —Ä–æ—É—Ç–µ—Ä—ã (—è–¥—Ä–∞, —Å–∏—Å—Ç–µ–º–Ω—ã–µ, –ø–ª–∞–≥–∏–Ω—ã) –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ Dispatcher.")

        if settings.core.setup_bot_commands_on_startup:
            await _setup_bot_commands(bot, services, admin_router_available=ADMIN_ROUTER_AVAILABLE)
        else:
            global_logger.info("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.")

        @dp.startup()
        async def on_bot_startup():
            nonlocal sdb_version
            bot_info = await bot.get_me()
            services.logger.info(f"‚ö° –°–æ–±—ã—Ç–∏–µ startup –¥–ª—è Dispatcher (–±–æ—Ç: @{bot_info.username})...")
            try:
                await bot.delete_webhook(drop_pending_updates=True)
                services.logger.info("Webhook —É–¥–∞–ª–µ–Ω, –æ–∂–∏–¥–∞—é—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã.")
            except Exception as e_startup_hook:
                services.logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞ —ç—Ç–∞–ø–µ startup –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞: {e_startup_hook}", exc_info=True)

            services.logger.success(f"‚úÖ –ë–æ—Ç SDB @{bot_info.username} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
            if services.config.core.super_admins:
                for admin_id in services.config.core.super_admins:
                    try:
                        await bot.send_message(admin_id, f"üöÄ –ë–æ—Ç SDB @{bot_info.username} (v{sdb_version}) —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")
                    except Exception as e_send:
                        services.logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –∞–¥–º–∏–Ω—É {admin_id}: {e_send}")

        @dp.shutdown()
        async def on_bot_shutdown():
            nonlocal logging_manager
            bot_info = await bot.get_me()
            services.logger.info(f"‚è≥ –°–æ–±—ã—Ç–∏–µ shutdown –¥–ª—è Dispatcher. –ù–∞—á–∞–ª–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞ @{bot_info.username}...")

            if services and services.config.core.super_admins:
                for admin_id in services.config.core.super_admins:
                    try:
                        await bot.send_message(admin_id, f"üõë –ë–æ—Ç SDB @{bot_info.username} –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...")
                    except Exception as e_send:
                         services.logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∞–¥–º–∏–Ω—É {admin_id}: {e_send}")

            if logging_manager:
                await logging_manager.shutdown_logging()

            if pid_file_actual_path.exists():
                try:
                    pid_in_file = int(pid_file_actual_path.read_text().strip())
                    if pid_in_file == os.getpid():
                        pid_file_actual_path.unlink(missing_ok=True)
                        global_logger.info(f"PID-—Ñ–∞–π–ª {pid_file_actual_path} —É–¥–∞–ª–µ–Ω –ø—Ä–∏ —à—Ç–∞—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ (on_bot_shutdown).")
                    else:
                         global_logger.info(f"PID-—Ñ–∞–π–ª {pid_file_actual_path} (PID: {pid_in_file}) –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É (PID: {os.getpid()}). –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ –≤ on_bot_shutdown.")
                except Exception as e_unlink_pid_shutdown:
                    global_logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å PID-—Ñ–∞–π–ª {pid_file_actual_path} –≤ on_bot_shutdown: {e_unlink_pid_shutdown}")

            global_logger.info(f"üèÅ –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞ @{bot_info.username} –ø–æ—á—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (—Å–µ—Ä–≤–∏—Å—ã –±—É–¥—É—Ç –∑–∞–∫—Ä—ã—Ç—ã –≤ finally).")

        bot_username_for_log = (await bot.get_me()).username
        global_logger.info(f"üì° –ó–∞–ø—É—Å–∫ Telegram Bot Polling –¥–ª—è @{bot_username_for_log}...")

        await dp.start_polling(bot)
        exit_code_internal = 0

    except (KeyboardInterrupt, SystemExit) as e_exit:
        global_logger.info(f"üö® –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ ({type(e_exit).__name__}). –ü–æ–ª–ª–∏–Ω–≥ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è...")
        exit_code_internal = 0
    except Exception as e_main_run:
        global_logger.critical(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ run_sdb_bot: {e_main_run}", exc_info=True)
        exit_code_internal = 1
    finally:
        global_logger.info("–ë–ª–æ–∫ finally –≤ run_sdb_bot.")

        if bot:
            try:
                global_logger.info("–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏ –±–æ—Ç–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ Aiogram –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ Dispatcher.start_polling.")
            except TelegramRetryAfter as e_retry:
                global_logger.warning(f"TelegramRetryAfter –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–∫—Ä—ã—Ç—å —Å–µ—Å—Å–∏—é –±–æ—Ç–∞ (–∏–ª–∏ —É–∂–µ –≤–æ –≤—Ä–µ–º—è –µ–µ –∑–∞–∫—Ä—ã—Ç–∏—è Aiogram): {e_retry}")
            except Exception as e_bot_close:
                global_logger.warning(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —Å –æ–±—ä–µ–∫—Ç–æ–º –±–æ—Ç–∞ –≤ finally: {type(e_bot_close).__name__} - {e_bot_close}", exc_info=True)

        if services:
            try:
                await services.close_services()
                global_logger.info("–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã BotServicesProvider –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –±–ª–æ–∫–µ finally.")
            except Exception as e_services_close:
                global_logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –±–ª–æ–∫–µ finally: {e_services_close}", exc_info=True)

        if logging_manager and logging_manager._is_initialized:
            await logging_manager.shutdown_logging()

        if pid_file_actual_path.exists():
            try:
                pid_in_file = int(pid_file_actual_path.read_text().strip())
                if pid_in_file == os.getpid():
                    pid_file_actual_path.unlink(missing_ok=True)
                    global_logger.info(f"PID-—Ñ–∞–π–ª {pid_file_actual_path} —É–¥–∞–ª–µ–Ω/–ø—Ä–æ–≤–µ—Ä–µ–Ω –≤ –±–ª–æ–∫–µ finally.")
            except Exception as e_final_pid_unlink:
                global_logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å/–ø—Ä–æ–≤–µ—Ä–∏—Ç—å PID-—Ñ–∞–π–ª {pid_file_actual_path}: {e_final_pid_unlink}")

        bot_name_display = getattr(bot, 'id', 'N/A') if bot else 'N/A'
        if bot and hasattr(bot, 'username') and bot.username:
            bot_name_display = f"@{bot.username} (ID: {bot.id})"

        global_logger.info(f"üèÅ –†–∞–±–æ—Ç–∞ –±–æ—Ç–∞ ({bot_name_display}) –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥ –≤—ã—Ö–æ–¥–∞: {exit_code_internal}")
        return exit_code_internal


======================================================================

------------------------------ FILE: alembic_migrations/script.py.mako ------------------------------
# alembic_migrations/script.py.mako
"""${message}

Revision ID: ${up_revision}
Revises: ${down_revision | comma,n}
Create Date: ${create_date}

"""
from typing import Sequence, Union

from alembic import op # type: ignore
import sqlalchemy as sa
${imports if imports else ""}

# revision identifiers, used by Alembic.
revision: str = ${repr(up_revision)}
down_revision: Union[str, None] = ${repr(down_revision)}
branch_labels: Union[str, Sequence[str], None] = ${repr(branch_labels)}
depends_on: Union[str, Sequence[str], None] = ${repr(depends_on)}


def upgrade() -> None:
    ${upgrades if upgrades else "    pass"}


def downgrade() -> None:
    ${downgrades if downgrades else "    pass"}


======================================================================

------------------------------ FILE: alembic_migrations/env.py ------------------------------
# alembic_migrations/env.py

import asyncio
from logging.config import fileConfig
import os
import sys
from pathlib import Path
import importlib
from typing import List, Optional

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π ---
ALEMBIC_DIR = Path(__file__).resolve().parent
SDB_PROJECT_ROOT = ALEMBIC_DIR.parent

if str(SDB_PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(SDB_PROJECT_ROOT))
    print(f"[Alembic Env] –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ SDB ({SDB_PROJECT_ROOT}) –¥–æ–±–∞–≤–ª–µ–Ω –≤ sys.path.")
else:
    sys.path.remove(str(SDB_PROJECT_ROOT))
    sys.path.insert(0, str(SDB_PROJECT_ROOT))
    print(f"[Alembic Env] –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ SDB ({SDB_PROJECT_ROOT}) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –ø–µ—Ä–≤—É—é –ø–æ–∑–∏—Ü–∏—é –≤ sys.path.")


from sqlalchemy import pool
from sqlalchemy.engine import Connection
from sqlalchemy.ext.asyncio import create_async_engine, AsyncEngine

from alembic import context # type: ignore

try:
    from core.app_settings import settings as sdb_settings
    from core.database.base import SDBBaseModel
    from core.database.manager import DBManager
    from core.module_loader import ModuleLoader, ModuleInfo
    from core.services_provider import BotServicesProvider
    from core.database import core_models # noqa: F401
    print("[Alembic Env] –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã SDB —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.")
except ImportError as e_imp:
    print(f"[ALEMBIC ENV ERROR] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ SDB: {e_imp}")
    print(f"–¢–µ–∫—É—â–∏–π sys.path –ø—Ä–∏ –æ—à–∏–±–∫–µ: {sys.path}")
    sys.exit(1)

target_metadata = SDBBaseModel.metadata

try:
    print("[Alembic Env] –ù–∞—á–∞–ª–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π...")
    temp_bsp_for_alembic = BotServicesProvider(settings=sdb_settings)
    module_loader_for_alembic = ModuleLoader(
        settings=sdb_settings,
        services_provider=temp_bsp_for_alembic # –ü–µ—Ä–µ–¥–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π BSP
    )
    module_loader_for_alembic.scan_all_available_modules()
    module_loader_for_alembic._load_enabled_plugin_names() # –ò—Å–ø–æ–ª—å–∑—É–µ–º _load_enabled_plugin_names

    # –î–ª—è Alembic –Ω–∞–º –Ω—É–∂–Ω—ã –º–æ–¥–µ–ª–∏ –≤—Å–µ—Ö –ê–ö–¢–ò–í–ù–´–• –ü–õ–ê–ì–ò–ù–û–í
    active_plugin_module_infos: List[ModuleInfo] = [
        info for name, info in module_loader_for_alembic.available_modules.items()
        # –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –∏—Å–ø–æ–ª—å–∑—É–µ–º enabled_plugin_names
        if not info.is_system_module and name in module_loader_for_alembic.enabled_plugin_names and info.manifest and info.path
    ]

    if active_plugin_module_infos:
        print(f"[Alembic Env] –ù–∞–π–¥–µ–Ω–æ {len(active_plugin_module_infos)} –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–¥–µ–ª–µ–π.")
        for module_info in active_plugin_module_infos:
            print(f"[Alembic Env] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–≥–∏–Ω–∞: {module_info.name}")
            module_models_file = module_info.path / "models.py"
            module_models_pkg_init = module_info.path / "models" / "__init__.py"
            
            imported_this_module = False
            if module_models_file.is_file():
                # –î–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤ –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –∏–º–ø–æ—Ä—Ç–∞ "modules"
                import_target = f"modules.{module_info.path.name}.models"
                print(f"[Alembic Env] –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞: {import_target}")
                try:
                    importlib.import_module(import_target)
                    print(f"[Alembic Env] > –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –º–æ–¥–µ–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞: {import_target}")
                    imported_this_module = True
                except ImportError as e_imp_f:
                    print(f"[Alembic Env] > –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞ {import_target}: {e_imp_f}")
                except Exception as e_f:
                    print(f"[Alembic Env] > –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞ {import_target}: {type(e_f).__name__} - {e_f}")
            
            if not imported_this_module and module_models_pkg_init.is_file():
                import_target = f"modules.{module_info.path.name}.models" 
                print(f"[Alembic Env] –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π –∏–∑ –ø–∞–∫–µ—Ç–∞: {import_target}")
                try:
                    importlib.import_module(import_target)
                    print(f"[Alembic Env] > –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–∞–∫–µ—Ç –º–æ–¥–µ–ª–µ–π: {import_target}")
                except ImportError as e_imp_p:
                    print(f"[Alembic Env] > –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –ø–∞–∫–µ—Ç–∞ –º–æ–¥–µ–ª–µ–π {import_target}: {e_imp_p}")
                except Exception as e_p:
                    print(f"[Alembic Env] > –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –ø–∞–∫–µ—Ç–∞ –º–æ–¥–µ–ª–µ–π {import_target}: {type(e_p).__name__} - {e_p}")
            elif not imported_this_module and not module_models_file.is_file():
                 print(f"[Alembic Env] > –î–ª—è –ø–ª–∞–≥–∏–Ω–∞ '{module_info.name}' –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ —Ñ–∞–π–ª models.py, –Ω–∏ –ø–∞–∫–µ—Ç models/__init__.py.")
    else:
        print("[Alembic Env] –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
    
    # –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ –≤ core/sys_modules/ —Å –º–æ–¥–µ–ª—è–º–∏,
    # –∏ –æ–Ω–∏ –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ core.database.core_models),
    # –∏—Ö –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–¥–µ—Å—å —è–≤–Ω–æ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∏—Ö –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è.
    # –ü—Ä–∏–º–µ—Ä:
    # print("[Alembic Env] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —è–¥—Ä–∞...")
    # sys_module_path = SDB_PROJECT_ROOT / "core" / "sys_modules" / "my_sys_module_with_models"
    # if (sys_module_path / "models.py").is_file():
    #    importlib.import_module("core.sys_modules.my_sys_module_with_models.models")
    #    print("[Alembic Env] –ú–æ–¥–µ–ª–∏ –∏–∑ 'my_sys_module_with_models' –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.")

    print(f"[Alembic Env] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–±–ª–∏—Ü –≤ target_metadata: {len(target_metadata.tables)}")

except Exception as e_load_mod_env:
    print(f"[ALEMBIC ENV ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥–µ–ª–µ–π –º–æ–¥—É–ª–µ–π –≤ env.py: {e_load_mod_env}")
    import traceback
    traceback.print_exc()
    print("[ALEMBIC ENV WARNING] –ò–∑-–∑–∞ –æ—à–∏–±–∫–∏ –≤—ã—à–µ, Alembic –º–æ–∂–µ—Ç –Ω–µ –≤–∏–¥–µ—Ç—å –º–æ–¥–µ–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∏–ª–∏ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π.")

config = context.config
try:
    temp_db_manager_for_url = DBManager(db_settings=sdb_settings.db, app_settings=sdb_settings)
    db_connection_url = temp_db_manager_for_url._build_db_url()
    config.set_main_option("sqlalchemy.url", db_connection_url)
    print(f"[Alembic Env] sqlalchemy.url —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ SDB: {db_connection_url[:db_connection_url.find('://')+3]}...")
except Exception as e_db_url_env:
    print(f"[ALEMBIC ENV ERROR] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è URL –ë–î –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ SDB: {e_db_url_env}")
    sys.exit(1)

if config.config_file_name is not None:
    fileConfig(config.config_file_name)

def _get_dialect_name_from_configured_context() -> Optional[str]:
    try:
        migration_context = context.get_context()
        if migration_context and migration_context.dialect:
            return migration_context.dialect.name.lower()
    except Exception: pass
    return None

def include_object(object, name, type_, reflected, compare_to):
    if type_ == "table" and object.metadata != target_metadata:
        return False
    return True

def compare_type(alem_context, inspected_column, metadata_column, inspected_type, metadata_type):
    dialect_name = _get_dialect_name_from_configured_context()
    if not dialect_name and alem_context.dialect:
        dialect_name = alem_context.dialect.name.lower()

    if dialect_name == 'sqlite':
        inspected_type_str = str(inspected_type).upper()
        metadata_type_str = str(metadata_type).upper()
        if metadata_type_str == 'BIGINTEGER' and inspected_type_str == 'INTEGER': return False
        if metadata_type_str == 'BOOLEAN' and inspected_type_str == 'INTEGER': return False
        if 'DATETIME' in metadata_type_str and 'TIMESTAMP' in inspected_type_str: return False
        if 'TIMESTAMP' in metadata_type_str and 'DATETIME' in inspected_type_str: return False
    elif dialect_name == 'mysql':
        if str(metadata_type).upper() == 'BOOLEAN' and str(inspected_type).upper() == 'TINYINT(1)': return False
    return None

def render_item(type_, obj, autogen_context):
    dialect_name = _get_dialect_name_from_configured_context()
    if not dialect_name and autogen_context.dialect:
         dialect_name = autogen_context.dialect.name.lower()
         
    if dialect_name == 'sqlite':
        if type_ == "table_comment" or type_ == "column_comment":
            return None 
    return False

def run_migrations_offline() -> None:
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url, target_metadata=target_metadata, literal_binds=True,
        dialect_opts={"paramstyle": "named"},
        include_object=include_object,
        compare_type=compare_type,
        compare_server_default=True,
        render_item=render_item
    )
    with context.begin_transaction():
        context.run_migrations()

def do_run_migrations(connection: Connection) -> None:
    context.configure(
        connection=connection, target_metadata=target_metadata,
        include_object=include_object,
        compare_type=compare_type,
        compare_server_default=True,
        render_item=render_item
    )
    with context.begin_transaction():
        context.run_migrations()

async def run_migrations_online() -> None:
    db_url_for_engine = config.get_main_option("sqlalchemy.url")
    if not db_url_for_engine:
        raise RuntimeError("sqlalchemy.url –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Alembic –¥–ª—è online —Ä–µ–∂–∏–º–∞!")

    connectable_engine: AsyncEngine = create_async_engine(
        db_url_for_engine,
        poolclass=pool.NullPool,
    )
    
    async with connectable_engine.connect() as connection:
        await connection.run_sync(do_run_migrations)
    await connectable_engine.dispose()

if context.is_offline_mode():
    print("[Alembic Env] –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –≤ offline —Ä–µ–∂–∏–º–µ...")
    run_migrations_offline()
else:
    print("[Alembic Env] –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –≤ online —Ä–µ–∂–∏–º–µ...")
    asyncio.run(run_migrations_online())


======================================================================

------------------------------ FILE: scripts/commands.txt ------------------------------
find core/admin -name "*.py" -exec echo "--- START OF FILE {} ---" \; -exec cat {} \; -exec echo "\n--- END OF FILE {} ---" \; > admin.txt 


======================================================================

------------------------------ FILE: scripts/replace_uk_to_ua.py ------------------------------
# SwiftDevBot/scripts/replace_uk_to_ua.py
import os
from pathlib import Path
import re

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
PROJECT_ROOT = Path(".")  # –ó–∞–ø—É—Å–∫–∞—Ç—å –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ SwiftDevBot
FILE_EXTENSIONS_TO_PROCESS = {".py", ".yaml", ".yml", ".json", ".md", ".env", ".po", ".pot", ".example", ".ini"}
EXCLUDE_DIRS_SCRIPT = {".git", ".venv", "__pycache__", "docs", "site", "build", "dist", "project_snapshot.txt"} 
DRY_RUN = False # –ï—Å–ª–∏ True, —Å–∫—Ä–∏–ø—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ –æ–Ω –±—ã –∑–∞–º–µ–Ω–∏–ª, –Ω–æ –Ω–µ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ñ–∞–π–ª—ã

REPLACEMENT_PATTERNS = {
    r"(['\"])uk\1": r"\1ua\1",
    r"(\buk\b)(?=[/\s,\]\}])": r"ua",
    r"Language: ua": r"Language: ua",
    r'(available_locales:\s*\[[^\]]*?)(\buk\b)([^\]]*?\])': r'\1ua\3', 
    r'(default_locale:\s*[\'"])uk([\'"])': r'\1ua\2', 
    r'(SDB_I18N_AVAILABLE_LOCALES\s*=\s*[\'"])([^\'"]*?)(\buk\b)([^\'"]*)([\'"])': r'\1\2ua\4\5', 
    r'(SDB_I18N_DEFAULT_LOCALE\s*=\s*[\'"])uk([\'"])': r'\1ua\2', 
}

RENAME_PATTERNS = {
    lambda p: p.is_dir() and p.name == "ua" and p.parent.name == "locales" and p.parent.parent == PROJECT_ROOT.resolve(): lambda p: p.with_name("ua"),
}

changed_content_files = set()
renamed_paths_log = []


def process_file_content(file_path: Path, dry_run: bool) -> int:
    global changed_content_files
    changes_count = 0
    try:
        content = file_path.read_text(encoding="utf-8")
        # original_content = content # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å
        
        file_actually_changed_by_script = False
        current_content_for_file = content # –†–∞–±–æ—Ç–∞–µ–º —Å —ç—Ç–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π

        for pattern, replacement in REPLACEMENT_PATTERNS.items():
            # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
            # re.subn(pattern, replacement, string, ...)
            new_content_after_sub, num_subs = re.subn(pattern, replacement, current_content_for_file, flags=re.IGNORECASE)
            # --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
            if num_subs > 0:
                current_content_for_file = new_content_after_sub # –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
                changes_count += num_subs
                file_actually_changed_by_script = True
                if dry_run:
                    # –î–ª—è DRY_RUN –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–∞–µ–º –æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏, –Ω–µ –º–µ–Ω—è—è 'content' –¥–ª—è –∑–∞–ø–∏—Å–∏
                    print(f"[DRY RUN] Would change content in {file_path} (pattern: '{pattern}') - {num_subs} occurrences")
                else:
                    print(f"Changed content in {file_path} (pattern: '{pattern}') - {num_subs} occurrences")
        
        if file_actually_changed_by_script: 
            changed_content_files.add(file_path.relative_to(PROJECT_ROOT)) 
            if not dry_run:
                # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
                file_path.write_text(current_content_for_file, encoding="utf-8")
            
    except Exception as e:
        print(f"Error processing file content {file_path}: {e}")
    return changes_count

def rename_paths_script(root_path: Path, dry_run: bool):
    global renamed_paths_log
    local_renamed_paths_log = [] 

    paths_to_rename_candidates = []
    for path_obj in root_path.rglob("*"): 
        if any(excluded_dir in path_obj.parts for excluded_dir in EXCLUDE_DIRS_SCRIPT):
            continue
        for matcher_func, new_name_func in RENAME_PATTERNS.items():
            if matcher_func(path_obj):
                new_path = new_name_func(path_obj)
                if new_path != path_obj:
                     paths_to_rename_candidates.append((path_obj, new_path))
                break 

    paths_to_rename_candidates.sort(key=lambda x: len(x[0].parts), reverse=True)

    for old_path, new_path in paths_to_rename_candidates:
        if old_path.exists(): 
            log_entry = f"{old_path.relative_to(PROJECT_ROOT)} -> {new_path.relative_to(PROJECT_ROOT)}"
            if dry_run:
                print(f"[DRY RUN] Would rename: {log_entry}")
                local_renamed_paths_log.append(log_entry)
            else:
                try:
                    if new_path.exists():
                        print(f"Warning: Target path {new_path} already exists. Skipping rename of {old_path}")
                        continue
                    old_path.rename(new_path)
                    print(f"Renamed: {log_entry}")
                    local_renamed_paths_log.append(log_entry)
                except Exception as e:
                    print(f"Error renaming {old_path} to {new_path}: {e}")
    
    renamed_paths_log.extend(local_renamed_paths_log) 
    return bool(local_renamed_paths_log)


def main():
    global changed_content_files, renamed_paths_log
    total_files_processed = 0
    total_changes_made = 0

    print(f"Starting replacement process in {PROJECT_ROOT.resolve()}")
    if DRY_RUN:
        print("DRY RUN mode: No files will be modified.")

    print("\n--- Renaming paths ---")
    renamed_anything_paths = rename_paths_script(PROJECT_ROOT, DRY_RUN)
    if not DRY_RUN and renamed_anything_paths:
        print("Some paths were renamed. Content processing will use new paths if applicable.")
    elif not renamed_anything_paths:
        print("No paths matched renaming patterns.")

    print("\n--- Processing file content ---")
    for root_str, dirs, files in os.walk(PROJECT_ROOT, topdown=True):
        root_path = Path(root_str)
        
        if any(excluded_dir in root_path.relative_to(PROJECT_ROOT).parts for excluded_dir in EXCLUDE_DIRS_SCRIPT):
            dirs[:] = [] 
            continue

        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS_SCRIPT]
        
        for filename in files:
            file_path = root_path / filename
            if file_path.suffix.lower() in FILE_EXTENSIONS_TO_PROCESS:
                if any(excluded_dir in file_path.relative_to(PROJECT_ROOT).parts for excluded_dir in EXCLUDE_DIRS_SCRIPT):
                    continue
                
                changes = process_file_content(file_path, DRY_RUN)
                if changes > 0:
                    total_changes_made += changes
                total_files_processed += 1
    
    print("\n" + "="*20 + " SCRIPT EXECUTION SUMMARY " + "="*20)
    if DRY_RUN:
        print("\n‚ö†Ô∏è  THIS WAS A DRY RUN. NO ACTUAL CHANGES WERE MADE TO FILES OR PATHS. ‚ö†Ô∏è")

    print(f"\nTotal unique files with content changes: {len(changed_content_files)}")
    if changed_content_files:
        print("Files with content changes (relative to project root):")
        for f_path in sorted(list(changed_content_files)):
            print(f"  - {f_path}")
    
    print(f"\nTotal paths renamed: {len(renamed_paths_log)}")
    if renamed_paths_log:
        print("Renamed paths:")
        for entry in renamed_paths_log:
            print(f"  - {entry}")
            
    print(f"\nTotal individual text replacements made: {total_changes_made}")
    print(f"Total files scanned for content processing: {total_files_processed}")
    
    if not DRY_RUN and (changed_content_files or renamed_paths_log):
        print("\nRECOMMENDATION: Review all changes with 'git diff' before committing!")
    elif not DRY_RUN:
        print("No changes were made to file contents or paths.")

if __name__ == "__main__":
    if not DRY_RUN:
        confirm = input(
            "This script will attempt to modify project files and rename paths to replace 'ua' with 'ua'.\n"
            "üî• MAKE SURE YOU HAVE A RELIABLE BACKUP (e.g., committed to Git). üî•\n"
            "This operation can have unintended consequences if patterns are not precise.\n"
            "It's highly recommended to run with DRY_RUN=True first and review the output.\n\n"
            "Type 'YES_I_AM_ABSOLUTELY_SURE' to proceed with actual changes: "
        )
        if confirm != "YES_I_AM_ABSOLUTELY_SURE":
            print("Aborted by user.")
            exit()
    main()


======================================================================

------------------------------ FILE: scripts/test_db_support.py ------------------------------
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ë–î.
"""
import sys
import os
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from sqlalchemy import create_engine, text
from core.database.db_utils import DatabaseDialectHandler, get_db_info_query


def test_sqlite():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç SQLite"""
    print("\n=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SQLite ===")
    engine = create_engine("sqlite:///:memory:")
    
    features = DatabaseDialectHandler.get_dialect_features(engine)
    types = DatabaseDialectHandler.get_recommended_types(engine)
    
    print(f"–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: {features}")
    print(f"–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç–∏–ø—ã: {types}")
    
    with engine.connect() as conn:
        result = conn.execute(text("SELECT sqlite_version()"))
        version = result.scalar()
        print(f"–í–µ—Ä—Å–∏—è SQLite: {version}")
    
    return True


def test_mysql():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç MySQL (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)"""
    print("\n=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MySQL ===")
    # –ü—Ä–∏–º–µ—Ä URL - –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
    mysql_url = "mysql+pymysql://root:Sova3568@192.168.31.3:33066/sdb_mysql_db?charset=utf8mb4"

    try:
        engine = create_engine(mysql_url)
        features = DatabaseDialectHandler.get_dialect_features(engine)
        types = DatabaseDialectHandler.get_recommended_types(engine)
        
        print(f"–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: {features}")
        print(f"–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç–∏–ø—ã: {types}")
        
        with engine.connect() as conn:
            result = conn.execute(text("SELECT VERSION()"))
            version = result.scalar()
            print(f"–í–µ—Ä—Å–∏—è MySQL: {version}")
        
        return True
    except Exception as e:
        print(f"MySQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e}")
        return False


def test_postgresql():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç PostgreSQL (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)"""
    print("\n=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ PostgreSQL ===")
    # –ü—Ä–∏–º–µ—Ä URL - –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
    pg_url = "postgresql+psycopg://soverx:Sova3568@192.168.31.3:2345/sdb_database"
    
    try:
        engine = create_engine(pg_url)
        features = DatabaseDialectHandler.get_dialect_features(engine)
        types = DatabaseDialectHandler.get_recommended_types(engine)
        
        print(f"–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: {features}")
        print(f"–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç–∏–ø—ã: {types}")
        
        with engine.connect() as conn:
            result = conn.execute(text("SELECT version()"))
            version = result.scalar()
            print(f"–í–µ—Ä—Å–∏—è PostgreSQL: {version}")
        
        return True
    except Exception as e:
        print(f"PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e}")
        return False


if __name__ == "__main__":
    print("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö...")
    
    results = {
        'SQLite': test_sqlite(),
        'MySQL': test_mysql(),
        'PostgreSQL': test_postgresql(),
    }
    
    print("\n=== –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ===")
    for db_name, success in results.items():
        status = "‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç" if success else "‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        print(f"{db_name}: {status}")


======================================================================

------------------------------ FILE: scripts/reset_alembic.py ------------------------------
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è Alembic –≤ MySQL –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
–ß–∏—Ç–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è SDB_DB_MYSQL_DSN.
"""
import asyncio
import os
import sys
from urllib.parse import urlparse, parse_qs
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å python-dotenv, –µ—Å–ª–∏ –æ–Ω –≤ venv
project_root = Path(__file__).resolve().parent.parent
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

try:
    import aiomysql
    from dotenv import load_dotenv, find_dotenv
except ImportError as e:
    print(f"‚úó –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫: {e}")
    print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ aiomysql –∏ python-dotenv: pip install aiomysql python-dotenv")
    sys.exit(1)

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
env_file = find_dotenv(filename=".env", usecwd=True, raise_error_if_not_found=False)
if env_file:
    print(f"‚ÑπÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑: {env_file}")
    load_dotenv(env_file)
else:
    print("‚ö†Ô∏è  .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

async def reset_alembic_state():
    """–û—á–∏—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É alembic_version –∏–∑ MySQL"""
    
    mysql_dsn = os.getenv("SDB_DB_MYSQL_DSN")
    
    if not mysql_dsn:
        print("‚úó –û—à–∏–±–∫–∞: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è SDB_DB_MYSQL_DSN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.")
        print("  –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–µ –≤ –≤–∞—à–µ–º .env —Ñ–∞–π–ª–µ –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.")
        print("  –ü—Ä–∏–º–µ—Ä: SDB_DB_MYSQL_DSN=\"mysql+aiomysql://user:pass@host:port/dbname?charset=utf8mb4\"")
        return

    print(f"‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DSN –∏–∑ SDB_DB_MYSQL_DSN: mysql+aiomysql://<user>:<pass>@<host>:<port>/<dbname>...")

    try:
        # –ü–∞—Ä—Å–∏–Ω–≥ DSN –¥–ª—è aiomysql.connect, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç DSN –Ω–∞–ø—Ä—è–º—É—é
        # (—Ö–æ—Ç—è SQLAlchemy create_engine –µ–≥–æ –ø–∞—Ä—Å–∏—Ç).
        # –§–æ—Ä–º–∞—Ç DSN –¥–ª—è SQLAlchemy: mysql+driver://user:password@host:port/database?params
        # –ù–∞–º –Ω—É–∂–Ω–æ –∏–∑–≤–ª–µ—á—å user, password, host, port, database.
        
        # –£–±–∏—Ä–∞–µ–º —Å—Ö–µ–º—É –∏ –¥—Ä–∞–π–≤–µ—Ä, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, –¥–ª—è urlparse
        parsed_url_str = mysql_dsn
        if parsed_url_str.startswith("mysql+aiomysql://"):
            parsed_url_str = parsed_url_str[len("mysql+aiomysql://"):]
        elif parsed_url_str.startswith("mysql://"): # –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ —É–∫–∞–∂–µ—Ç –±–µ–∑ –¥—Ä–∞–π–≤–µ—Ä–∞
             parsed_url_str = parsed_url_str[len("mysql://"):]

        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Ö–µ–º—É, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç, —á—Ç–æ–±—ã urlparse –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–ª
        if "://" not in parsed_url_str:
            parsed_url_str = f"temp://{parsed_url_str}"

        parsed_url = urlparse(parsed_url_str)
        
        db_user = parsed_url.username
        db_password = parsed_url.password
        db_host = parsed_url.hostname
        db_port = parsed_url.port or 3306 # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç MySQL
        db_name = parsed_url.path.lstrip('/') if parsed_url.path else None
        
        query_params = parse_qs(parsed_url.query)
        db_charset = query_params.get('charset', ['utf8mb4'])[0] # –î–µ—Ñ–æ–ª—Ç utf8mb4

        if not all([db_user, db_host, db_name]):
            print("‚úó –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å DSN. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç user, host –∏ –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")
            print(f"  –†–∞—Å–ø–∞—Ä—Å–µ–Ω–æ: user='{db_user}', host='{db_host}', port='{db_port}', dbname='{db_name}'")
            return

        connection_params = {
            'host': db_host,
            'port': int(db_port),
            'user': db_user,
            'db': db_name,
            'charset': db_charset
        }
        if db_password: # –ü–∞—Ä–æ–ª—å –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
            connection_params['password'] = db_password
        
        print(f"‚ÑπÔ∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MySQL: host={db_host}, port={db_port}, user={db_user}, db={db_name}, charset={db_charset}")

        connection = await aiomysql.connect(**connection_params) # type: ignore
        
        async with connection.cursor() as cursor:
            # –£–¥–∞–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É alembic_version –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            await cursor.execute("DROP TABLE IF EXISTS alembic_version")
            print("‚úì –¢–∞–±–ª–∏—Ü–∞ alembic_version —É–¥–∞–ª–µ–Ω–∞ –∏–∑ MySQL.")
            
        # await connection.commit() # DROP TABLE –æ–±—ã—á–Ω–æ –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ MySQL, –Ω–æ –¥–ª—è —è–≤–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å
        connection.close()
        print("‚úì –°–æ—Å—Ç–æ—è–Ω–∏–µ Alembic –¥–ª—è MySQL —Å–±—Ä–æ—à–µ–Ω–æ.")
        
    except aiomysql.Error as e_mysql: # –õ–æ–≤–∏–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ aiomysql
        print(f"‚úó –û—à–∏–±–∫–∞ aiomysql: –ö–æ–¥ {e_mysql.args[0]}, –°–æ–æ–±—â–µ–Ω–∏–µ: {e_mysql.args[1] if len(e_mysql.args) > 1 else str(e_mysql)}")
    except Exception as e:
        print(f"‚úó –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è MySQL: {type(e).__name__} - {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    asyncio.run(reset_alembic_state())


======================================================================

------------------------------ FILE: scripts/snapshot_generator.py ------------------------------
import os
from pathlib import Path

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
OUTPUT_FILENAME = "project_snapshot.txt"
EXCLUDE_DIRS = {
    ".venv", "venv", "__pycache__", ".git", ".idea", ".vscode",
    "build", "dist", "*.egg-info", "node_modules",
    "Data/Cache", "Data/LogsBot", "Data/Temp", "Data/Uploads", # –ò–∑ —Ç–≤–æ–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Data/
    "logs" # –û–±—â–∞—è –ø–∞–ø–∫–∞ –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –µ—Å—Ç—å
    "modules", # –ü–∞–ø–∫–∞ —Å –º–æ–¥—É–ª—è–º–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
}
EXCLUDE_FILES = {
    OUTPUT_FILENAME,  # –ù–µ –≤–∫–ª—é—á–∞—Ç—å —Å–∞–º —Ñ–∞–π–ª –≤—ã–≤–æ–¥–∞
    ".DS_Store",
    "*.pyc",
    "*.swp",
    "*.swo",
    # –î–æ–±–∞–≤—å —Å—é–¥–∞ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –±–æ–ª—å—à–∏–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏
    "project_snapshot.txt"
    "TEST.md"
}
EXCLUDE_EXTENSIONS = {
    ".sqlite", ".db", ".db-journal", # –§–∞–π–ª—ã –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö (–º–æ–≥—É—Ç –±—ã—Ç—å –±–æ–ª—å—à–∏–º–∏)
    ".log", # –£–∂–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç—Å—è EXCLUDE_DIRS, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    # –î–æ–±–∞–≤—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å
    # ".zip", ".tar.gz"
}
MAX_FILE_SIZE_MB = 2  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (–≤ –ú–ë)
MAX_TOTAL_OUTPUT_SIZE_MB = 50 # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ª–∏–º–∏—Ç –Ω–∞ –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–º)

# –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
FILE_ENCODING = "utf-8"
# --- –ö–æ–Ω–µ—Ü –Ω–∞—Å—Ç—Ä–æ–µ–∫ ---

def should_exclude_dir(dir_name, exclude_set):
    return dir_name in exclude_set

def should_exclude_file(file_name, file_path, exclude_files_set, exclude_ext_set):
    if file_name in exclude_files_set:
        return True
    if file_path.suffix.lower() in exclude_ext_set:
        return True
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ –º–∞—Å–∫–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    # import fnmatch
    # for pattern in exclude_files_set:
    #     if fnmatch.fnmatch(file_name, pattern):
    #         return True
    return False

def get_dir_tree(start_path, indent_char="    ", max_depth=10):
    tree_lines = []
    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –≥–ª—É–±–∏–Ω—É —Ä–µ–∫—É—Ä—Å–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–≥–æ –¥–µ—Ä–µ–≤–∞
    if max_depth < 0:
        return ["... (Max depth reached)"]

    try:
        items = sorted(list(start_path.iterdir()), key=lambda p: (p.is_file(), p.name.lower()))
    except PermissionError:
        return [f"... (Permission denied: {start_path})"]
    except FileNotFoundError:
        return [f"... (Not found: {start_path})"]


    for i, item in enumerate(items):
        is_last = i == (len(items) - 1)
        prefix = indent_char + ("‚îî‚îÄ‚îÄ " if is_last else "‚îú‚îÄ‚îÄ ")

        if item.is_dir():
            if should_exclude_dir(item.name, EXCLUDE_DIRS):
                tree_lines.append(f"{prefix}{item.name}/ [EXCLUDED_DIR]")
                continue
            tree_lines.append(f"{prefix}{item.name}/")
            # –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            # –£–º–µ–Ω—å—à–∞–µ–º max_depth –¥–ª—è –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
            sub_indent = indent_char + ("    " if is_last else "‚îÇ   ")
            tree_lines.extend([sub_indent + line for line in get_dir_tree(item, indent_char, max_depth -1)])
        else:
            if should_exclude_file(item.name, item, EXCLUDE_FILES, EXCLUDE_EXTENSIONS):
                tree_lines.append(f"{prefix}{item.name} [EXCLUDED_FILE]")
                continue
            tree_lines.append(f"{prefix}{item.name}")
            
    return tree_lines


def main():
    project_root = Path(".") # –ó–∞–ø—É—Å–∫–∞—Ç—å –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
    snapshot_content = []
    current_total_size = 0
    max_total_bytes = MAX_TOTAL_OUTPUT_SIZE_MB * 1024 * 1024

    # 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
    snapshot_content.append("=" * 30 + " PROJECT STRUCTURE " + "=" * 30)
    snapshot_content.append(f"{project_root.resolve().name}/")
    tree_str = "\n".join(get_dir_tree(project_root))
    snapshot_content.append(tree_str)
    snapshot_content.append("\n" + "=" * 70 + "\n")
    current_total_size += len(tree_str.encode(FILE_ENCODING, errors='ignore'))


    # 2. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤
    for item_path in project_root.rglob("*"): # –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –æ–±—Ö–æ–¥ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫
        if current_total_size > max_total_bytes:
            snapshot_content.append("\n... (Total output size limit reached, stopping file content inclusion) ...\n")
            print(f"Warning: Total output size limit ({MAX_TOTAL_OUTPUT_SIZE_MB}MB) reached. Some file contents might be omitted.")
            break

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ rglob
        is_in_excluded_dir = False
        for part in item_path.relative_to(project_root).parts:
            if part in EXCLUDE_DIRS:
                is_in_excluded_dir = True
                break
        if is_in_excluded_dir and item_path.is_dir(): # –ï—Å–ª–∏ —Å–∞–º–∞ –ø–∞–ø–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–µ rglob
            continue
        if item_path.is_dir(): # –ï—Å–ª–∏ —ç—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (—É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –≤ –¥–µ—Ä–µ–≤–µ)
            if item_path.name in EXCLUDE_DIRS: # –î–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞
                 continue
            continue


        relative_path_str = str(item_path.relative_to(project_root))

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ñ–∞–π–ª –≤–Ω—É—Ç—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        # –≠—Ç–æ –Ω—É–∂–Ω–æ, —Ç.–∫. rglob –º–æ–∂–µ—Ç –¥–∞—Ç—å —Ñ–∞–π–ª—ã –∏–∑ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ö–æ—Ç–∏–º –∏—Å–∫–ª—é—á–∏—Ç—å —Ü–µ–ª–∏–∫–æ–º
        parent_excluded = False
        for parent in item_path.parents:
            if parent.name in EXCLUDE_DIRS:
                parent_excluded = True
                break
        if parent_excluded:
            # print(f"Skipping (parent excluded): {relative_path_str}")
            continue
            
        if item_path.name in EXCLUDE_DIRS: # –ï—Å–ª–∏ —Å–∞–º —Ñ–∞–π–ª - —ç—Ç–æ –∏–º—è –∏—Å–∫–ª—é—á–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã)
            # print(f"Skipping (matches excluded dir name): {relative_path_str}")
            continue

        if should_exclude_file(item_path.name, item_path, EXCLUDE_FILES, EXCLUDE_EXTENSIONS):
            # print(f"Skipping (excluded file/ext): {relative_path_str}")
            continue
        
        snapshot_content.append("-" * 30 + f" FILE: {relative_path_str} " + "-" * 30)
        try:
            file_size = item_path.stat().st_size
            if file_size > MAX_FILE_SIZE_MB * 1024 * 1024:
                snapshot_content.append(f"[CONTENT OMITTED - File size ({file_size / (1024*1024):.2f} MB) > {MAX_FILE_SIZE_MB} MB]\n")
                print(f"Skipping content of large file: {relative_path_str}")
            else:
                with open(item_path, "r", encoding=FILE_ENCODING, errors="ignore") as f:
                    content = f.read()
                snapshot_content.append(content + "\n")
                current_total_size += len(content.encode(FILE_ENCODING, errors='ignore'))

        except Exception as e:
            snapshot_content.append(f"[ERROR READING FILE: {e}]\n")
            print(f"Error reading file {relative_path_str}: {e}")
        snapshot_content.append("\n" + "=" * 70 + "\n")


    # 3. –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª
    try:
        with open(OUTPUT_FILENAME, "w", encoding=FILE_ENCODING) as f:
            f.write("\n".join(snapshot_content))
        print(f"Project snapshot saved to: {OUTPUT_FILENAME}")
        print(f"Approximate total output size: {current_total_size / (1024*1024):.2f} MB")

    except Exception as e:
        print(f"Error writing snapshot file: {e}")

if __name__ == "__main__":
    main()


======================================================================

------------------------------ FILE: scripts/create_project_structure.py ------------------------------
from pathlib import Path

# –ò–º—è –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ (–µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –≤–Ω—É—Ç—Ä–∏ –Ω–µ–µ, —Ç–æ ".")
PROJECT_ROOT_NAME = "." # –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –≤ –∫–æ—Ä–Ω–µ SwiftDevBot
# –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç —Å–Ω–∞—Ä—É–∂–∏, —Ç–æ PROJECT_ROOT_NAME = "SwiftDevBot"

def create_dir(path: Path):
    path.mkdir(parents=True, exist_ok=True)
    print(f"–°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {path}")

def create_file(path: Path, content: str = ""):
    path.touch(exist_ok=True)
    if content:
        path.write_text(content, encoding='utf-8')
    print(f"–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {path}")

def main():
    project_root = Path(PROJECT_ROOT_NAME).resolve()
    
    if PROJECT_ROOT_NAME != ".": # –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ –≤ –∫–æ—Ä–Ω–µ, —Å–æ–∑–¥–∞–µ–º –∫–æ—Ä–µ–Ω—å
        create_dir(project_root)

    print(f"–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞: {project_root}")

    # 1. –§–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
    create_file(project_root / ".env")
    create_file(project_root / "run_bot.py")
    create_file(project_root / "sdb.py") # –ò–ª–∏ sdb –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, –µ—Å–ª–∏ –ø–æ—Ç–æ–º —Å–¥–µ–ª–∞–µ—à—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
    create_file(project_root / "requirements.txt")
    create_file(project_root / "requirements-dev.txt")
    create_file(project_root / "alembic.ini")
    create_file(project_root / "config.yaml", "# –®–∞–±–ª–æ–Ω/–¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥")
    
    # 2. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —è–¥—Ä–∞ core/
    core_path = project_root / "core"
    core_subdirs = ["database", "cache", "http_client", "ui", "rbac", "utils_core", "i18n", "events"]
    for subdir in core_subdirs:
        create_dir(core_path / subdir)
        create_file(core_path / subdir / "__init__.py")

    create_file(core_path / "__init__.py")
    create_file(core_path / "app_settings.py")
    create_file(core_path / "services_provider.py")
    create_file(core_path / "bot_entrypoint.py")
    create_file(core_path / "module_loader.py")

    create_file(core_path / "database" / "base.py")
    create_file(core_path / "database" / "manager.py")
    create_file(core_path / "database" / "core_models.py")

    create_file(core_path / "cache" / "manager.py")
    create_file(core_path / "http_client" / "manager.py")

    create_file(core_path / "ui" / "keyboards_core.py")
    create_file(core_path / "ui" / "navigation_core.py")
    create_file(core_path / "ui" / "registry_ui.py")
    # create_file(core_path / "ui" / "callback_data_factories.py")

    create_file(core_path / "i18n" / "middleware.py")
    create_file(core_path / "i18n" / "translator.py")

    create_file(core_path / "events" / "dispatcher.py")
    
    create_file(core_path / "rbac" / "service.py")
    create_file(core_path / "utils_core" / "__init__.py") # –£–∂–µ —Å–æ–∑–¥–∞–Ω –≤—ã—à–µ, –Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã
    # create_file(core_path / "utils_core" / "command_utils.py")

    # 3. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –º–æ–¥—É–ª–µ–π modules/
    modules_path = project_root / "modules"
    create_dir(modules_path)
    create_file(modules_path / "__init__.py")
    create_file(modules_path / ".gitkeep")

    system_module_path = modules_path / "system_base_module"
    create_dir(system_module_path)
    create_file(system_module_path / "__init__.py")
    create_file(system_module_path / "handlers_system.py")
    create_file(system_module_path / "keyboards_system.py")
    create_file(system_module_path / "manifest.yaml") # –∏–ª–∏ .json

    example_module_path = modules_path / "example_module"
    create_dir(example_module_path)
    create_file(example_module_path / "__init__.py")
    create_file(example_module_path / "handlers_example.py")
    create_file(example_module_path / "keyboards_example.py")
    create_file(example_module_path / "models_example.py")
    create_file(example_module_path / "manifest.yaml") # –∏–ª–∏ .json

    # 4. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –ª–æ–≥–∏–∫–∏ CLI –∫–æ–º–∞–Ω–¥ cli_commands/
    cli_commands_path = project_root / "cli_commands"
    create_dir(cli_commands_path)
    create_file(cli_commands_path / "__init__.py")
    create_file(cli_commands_path / "setup_cmd.py")
    create_file(cli_commands_path / "db_cmd.py")
    create_file(cli_commands_path / "module_cmd.py")
    create_file(cli_commands_path / "user_cmd.py")
    create_file(cli_commands_path / "backup_cmd.py")
    create_file(cli_commands_path / "system_cmd.py")
    create_file(cli_commands_path / "cli_utils.py")

    # 5. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π Alembic alembic_migrations/
    alembic_path = project_root / "alembic_migrations"
    create_dir(alembic_path / "versions") # versions —Å–æ–∑–¥–∞–µ—Ç—Å—è alembic init
    create_file(alembic_path / "versions" / ".gitkeep") # –ß—Ç–æ–±—ã versions –ø–∞–ø–∫–∞ –±—ã–ª–∞
    # –î–ª—è env.py –∏ script.py.mako –ª—É—á—à–µ, —á—Ç–æ–±—ã –∏—Ö —Å–æ–∑–¥–∞–ª alembic init
    # –ù–æ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç—ã–µ –∑–∞–≥–ª—É—à–∫–∏, –µ—Å–ª–∏ alembic init –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å—Ä–∞–∑—É
    create_file(alembic_path / "env.py", "# Alembic env.py - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–ª—è SDB") 
    create_file(alembic_path / "script.py.mako", '"""${message} ..."""\n# ... (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω)')


    # 6. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞ project_data/
    project_data_path = project_root / "project_data"
    data_subdirs = ["Config", "Logs", "Cache_data", "Database_files", "module_backups", "core_backups"]
    for subdir in data_subdirs:
        create_dir(project_data_path / subdir)
        create_file(project_data_path / subdir / ".gitkeep")
    
    create_file(project_data_path / ".gitignore", "*\n!.gitignore\n!*/\n!.gitkeep\n")
    # create_file(project_data_path / "Config" / "core_settings.yaml") # –°–æ–∑–¥–∞—Å—Ç—Å—è —á–µ—Ä–µ–∑ sdb setup
    # create_file(project_data_path / "Config" / "enabled_modules.json")

    # 7. –ü–∞–ø–∫–∞ –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ locales/
    locales_path = project_root / "locales"
    create_dir(locales_path / "en" / "LC_MESSAGES")
    create_dir(locales_path / "ua" / "LC_MESSAGES")
    create_file(locales_path / "bot.pot")
    create_file(locales_path / "en" / "LC_MESSAGES" / "bot.po")
    create_file(locales_path / "ua" / "LC_MESSAGES" / "bot.po")
    
    # 8. –ü–∞–ø–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ tests/ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    # tests_path = project_root / "tests"
    # tests_subdirs = ["core_tests", "module_tests", "cli_tests"]
    # create_dir(tests_path)
    # create_file(tests_path / "__init__.py")
    # for subdir in tests_subdirs:
    #     create_dir(tests_path / subdir)
    #     create_file(tests_path / subdir / "__init__.py")
    # create_file(tests_path / "smoke_test_cli.py")

    print("\n–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ SwiftDevBot —Å–æ–∑–¥–∞–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Python —Å–∫—Ä–∏–ø—Ç–∞!")
    print("–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:")
    print("1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ 'alembic init alembic_migrations' –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã Alembic —Å–∞–º —Å–æ–∑–¥–∞–ª env.py –∏ script.py.mako.")
    print("   (–ø–µ—Ä–µ–¥ —ç—Ç–∏–º —É–¥–∞–ª–∏—Ç–µ alembic_migrations/env.py –∏ alembic_migrations/script.py.mako, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã —ç—Ç–∏–º —Å–∫—Ä–∏–ø—Ç–æ–º).")
    print("2. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å alembic.ini (script_location = alembic_migrations) –∏ —Å–∞–º alembic_migrations/env.py.")
    print("3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ .gitignore –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.")

if __name__ == "__main__":
    main()


======================================================================

------------------------------ FILE: scripts/clean_cache.py ------------------------------
import os
import shutil
from pathlib import Path

def clean_pycache(start_path: str = "."):
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ __pycache__ –∏ .pyc —Ñ–∞–π–ª—ã."""
    
    counter = {"dirs": 0, "files": 0}
    
    for root, dirs, files in os.walk(start_path):
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é .venv –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if ".venv" in root:
            continue
            
        # –£–¥–∞–ª—è–µ–º __pycache__ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        if "__pycache__" in dirs:
            cache_path = Path(root) / "__pycache__"
            shutil.rmtree(cache_path)
            print(f"üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {cache_path}")
            counter["dirs"] += 1
            
        # –£–¥–∞–ª—è–µ–º .pyc —Ñ–∞–π–ª—ã
        for file in files:
            if file.endswith(".pyc"):
                file_path = Path(root) / file
                os.remove(file_path)
                print(f"üóëÔ∏è  –£–¥–∞–ª–µ–Ω —Ñ–∞–π–ª: {file_path}")
                counter["files"] += 1
    
    return counter

if __name__ == "__main__":
    # –ò–∑–º–µ–Ω—è–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
    project_root = str(Path(__file__).parent.parent)
    print(f"üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {project_root}")
    results = clean_pycache(project_root)
    
    print("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏:")
    print(f"- –£–¥–∞–ª–µ–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π __pycache__: {results['dirs']}")
    print(f"- –£–¥–∞–ª–µ–Ω–æ .pyc —Ñ–∞–π–ª–æ–≤: {results['files']}")


======================================================================

------------------------------ FILE: modules/example_module/permissions.py ------------------------------
# modules/example_module/permissions.py

MODULE_NAME = "example_module" # –í–∞–∂–Ω–æ, —á—Ç–æ–±—ã —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å –∏–º–µ–Ω–µ–º –º–æ–¥—É–ª—è/–ø–∞–ø–∫–∏

# –ë–∞–∑–æ–≤—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –º–æ–¥—É–ª—è
PERM_ACCESS_USER_FEATURES = f"{MODULE_NAME}.access_user_features"

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
PERM_VIEW_MODULE_SETTINGS = f"{MODULE_NAME}.view_module_settings" # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
PERM_VIEW_SECRET_INFO = f"{MODULE_NAME}.view_secret_info"

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
PERM_PERFORM_BASIC_ACTION = f"{MODULE_NAME}.perform_basic_action" # –°—Ç–∞—Ä–æ–µ "do_magic"
PERM_PERFORM_ADVANCED_ACTION = f"{MODULE_NAME}.perform_advanced_action"

# –†–∞–±–æ—Ç–∞ —Å –∑–∞–º–µ—Ç–∫–∞–º–∏ (CRUD)
PERM_MANAGE_OWN_NOTES = f"{MODULE_NAME}.manage_own_notes" # –û–±—â–µ–µ –ø—Ä–∞–≤–æ –Ω–∞ —Å–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏

# –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–ª—è –º–æ–¥—É–ª—è
PERM_ADMIN_VIEW_ALL_NOTES = f"{MODULE_NAME}.admin_view_all_notes"
PERM_ADMIN_MANAGE_MODULE = f"{MODULE_NAME}.admin_manage_module" # –û–±—â–µ–µ –∞–¥–º–∏–Ω—Å–∫–æ–µ –ø—Ä–∞–≤–æ –¥–ª—è –º–æ–¥—É–ª—è


======================================================================

------------------------------ FILE: modules/example_module/handlers_example.py ------------------------------
# modules/example_module/handlers_example.py
from aiogram import Router, types, F, Bot
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.markdown import hbold, hcode, hitalic
from aiogram.exceptions import TelegramBadRequest 
from loguru import logger
from sqlalchemy import select, delete as sql_delete, func 

from .keyboards_example import (
    get_example_module_main_menu_keyboard,
    get_my_notes_keyboard,
    get_note_details_keyboard
)
from .callback_data_factories_example import ExampleModuleAction
from core.ui.callback_data_factories import ModuleMenuEntry, CoreMenuNavigate 
from .permissions import ( 
    MODULE_NAME, 
    PERM_ACCESS_USER_FEATURES,
    PERM_VIEW_MODULE_SETTINGS,
    PERM_VIEW_SECRET_INFO,
    PERM_PERFORM_BASIC_ACTION,
    PERM_PERFORM_ADVANCED_ACTION,
    PERM_MANAGE_OWN_NOTES,
    PERM_ADMIN_VIEW_ALL_NOTES,
    PERM_ADMIN_MANAGE_MODULE 
)
from .models import UserNote 

from typing import TYPE_CHECKING, Any, List, Optional
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession

example_module_router = Router(name="sdb_example_module_handlers")

class FSMExampleDialog(StatesGroup):
    waiting_for_name = State()
    waiting_for_age = State()

class FSMAddNote(StatesGroup):
    waiting_for_note_text = State()

async def check_permission(
    user_id: int, 
    permission_name: str, 
    services: 'BotServicesProvider', 
    session: 'AsyncSession'
) -> bool:
    has_perm = await services.rbac.user_has_permission(session, user_id, permission_name)
    if not has_perm:
        logger.warning(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–æ–ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏–∏, —Ç—Ä–µ–±—É—é—â–µ–π –ø—Ä–∞–≤–∞ '{permission_name}', –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –µ–≥–æ.")
    return has_perm

@example_module_router.message(Command("example"))
async def handle_example_command(
    message: types.Message, 
    services_provider: 'BotServicesProvider'
):
    user_id = message.from_user.id
    logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤—ã–∑–≤–∞–ª –∫–æ–º–∞–Ω–¥—É /example.")
    
    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_ACCESS_USER_FEATURES, services_provider, session):
            await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –º–æ–¥—É–ª—é.")
            return

    module_info = services_provider.modules.get_module_info(MODULE_NAME)
    display_name = module_info.manifest.display_name if module_info and module_info.manifest else MODULE_NAME
    
    text = (f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ {hbold(display_name)}!\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:")
    async with services_provider.db.get_session() as session: 
        keyboard = await get_example_module_main_menu_keyboard(services_provider, user_id, session)
    await message.answer(text, reply_markup=keyboard)

@example_module_router.callback_query(ModuleMenuEntry.filter(F.module_name == MODULE_NAME))
async def cq_show_example_module_main_menu(
    query: types.CallbackQuery, 
    callback_data: ModuleMenuEntry, 
    services_provider: 'BotServicesProvider'
):
    user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤–æ—à–µ–ª –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –º–æ–¥—É–ª—è.")

    async with services_provider.db.get_session() as session: 
        if not await check_permission(user_id, PERM_ACCESS_USER_FEATURES, services_provider, session):
            await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –º–µ–Ω—é.", show_alert=True)
            return

        module_info = services_provider.modules.get_module_info(MODULE_NAME)
        display_name = module_info.manifest.display_name if module_info and module_info.manifest else MODULE_NAME

        text = (f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ {hbold(display_name)}!\n"
                f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:")
        keyboard = await get_example_module_main_menu_keyboard(services_provider, user_id, session)
    
        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
                await query.answer()
            except TelegramBadRequest as e: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
                if "message is not modified" in str(e).lower(): await query.answer()
                else: logger.warning(f"[{MODULE_NAME}] –û—à–∏–±–∫–∞ edit_text –≤ –º–µ–Ω—é –º–æ–¥—É–ª—è: {e}")
            except Exception as e: 
                logger.error(f"[{MODULE_NAME}] –û—à–∏–±–∫–∞ –≤ cq_show_example_module_main_menu: {e}", exc_info=True)
                await query.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.", show_alert=True)
        else:
            await query.answer()

@example_module_router.callback_query(ExampleModuleAction.filter(F.action == "show_module_settings"))
async def cq_action_show_module_settings(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider'
):
    user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–∫–∞–∑–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è.")
    
    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_VIEW_MODULE_SETTINGS, services_provider, session):
            await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.", show_alert=True)
            return

        actual_module_settings = services_provider.modules.get_module_settings(MODULE_NAME)
        settings_text_parts = [f"‚öôÔ∏è {hbold('–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è')} {hcode(MODULE_NAME)}:"]
        if actual_module_settings:
            for key, value in actual_module_settings.items():
                settings_text_parts.append(f"  ‚ñ´Ô∏è {hcode(key)}: {hcode(str(value))}")
        else:
            settings_text_parts.append("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")
        
        text = "\n".join(settings_text_parts)
        keyboard = await get_example_module_main_menu_keyboard(services_provider, user_id, session)
    
        if query.message:
            try:
                if query.message.text != text: await query.message.edit_text(text, reply_markup=keyboard)
                await query.answer()
            except TelegramBadRequest as e: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
                if "message is not modified" not in str(e).lower(): logger.warning(f"[{MODULE_NAME}] –û—à–∏–±–∫–∞ edit_text (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏): {e}")
                await query.answer()
            except Exception as e:
                logger.error(f"[{MODULE_NAME}] –û—à–∏–±–∫–∞ –≤ cq_action_show_module_settings: {e}", exc_info=True)
                await query.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.", show_alert=True)

@example_module_router.callback_query(ExampleModuleAction.filter(F.action == "show_secret_info"))
async def cq_action_show_secret_info(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_VIEW_SECRET_INFO, services_provider, session):
            await query.answer("ü§´ –≠—Ç–æ —Å–µ–∫—Ä–µ—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –¥–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω!", show_alert=True)
            return
    await query.answer("üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π —Å—É–ø–µ—Ä-—Å–µ–∫—Ä–µ—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏! üéâ", show_alert=True)

@example_module_router.callback_query(ExampleModuleAction.filter(F.action == "do_basic_action"))
async def cq_action_do_basic_action(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_PERFORM_BASIC_ACTION, services_provider, session):
            await query.answer("–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.", show_alert=True)
            return
    await query.answer("‚úÖ –ë–∞–∑–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!", show_alert=True)

@example_module_router.callback_query(ExampleModuleAction.filter(F.action == "do_advanced_action"))
async def cq_action_do_advanced_action(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_PERFORM_ADVANCED_ACTION, services_provider, session):
            await query.answer("üöÄ –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Å–æ–±—ã—Ö –ø—Ä–∞–≤!", show_alert=True)
            return
    await query.answer("üí• –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! üí•", show_alert=True)

@example_module_router.message(Command("fsm_example"))
async def cmd_fsm_start(message: types.Message, state: FSMContext, services_provider: 'BotServicesProvider'):
    user_id = message.from_user.id
    logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞—á–∞–ª FSM-–¥–∏–∞–ª–æ–≥ (/fsm_example).")
    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_ACCESS_USER_FEATURES, services_provider, session): 
            await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.")
            return
    await state.set_state(FSMExampleDialog.waiting_for_name)
    await message.answer("–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç –≤ —ç—Ç–æ–º FSM-–¥–∏–∞–ª–æ–≥–µ?")

@example_module_router.message(StateFilter(FSMExampleDialog.waiting_for_name))
async def process_fsm_name(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    if not message.text:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —Å–≤–æ–µ –∏–º—è —Ç–µ–∫—Å—Ç–æ–º.")
        return
    await state.update_data(name=message.text)
    await state.set_state(FSMExampleDialog.waiting_for_age)
    logger.info(f"[{MODULE_NAME}] FSM: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤–≤–µ–ª –∏–º—è: {message.text}")
    await message.answer(f"–ü—Ä–∏—è—Ç–Ω–æ, {hitalic(message.text)}! –ê —Å–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç (FSM)?")

@example_module_router.message(StateFilter(FSMExampleDialog.waiting_for_age))
async def process_fsm_age(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    if not message.text or not message.text.isdigit():
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —Å–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç —Ü–∏—Ñ—Ä–∞–º–∏.")
        return
    age = int(message.text)
    if not (0 < age < 120):
        await message.answer("–ù–µ–æ–±—ã—á–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.")
        return
    user_data = await state.get_data()
    name = user_data.get("name", "–ù–µ–∑–Ω–∞–∫–æ–º–µ—Ü")
    logger.info(f"[{MODULE_NAME}] FSM: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} (–∏–º—è: {name}) –≤–≤–µ–ª –≤–æ–∑—Ä–∞—Å—Ç: {age}")
    await message.answer(
        f"–ó–∞–ø–æ–º–Ω–∏–ª, {hitalic(name)} ({age} –ª–µ—Ç)!\n"
        f"FSM –¥–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω. –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ."
    )
    await state.clear() 

@example_module_router.message(Command("cancel_fsm"), StateFilter(FSMExampleDialog)) 
async def cancel_fsm_dialog(message: types.Message, state: FSMContext):
    current_state = await state.get_state()
    logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –æ—Ç–º–µ–Ω–∏–ª FSM –¥–∏–∞–ª–æ–≥ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è {current_state}")
    await state.clear()
    await message.answer("FSM –¥–∏–∞–ª–æ–≥ –æ—Ç–º–µ–Ω–µ–Ω.")

@example_module_router.message(Command("my_notes"))
async def cmd_my_notes(message: types.Message, services_provider: 'BotServicesProvider'):
    user_id = message.from_user.id
    logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏ (/my_notes).")
    
    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_MANAGE_OWN_NOTES, services_provider, session):
            await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∞–º–∏.")
            return

        stmt = select(UserNote).where(UserNote.user_telegram_id == user_id).order_by(UserNote.created_at.desc())
        result = await session.execute(stmt)
        notes: List[UserNote] = list(result.scalars().all())
        
        text = f"üìù {hbold('–í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏')}:"
        if not notes:
            text += "\n–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫. –ú–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é."
            
        keyboard = await get_my_notes_keyboard(notes, services_provider, user_id, session)
        await message.answer(text, reply_markup=keyboard)

@example_module_router.callback_query(ExampleModuleAction.filter(F.action == "my_notes_list"))
async def cq_my_notes_list(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–ø–∏—Å–æ–∫ —Å–≤–æ–∏—Ö –∑–∞–º–µ—Ç–æ–∫ (callback).")
    
    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_MANAGE_OWN_NOTES, services_provider, session):
            await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∞–º–∏.", show_alert=True)
            return

        stmt = select(UserNote).where(UserNote.user_telegram_id == user_id).order_by(UserNote.created_at.desc())
        result = await session.execute(stmt)
        notes: List[UserNote] = list(result.scalars().all())
        
        text = f"üìù {hbold('–í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏')}:"
        if not notes:
            text += "\n–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫. –ú–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é."
            
        keyboard = await get_my_notes_keyboard(notes, services_provider, user_id, session)
        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
                await query.answer()
            except TelegramBadRequest as e: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
                if "message is not modified" not in str(e).lower(): logger.warning(f"–û—à–∏–±–∫–∞ edit_text –≤ cq_my_notes_list: {e}")
                await query.answer()
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ cq_my_notes_list: {e}", exc_info=True)
                await query.answer("–û—à–∏–±–∫–∞.", show_alert=True)

@example_module_router.callback_query(ExampleModuleAction.filter(F.action == "add_note_start"))
async def cq_add_note_start(query: types.CallbackQuery, state: FSMContext, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_MANAGE_OWN_NOTES, services_provider, session):
            await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫.", show_alert=True)
            return
    
    module_settings = services_provider.modules.get_module_settings(MODULE_NAME)
    max_notes = module_settings.get("max_notes_per_user", 5) if module_settings else 5
    
    async with services_provider.db.get_session() as session: 
        count_stmt = select(func.count(UserNote.id)).where(UserNote.user_telegram_id == user_id)
        notes_count_res = await session.execute(count_stmt)
        notes_count = notes_count_res.scalar_one_or_none() or 0

    if notes_count >= max_notes:
        await query.answer(f"–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∑–∞–º–µ—Ç–æ–∫ ({max_notes} —à—Ç.). –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ.", show_alert=True)
        return

    await state.set_state(FSMAddNote.waiting_for_note_text)
    await query.message.answer("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–∞—à–µ–π –Ω–æ–≤–æ–π –∑–∞–º–µ—Ç–∫–∏:") # type: ignore
    await query.answer()

@example_module_router.message(StateFilter(FSMAddNote.waiting_for_note_text))
async def process_add_note_text(message: types.Message, state: FSMContext, services_provider: 'BotServicesProvider'):
    user_id = message.from_user.id
    if not message.text:
        await message.answer("–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ /cancel_note.")
        return

    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_MANAGE_OWN_NOTES, services_provider, session):
            await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫.")
            await state.clear()
            return
        
        new_note = UserNote(user_telegram_id=user_id, note_text=message.text)
        session.add(new_note)
        try:
            await session.commit()
            logger.info(f"[{MODULE_NAME}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –¥–æ–±–∞–≤–∏–ª –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É: '{message.text[:30]}...'")
            await message.answer(f"‚úÖ –ó–∞–º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /my_notes –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.")
        except Exception as e:
            await session.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏ –¥–ª—è {user_id}: {e}", exc_info=True)
            await message.answer("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        finally:
            await state.clear()

@example_module_router.message(Command("cancel_note"), StateFilter(FSMAddNote))
async def cancel_add_note_fsm(message: types.Message, state: FSMContext):
    await state.clear()
    await message.answer("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.")

@example_module_router.callback_query(ExampleModuleAction.filter(F.action == "view_note_details"))
async def cq_view_note_details(query: types.CallbackQuery, callback_data: ExampleModuleAction, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    note_id = callback_data.item_id
    if note_id is None:
        await query.answer("–û—à–∏–±–∫–∞: ID –∑–∞–º–µ—Ç–∫–∏ –Ω–µ —É–∫–∞–∑–∞–Ω.", show_alert=True); return

    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_MANAGE_OWN_NOTES, services_provider, session):
            await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —ç—Ç–æ–π –∑–∞–º–µ—Ç–∫–∏.", show_alert=True); return
        
        note = await session.get(UserNote, note_id)
        if not note or note.user_telegram_id != user_id:
            await query.answer("–ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –∫ –Ω–µ–π –¥–æ—Å—Ç—É–ø–∞.", show_alert=True); return
            
        text = f"üìù {hbold('–î–µ—Ç–∞–ª–∏ –∑–∞–º–µ—Ç–∫–∏:')}\n\n{hitalic(note.note_text)}\n\n–°—Ç–∞—Ç—É—Å: {'‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' if note.is_done else 'üîò –í –ø—Ä–æ—Ü–µ—Å—Å–µ'}"
        keyboard = await get_note_details_keyboard(note, services_provider, user_id, session)
        if query.message:
            try:
                await query.message.edit_text(text, reply_markup=keyboard)
                await query.answer()
            except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ –≤ cq_view_note_details: {e}")

@example_module_router.callback_query(ExampleModuleAction.filter(F.action == "toggle_note_done"))
async def cq_toggle_note_done(query: types.CallbackQuery, callback_data: ExampleModuleAction, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    note_id = callback_data.item_id
    if note_id is None: await query.answer("–û—à–∏–±–∫–∞ ID.", show_alert=True); return

    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_MANAGE_OWN_NOTES, services_provider, session):
            await query.answer("–ù–µ—Ç –ø—Ä–∞–≤.", show_alert=True); return
        
        note = await session.get(UserNote, note_id)
        if not note or note.user_telegram_id != user_id:
            await query.answer("–ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞/–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞.", show_alert=True); return
            
        note.is_done = not note.is_done
        session.add(note)
        alert_text = ""
        try:
            await session.commit()
            alert_text = "–°—Ç–∞—Ç—É—Å –∑–∞–º–µ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω."
            logger.info(f"–°—Ç–∞—Ç—É—Å –∑–∞–º–µ—Ç–∫–∏ ID {note.id} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {note.is_done} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")
            text = f"üìù {hbold('–î–µ—Ç–∞–ª–∏ –∑–∞–º–µ—Ç–∫–∏:')}\n\n{hitalic(note.note_text)}\n\n–°—Ç–∞—Ç—É—Å: {'‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' if note.is_done else 'üîò –í –ø—Ä–æ—Ü–µ—Å—Å–µ'}"
            keyboard = await get_note_details_keyboard(note, services_provider, user_id, session)
            if query.message: await query.message.edit_text(text, reply_markup=keyboard)
        except Exception as e:
            await session.rollback()
            alert_text = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."
            logger.error(f"–û—à–∏–±–∫–∞ toggle_note_done: {e}")
        await query.answer(alert_text)

@example_module_router.callback_query(ExampleModuleAction.filter(F.action == "delete_note_confirm"))
async def cq_delete_note_confirm(query: types.CallbackQuery, callback_data: ExampleModuleAction, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    note_id = callback_data.item_id
    if note_id is None: await query.answer("–û—à–∏–±–∫–∞ ID.", show_alert=True); return

    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_MANAGE_OWN_NOTES, services_provider, session):
            await query.answer("–ù–µ—Ç –ø—Ä–∞–≤.", show_alert=True); return
        
        stmt = sql_delete(UserNote).where(UserNote.id == note_id, UserNote.user_telegram_id == user_id)
        result = await session.execute(stmt)
        alert_text = ""
        if result.rowcount > 0:
            try:
                await session.commit()
                alert_text = "–ó–∞–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞."
                logger.info(f"–ó–∞–º–µ—Ç–∫–∞ ID {note_id} —É–¥–∞–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}.")
                notes_stmt = select(UserNote).where(UserNote.user_telegram_id == user_id).order_by(UserNote.created_at.desc())
                notes_res = await session.execute(notes_stmt)
                notes: List[UserNote] = list(notes_res.scalars().all())
                list_text = f"üìù {hbold('–í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏')}:" + ("\n–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫." if not notes else "")
                list_kb = await get_my_notes_keyboard(notes, services_provider, user_id, session)
                if query.message: await query.message.edit_text(list_text, reply_markup=list_kb)
            except Exception as e:
                await session.rollback()
                alert_text = "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è."
                logger.error(f"–û—à–∏–±–∫–∞ commit –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏: {e}")
        else:
            alert_text = "–ó–∞–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞."
        await query.answer(alert_text)

@example_module_router.message(Command("example_admin"))
async def cmd_example_admin(message: types.Message, services_provider: 'BotServicesProvider'):
    user_id = message.from_user.id
    async with services_provider.db.get_session() as session:
        if not await check_permission(user_id, PERM_ADMIN_MANAGE_MODULE, services_provider, session):
            await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            return
    await message.answer("–í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –∫–æ–º–∞–Ω–¥—É –º–æ–¥—É–ª—è Example!")


======================================================================

------------------------------ FILE: modules/example_module/callback_data_factories_example.py ------------------------------
# modules/example_module/callback_data_factories_example.py

from aiogram.filters.callback_data import CallbackData
from typing import Optional

EXAMPLE_MODULE_PREFIX = "exmpl" 

class ExampleModuleAction(CallbackData, prefix=EXAMPLE_MODULE_PREFIX):
    action: str 
    # –î–ª—è –æ–±—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
    item_id: Optional[int] = None # –ú–æ–∂–µ—Ç –±—ã—Ç—å ID –∑–∞–º–µ—Ç–∫–∏, –∏–ª–∏ —á–µ–≥–æ-—Ç–æ –µ—â–µ

    # –î–ª—è FSM, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –∫–∞–∫–æ–π-—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä
    param: Optional[str] = None


======================================================================

------------------------------ FILE: modules/example_module/keyboards_example.py ------------------------------
# modules/example_module/keyboards_example.py

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–±—Ä–∏–∫—É –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —è–¥—Ä–∞, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
from core.ui.callback_data_factories import CoreMenuNavigate, ModuleMenuEntry # <--- –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢ ModuleMenuEntry
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–≤–æ—é —Ñ–∞–±—Ä–∏–∫—É –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
from .callback_data_factories_example import ExampleModuleAction 
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–µ–Ω–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –∏–∑ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
from .permissions import (
    PERM_VIEW_MODULE_SETTINGS,
    PERM_VIEW_SECRET_INFO,
    PERM_PERFORM_BASIC_ACTION,
    PERM_PERFORM_ADVANCED_ACTION,
    PERM_MANAGE_OWN_NOTES
)
from .models import UserNote # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫

from typing import TYPE_CHECKING, List
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession


async def get_example_module_main_menu_keyboard(
    services: 'BotServicesProvider', 
    user_id: int, 
    session: 'AsyncSession' 
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    # –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è"
    if await services.rbac.user_has_permission(session, user_id, PERM_VIEW_MODULE_SETTINGS):
        builder.button(
            text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è (–≥–ª–æ–±.)",
            callback_data=ExampleModuleAction(action="show_module_settings").pack()
        )
    
    # –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é"
    if await services.rbac.user_has_permission(session, user_id, PERM_VIEW_SECRET_INFO):
        builder.button(
            text="ü§´ –°–µ–∫—Ä–µ—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",
            callback_data=ExampleModuleAction(action="show_secret_info").pack()
        )

    # –ö–Ω–æ–ø–∫–∞ "–ë–∞–∑–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ"
    if await services.rbac.user_has_permission(session, user_id, PERM_PERFORM_BASIC_ACTION):
        builder.button(
            text="‚ñ∂Ô∏è –ë–∞–∑–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ",
            callback_data=ExampleModuleAction(action="do_basic_action").pack()
        )

    # –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ"
    if await services.rbac.user_has_permission(session, user_id, PERM_PERFORM_ADVANCED_ACTION):
        builder.button(
            text="üöÄ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ",
            callback_data=ExampleModuleAction(action="do_advanced_action").pack()
        )
    
    # –ö–Ω–æ–ø–∫–∞ "–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏"
    if await services.rbac.user_has_permission(session, user_id, PERM_MANAGE_OWN_NOTES):
        builder.button(
            text="üìù –ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏",
            callback_data=ExampleModuleAction(action="my_notes_list").pack()
        )

    if not builder.export(): 
        builder.button(
            text="ü§∑‚Äç‚ôÇÔ∏è –î–ª—è –≤–∞—Å –∑–¥–µ—Å—å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π",
            callback_data="example_module:no_actions" 
        )

    builder.button(
        text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª–µ–π",
        callback_data=CoreMenuNavigate(target_menu="modules_list", page=1).pack() 
    )
    
    builder.adjust(1) 
    return builder.as_markup()

async def get_my_notes_keyboard(
    notes: List[UserNote], 
    services: 'BotServicesProvider', 
    user_id: int, 
    session: 'AsyncSession'
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()

    if notes:
        for note in notes:
            status_icon = "‚úÖ" if note.is_done else "üìù"
            note_text_short = note.note_text[:30] + "..." if len(note.note_text) > 30 else note.note_text
            builder.button(
                text=f"{status_icon} {note_text_short}",
                callback_data=ExampleModuleAction(action="view_note_details", item_id=note.id).pack()
            )
        builder.adjust(1)
    else:
        builder.button(text="–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫.", callback_data="example_module:no_notes_dummy")

    builder.row(
        InlineKeyboardButton(
            text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É",
            callback_data=ExampleModuleAction(action="add_note_start").pack()
        )
    )
    builder.row(
        InlineKeyboardButton(
            text="‚¨ÖÔ∏è –í –º–µ–Ω—é –º–æ–¥—É–ª—è",
            # –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ModuleMenuEntry, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º
            callback_data=ModuleMenuEntry(module_name="example_module").pack() 
        )
    )
    return builder.as_markup()

async def get_note_details_keyboard(
    note: UserNote,
    services: 'BotServicesProvider', 
    user_id: int, 
    session: 'AsyncSession'
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    toggle_done_text = "üìù –°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É" if note.is_done else "‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ —Å–¥–µ–ª–∞–Ω–æ"
    builder.button(
        text=toggle_done_text,
        callback_data=ExampleModuleAction(action="toggle_note_done", item_id=note.id).pack()
    )
    builder.button(
        text="üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É",
        callback_data=ExampleModuleAction(action="delete_note_confirm", item_id=note.id).pack()
    )
    builder.adjust(1)
    builder.row(
        InlineKeyboardButton(
            text="‚¨ÖÔ∏è –ö –º–æ–∏–º –∑–∞–º–µ—Ç–∫–∞–º",
            callback_data=ExampleModuleAction(action="my_notes_list").pack()
        )
    )
    return builder.as_markup()


======================================================================

------------------------------ FILE: modules/example_module/manifest.yaml ------------------------------
# modules/example_module/manifest.yaml
name: "example_module"
display_name: "–ü—Ä–∏–º–µ—Ä –ú–æ–¥—É–ª—è SDB (–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)"
version: "0.2.0"
description: "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã SwiftDevBot, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∏–π —Ä–∞–∑–ª–∏—á–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞, FSM, —Ä–∞–±–æ—Ç—É —Å –¥–∞–Ω–Ω—ã–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏."
author: "SDB Core Team (Example)"

python_requirements: []
sdb_module_dependencies: []

model_definitions:
  - "modules.example_module.models.ExampleTableOne"
  - "modules.example_module.models.AnotherExampleTable"
  - "modules.example_module.models.UserNote"

commands:
  - command: "example"
    description: "–ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ü—Ä–∏–º–µ—Ä–Ω–æ–≥–æ –ú–æ–¥—É–ª—è"
    icon: "üåü"
    category: "–ü—Ä–∏–º–µ—Ä—ã"
    admin_only: false
  - command: "fsm_example"
    description: "üó£Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å FSM –¥–∏–∞–ª–æ–≥ (–ø—Ä–∏–º–µ—Ä)"
    icon: "üó£Ô∏è"
    category: "–ü—Ä–∏–º–µ—Ä—ã"
    admin_only: false
  - command: "my_notes"
    description: "üìù –ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏ (–ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–æ–¥—É–ª—å)"
    icon: "üìù"
    category: "–ü—Ä–∏–º–µ—Ä—ã"
    admin_only: false

permissions: 
  - name: "example_module.access_user_features"
    description: "–î–æ—Å—Ç—É–ø –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –∏ —Ñ—É–Ω–∫—Ü–∏—è–º –º–æ–¥—É–ª—è Example."
  - name: "example_module.view_module_settings"
    description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–æ–¥—É–ª—è Example."
  - name: "example_module.view_secret_info"
    description: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –º–æ–¥—É–ª–µ Example."
  - name: "example_module.perform_basic_action"
    description: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –≤ –º–æ–¥—É–ª–µ Example."
  - name: "example_module.perform_advanced_action"
    description: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ/–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –≤ –º–æ–¥—É–ª–µ Example."
  - name: "example_module.manage_own_notes"
    description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—Å–æ–∑–¥–∞–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä, —É–¥–∞–ª–µ–Ω–∏–µ) —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∑–∞–º–µ—Ç–∫–∞–º–∏ –≤ –º–æ–¥—É–ª–µ Example."
  - name: "example_module.admin_view_all_notes"
    description: "[–ê–î–ú–ò–ù] –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞–º–µ—Ç–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –º–æ–¥—É–ª–µ Example."
  - name: "example_module.admin_manage_module"
    description: "[–ê–î–ú–ò–ù] –û–±—â–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –º–æ–¥—É–ª—è Example."

settings:
  example_setting_string:
    type: "string"
    label: "–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–æ–≤–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
    description: "–í–≤–µ–¥–∏—Ç–µ —Å—é–¥–∞ –∫–∞–∫–æ–π-–Ω–∏–±—É–¥—å —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞."
    default: "–ü—Ä–∏–≤–µ—Ç –∏–∑ –ø—Ä–∏–º–µ—Ä–∞!"
    required: false
  example_setting_bool:
    type: "bool"
    label: "–ü—Ä–∏–º–µ—Ä –±—É–ª–µ–≤–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
    description: "–í–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å —á—Ç–æ-—Ç–æ."
    default: true
  max_notes_per_user:
    type: "int"
    label: "–ú–∞–∫—Å. –∑–∞–º–µ—Ç–æ–∫ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    description: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–º–µ—Ç–æ–∫, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å."
    default: 5
    min_value: 1
    max_value: 100

metadata:
  min_sdb_core_version: "0.1.0"
  tags: ["example", "demonstration", "tutorial", "fsm", "crud", "permissions"]
  assign_default_access_to_user_role: true


======================================================================

------------------------------ FILE: modules/example_module/module_settings.yaml ------------------------------
# modules/example_module/module_settings.yaml
example_setting_string: "111–î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞ example_module/module_settings.yaml"
example_setting_bool: false
# –î–æ–±–∞–≤—å —Å—é–¥–∞ –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ example_module


======================================================================

------------------------------ FILE: modules/example_module/__init__.py ------------------------------
# modules/example_module/__init__.py

from aiogram import Dispatcher, Bot, Router
from loguru import logger

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–æ—É—Ç–µ—Ä –∏ MODULE_NAME
from .handlers_example import example_module_router, MODULE_NAME 
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∞–∑–æ–≤–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ UI –º–æ–¥—É–ª—è
from .permissions import PERM_ACCESS_USER_FEATURES 

from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from core.module_loader import ModuleInfo

async def setup_module(dp: Dispatcher, bot: Bot, services: 'BotServicesProvider'):
    module_info: Optional[ModuleInfo] = services.modules.get_module_info(MODULE_NAME)
    
    if not module_info or not module_info.manifest:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–ª–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç –¥–ª—è –º–æ–¥—É–ª—è '{MODULE_NAME}'. "
                     "–ú–æ–¥—É–ª—å –Ω–µ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")
        return

    display_name = module_info.manifest.display_name
    version = module_info.manifest.version
    logger.info(f"[{MODULE_NAME}] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥—É–ª—è: {display_name} v{version}...")

    if isinstance(example_module_router, Router):
        dp.include_router(example_module_router)
        logger.info(f"[{MODULE_NAME}] –†–æ—É—Ç–µ—Ä '{example_module_router.name}' —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.")
    else:
        logger.error(f"[{MODULE_NAME}] –û—à–∏–±–∫–∞: 'example_module_router' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º aiogram.Router.")

    from core.ui.callback_data_factories import ModuleMenuEntry 

    entry_cb_data = ModuleMenuEntry(module_name=MODULE_NAME).pack()
    
    icon = "üåü" # –ú–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞, –µ—Å–ª–∏ —Ç–∞–º –±—É–¥–µ—Ç —Ç–∞–∫–æ–µ –ø–æ–ª–µ –¥–ª—è UI Entry
    if module_info.manifest.commands: # –ü–æ–ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∫–æ–Ω–∫—É –∏–∑ –ø–µ—Ä–≤–æ–π –∫–æ–º–∞–Ω–¥—ã
        primary_command = next((cmd for cmd in module_info.manifest.commands if cmd.command == "example"), None)
        if primary_command and primary_command.icon:
            icon = primary_command.icon

    description = module_info.manifest.description or f"–ú–æ–¥—É–ª—å {display_name}"

    services.ui_registry.register_module_entry(
        module_name=MODULE_NAME, 
        display_name=display_name,
        entry_callback_data=entry_cb_data, 
        icon=icon,
        description=description,
        order=100,
        required_permission_to_view=PERM_ACCESS_USER_FEATURES # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    )
    logger.info(f"[{MODULE_NAME}] UI-—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –º–æ–¥—É–ª—è '{display_name}' –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ UIRegistry.")

    logger.success(f"‚úÖ –ú–æ–¥—É–ª—å '{MODULE_NAME}' ({display_name}) —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.")


======================================================================

------------------------------ FILE: modules/example_module/models.py ------------------------------
# modules/example_module/models.py
from sqlalchemy import String, Integer, ForeignKey, Text, Boolean, BigInteger # <--- –î–æ–±–∞–≤–∏–ª BigInteger
from sqlalchemy.orm import Mapped, mapped_column, relationship
from core.database.base import SDBBaseModel 
from core.database.core_models import SDB_CORE_TABLE_PREFIX # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è ForeignKey
from typing import Optional, TYPE_CHECKING

if TYPE_CHECKING:
    from core.database.core_models import User # –î–ª—è type hinting –≤ Mapped

# –û—Å—Ç–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥–µ–ª–∏
class ExampleTableOne(SDBBaseModel): 
    __tablename__ = "mod_example_table_one"
    name: Mapped[str] = mapped_column(String(100), nullable=False, comment="–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è")
    description: Mapped[Optional[str]] = mapped_column(String(255), comment="–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞")
    is_active: Mapped[bool] = mapped_column(Boolean, default=True, server_default="1")

    def __repr__(self):
        return f"<ExampleTableOne(id={self.id}, name='{self.name}')>"

class AnotherExampleTable(SDBBaseModel): 
    __tablename__ = "mod_another_example_table"
    example_one_id: Mapped[Optional[int]] = mapped_column(Integer, ForeignKey('mod_example_table_one.id', ondelete='CASCADE')) 
    value: Mapped[str] = mapped_column(String(200), nullable=False, comment="–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è")
    example_one: Mapped[Optional["ExampleTableOne"]] = relationship("ExampleTableOne", backref="another_examples") 

    def __repr__(self):
        return f"<AnotherExampleTable(id={self.id}, value='{self.value}')>"

# –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
class UserNote(SDBBaseModel):
    __tablename__ = "mod_example_user_notes"

    # Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∑–∞–º–µ—Ç–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–µ–º BigInteger.
    user_telegram_id: Mapped[int] = mapped_column(
        BigInteger, # <--- –ò–ó–ú–ï–ù–ï–ù–û –ó–î–ï–°–¨
        index=True, 
        nullable=False, 
        comment="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–≤–ª–∞–¥–µ–ª—å—Ü–∞ –∑–∞–º–µ—Ç–∫–∏"
    )
    note_text: Mapped[str] = mapped_column(Text, nullable=False, comment="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏")
    is_done: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False, comment="–û—Ç–º–µ—á–µ–Ω–∞ –ª–∏ –∑–∞–º–µ—Ç–∫–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è")

    # –°–≤—è–∑—å —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π SDB (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)
    # –í–Ω–µ—à–Ω–∏–π –∫–ª—é—á –Ω–∞ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ sdb_users.
    # –≠—Ç–æ –ø–æ–ª–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Ç—ã –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –ø–æ user_telegram_id.
    # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å, —Ç–æ UserNote.user_id –±—É–¥–µ—Ç —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ User.id –∏–∑ core_models.
    # –ò user_telegram_id –∑–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–º, –µ—Å–ª–∏ –µ—Å—Ç—å user_id.
    # –ù–æ –µ—Å–ª–∏ –º–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –∏ –Ω–µ –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –æ–±—ä–µ–∫—Ç—É User –∏–∑ —è–¥—Ä–∞,
    # —Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ user_telegram_id –≤ —Å–∞–º–æ–π —Ç–∞–±–ª–∏—Ü–µ –º–æ–¥—É–ª—è –ø–æ–ª–µ–∑–Ω–æ.
    # –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –æ—Å—Ç–∞–≤–∏–º –æ–±–∞, –Ω–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥.
    
    # user_db_id: Mapped[int] = mapped_column(ForeignKey(f"{SDB_CORE_TABLE_PREFIX}users.id", ondelete="CASCADE"), index=True)
    # user: Mapped["User"] = relationship(backref="example_module_notes")

    def __repr__(self) -> str:
        return f"<UserNote(id={self.id}, user_tg_id={self.user_telegram_id}, text='{self.note_text[:20]}...', done={self.is_done})>"


======================================================================

------------------------------ FILE: project_data/core_backups/.gitkeep ------------------------------



======================================================================

------------------------------ FILE: project_data/Cache_data/.gitkeep ------------------------------



======================================================================

------------------------------ FILE: project_data/module_backups/.gitkeep ------------------------------



======================================================================

------------------------------ FILE: project_data/Database_files/.gitkeep ------------------------------



======================================================================

------------------------------ FILE: project_data/Logs/.gitkeep ------------------------------



======================================================================

------------------------------ FILE: project_data/Config/modules_settings/example_module.yaml ------------------------------
example_setting_string: 111–î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞ example_module/module_settings.yaml
example_setting_bool: false
max_notes_per_user: 5



======================================================================

------------------------------ FILE: core/sys_modules/__init__.py ------------------------------
# core/sys_modules/__init__.py
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –¥–µ–ª–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é 'sys_modules' –ø–∞–∫–µ—Ç–æ–º Python.
# –°—é–¥–∞ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–º–µ—â–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ —è–¥—Ä–∞.

# –ü—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –±—ã –∑–¥–µ—Å—å –±—ã–ª –º–æ–¥—É–ª—å 'internal_logger_viewer':
# from .internal_logger_viewer import setup_module as setup_logger_viewer_module
# from .internal_logger_viewer.handlers import logger_viewer_router

# __all__ = ["setup_logger_viewer_module", "logger_viewer_router"]


======================================================================

------------------------------ FILE: core/rbac/__init__.py ------------------------------



======================================================================

------------------------------ FILE: core/rbac/service.py ------------------------------
# core/rbac/service.py
from sqlalchemy.orm import selectinload
from typing import List, Optional, TYPE_CHECKING, Set, Dict, Tuple, Union
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, delete, func as sql_func 
from loguru import logger

from core.database.core_models import User, Role, UserRole, Permission, RolePermission, UserPermission # –î–æ–±–∞–≤–ª–µ–Ω–∞ UserPermission
from core.schemas.module_manifest import PermissionManifest as ModulePermissionManifestSchema


if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider 
    from core.database.manager import DBManager 
    from core.module_loader import ModuleInfo 

# --- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –†–æ–ª–∏ ---
DEFAULT_ROLE_USER = "User"
DEFAULT_ROLE_MODERATOR = "Moderator"
DEFAULT_ROLE_ADMIN = "Admin"

DEFAULT_ROLES_DEFINITIONS: Dict[str, str] = {
    DEFAULT_ROLE_USER: "–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –±–∞–∑–æ–≤—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞.",
    DEFAULT_ROLE_MODERATOR: "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –±–∞–∑–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.",
    DEFAULT_ROLE_ADMIN: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –∏–º–µ–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ–±–ª–∞—Å—Ç—è—Ö.",
}

# --- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ø–î–†–ê (Permissions) ---
PERMISSION_CORE_VIEW_ADMIN_PANEL = "core.admin.view_panel"
PERMISSION_CORE_USERS_VIEW_LIST = "core.users.view_list"
PERMISSION_CORE_USERS_VIEW_DETAILS = "core.users.view_details"
PERMISSION_CORE_USERS_EDIT_PROFILE = "core.users.edit_profile"
PERMISSION_CORE_USERS_MANAGE_STATUS = "core.users.manage_status"
PERMISSION_CORE_USERS_ASSIGN_ROLES = "core.users.assign_roles"
PERMISSION_CORE_USERS_DELETE = "core.users.delete"
PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS = "core.users.manage_direct_permissions" # –ù–û–í–û–ï –†–ê–ó–†–ï–®–ï–ù–ò–ï

PERMISSION_CORE_ROLES_VIEW = "core.roles.view"
PERMISSION_CORE_ROLES_CREATE = "core.roles.create" 
PERMISSION_CORE_ROLES_EDIT = "core.roles.edit" 
PERMISSION_CORE_ROLES_DELETE = "core.roles.delete" 
PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS = "core.roles.assign_permissions"

PERMISSION_CORE_PERMISSIONS_VIEW = "core.permissions.view" 

PERMISSION_CORE_MODULES_VIEW_LIST = "core.modules.view_list"
PERMISSION_CORE_MODULES_TOGGLE_ACTIVATION = "core.modules.toggle_activation"
PERMISSION_CORE_MODULES_MANAGE_SETTINGS = "core.modules.manage_settings"

PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC = "core.system.view_info.basic"
PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL = "core.system.view_info.full"
PERMISSION_CORE_SYSTEM_VIEW_LOGS_BASIC = "core.system.view_logs.basic"
PERMISSION_CORE_SYSTEM_VIEW_LOGS_FULL = "core.system.view_logs.full"
PERMISSION_CORE_SYSTEM_MANAGE_BACKUPS = "core.system.manage_backups"
PERMISSION_CORE_SYSTEM_SEND_BROADCAST = "core.system.send_broadcast"

PERMISSION_CORE_SETTINGS_VIEW = "core.settings.view"
PERMISSION_CORE_SETTINGS_EDIT = "core.settings.edit"


DEFAULT_CORE_PERMISSIONS_DEFINITIONS: Dict[str, str] = {
    PERMISSION_CORE_VIEW_ADMIN_PANEL: "–î–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏.",
    PERMISSION_CORE_USERS_VIEW_LIST: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.",
    PERMISSION_CORE_USERS_VIEW_DETAILS: "–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.",
    PERMISSION_CORE_USERS_EDIT_PROFILE: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–º—è, —è–∑—ã–∫ –∏ —Ç.–¥.).",
    PERMISSION_CORE_USERS_MANAGE_STATUS: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–∫—Ç–∏–≤–µ–Ω/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω).",
    PERMISSION_CORE_USERS_ASSIGN_ROLES: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Å–Ω—è—Ç–∏–µ —Ä–æ–ª–µ–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.",
    PERMISSION_CORE_USERS_DELETE: "–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Å–∏—Å—Ç–µ–º—ã.",
    PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.", # –û–ü–ò–°–ê–ù–ò–ï –ù–û–í–û–ì–û –†–ê–ó–†–ï–®–ï–ù–ò–Ø
    PERMISSION_CORE_ROLES_VIEW: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–æ–ª–µ–π –∏ –∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.",
    PERMISSION_CORE_ROLES_CREATE: "–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–æ–ª–µ–π.", 
    PERMISSION_CORE_ROLES_EDIT: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–æ–ª–µ–π (–∏–º—è, –æ–ø–∏—Å–∞–Ω–∏–µ).",
    PERMISSION_CORE_ROLES_DELETE: "–£–¥–∞–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π.", 
    PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Å–Ω—è—Ç–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Å —Ä–æ–ª–µ–π.",
    PERMISSION_CORE_PERMISSIONS_VIEW: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.",
    PERMISSION_CORE_MODULES_VIEW_LIST: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤.",
    PERMISSION_CORE_MODULES_TOGGLE_ACTIVATION: "–í–∫–ª—é—á–µ–Ω–∏–µ –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–æ–≤.",
    PERMISSION_CORE_MODULES_MANAGE_SETTINGS: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –º–æ–¥—É–ª–µ–π.",
    PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC: "–ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–∑–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.",
    PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL: "–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–ª–Ω–æ–π —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.",
    PERMISSION_CORE_SYSTEM_VIEW_LOGS_BASIC: "–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö –ª–æ–≥–æ–≤ —Å–∏—Å—Ç–µ–º—ã.",
    PERMISSION_CORE_SYSTEM_VIEW_LOGS_FULL: "–ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ª–æ–≥–æ–≤ —Å–∏—Å—Ç–µ–º—ã –∏ –∏—Ö —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ.",
    PERMISSION_CORE_SYSTEM_MANAGE_BACKUPS: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –∫–æ–ø–∏—è–º–∏ —Å–∏—Å—Ç–µ–º—ã.",
    PERMISSION_CORE_SYSTEM_SEND_BROADCAST: "–û—Ç–ø—Ä–∞–≤–∫–∞ —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.",
    PERMISSION_CORE_SETTINGS_VIEW: "–ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ —è–¥—Ä–∞ SwiftDevBot.",
    PERMISSION_CORE_SETTINGS_EDIT: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —è–¥—Ä–∞ SwiftDevBot (–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫).",
}

DEFAULT_PERMISSIONS_FOR_CORE_MODERATOR_ROLE: Set[str] = {
    PERMISSION_CORE_VIEW_ADMIN_PANEL, 
    PERMISSION_CORE_USERS_VIEW_LIST,
    PERMISSION_CORE_USERS_VIEW_DETAILS,
    PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC,
}

DEFAULT_PERMISSIONS_FOR_CORE_ADMIN_ROLE: Set[str] = {
    *DEFAULT_PERMISSIONS_FOR_CORE_MODERATOR_ROLE, 
    PERMISSION_CORE_USERS_MANAGE_STATUS,
    PERMISSION_CORE_USERS_ASSIGN_ROLES, 
    PERMISSION_CORE_MODULES_VIEW_LIST,
    PERMISSION_CORE_SYSTEM_VIEW_LOGS_BASIC,
    PERMISSION_CORE_ROLES_VIEW, 
    PERMISSION_CORE_PERMISSIONS_VIEW, 
    PERMISSION_CORE_ROLES_CREATE, 
    PERMISSION_CORE_ROLES_EDIT,       
    PERMISSION_CORE_ROLES_DELETE,     
    PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS,
    PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS, # –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª–∏ Admin –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
}

DEFAULT_PERMISSIONS_FOR_CORE_USER_ROLE: Set[str] = set()


class RBACService:
    def __init__(self, services: Optional['BotServicesProvider'] = None, db_manager: Optional['DBManager'] = None):
        self._services_provider_ref: Optional['BotServicesProvider'] = services
        if db_manager: 
             self._db_manager = db_manager
        elif services and hasattr(services, 'db') and services.db is not None:
            self._db_manager = services.db
        else:
            self._db_manager = None 
            logger.warning("RBACService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –±–µ–∑ DBManager. "
                           "–ú–µ—Ç–æ–¥—ã ensure_default_... –ø–æ—Ç—Ä–µ–±—É—é—Ç —è–≤–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ —Å–µ—Å—Å–∏–∏ –∏–ª–∏ DBManager.")
            
        self._logger = logger.bind(service="RBACService")
        self._logger.info("RBACService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    async def _get_role_by_name(self, session: AsyncSession, role_name: str) -> Optional[Role]:
        self._logger.trace(f"–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ –∏–º–µ–Ω–∏: '{role_name}'")
        stmt = select(Role).options(selectinload(Role.permissions)).where(Role.name == role_name)
        result = await session.execute(stmt)
        role = result.scalars().first()
        self._logger.trace(f"–†–æ–ª—å '{role_name}' –Ω–∞–π–¥–µ–Ω–∞: {role is not None} (ID: {getattr(role, 'id', 'N/A')})")
        return role

    async def get_or_create_role(self, session: AsyncSession, role_name: str, description: Optional[str] = None) -> Optional[Role]:
        role = await self._get_role_by_name(session, role_name)
        if not role:
            role_def_desc = DEFAULT_ROLES_DEFINITIONS.get(role_name)
            current_description = description if description is not None else role_def_desc
            
            if role_name in DEFAULT_ROLES_DEFINITIONS and description is None:
                current_description = role_def_desc

            self._logger.info(f"–†–æ–ª—å '{role_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º: '{current_description or '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}'.")
            role = Role(name=role_name, description=current_description)
            session.add(role)
            try:
                await session.flush([role])
                self._logger.success(f"–†–æ–ª—å '{role_name}' —Å–æ–∑–¥–∞–Ω–∞ (—Åflushed) —Å ID: {role.id}")
            except Exception as e_flush_role:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ flush –¥–ª—è –Ω–æ–≤–æ–π —Ä–æ–ª–∏ '{role_name}': {e_flush_role}", exc_info=True)
                return None 
        return role

    async def register_permissions_from_modules(self, session: AsyncSession) -> int:
        if not self._services_provider_ref or not hasattr(self._services_provider_ref, 'modules'):
            self._logger.error("ModuleLoader –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ BotServicesProvider. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.")
            return 0
        
        module_loader = self._services_provider_ref.modules
        declared_perms_manifests: List[ModulePermissionManifestSchema] = module_loader.get_all_declared_permissions_from_active_modules()
        
        if not declared_perms_manifests:
            self._logger.info("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö, –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
            return 0

        self._logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(declared_perms_manifests)} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ö –º–æ–¥—É–ª–µ–π –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–ø—Ä–æ–≤–µ—Ä–∫–∏...")
        
        created_count = 0
        
        for perm_mft in declared_perms_manifests:
            existing_perm = await self._get_permission_by_name(session, perm_mft.name)
            if not existing_perm:
                new_perm_obj = await self.get_or_create_permission(session, perm_mft.name, perm_mft.description)
                if new_perm_obj: 
                    created_count +=1 
                else:
                    self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å/–ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–æ–¥—É–ª—è '{perm_mft.name}'.")
            else:
                if existing_perm.description != perm_mft.description:
                     self._logger.info(f"–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–æ–¥—É–ª—è '{perm_mft.name}' –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è. "
                                      f"–ë–î: '{existing_perm.description}', –ú–∞–Ω–∏—Ñ–µ—Å—Ç: '{perm_mft.description}'. –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.")
                self._logger.trace(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–æ–¥—É–ª—è '{perm_mft.name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î.")
        
        if created_count > 0 : 
             self._logger.success(f"{created_count} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –∏–∑ –º–æ–¥—É–ª–µ–π –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã/–æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã (flush –±—ã–ª –≤ get_or_create_permission).")
        
        return created_count


    async def ensure_default_entities_exist(self, session: AsyncSession) -> Tuple[int, int, int]:
        self._logger.info("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π RBAC (—Ä–æ–ª–∏, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —è–¥—Ä–∞, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–æ–¥—É–ª–µ–π)...")
        
        created_core_perms_count = 0
        created_module_perms_count = 0 
        created_roles_count = 0
        initial_session_dirty = bool(session.new or session.dirty or session.deleted)

        self._logger.debug("–≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ø–î–†–ê.")
        core_permissions_to_add_objs: List[Permission] = []
        for perm_name, perm_description in DEFAULT_CORE_PERMISSIONS_DEFINITIONS.items(): 
            existing_perm = await self._get_permission_by_name(session, perm_name)
            if not existing_perm:
                new_perm = Permission(name=perm_name, description=perm_description)
                core_permissions_to_add_objs.append(new_perm)
                self._logger.info(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —è–¥—Ä–∞ '{perm_name}' –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.")
                created_core_perms_count += 1
        
        if core_permissions_to_add_objs:
            session.add_all(core_permissions_to_add_objs)
            self._logger.info(f"{created_core_perms_count} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —è–¥—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Å–µ—Å—Å–∏—é.")

        self._logger.debug("–≠—Ç–∞–ø 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –∏–∑ –ú–ê–ù–ò–§–ï–°–¢–û–í –ú–û–î–£–õ–ï–ô.")
        module_perms_result = await self.register_permissions_from_modules(session)
        if module_perms_result == -1: 
            self._logger.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π. –î–∞–ª—å–Ω–µ–π—à–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RBAC –ø—Ä–µ—Ä–≤–∞–Ω–∞.")
            return 0, 0, -1 
        created_module_perms_count = module_perms_result
        
        self._logger.debug("–≠—Ç–∞–ø 3: –°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –†–û–õ–ï–ô.")
        roles_to_add_objs: List[Role] = []
        for role_name, role_description in DEFAULT_ROLES_DEFINITIONS.items(): 
            existing_role = await self._get_role_by_name(session, role_name) 
            if not existing_role:
                new_role = Role(name=role_name, description=role_description)
                roles_to_add_objs.append(new_role)
                self._logger.info(f"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ä–æ–ª—å '{role_name}' –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.")
                created_roles_count += 1
        
        if roles_to_add_objs:
            session.add_all(roles_to_add_objs)
            self._logger.info(f"{created_roles_count} —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Å–µ—Å—Å–∏—é.")
        
        if core_permissions_to_add_objs or roles_to_add_objs or created_module_perms_count > 0 : 
            try:
                self._logger.debug("–≠—Ç–∞–ø 4: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±—â–∏–π flush –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –Ω–æ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π...")
                await session.flush()
                self._logger.debug("–û–±—â–∏–π Flush –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ.")
            except Exception as e_flush_all:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—â–µ–º flush —Ä–æ–ª–µ–π/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π: {e_flush_all}", exc_info=True)
                await session.rollback() 
                return 0, 0, 0 

        self._logger.debug(f"–≠—Ç–∞–ø 5: –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ø–î–†–ê —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Ä–æ–ª—è–º.")
        assigned_perms_summary: Dict[str, int] = {}
        
        all_permissions_in_db = await self.get_all_permissions(session)
        all_permissions_map_by_name = {p.name: p for p in all_permissions_in_db}

        role_core_permission_map = {
            DEFAULT_ROLE_ADMIN: DEFAULT_PERMISSIONS_FOR_CORE_ADMIN_ROLE,
            DEFAULT_ROLE_MODERATOR: DEFAULT_PERMISSIONS_FOR_CORE_MODERATOR_ROLE,
            DEFAULT_ROLE_USER: DEFAULT_PERMISSIONS_FOR_CORE_USER_ROLE 
        }
        
        changes_in_role_perms_assignment = False
        for role_name_to_setup, core_perm_names_to_assign in role_core_permission_map.items():
            role_obj = await self._get_role_by_name(session, role_name_to_setup) 
            if not role_obj or role_obj.id is None:
                self._logger.error(f"–†–æ–ª—å '{role_name_to_setup}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç ID –ø–æ—Å–ª–µ flush. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.")
                continue
            
            current_role_assigned_count = 0
            self._logger.info(f"–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —è–¥–µ—Ä–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Ä–æ–ª–∏ '{role_name_to_setup}' (ID: {role_obj.id})...")
            for perm_name in core_perm_names_to_assign:
                perm_obj_to_assign = all_permissions_map_by_name.get(perm_name)
                if not perm_obj_to_assign or perm_obj_to_assign.id is None:
                    self._logger.warning(f"–Ø–¥–µ—Ä–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{perm_name}' –¥–ª—è —Ä–æ–ª–∏ '{role_name_to_setup}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç ID. –ü—Ä–æ–ø—É—Å–∫.")
                    continue
                
                if await self._ensure_role_has_permission_link(session, role_obj.id, perm_obj_to_assign.id):
                    if await self.assign_permission_to_role(session, role_obj, perm_obj_to_assign.name, auto_create_perm=False):
                        current_role_assigned_count +=1
                        changes_in_role_perms_assignment = True 
            
            if current_role_assigned_count > 0:
                assigned_perms_summary[role_name_to_setup] = current_role_assigned_count
                self._logger.info(f"{current_role_assigned_count} –Ω–æ–≤—ã—Ö —è–¥–µ—Ä–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –±—ã–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã/–Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Ä–æ–ª–∏ '{role_name_to_setup}'.")

        self._logger.debug(f"–≠—Ç–∞–ø 5.1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤ –º–æ–¥—É–ª–µ–π —Ä–æ–ª–∏ '{DEFAULT_ROLE_USER}'.")
        role_user_obj = await self._get_role_by_name(session, DEFAULT_ROLE_USER)
        module_loader = self._services_provider_ref.modules if self._services_provider_ref else None
        
        auto_assigned_module_perms_count = 0
        if role_user_obj and role_user_obj.id and module_loader:
            for module_info in module_loader.get_all_modules_info():
                if module_info.manifest and \
                   module_info.manifest.metadata and \
                   module_info.manifest.metadata.assign_default_access_to_user_role:
                    
                    base_access_perm_name = f"{module_info.name}.access_user_features"
                    perm_obj = all_permissions_map_by_name.get(base_access_perm_name)
                    if perm_obj and perm_obj.id:
                        if await self._ensure_role_has_permission_link(session, role_user_obj.id, perm_obj.id):
                            if await self.assign_permission_to_role(session, role_user_obj, perm_obj.name, auto_create_perm=False):
                                self._logger.info(f"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{perm_obj.name}' —Ä–æ–ª–∏ '{DEFAULT_ROLE_USER}'.")
                                auto_assigned_module_perms_count += 1
                                changes_in_role_perms_assignment = True 
                    else:
                        self._logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{base_access_perm_name}' –¥–ª—è –º–æ–¥—É–ª—è '{module_info.name}', "
                                             "—Ö–æ—Ç—è –æ–Ω –ø–æ–º–µ—á–µ–Ω –¥–ª—è –∞–≤—Ç–æ-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏ User.")
        if auto_assigned_module_perms_count > 0:
            if DEFAULT_ROLE_USER in assigned_perms_summary :
                 assigned_perms_summary[DEFAULT_ROLE_USER] += auto_assigned_module_perms_count
            else:
                 assigned_perms_summary[DEFAULT_ROLE_USER] = auto_assigned_module_perms_count


        final_session_dirty = bool(session.new or session.dirty or session.deleted)
        if final_session_dirty or (not initial_session_dirty and (created_roles_count or created_core_perms_count or created_module_perms_count > 0 or any(assigned_perms_summary.values()))):
            self._logger.debug("–≠—Ç–∞–ø 6: –ü–æ–ø—ã—Ç–∫–∞ –∫–æ–º–º–∏—Ç–∞ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π RBAC...")
            try:
                await session.commit() 
                summary_log_parts = []
                if created_roles_count: summary_log_parts.append(f"{created_roles_count} —Ä–æ–ª–µ–π —Å–æ–∑–¥–∞–Ω–æ")
                if created_core_perms_count: summary_log_parts.append(f"{created_core_perms_count} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —è–¥—Ä–∞ —Å–æ–∑–¥–∞–Ω–æ")
                if created_module_perms_count > 0: summary_log_parts.append(f"{created_module_perms_count} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥—É–ª–µ–π —Å–æ–∑–¥–∞–Ω–æ/–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ")
                for role_name_sum, count_sum in assigned_perms_summary.items():
                    if count_sum > 0: summary_log_parts.append(f"{count_sum} —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–∞–∑–Ω–∞—á–µ–Ω–æ {role_name_sum}")
                
                log_msg_commit = (f"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ RBAC —Å—É—â–Ω–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã: "
                                  f"{'; '.join(summary_log_parts) or '–Ω–µ—Ç —è–≤–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∞–≤.'}.")
                self._logger.success(log_msg_commit)
            except Exception as e:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö RBAC —Å—É—â–Ω–æ—Å—Ç–µ–π: {e}", exc_info=True)
                await session.rollback()
                return 0, 0, 0 
        else:
            self._logger.info("–ù–µ –±—ã–ª–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ RBAC –¥–ª—è –∫–æ–º–º–∏—Ç–∞.")

        return created_roles_count, created_core_perms_count, created_module_perms_count
    

    async def _ensure_role_has_permission_link(self, session: AsyncSession, role_id: int, permission_id: int) -> bool:
        self._logger.trace(f"[ENSURE_LINK] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ –¥–ª—è RoleID: {role_id}, PermID: {permission_id}")
        link_exists_stmt = select(RolePermission.id).where(
            RolePermission.role_id == role_id,
            RolePermission.permission_id == permission_id
        ).limit(1)
        try:
            link_res = await session.execute(link_exists_stmt)
            scalar_result = link_res.scalar_one_or_none()
            if scalar_result is None:
                self._logger.trace(f"[ENSURE_LINK] –°–≤—è–∑—å –¥–ª—è RoleID {role_id}, PermID {permission_id} –ù–ï –Ω–∞–π–¥–µ–Ω–∞ (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å).")
                return True 
            else:
                self._logger.trace(f"[ENSURE_LINK] –°–≤—è–∑—å –¥–ª—è RoleID {role_id}, PermID {permission_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (ID: {scalar_result}).")
                return False 
        except Exception as e_exec_link:
            self._logger.error(f"[ENSURE_LINK] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–≤—è–∑–∏ RolePermission –¥–ª—è RoleID {role_id}, PermID {permission_id}: {e_exec_link}", exc_info=True)
            return False

    async def assign_role_to_user(self, session: AsyncSession, user: User, role_name: str) -> bool:
        if not user or user.id is None: 
            self._logger.error(f"–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç ID (user: {user}).")
            return False
            
        role_obj = await self.get_or_create_role(session, role_name)
        if not role_obj or role_obj.id is None: 
            self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å '{role_name}' (ID: {getattr(role_obj, 'id', 'N/A')}) –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.id}.")
            return False

        self._logger.debug(f"[ASSIGN_ROLE_TO_USER] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ –¥–ª—è UserID: {user.id} (—Ç–∏–ø: {type(user.id)}), RoleID: {role_obj.id} (—Ç–∏–ø: {type(role_obj.id)})")
        existing_link_stmt = select(UserRole.id).where(UserRole.user_id == user.id, UserRole.role_id == role_obj.id).limit(1)
        try:
            existing_link_res = await session.execute(existing_link_stmt) 
            scalar_res_link = existing_link_res.scalar_one_or_none()
            self._logger.debug(f"[ASSIGN_ROLE_TO_USER] –†–µ–∑—É–ª—å—Ç–∞—Ç scalar_one_or_none –¥–ª—è UserID {user.id}, RoleID {role_obj.id}: {scalar_res_link} (—Ç–∏–ø: {type(scalar_res_link)})")

            if scalar_res_link is not None:
                self._logger.debug(f"–†–æ–ª—å '{role_name}' —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID: {user.id}.")
                return True 
            
            new_user_role_link = UserRole(user_id=user.id, role_id=role_obj.id)
            session.add(new_user_role_link)
            self._logger.info(f"–†–æ–ª—å '{role_name}' (RoleID: {role_obj.id}) –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é UserID: {user.id} (–æ–∂–∏–¥–∞–µ—Ç commit).")
            return True
        except Exception as e_assign:
            self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Ä–æ–ª–∏ '{role_name}' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.id}: {e_assign}", exc_info=True)
            return False

    async def remove_role_from_user(self, session: AsyncSession, user: User, role_name: str) -> bool:
        if not user or user.id is None:
            self._logger.error("–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å —Ä–æ–ª—å —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID).")
            return False
            
        role_to_remove = await self._get_role_by_name(session, role_name)
        if not role_to_remove or role_to_remove.id is None: 
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–æ–ª—å '{role_name}' –∏–ª–∏ —Ä–æ–ª—å –±–µ–∑ ID —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}.")
            return True 

        try:
            stmt_delete = delete(UserRole).where(UserRole.user_id == user.id, UserRole.role_id == role_to_remove.id)
            result = await session.execute(stmt_delete) 
            
            if result.rowcount > 0:
                self._logger.info(f"–†–æ–ª—å '{role_name}' —Å–Ω—è—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id} (–æ–∂–∏–¥–∞–µ—Ç commit).")
                return True
            else:
                self._logger.debug(f"–†–æ–ª—å '{role_name}' –Ω–µ –±—ã–ª–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.id}. –°–Ω—è—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
                return True
        except Exception as e: 
            self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏ UserRole –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id} –∏ —Ä–æ–ª–∏ '{role_name}': {e}", exc_info=True)
            return False

    def user_has_role(self, user: User, role_name: str) -> bool:
        if not user or not user.roles: return False
        return any(r.name.lower() == role_name.lower() for r in user.roles if r and r.name)

    async def user_has_role_async(self, session: AsyncSession, user_telegram_id: int, role_name: str) -> bool:
        stmt = select(User).options(selectinload(User.roles)).where(User.telegram_id == user_telegram_id)
        result = await session.execute(stmt)
        user_db: Optional[User] = result.scalars().first()
        
        if not user_db:
            self._logger.debug(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID {user_telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–æ–ª–∏ '{role_name}'.")
            return False
        return self.user_has_role(user_db, role_name)

    def get_user_role_names(self, user: User) -> Set[str]:
        if not user or not user.roles: return set()
        return {role.name for role in user.roles if role and role.name}

    async def get_user_roles_async(self, session: AsyncSession, user_telegram_id: int) -> List[Role]:
        stmt = select(User).options(selectinload(User.roles)).where(User.telegram_id == user_telegram_id)
        result = await session.execute(stmt)
        user_db: Optional[User] = result.scalars().first()
        
        if not user_db:
            self._logger.debug(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID {user_telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –µ–≥–æ —Ä–æ–ª–µ–π.")
            return []
        return list(user_db.roles) if user_db.roles else []

    async def get_all_roles(self, session: AsyncSession) -> List[Role]:
        stmt = select(Role).options(selectinload(Role.permissions)).order_by(Role.name)
        result = await session.execute(stmt)
        roles = list(result.scalars().all())
        self._logger.debug(f"–ó–∞–ø—Ä–æ—à–µ–Ω —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–æ–ª–µ–π. –ù–∞–π–¥–µ–Ω–æ: {len(roles)}.")
        return roles

    async def delete_role(self, session: AsyncSession, role_name_or_id: Union[str, int]) -> bool: 
        self._logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–ª–∏: '{role_name_or_id}'...")
        role: Optional[Role] = None
        if isinstance(role_name_or_id, str):
            role = await self._get_role_by_name(session, role_name_or_id)
        elif isinstance(role_name_or_id, int):
            role = await session.get(Role, role_name_or_id)
        
        if not role:
            self._logger.warning(f"–†–æ–ª—å '{role_name_or_id}' –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return False 
        
        if role.name in DEFAULT_ROLES_DEFINITIONS: 
             self._logger.error(f"–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ä–æ–ª–∏ '{role.name}'. –û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞.")
             return False
        
        user_role_count_stmt = select(sql_func.count(UserRole.id)).where(UserRole.role_id == role.id)
        user_role_count_res = await session.execute(user_role_count_stmt)
        user_count_with_role = user_role_count_res.scalar_one()
        
        if user_count_with_role > 0:
            self._logger.error(f"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å '{role.name}' (ID: {role.id}), —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ {user_count_with_role} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é(—è–º). "
                               "–°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∏—Ç–µ —ç—Ç—É —Ä–æ–ª—å —Å–æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
            return False
            
        try:
            await session.execute(delete(RolePermission).where(RolePermission.role_id == role.id))
            await session.delete(role)
            self._logger.warning(f"–†–æ–ª—å '{role.name}' (ID: {role.id}) –∏ –µ–µ —Å–≤—è–∑–∏ —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –ø–æ–º–µ—á–µ–Ω—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–æ–∂–∏–¥–∞–µ—Ç commit).")
            return True
        except Exception as e:
            self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–ª–∏ '{role.name}': {e}", exc_info=True)
            return False

    async def _get_permission_by_name(self, session: AsyncSession, permission_name: str) -> Optional[Permission]:
        self._logger.trace(f"–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏: '{permission_name}'")
        stmt = select(Permission).where(Permission.name == permission_name)
        result = await session.execute(stmt)
        perm = result.scalars().first()
        self._logger.trace(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–∞–π–¥–µ–Ω–æ: {perm is not None} (ID: {getattr(perm, 'id', 'N/A')})")
        return perm

    async def get_or_create_permission(self, session: AsyncSession, permission_name: str, description: Optional[str] = None) -> Optional[Permission]:
        permission = await self._get_permission_by_name(session, permission_name)
        if not permission:
            perm_def_desc = DEFAULT_CORE_PERMISSIONS_DEFINITIONS.get(permission_name)
            current_description = description if description is not None else perm_def_desc

            if current_description is not None: 
                self._logger.info(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º: '{current_description}'.")
                permission = Permission(name=permission_name, description=current_description)
                session.add(permission)
                try:
                    await session.flush([permission]) 
                    self._logger.success(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å–æ–∑–¥–∞–Ω–æ (—Åflushed) —Å ID: {permission.id}")
                except Exception as e_flush_perm:
                    self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ flush –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}': {e_flush_perm}", exc_info=True)
                    return None 
            else:
                self._logger.warning(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ. –ù–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.")
                return None
        return permission
        
    async def assign_permission_to_role(
        self, 
        session: AsyncSession, 
        role: Role, 
        permission_name: str,
        auto_create_perm: bool = True, 
    ) -> bool:
        if not role or role.id is None:
            self._logger.error(f"–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: –†–æ–ª—å –Ω–µ –≤–∞–ª–∏–¥–Ω–∞ –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç ID (role: {role}).")
            return False

        permission_obj: Optional[Permission] = None
        if auto_create_perm:
            permission_obj = await self.get_or_create_permission(session, permission_name, description=None)
        else:
            permission_obj = await self._get_permission_by_name(session, permission_name)
            
        if not permission_obj or permission_obj.id is None:
            log_msg = (f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å" + (" –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å" if auto_create_perm else "") +
                       f" —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' (ID: {getattr(permission_obj, 'id', 'N/A')}) –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏ '{role.name}'.")
            self._logger.error(log_msg)
            return False
        
        self._logger.debug(f"[ASSIGN_PERM_TO_ROLE] –ü—Ä–æ–≤–µ—Ä–∫–∞/–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–≤—è–∑–∏ –¥–ª—è RoleID: {role.id}, PermID: {permission_obj.id}")
        
        if await self._ensure_role_has_permission_link(session, role.id, permission_obj.id): 
            try:
                new_role_perm_link = RolePermission(role_id=role.id, permission_id=permission_obj.id)
                session.add(new_role_perm_link)
                self._logger.info(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' (PermID: {permission_obj.id}) –¥–æ–±–∞–≤–ª–µ–Ω–æ —Ä–æ–ª–∏ '{role.name}' (RoleID: {role.id}) (–æ–∂–∏–¥–∞–µ—Ç commit).")
                return True
            except Exception as e_add_link:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞ RolePermission –¥–ª—è RoleID {role.id}, PermID {permission_obj.id}: {e_add_link}", exc_info=True)
                return False
        else: 
            link_exists_stmt = select(RolePermission.id).where(
                RolePermission.role_id == role.id,          
                RolePermission.permission_id == permission_obj.id 
            ).limit(1)
            existing_link_res = await session.execute(link_exists_stmt)
            if existing_link_res.scalar_one_or_none() is not None:
                 self._logger.trace(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–æ–ª–∏ '{role.name}' (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ).")
                 return True 
            else: 
                 self._logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}' –∏ —Ä–æ–ª–∏ '{role.name}'. "
                                     "–í–æ–∑–º–æ–∂–Ω–æ, –æ—à–∏–±–∫–∞ –≤ _ensure_role_has_permission_link –∏–ª–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ.")
                 return False

    async def remove_permission_from_role(self, session: AsyncSession, role: Role, permission_name: str) -> bool:
        if not role or role.id is None: return False
        permission_to_remove = await self._get_permission_by_name(session, permission_name)
        if not permission_to_remove or permission_to_remove.id is None:
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å —Ä–æ–ª–∏ '{role.name}'.")
            return True

        try:
            stmt_delete = delete(RolePermission).where(
                RolePermission.role_id == role.id, 
                RolePermission.permission_id == permission_to_remove.id
            )
            result = await session.execute(stmt_delete)
            if result.rowcount > 0:
                self._logger.info(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å–Ω—è—Ç–æ —Å —Ä–æ–ª–∏ '{role.name}' (–æ–∂–∏–¥–∞–µ—Ç commit).")
                return True
            else:
                self._logger.debug(f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–µ –±—ã–ª–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–æ–ª–∏ '{role.name}'. –°–Ω—è—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
                return True
        except Exception as e_remove_perm:
            self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}' —Å —Ä–æ–ª–∏ '{role.name}': {e_remove_perm}", exc_info=True)
            return False

    async def user_has_permission(self, session: AsyncSession, user_telegram_id: int, permission_name: str) -> bool:
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –í–ª–∞–¥–µ–ª—å—Ü–∞ (–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
        if self._services_provider_ref and self._services_provider_ref.config: 
            if user_telegram_id in self._services_provider_ref.config.core.super_admins:
                self._logger.trace(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} —è–≤–ª—è–µ—Ç—Å—è –í–ª–∞–¥–µ–ª—å—Ü–µ–º, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.")
                return True
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –µ–≥–æ —Ä–æ–ª—è–º–∏ –∏ –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏
        stmt = (
            select(User)
            .options(
                selectinload(User.roles).selectinload(Role.permissions), # –†–æ–ª–∏ –∏ –∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
                selectinload(User.direct_permissions) # –ü—Ä—è–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            )
            .where(User.telegram_id == user_telegram_id)
        )
        result = await session.execute(stmt)
        user_db: Optional[User] = result.scalars().first()

        if not user_db:
            self._logger.trace(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}'.")
            return False
        
        perm_name_lower = permission_name.lower()

        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_db.direct_permissions:
            for perm_obj in user_db.direct_permissions:
                if perm_obj.name.lower() == perm_name_lower:
                    self._logger.trace(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} –∏–º–µ–µ—Ç –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}'.")
                    return True
        
        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Ä–æ–ª–∏
        if not user_db.roles:
            self._logger.trace(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} –Ω–µ –∏–º–µ–µ—Ç —Ä–æ–ª–µ–π –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}'.")
            # (–ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä—è–º—ã—Ö –ø—Ä–∞–≤ –∏ –Ω–µ—Ç —Ä–æ–ª–µ–π, —Ç–æ –ø—Ä–∞–≤–∞ –Ω–µ—Ç)
            # return False # –≠—Ç–æ —É—Å–ª–æ–≤–∏–µ —É–∂–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–º return False
        else: # –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–æ–ª–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö
            for role_obj in user_db.roles:
                if role_obj.permissions: 
                    for perm_obj in role_obj.permissions:
                        if perm_obj.name.lower() == perm_name_lower:
                            self._logger.trace(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} –∏–º–µ–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —á–µ—Ä–µ–∑ —Ä–æ–ª—å '{role_obj.name}'.")
                            return True
        
        self._logger.trace(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {user_telegram_id} –ù–ï –∏–º–µ–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{permission_name}' (–Ω–∏ –ø—Ä—è–º–æ–≥–æ, –Ω–∏ —á–µ—Ä–µ–∑ —Ä–æ–ª–∏).")
        return False

    async def get_all_permissions(self, session: AsyncSession) -> List[Permission]:
        stmt = select(Permission).order_by(Permission.name)
        result = await session.execute(stmt)
        permissions = list(result.scalars().all())
        self._logger.debug(f"–ó–∞–ø—Ä–æ—à–µ–Ω —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π. –ù–∞–π–¥–µ–Ω–æ: {len(permissions)}.")
        return permissions

    async def get_role_permissions(self, session: AsyncSession, role_name: str) -> List[Permission]:
        stmt = select(Role).options(selectinload(Role.permissions)).where(Role.name == role_name)
        result = await session.execute(stmt)
        role_with_perms: Optional[Role] = result.scalars().first()
        
        if not role_with_perms:
            self._logger.warning(f"–ó–∞–ø—Ä–æ—à–µ–Ω—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ä–æ–ª–∏ '{role_name}'.")
            return []
            
        return list(role_with_perms.permissions) if role_with_perms.permissions else []

    # --- –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---

    async def assign_direct_permission_to_user(
        self, 
        session: AsyncSession, 
        user: User, 
        permission_name: str,
        auto_create_perm: bool = True # –û–±—ã—á–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É–∂–µ –¥–æ–ª–∂–Ω–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
    ) -> bool:
        if not user or user.id is None:
            self._logger.error(f"–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç ID (user: {user}).")
            return False

        permission_obj: Optional[Permission]
        if auto_create_perm: # –≠—Ç–æ –±–æ–ª—å—à–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –∏–ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤
            permission_obj = await self.get_or_create_permission(session, permission_name)
        else:
            permission_obj = await self._get_permission_by_name(session, permission_name)
            
        if not permission_obj or permission_obj.id is None:
            log_msg = (f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å" + (" –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å" if auto_create_perm else "") +
                       f" —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –¥–ª—è –ø—Ä—è–º–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id}.")
            self._logger.error(log_msg)
            return False

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Å–≤—è–∑–∏
        existing_link_stmt = select(UserPermission.id).where(
            UserPermission.user_id == user.id,
            UserPermission.permission_id == permission_obj.id
        ).limit(1)
        existing_link_res = await session.execute(existing_link_stmt)
        if existing_link_res.scalar_one_or_none() is not None:
            self._logger.debug(f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id}.")
            return True # –°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—à–Ω—ã–º, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å

        # –ï—Å–ª–∏ –º—ã —É–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ user.direct_permissions.append()
        # user.direct_permissions.append(permission_obj)
        # session.add(user)
        # –ò–õ–ò, –µ—Å–ª–∏ —É–ø—Ä–∞–≤–ª—è–µ–º —Å–≤—è–∑—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ–π –Ω–∞–ø—Ä—è–º—É—é:
        new_user_perm_link = UserPermission(user_id=user.id, permission_id=permission_obj.id)
        session.add(new_user_perm_link)
        
        self._logger.info(f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id} (–æ–∂–∏–¥–∞–µ—Ç commit).")
        return True

    async def remove_direct_permission_from_user(
        self, 
        session: AsyncSession, 
        user: User, 
        permission_name: str
    ) -> bool:
        if not user or user.id is None:
            self._logger.error("–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
            return False
        
        permission_to_remove = await self._get_permission_by_name(session, permission_name)
        if not permission_to_remove or permission_to_remove.id is None:
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id}.")
            return True # –°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—à–Ω—ã–º, —Ç–∞–∫ –∫–∞–∫ –µ–≥–æ –∏ –Ω–µ –±—ã–ª–æ

        # –ï—Å–ª–∏ –º—ã —É–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ user.direct_permissions.remove()
        # if permission_to_remove in user.direct_permissions: # –ù—É–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ user.direct_permissions
        #     user.direct_permissions.remove(permission_to_remove)
        #     session.add(user)
        #     self._logger.info(f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å–Ω—è—Ç–æ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id} (–æ–∂–∏–¥–∞–µ—Ç commit).")
        #     return True
        # else:
        #     self._logger.debug(f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–µ –±—ã–ª–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id}. –°–Ω—è—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
        #     return True
        # –ò–õ–ò, –µ—Å–ª–∏ —É–ø—Ä–∞–≤–ª—è–µ–º —Å–≤—è–∑—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ–π –Ω–∞–ø—Ä—è–º—É—é:
        stmt_delete = delete(UserPermission).where(
            UserPermission.user_id == user.id,
            UserPermission.permission_id == permission_to_remove.id
        )
        result = await session.execute(stmt_delete)
        if result.rowcount > 0:
            self._logger.info(f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' —Å–Ω—è—Ç–æ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id} (–æ–∂–∏–¥–∞–µ—Ç commit).")
            return True
        else:
            self._logger.debug(f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_name}' –Ω–µ –±—ã–ª–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id}. –°–Ω—è—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
            return True


    async def get_user_direct_permissions(self, session: AsyncSession, user_id: int) -> List[Permission]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ –µ–≥–æ DB ID)."""
        user_db = await session.get(User, user_id, options=[selectinload(User.direct_permissions)])
        if not user_db:
            self._logger.warning(f"–ó–∞–ø—Ä–æ—à–µ–Ω—ã –ø—Ä—è–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (DB ID: {user_id}).")
            return []
        return list(user_db.direct_permissions) if user_db.direct_permissions else []


======================================================================

------------------------------ FILE: core/events/dispatcher.py ------------------------------
# core/events/dispatcher.py

import asyncio
from collections import defaultdict
from typing import Callable, Any, Coroutine, List, Dict, Optional, Union, TYPE_CHECKING # –î–æ–±–∞–≤–∏–ª Optional, Union
from loguru import logger

if TYPE_CHECKING:
    # –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π —Ç–∏–ø –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–±—ã—Ç–∏—è, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.
    # EventHandler = Callable[..., Coroutine[Any, Any, None]]
    pass


class EventDispatcher:
    """
    –ü—Ä–æ—Å—Ç–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è SwiftDevBot.
    –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º —Å–∏—Å—Ç–µ–º—ã (—è–¥—Ä—É, –º–æ–¥—É–ª—è–º) –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
    –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ –Ω–∏—Ö, –Ω–µ –∏–º–µ—è –ø—Ä—è–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞.
    """

    def __init__(self):
        # –°–ª–æ–≤–∞—Ä—å, –≥–¥–µ –∫–ª—é—á - —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –∏–º—è (—Ç–∏–ø) —Å–æ–±—ã—Ç–∏—è,
        # –∑–Ω–∞—á–µ–Ω–∏–µ - —Å–ø–∏—Å–æ–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (–∫–æ—Ä—É—Ç–∏–Ω).
        self._listeners: Dict[str, List[Callable[..., Coroutine[Any, Any, None]]]] = defaultdict(list)
        self._logger = logger.bind(service="EventDispatcher")
        self._logger.info("EventDispatcher –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    def subscribe(self, event_type: str, handler: Callable[..., Coroutine[Any, Any, None]]) -> None:
        """
        –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è.

        Args:
            event_type: –ò–º—è (—Ç–∏–ø) —Å–æ–±—ã—Ç–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞.
                        –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "sdb:core:startup", "module_name:user_registered").
            handler: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–∫–æ—Ä—É—Ç–∏–Ω–∞), –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏—è.
                     –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–µ –∂–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ (*args) –∏ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ (**kwargs) –∞—Ä–≥—É–º–µ–Ω—Ç—ã,
                     —á—Ç–æ –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –º–µ—Ç–æ–¥ publish().

        Raises:
            TypeError: –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π (–∫–æ—Ä—É—Ç–∏–Ω–æ–π).
        """
        if not asyncio.iscoroutinefunction(handler):
            err_msg = (f"–û–±—Ä–∞–±–æ—Ç—á–∏–∫ '{handler.__qualname__}' –¥–ª—è —Å–æ–±—ã—Ç–∏—è '{event_type}' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "
                       f"–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å 'async def').")
            self._logger.error(err_msg)
            raise TypeError(err_msg) # –î–µ–ª–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç—Ä–æ–∂–µ

        self._listeners[event_type].append(handler)
        self._logger.debug(f"–û–±—Ä–∞–±–æ—Ç—á–∏–∫ '{handler.__qualname__}' —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —Å–æ–±—ã—Ç–∏–µ '{event_type}'.")

    def unsubscribe(self, event_type: str, handler: Callable[..., Coroutine[Any, Any, None]]) -> None:
        """
        –û—Ç–ø–∏—Å—ã–≤–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è.

        Args:
            event_type: –ò–º—è (—Ç–∏–ø) —Å–æ–±—ã—Ç–∏—è.
            handler: –§—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–ø–∏—Å–∞—Ç—å.
        """
        try:
            self._listeners[event_type].remove(handler)
            self._logger.debug(f"–û–±—Ä–∞–±–æ—Ç—á–∏–∫ '{handler.__qualname__}' —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø–∏—Å–∞–Ω –æ—Ç —Å–æ–±—ã—Ç–∏—è '{event_type}'.")
        except ValueError: # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø–∏—Å–∞—Ç—å –Ω–µ–æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ '{handler.__qualname__}' "
                                 f"–æ—Ç —Å–æ–±—ã—Ç–∏—è '{event_type}'. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        except KeyError: # –¢–∞–∫–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è –≤–æ–æ–±—â–µ –Ω–µ—Ç –≤ _listeners
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è '{event_type}'.")

    async def publish(self, event_type: str, *args: Any, **kwargs: Any) -> List[Union[Any, Exception]]:
        """
        –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ, –≤—ã–∑—ã–≤–∞—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –Ω–∞ –Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

        –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `asyncio.gather()`.
        –ï—Å–ª–∏ –∫–∞–∫–æ–π-–ª–∏–±–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —ç—Ç–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–π–º–∞–Ω–æ,
        –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ, –∏ –≤–º–µ—Å—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —ç—Ç–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–º —Å–ø–∏—Å–∫–µ –±—É–¥–µ—Ç –æ–±—ä–µ–∫—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
        –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è.

        Args:
            event_type: –ò–º—è (—Ç–∏–ø) –ø—É–±–ª–∏–∫—É–µ–º–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.
            *args: –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã –∫–∞–∂–¥–æ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É.
            **kwargs: –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã –∫–∞–∂–¥–æ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É.

        Returns:
            –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞.
            –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ—Ä–Ω—É–ª –∑–Ω–∞—á–µ–Ω–∏–µ, –æ–Ω–æ –±—É–¥–µ—Ç –≤ —Å–ø–∏—Å–∫–µ.
            –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–∑–≤–∞–ª –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –≤ —Å–ø–∏—Å–∫–µ –Ω–∞ –µ–≥–æ –º–µ—Å—Ç–µ –±—É–¥–µ—Ç –æ–±—ä–µ–∫—Ç —ç—Ç–æ–≥–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
            –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.
        """
        if event_type not in self._listeners or not self._listeners[event_type]:
            self._logger.trace(f"–ù–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –¥–ª—è —Å–æ–±—ã—Ç–∏—è '{event_type}'. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞.")
            return []

        handlers_to_call = self._listeners[event_type]
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è –ª–æ–≥–∞, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö
        args_repr = f"{len(args)} positional"
        kwargs_repr = f"{len(kwargs)} keyword"
        
        self._logger.info(f"–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è '{event_type}' –¥–ª—è {len(handlers_to_call)} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤. "
                          f"–ê—Ä–≥—É–º–µ–Ω—Ç—ã: ({args_repr}), ({kwargs_repr}).")

        # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ—Ä—É—Ç–∏–Ω –¥–ª—è –≤—ã–∑–æ–≤–∞
        tasks = [handler(*args, **kwargs) for handler in handlers_to_call]
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ –∏ —Å–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        results: List[Union[Any, Exception]] = await asyncio.gather(*tasks, return_exceptions=True)

        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∏ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
        for i, result_or_exc in enumerate(results):
            if isinstance(result_or_exc, Exception):
                failed_handler_name = handlers_to_call[i].__qualname__
                self._logger.error(
                    f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Å–æ–±—ã—Ç–∏—è '{failed_handler_name}' –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏—è '{event_type}': "
                    f"{type(result_or_exc).__name__}('{result_or_exc}')",
                    exc_info=result_or_exc # –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–±–µ–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
                )
        
        return results

    def get_listeners_count(self, event_type: Optional[str] = None) -> Union[int, Dict[str, int]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.
        –ï—Å–ª–∏ `event_type` —É–∫–∞–∑–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.
        –ï—Å–ª–∏ `event_type` –Ω–µ —É–∫–∞–∑–∞–Ω (None), –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å {event_type: count} –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π.
        """
        if event_type:
            return len(self._listeners.get(event_type, []))
        else:
            return {etype: len(handler_list) for etype, handler_list in self._listeners.items() if handler_list}

    async def dispose(self) -> None: # –°–¥–µ–ª–∞–µ–º async, –µ—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
        """–û—á–∏—â–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤. –ü–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã."""
        self._listeners.clear()
        self._logger.info("EventDispatcher –æ—á–∏—â–µ–Ω (–≤—Å–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –∏ —Å–ø–∏—Å–∫–∏ —Å–æ–±—ã—Ç–∏–π —É–¥–∞–ª–µ–Ω—ã).")


======================================================================

------------------------------ FILE: core/events/__init__.py ------------------------------



======================================================================

------------------------------ FILE: core/http_client/manager.py ------------------------------
# core/http_client/manager.py

import asyncio
from typing import Optional, Dict, Any, Union, TYPE_CHECKING

try:
    import aiohttp
    from aiohttp import ClientSession, ClientTimeout, ClientResponse, ClientResponseError, ClientError
    from aiohttp import ServerTimeoutError as AiohttpTimeoutError
except ImportError:
    aiohttp = None # type: ignore
    ClientSession = Any # type: ignore
    ClientTimeout = Any # type: ignore
    ClientResponse = Any # type: ignore
    ClientResponseError = Any # type: ignore
    ClientError = Any # type: ignore
    AiohttpTimeoutError = Any # type: ignore

from loguru import logger

if TYPE_CHECKING:
    from core.app_settings import AppSettings


class HTTPClientManager:
    def __init__(self, default_timeout_seconds: int = 10, app_settings: Optional['AppSettings'] = None):
        if not aiohttp:
            msg = ("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ aiohttp –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–µ (`pip install aiohttp`). "
                   "HTTPClientManager –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
            logger.critical(msg)
            raise ImportError(msg)
            
        self._session: Optional[ClientSession] = None
        self._default_timeout_config = ClientTimeout(total=default_timeout_seconds) 
        self._app_settings: Optional['AppSettings'] = app_settings 
        self._is_initialized_successfully = False
        logger.info(f"HTTPClientManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (—Ç–∞–π–º–∞—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {default_timeout_seconds} —Å–µ–∫).")

    async def initialize(self) -> None:
        if self._session is None or self._session.closed:
            try:
                self._session = ClientSession(timeout=self._default_timeout_config)
                self._is_initialized_successfully = True
                logger.success("aiohttp.ClientSession —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ aiohttp.ClientSession: {e}", exc_info=True)
                self._session = None
                self._is_initialized_successfully = False
                raise 
        else:
            logger.debug("aiohttp.ClientSession —É–∂–µ –±—ã–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    async def dispose(self) -> None:
        if self._session and not self._session.closed:
            try:
                await self._session.close()
                logger.info("aiohttp.ClientSession —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç.")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ aiohttp.ClientSession: {e}", exc_info=True)
        self._session = None
        self._is_initialized_successfully = False

    def is_available(self) -> bool:
        return self._session is not None and not self._session.closed and self._is_initialized_successfully

    def _get_session(self) -> ClientSession:
        if not self.is_available():
            msg = "HTTPClientManager (aiohttp.ClientSession) –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç! –í—ã–∑–æ–≤–∏—Ç–µ initialize()."
            logger.critical(msg)
            raise RuntimeError(msg)
        return self._session # type: ignore 

    async def request(
        self,
        method: str,
        url: str,
        params: Optional[Dict[str, Any]] = None,
        data: Optional[Any] = None,
        json_data: Optional[Any] = None,
        headers: Optional[Dict[str, str]] = None,
        timeout_seconds: Optional[int] = None,
        raise_for_status: bool = False 
    ) -> Optional[ClientResponse]:
        session = self._get_session()
        current_timeout_config = ClientTimeout(total=timeout_seconds) if timeout_seconds is not None else self._default_timeout_config
        
        request_kwargs = {
            "params": params, "data": data, "json": json_data,
            "headers": headers, "timeout": current_timeout_config,
        }
        active_request_kwargs = {k: v for k, v in request_kwargs.items() if v is not None}

        log_context = {"method": method.upper(), "url": url, "params": params, "json_body": json_data is not None}
        logger.debug(f"HTTP Request: {method.upper()} {url}", **log_context)
        
        try:
            async with session.request(method, url, **active_request_kwargs) as response:
                logger.debug(f"HTTP Response: Status {response.status} for {url}", 
                             **log_context, status_code=response.status)
                if raise_for_status:
                    response.raise_for_status() 
                return response
        except ClientResponseError as e: 
            logger.warning(f"HTTP ClientResponseError: {e.status} {e.message} for {url}", **log_context)
            raise 
        except (asyncio.TimeoutError, AiohttpTimeoutError) as e:
            logger.warning(f"HTTP TimeoutError for {url} (timeout: {current_timeout_config.total}s): {type(e).__name__}", **log_context)
            raise 
        except ClientError as e: 
            logger.error(f"HTTP ClientError for {url}: {e}", **log_context, exc_info=True)
            raise 
        except Exception as e: 
            logger.error(f"Unexpected HTTP Error during request to {url}: {e}", **log_context, exc_info=True)
            raise


    async def get_json(
        self, url: str, params: Optional[Dict[str, Any]] = None, 
        headers: Optional[Dict[str, str]] = None, timeout_seconds: Optional[int] = None,
        default_on_error: Optional[Any] = None 
    ) -> Optional[Any]:
        response: Optional[ClientResponse] = None
        try:
            response = await self.request("GET", url, params=params, headers=headers, 
                                          timeout_seconds=timeout_seconds, raise_for_status=True)
            if response: 
                return await response.json()
            return default_on_error 
        except (ClientResponseError, asyncio.TimeoutError, AiohttpTimeoutError, ClientError) as e:
            logger.warning(f"HTTP(S) error during get_json for {url}: {type(e).__name__} - {e}")
            if default_on_error is not None: return default_on_error
            raise
        except aiohttp.ContentTypeError as e_json: 
            logger.warning(f"Failed to decode JSON response from {url}: {e_json}")
            if response: logger.trace(f"Response text (JSON error): {(await response.text())[:200]}")
            if default_on_error is not None: return default_on_error
            raise
        except Exception as e_unexp: 
            logger.error(f"Unexpected error in get_json for {url}: {e_unexp}", exc_info=True)
            if default_on_error is not None: return default_on_error
            raise


    async def post_json_response(
        self, url: str, json_data: Optional[Any] = None, params: Optional[Dict[str, Any]] = None,
        headers: Optional[Dict[str, str]] = None, timeout_seconds: Optional[int] = None,
        default_on_error: Optional[Any] = None 
    ) -> Optional[Any]:
        response: Optional[ClientResponse] = None
        try:
            response = await self.request("POST", url, params=params, json_data=json_data, headers=headers,
                                          timeout_seconds=timeout_seconds, raise_for_status=True)
            if response:
                return await response.json()
            return default_on_error
        except (ClientResponseError, asyncio.TimeoutError, AiohttpTimeoutError, ClientError) as e:
            logger.warning(f"HTTP(S) error during post_json for {url}: {type(e).__name__} - {e}")
            if default_on_error is not None: return default_on_error
            raise
        except aiohttp.ContentTypeError as e_json:
            logger.warning(f"Failed to decode JSON response from {url} after POST: {e_json}")
            if response: logger.trace(f"Response text (JSON error): {(await response.text())[:200]}")
            if default_on_error is not None: return default_on_error
            raise
        except Exception as e_unexp:
            logger.error(f"Unexpected error in post_json for {url}: {e_unexp}", exc_info=True)
            if default_on_error is not None: return default_on_error
            raise


======================================================================

------------------------------ FILE: core/http_client/__init__.py ------------------------------



======================================================================

------------------------------ FILE: core/schemas/module_manifest.py ------------------------------
# core/schemas/module_manifest.py

from typing import List, Optional, Dict, Any, Union, Literal
from pydantic import BaseModel, Field, field_validator, HttpUrl, ValidationInfo
import re
from loguru import logger 


class CommandManifest(BaseModel):
    command: str = Field(..., description="–°–∞–º–∞ –∫–æ–º–∞–Ω–¥–∞ (–±–µ–∑ '/'). –ù–∞–ø—Ä–∏–º–µ—Ä, 'weather'.")
    description: str = Field(..., description="–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è /help).")
    icon: Optional[str] = Field(default=None, description="–≠–º–æ–¥–∑–∏-–∏–∫–æ–Ω–∫–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).")
    category: Optional[str] = Field(default=None, description="–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).")
    admin_only: bool = Field(default=False, alias="admin", description="–¢—Ä–µ–±—É–µ—Ç –ª–∏ –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")

class SettingChoiceOption(BaseModel):
    value: Any
    display_name: str

class SettingManifest(BaseModel):
    type: Literal["string", "int", "float", "bool", "choice", "multichoice", "text"] = Field(
        description="–¢–∏–ø –Ω–∞—Å—Ç—Ä–æ–π–∫–∏."
    )
    label: str = Field(..., description="–ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–¥–ª—è UI).")
    description: Optional[str] = Field(default=None, description="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–¥–ª—è UI).")
    default: Optional[Any] = Field(default=None, description="–ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –µ—Å–ª–∏ required=True –∏ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –∫–æ–Ω—Ñ–∏–≥–µ.")
    required: bool = Field(default=False, description="–Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π.")
    options: Optional[List[Union[str, int, float, SettingChoiceOption]]] = Field(
        default=None,
        description="–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤."
    )
    min_value: Optional[Union[int, float]] = Field(default=None, alias="min", description="–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.")
    max_value: Optional[Union[int, float]] = Field(default=None, alias="max", description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.")
    regex_validator: Optional[str] = Field(default=None, description="–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫–∏.")

    @field_validator('options', mode='before')
    @classmethod
    def _check_options_for_choice_type(cls, v: Optional[List[Any]], info: ValidationInfo) -> Optional[List[Any]]:
        setting_type = info.data.get('type') if info.data else None
        if setting_type in ["choice", "multichoice"] and (v is None or not v):
            raise ValueError(f"–ü–æ–ª–µ 'options' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ç–∏–ø–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ '{setting_type}'")
        if setting_type not in ["choice", "multichoice"] and v is not None:
            logger.warning(f"–ü–æ–ª–µ 'options' –ø—Ä–∏–º–µ–Ω–∏–º–æ —Ç–æ–ª—å–∫–æ –¥–ª—è 'choice'/'multichoice', –Ω–æ —É–∫–∞–∑–∞–Ω–æ –¥–ª—è '{setting_type}'.")
        return v

    @field_validator('min_value', 'max_value', mode='before')
    @classmethod
    def _check_min_max_for_numeric_type(cls, v: Optional[Union[int, float]], info: ValidationInfo) -> Optional[Union[int, float]]:
        setting_type = info.data.get('type') if info.data else None
        field_name = info.field_name 
        if setting_type not in ["int", "float"] and v is not None:
            logger.warning(f"–ü–æ–ª–µ '{field_name}' –ø—Ä–∏–º–µ–Ω–∏–º–æ —Ç–æ–ª—å–∫–æ –¥–ª—è 'int'/'float', –Ω–æ —É–∫–∞–∑–∞–Ω–æ –¥–ª—è '{setting_type}'.")
        return v

    @field_validator('regex_validator', mode='before')
    @classmethod
    def _check_regex_for_string_type(cls, v: Optional[str], info: ValidationInfo) -> Optional[str]:
        setting_type = info.data.get('type') if info.data else None
        if setting_type != "string" and v is not None:
            logger.warning(f"–ü–æ–ª–µ 'regex_validator' –ø—Ä–∏–º–µ–Ω–∏–º–æ —Ç–æ–ª—å–∫–æ –¥–ª—è 'string', –Ω–æ —É–∫–∞–∑–∞–Ω–æ –¥–ª—è '{setting_type}'.")
        if v is not None:
            try: re.compile(v)
            except re.error as e: raise ValueError(f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π regex –≤ 'regex_validator': {e}")
        return v

    @field_validator('default', mode='after') 
    @classmethod
    def _check_default_for_required(cls, v: Optional[Any], info: ValidationInfo) -> Optional[Any]:
        if info.data.get('required') and v is None:
             field_label = info.data.get('label', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞') 
             raise ValueError(f"–î–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ '{field_label}' (required=True) –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–∫–∞–∑–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ 'default' –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ.")
        return v

class PermissionManifest(BaseModel): 
    name: str = Field(..., description="–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'my_module.can_edit_items'). –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'module_name.permission_key'.")
    description: str = Field(..., description="–ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.")

    @field_validator('name')
    @classmethod
    def _validate_permission_name_format(cls, v: str, info: ValidationInfo) -> str:
        if not re.fullmatch(r"^[a-z0-9_]+(\.[a-z0-9_]+)+$", v.lower()):
            raise ValueError(f"–ò–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{v}' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'module_name.permission_key' "
                             f"(–Ω–∞–ø—Ä–∏–º–µ—Ä, 'example_module.view_data') –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, '_' –∏ '.'")
        return v.lower() 


class BackgroundTaskManifest(BaseModel):
    entry_point: str = Field(...)
    schedule: Optional[str] = Field(default=None)
    description: Optional[str] = Field(default=None)

class ModuleMetadata(BaseModel):
    homepage: Optional[HttpUrl] = Field(default=None)
    license: Optional[str] = Field(default=None)
    tags: List[str] = Field(default_factory=list)
    min_sdb_core_version: Optional[str] = Field(default=None)
    assign_default_access_to_user_role: bool = Field( # <--- –ù–û–í–û–ï –ü–û–õ–ï
        default=False, 
        description="–ï—Å–ª–∏ true, –±–∞–∑–æ–≤–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{module_name}.access_user_features' –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–æ–ª–∏ 'User'."
    )

    @field_validator('min_sdb_core_version', mode='before')
    @classmethod
    def _validate_semver_format(cls, v: Optional[str]) -> Optional[str]:
        if v is not None:
            semver_regex = r"^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$"
            if not re.fullmatch(semver_regex, v):
                raise ValueError(f"min_sdb_core_version ('{v}') –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ SemVer")
        return v

class ModuleManifest(BaseModel):
    name: str = Field(..., min_length=3, pattern=r'^[a-z][a-z0-9_]*[a-z0-9]$')
    display_name: str = Field(..., min_length=3)
    version: str = Field(...)
    description: Optional[str] = Field(default=None)
    author: Optional[str] = Field(default=None)
    
    python_requirements: List[str] = Field(default_factory=list)
    sdb_module_dependencies: List[str] = Field(default_factory=list)
    model_definitions: List[str] = Field(default_factory=list)
    commands: List[CommandManifest] = Field(default_factory=list)
    settings: Dict[str, SettingManifest] = Field(default_factory=dict) 
    declared_permissions: List[PermissionManifest] = Field(default_factory=list, alias="permissions")
    background_tasks: Dict[str, BackgroundTaskManifest] = Field(default_factory=dict)
    metadata: ModuleMetadata = Field(default_factory=ModuleMetadata) # <--- –ò–ó–ú–ï–ù–ï–ù–û: metadata —Ç–µ–ø–µ—Ä—å –Ω–µ Optional, —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –±—ã–ª–æ –ø–æ–ª–µ assign_default_access_to_user_role

    @field_validator('version', mode='before')
    @classmethod
    def _validate_module_version_format(cls, v: str) -> str:
        semver_regex = r"^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$"
        if not re.fullmatch(semver_regex, v):
            raise ValueError(f"–í–µ—Ä—Å–∏—è –º–æ–¥—É–ª—è ('{v}') –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—É SemVer 2.0.0")
        return v

    @field_validator('name', mode='before')
    @classmethod
    def _validate_module_name(cls, v: str) -> str:
        if not v.islower() and "_" not in v: 
            if v.lower() != v: 
                 logger.warning(f"–ò–º—è –º–æ–¥—É–ª—è '{v}' —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è snake_case.")
        return v
        
    @field_validator('declared_permissions') 
    @classmethod
    def _validate_permission_names_match_module(cls, v: List[PermissionManifest], info: ValidationInfo) -> List[PermissionManifest]:
        module_name = info.data.get('name') 
        if module_name:
            for perm_manifest in v:
                if not perm_manifest.name.startswith(f"{module_name}."):
                    raise ValueError(
                        f"–ò–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{perm_manifest.name}' –≤ –º–æ–¥—É–ª–µ '{module_name}' "
                        f"–¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞ '{module_name}.'"
                    )
        return v

    class Config:
        extra = 'forbid' 
        validate_assignment = True
        populate_by_name = True


======================================================================

------------------------------ FILE: core/ui/registry_ui.py ------------------------------
# core/ui/registry_ui.py

from typing import List, Dict, Optional, Callable, Any
from pydantic import BaseModel, Field, field_validator, ValidationError
from loguru import logger


class ModuleUIEntry(BaseModel):
    module_name: str = Field(description="–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –º–æ–¥—É–ª—è (–¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å manifest.name)")
    display_name: str = Field(description="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é")
    entry_callback_data: str = Field(description="–°—Ç—Ä–æ–∫–∞ callback_data –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞ –≤ –º–æ–¥—É–ª—å")
    
    icon: Optional[str] = Field(default=None, description="–≠–º–æ–¥–∑–∏-–∏–∫–æ–Ω–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)")
    description: Optional[str] = Field(
        default=None, 
        description="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è, –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ UI (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Å–ø–∏—Å–∫–µ –º–æ–¥—É–ª–µ–π)"
    )
    order: int = Field(
        default=100, 
        description="–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤ –º–µ–Ω—é (–º–µ–Ω—å—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–∑–Ω–∞—á–∞–µ—Ç –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç/–ø–æ–ª–æ–∂–µ–Ω–∏–µ)"
    )
    # –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç—Ç–æ–π –∫–Ω–æ–ø–∫–∏ –≤ –æ–±—â–µ–º –º–µ–Ω—é
    required_permission_to_view: Optional[str] = Field(
        default=None,
        description="–ò–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —ç—Ç–∞ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –±—ã–ª–∞ –≤–∏–¥–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."
    )

    @field_validator('module_name', 'display_name', 'entry_callback_data')
    @classmethod 
    def names_must_not_be_empty(cls, v: str) -> str: 
        if not v or not v.strip():
            raise ValueError("–ò–º—è –º–æ–¥—É–ª—è, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –∏ entry_callback_data –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏")
        return v

    class Config:
        validate_assignment = True 
        extra = 'forbid' 


class UIRegistry:
    def __init__(self):
        self._module_entries: Dict[str, ModuleUIEntry] = {}
        self._logger = logger.bind(service="UIRegistry")
        self._logger.info("UIRegistry –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    def register_module_entry(
        self,
        module_name: str,
        display_name: str,
        entry_callback_data: str,
        icon: Optional[str] = None,
        description: Optional[str] = None,
        order: int = 100,
        required_permission_to_view: Optional[str] = None # <--- –ù–æ–≤–æ–µ –ø–æ–ª–µ
    ) -> bool:
        if module_name in self._module_entries:
            self._logger.warning(
                f"–ú–æ–¥—É–ª—å '{module_name}' —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª —Å–≤–æ—é UI-—Ç–æ—á–∫—É –≤—Ö–æ–¥–∞. "
                f"–ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é –∑–∞–ø–∏—Å—å."
            )
        
        try:
            entry = ModuleUIEntry(
                module_name=module_name,
                display_name=display_name,
                entry_callback_data=entry_callback_data,
                icon=icon,
                description=description,
                order=order,
                required_permission_to_view=required_permission_to_view # <--- –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤–æ–µ –ø–æ–ª–µ
            )
            self._module_entries[module_name] = entry
            self._logger.info(f"UI-—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' ('{display_name}') —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞. "
                              f"–¢—Ä–µ–±—É–µ–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞: '{required_permission_to_view or '–Ω–µ—Ç'}'.")
            return True
        except ValidationError as e:
            self._logger.error(f"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ UI-—Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}': {e}")
            return False
        except Exception as e:
            self._logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ UI-—Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}': {e}", exc_info=True)
            return False

    def unregister_module_entry(self, module_name: str) -> bool:
        if module_name in self._module_entries:
            del self._module_entries[module_name]
            self._logger.info(f"UI-—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –º–æ–¥—É–ª—è '{module_name}' –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ (—É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞).")
            return True
        else:
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π UI-—Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª—è '{module_name}'.")
            return False

    def get_all_module_entries(self) -> List[ModuleUIEntry]: # –£–±—Ä–∞–ª for_admin_status, –±—É–¥–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å required_permission_to_view
        entries = list(self._module_entries.values())
        entries.sort(key=lambda x: (x.order, x.display_name.lower()))
        self._logger.trace(f"–ó–∞–ø—Ä–æ—à–µ–Ω —Å–ø–∏—Å–æ–∫ –í–°–ï–• UI-—Ç–æ—á–µ–∫ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª–µ–π. –ù–∞–π–¥–µ–Ω–æ: {len(entries)}")
        return entries

    def get_module_entry(self, module_name: str) -> Optional[ModuleUIEntry]:
        return self._module_entries.get(module_name)

    async def dispose(self) -> None: 
        self._module_entries.clear()
        self._logger.info("UIRegistry –æ—á–∏—â–µ–Ω (–≤—Å–µ UI-—Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª–µ–π —É–¥–∞–ª–µ–Ω—ã).")


======================================================================

------------------------------ FILE: core/ui/handlers_core_ui.py ------------------------------
# SwiftDevBot/core/ui/handlers_core_ui.py
from aiogram import Router, F, types, Bot
from aiogram.filters import CommandStart, Command, StateFilter 
from aiogram.fsm.context import FSMContext 
from aiogram.fsm.state import State, StatesGroup 
from aiogram.utils.markdown import hbold, hitalic, hcode 
import html # <--- –ò–ú–ü–û–†–¢–ò–†–£–ï–ú –°–¢–ê–ù–î–ê–†–¢–ù–´–ô –ú–û–î–£–õ–¨ html
from loguru import logger
from aiogram.exceptions import TelegramBadRequest 
from aiogram.types import ReplyKeyboardRemove 

from .callback_data_factories import CoreMenuNavigate, ModuleMenuEntry, CoreServiceAction 
from .keyboards_core import (
    get_main_menu_reply_keyboard,
    get_modules_list_keyboard, 
    get_welcome_confirmation_keyboard, 
    get_profile_menu_keyboard,         
    get_language_selection_keyboard, 
    TEXTS_CORE_KEYBOARDS_EN 
)
from core.database.core_models import User as DBUser 
from core.ui.registry_ui import ModuleUIEntry 
from sqlalchemy import select 
from core.i18n.translator import Translator 

from typing import TYPE_CHECKING, Optional, List
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession 

core_ui_router = Router(name="sdb_core_ui_handlers")
MODULE_NAME_FOR_LOG = "CoreUI"

class FSMFeedback(StatesGroup):
    waiting_for_feedback_message = State()

async def show_main_menu_reply(
    message_or_query: types.Message | types.CallbackQuery, 
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
    text_override: Optional[str] = None,
    state: Optional[FSMContext] = None 
):
    if state: 
        current_fsm_state = await state.get_state()
        if current_fsm_state is not None:
            logger.info(f"[{MODULE_NAME_FOR_LOG}] –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM ({current_fsm_state}) –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –≥–ª–∞–≤–Ω–æ–≥–æ reply-–º–µ–Ω—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {sdb_user.telegram_id}.")
            await state.clear()

    user_id = sdb_user.telegram_id
    user_display_name = sdb_user.full_name 
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] User {user_id} ({user_display_name}) showing main reply menu.")
    
    texts = TEXTS_CORE_KEYBOARDS_EN
    default_text = f"üè† {hbold('–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é SwiftDevBot')}\n–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {hbold(user_display_name)}! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    text_to_send = text_override if text_override else default_text
    
    keyboard = await get_main_menu_reply_keyboard(services_provider=services_provider, user_telegram_id=user_id)
    
    target_chat_id = message_or_query.chat.id if isinstance(message_or_query, types.Message) else message_or_query.message.chat.id # type: ignore

    if isinstance(message_or_query, types.CallbackQuery) and message_or_query.message:
        try:
            if message_or_query.message.reply_markup: 
                 await message_or_query.message.edit_reply_markup(reply_markup=None)
        except Exception as e_del_edit:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º reply menu: {e_del_edit}")
    
    await bot.send_message(target_chat_id, text_to_send, reply_markup=keyboard)
    
    if isinstance(message_or_query, types.CallbackQuery):
        await message_or_query.answer()


@core_ui_router.message(CommandStart())
async def handle_start_command(
    message: types.Message,
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser, 
    state: FSMContext, 
    user_was_just_created: Optional[bool] = False 
):
    user_tg = message.from_user 
    if not user_tg: return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_tg.id} (@{user_tg.username or 'N/A'}) –≤—ã–∑–≤–∞–ª /start. "
                f"SDB_User DB ID: {sdb_user.id}. –ë—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω (–≤ middleware): {user_was_just_created}.")

    texts = TEXTS_CORE_KEYBOARDS_EN
    is_owner_from_config = sdb_user.telegram_id in services_provider.config.core.super_admins
    user_display_name = sdb_user.full_name 

    if is_owner_from_config or not user_was_just_created: 
        logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} ({'–í–ª–∞–¥–µ–ª–µ—Ü' if is_owner_from_config else '—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π'}). –ü–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ reply-–º–µ–Ω—é.")
        await show_main_menu_reply(message, bot, services_provider, sdb_user, state=state) 
    else: 
        logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –Ω–æ–≤—ã–π. –ü–æ–∫–∞–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.")
        welcome_title = texts.get("welcome_message_title", "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!")
        welcome_body = texts.get("welcome_message_body", "–û–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞...")
        full_welcome_text = f"{hbold(welcome_title)}\n\n{welcome_body}"
        welcome_keyboard = get_welcome_confirmation_keyboard()
        await message.answer(full_welcome_text, reply_markup=welcome_keyboard)


@core_ui_router.callback_query(CoreServiceAction.filter(F.action == "confirm_registration"))
async def cq_confirm_registration_and_show_main_menu(
    query: types.CallbackQuery, 
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
    state: FSMContext 
):
    user_id = sdb_user.telegram_id 
    user_full_name = sdb_user.full_name
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} ({user_full_name}) –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –ø–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ reply-–º–µ–Ω—é.")
    
    if query.message:
        try:
            await query.message.delete()
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º: {e}")
            
    await show_main_menu_reply(query, bot, services_provider, sdb_user, 
                               text_override=f"–û—Ç–ª–∏—á–Ω–æ, {hbold(user_full_name)}! –í–æ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
                               state=state) 


@core_ui_router.callback_query(CoreServiceAction.filter(F.action == "cancel_registration"))
async def cq_cancel_registration(
    query: types.CallbackQuery, 
    bot: Bot, 
    services_provider: 'BotServicesProvider', 
    state: FSMContext 
):
    user_id = query.from_user.id 
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ—Ç–º–µ–Ω–∏–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é/–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ.")
    await state.clear() 
    
    texts = TEXTS_CORE_KEYBOARDS_EN
    cancel_text = texts.get("registration_cancelled_message", "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")

    if query.message:
        try:
            await query.message.delete()
        except Exception as e_delete:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (user: {user_id}): {e_delete}")
    
    await bot.send_message(user_id, cancel_text, reply_markup=ReplyKeyboardRemove())
    await query.answer()


@core_ui_router.message(F.text == TEXTS_CORE_KEYBOARDS_EN["main_menu_reply_modules"], StateFilter(None)) 
async def handle_text_modules_list(message: types.Message, bot:Bot, services_provider: 'BotServicesProvider', sdb_user: DBUser):
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –Ω–∞–∂–∞–ª reply-–∫–Ω–æ–ø–∫—É '–ú–æ–¥—É–ª–∏'")
    await send_modules_list_message(message.chat.id, bot, services_provider, sdb_user, page=1)

@core_ui_router.message(F.text == TEXTS_CORE_KEYBOARDS_EN["main_menu_reply_profile"], StateFilter(None))
async def handle_text_profile(message: types.Message, bot: Bot, services_provider: 'BotServicesProvider', sdb_user: DBUser):
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –Ω–∞–∂–∞–ª reply-–∫–Ω–æ–ø–∫—É '–ü—Ä–æ—Ñ–∏–ª—å'")
    await send_profile_message(message.chat.id, bot, services_provider, sdb_user)

@core_ui_router.message(F.text == TEXTS_CORE_KEYBOARDS_EN["main_menu_reply_feedback"], StateFilter(None))
async def handle_text_feedback_start_fsm(
    message: types.Message, 
    services_provider: 'BotServicesProvider', 
    sdb_user: DBUser, 
    state: FSMContext
):
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –Ω–∞–∂–∞–ª reply-–∫–Ω–æ–ø–∫—É '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å', –≤—Ö–æ–¥ –≤ FSM.")
    text = (
        "‚úçÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.\n"
        f"{hitalic('–î–ª—è –æ—Ç–º–µ–Ω—ã –≤–≤–µ–¥–∏—Ç–µ /cancel_feedback')}"
    )
    await state.set_state(FSMFeedback.waiting_for_feedback_message)
    await message.answer(text) 

@core_ui_router.message(StateFilter(FSMFeedback.waiting_for_feedback_message), F.text)
async def process_feedback_message(
    message: types.Message, 
    bot: Bot, 
    services_provider: 'BotServicesProvider', 
    sdb_user: DBUser, 
    state: FSMContext
):
    feedback_text = message.text
    user_id = sdb_user.telegram_id
    # –ò–°–ü–û–õ–¨–ó–£–ï–ú html.escape
    user_full_name_escaped = html.escape(sdb_user.full_name) 
    username_escaped = f"@{html.escape(sdb_user.username)}" if sdb_user.username else "(–Ω–µ—Ç username)"
    
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ—Ç {user_id} ({username_escaped}): '{feedback_text[:100]}...'")

    admin_message_header = (
        f"üì¨ {hbold('–ù–æ–≤—ã–π –æ—Ç–∑—ã–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!')}\n\n"
        f"üë§ –û—Ç: {user_full_name_escaped}\n"
        f"üÜî Telegram ID: {hcode(str(user_id))}\n"
        f"üîó Username: {username_escaped}\n"
        f"üïí –í—Ä–µ–º—è: {message.date.strftime('%Y-%m-%d %H:%M:%S %Z') if message.date else 'N/A'}\n"
    )
    admin_message_body = f"\nüìù {hbold('–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞:')}\n{html.escape(feedback_text)}" # –ò–°–ü–û–õ–¨–ó–£–ï–ú html.escape
    full_admin_message = admin_message_header + admin_message_body
    
    sent_to_admins_count = 0
    if services_provider.config.core.super_admins:
        for admin_tg_id in services_provider.config.core.super_admins:
            try:
                await bot.send_message(admin_tg_id, full_admin_message)
                sent_to_admins_count += 1
            except Exception as e:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –∞–¥–º–∏–Ω—É {admin_tg_id}: {e}")
        if sent_to_admins_count > 0:
            logger.info(f"–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω {sent_to_admins_count} —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.")
        else:
            logger.warning("–û—Ç–∑—ã–≤ –Ω–µ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∏ –æ–¥–Ω–æ–º—É —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (–≤–æ–∑–º–æ–∂–Ω–æ, —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∏ –æ—à–∏–±–∫–∏).")
    else:
        logger.warning("–°–ø–∏—Å–æ–∫ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –ø—É—Å—Ç. –û—Ç–∑—ã–≤ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.")
    
    await message.reply("–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! –ú—ã –µ–≥–æ –ø–æ–ª—É—á–∏–ª–∏.")
    await show_main_menu_reply(message, bot, services_provider, sdb_user, text_override="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", state=state)

@core_ui_router.message(Command("cancel_feedback"), StateFilter(FSMFeedback.waiting_for_feedback_message))
async def cancel_feedback_fsm(
    message: types.Message, 
    bot: Bot,
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
    state: FSMContext
):
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –æ—Ç–º–µ–Ω–∏–ª –≤–≤–æ–¥ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.")
    await message.reply("–í–≤–æ–¥ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ—Ç–º–µ–Ω–µ–Ω.")
    await show_main_menu_reply(message, bot, services_provider, sdb_user, text_override="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", state=state)


@core_ui_router.message(F.text == TEXTS_CORE_KEYBOARDS_EN["main_menu_reply_admin_panel"], StateFilter(None))
async def handle_text_admin_panel(message: types.Message, bot:Bot, services_provider: 'BotServicesProvider', sdb_user: DBUser, state: FSMContext): 
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {sdb_user.telegram_id} –Ω–∞–∂–∞–ª reply-–∫–Ω–æ–ø–∫—É '–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å'")
    await state.clear() 
    from core.admin.entry.handlers_entry import send_admin_main_menu 
    await send_admin_main_menu(message, services_provider) 


@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "main_reply"))
async def cq_nav_to_main_menu_reply(
    query: types.CallbackQuery, 
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
    state: FSMContext 
):
    await show_main_menu_reply(query, bot, services_provider, sdb_user, state=state) 


async def send_modules_list_message(
    chat_id: int, 
    bot: Bot, 
    services_provider: 'BotServicesProvider', 
    sdb_user: DBUser, 
    page: int = 1,
    message_to_edit: Optional[types.Message] = None 
):
    user_id = sdb_user.telegram_id
    texts = TEXTS_CORE_KEYBOARDS_EN
    items_per_page = 5
    keyboard = await get_modules_list_keyboard(services_provider, user_id, page, items_per_page)
    
    num_module_buttons = 0; total_accessible_items = 0
    if keyboard.inline_keyboard: 
        for row in keyboard.inline_keyboard:
            for button in row:
                if button.callback_data and button.callback_data.startswith(ModuleMenuEntry.__prefix__):
                    num_module_buttons +=1

    all_module_ui_entries_temp = services_provider.ui_registry.get_all_module_entries()
    if all_module_ui_entries_temp:
        async with services_provider.db.get_session() as session:
            for entry_temp in all_module_ui_entries_temp:
                if entry_temp.required_permission_to_view:
                    if await services_provider.rbac.user_has_permission(session, user_id, entry_temp.required_permission_to_view):
                        total_accessible_items +=1
                else: total_accessible_items +=1
    
    total_pages = (total_accessible_items + items_per_page - 1) // items_per_page
    total_pages = max(1, total_pages)

    if num_module_buttons == 0 and page == 1: text = texts["modules_list_no_modules"]
    else: text = texts["modules_list_title_template"].format(current_page=page, total_pages=total_pages)
    
    if message_to_edit: 
        try:
            if message_to_edit.text != text or message_to_edit.reply_markup != keyboard:
                await message_to_edit.edit_text(text, reply_markup=keyboard)
            return 
        except TelegramBadRequest as e:
            if "message is not modified" not in str(e).lower():
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å edit modules list (inline pagination): {e}")
            return
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ send_modules_list_message (edit): {e}", exc_info=True)
            return
    
    await bot.send_message(chat_id, text, reply_markup=keyboard)


async def send_profile_message(
    chat_id: int, 
    bot: Bot, 
    services_provider: 'BotServicesProvider', 
    sdb_user: DBUser,
    message_to_edit: Optional[types.Message] = None
):
    texts = TEXTS_CORE_KEYBOARDS_EN
    reg_date_str = sdb_user.created_at.strftime('%d.%m.%Y %H:%M') if sdb_user.created_at else texts["profile_no_reg_date"]
    username_str = f"@{sdb_user.username}" if sdb_user.username else texts["profile_no_username"] 
    current_lang = sdb_user.preferred_language_code or services_provider.config.core.i18n.default_locale
    lang_display_name = current_lang.upper()

    profile_text = texts["profile_info_template"].format(
        user_id=hcode(str(sdb_user.telegram_id)),
        full_name=hbold(sdb_user.full_name),
        username=username_str,
        registration_date=reg_date_str,
        current_language=lang_display_name
    )
    final_text = f"{hbold(texts['profile_title'])}\n\n{profile_text}"
    keyboard = await get_profile_menu_keyboard(sdb_user, services_provider)
    
    if message_to_edit:
        try:
            if message_to_edit.text != final_text or message_to_edit.reply_markup != keyboard:
                await message_to_edit.edit_text(final_text, reply_markup=keyboard)
            return
        except TelegramBadRequest as e:
            if "message is not modified" not in str(e).lower():
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å edit profile (inline nav): {e}")
            return
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ send_profile_message (edit): {e}", exc_info=True)
            return
            
    await bot.send_message(chat_id, final_text, reply_markup=keyboard)


@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "modules_list"))
async def cq_nav_to_modules_list(
    query: types.CallbackQuery, 
    callback_data: CoreMenuNavigate, 
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser
):
    user_id = sdb_user.telegram_id
    page = callback_data.page if callback_data.page is not None else 1
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] User {user_id} requested modules list (inline nav), page: {page}")
    
    if query.message:
        await send_modules_list_message(query.message.chat.id, bot, services_provider, sdb_user, page, message_to_edit=query.message)
    await query.answer()


@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "profile"))
async def cq_nav_to_profile( 
    query: types.CallbackQuery, 
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser 
):
    if query.message:
        await send_profile_message(query.message.chat.id, bot, services_provider, sdb_user, message_to_edit=query.message)
    await query.answer()


@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "profile_change_lang_list"))
async def cq_profile_show_language_list(
    query: types.CallbackQuery,
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser
):
    user_id = sdb_user.telegram_id
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] User {user_id} requested language selection list.")
    
    texts = TEXTS_CORE_KEYBOARDS_EN
    i18n_settings = services_provider.config.core.i18n
    
    current_lang = sdb_user.preferred_language_code or i18n_settings.default_locale
    available_langs = i18n_settings.available_locales
    
    text = texts.get("profile_select_language_title", "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:")
    keyboard = await get_language_selection_keyboard(current_lang, available_langs)
    
    if query.message:
        try:
            if query.message.text != text or query.message.reply_markup != keyboard: 
                await query.message.edit_text(text, reply_markup=keyboard)
            await query.answer()
        except TelegramBadRequest as e:
            if "message is not modified" not in str(e).lower():
                 logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ edit_text –≤ cq_profile_show_language_list: {e}")
            await query.answer() 
        except Exception as e:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –≤ cq_profile_show_language_list: {e}", exc_info=True)
            await query.answer("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.")

@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "profile_set_lang"))
async def cq_profile_set_language(
    query: types.CallbackQuery,
    callback_data: CoreMenuNavigate,
    bot: Bot, 
    services_provider: 'BotServicesProvider',
    sdb_user: DBUser,
    translator: Translator 
):
    new_lang_code = callback_data.payload
    user_id = sdb_user.telegram_id
    
    if not new_lang_code or new_lang_code not in services_provider.config.core.i18n.available_locales:
        logger.warning(f"[{MODULE_NAME_FOR_LOG}] User {user_id} –ø–æ–ø—ã—Ç–∞–ª—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —è–∑—ã–∫: {new_lang_code}")
        await query.answer("–í—ã–±—Ä–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —è–∑—ã–∫.", show_alert=True)
        if query.message: 
            await send_profile_message(query.message.chat.id, bot, services_provider, sdb_user, message_to_edit=query.message)
        return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] User {user_id} —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —è–∑—ã–∫: {new_lang_code}")
    
    user_service = services_provider.user_service 
    async with services_provider.db.get_session() as session: 
        user_in_session = await session.get(DBUser, sdb_user.id) 
        if user_in_session:
            if await user_service.update_user_language(user_in_session, new_lang_code, session):
                try:
                    await session.commit()
                    sdb_user.preferred_language_code = new_lang_code 
                    
                    logger.success(f"[{MODULE_NAME_FOR_LOG}] –Ø–∑—ã–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {new_lang_code} –≤ –ë–î.")
                    await query.answer(f"Language changed to {new_lang_code.upper()}", show_alert=False)
                except Exception as e_commit:
                    await session.rollback()
                    logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ commit –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞ –¥–ª—è {user_id}: {e_commit}", exc_info=True)
                    await query.answer("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —è–∑—ã–∫–∞.", show_alert=True)
            else:
                await query.answer(f"–Ø–∑—ã–∫ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ {new_lang_code.upper()}.", show_alert=False)
        else: 
            await query.answer("–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–∑—ã–∫–∞.", show_alert=True)
            
    if query.message:
        await send_profile_message(query.message.chat.id, bot, services_provider, sdb_user, message_to_edit=query.message)
    

@core_ui_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "feedback_fsm_start"))
async def cq_nav_to_feedback_fsm_start( 
    query: types.CallbackQuery, 
    bot: Bot, 
    services_provider: 'BotServicesProvider', 
    sdb_user: DBUser, 
    state: FSMContext
):
    user_id = query.from_user.id
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] User {user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å (FSM —á–µ—Ä–µ–∑ callback).")
    text = (
        "‚úçÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.\n"
        f"{hitalic('–î–ª—è –æ—Ç–º–µ–Ω—ã –≤–≤–µ–¥–∏—Ç–µ /cancel_feedback')}"
    )
    await state.set_state(FSMFeedback.waiting_for_feedback_message)
    
    if query.message:
        try: 
            await query.message.edit_text(text, reply_markup=None) 
        except TelegramBadRequest as e:
             if "message is not modified" not in str(e).lower():
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤–≤–æ–¥–æ–º feedback (callback): {e}")
                await bot.send_message(user_id, text) 
        except Exception as e_edit_fb:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤–≤–æ–¥–æ–º feedback (callback): {e_edit_fb}")
            await bot.send_message(user_id, text)
    else: 
        await bot.send_message(user_id, text)
    await query.answer()


@core_ui_router.callback_query(CoreServiceAction.filter(F.action == "delete_this_message"))
async def cq_service_action_delete_message(query: types.CallbackQuery, bot: Bot):
    user_id = query.from_user.id
    message_id = query.message.message_id if query.message else "N/A"
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] User {user_id} requested to delete message_id: {message_id}")
    
    try:
        if query.message:
            await bot.delete_message(chat_id=query.message.chat.id, message_id=query.message.message_id)
            await query.answer("–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ.") 
        else:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É –æ—Ç user {user_id}.")
            await query.answer("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
    except TelegramBadRequest as e: 
        logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ {message_id} –¥–ª—è user {user_id}: {e} (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤).")
        await query.answer() 
    except Exception as e:
        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è {message_id} –¥–ª—è user {user_id}: {e}", exc_info=True)
        await query.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.", show_alert=True)


======================================================================

------------------------------ FILE: core/ui/keyboards_core.py ------------------------------
# SwiftDevBot/core/ui/keyboards_core.py

from typing import List, Dict, Optional, TYPE_CHECKING
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω—É–∂–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton 
from aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder # –î–æ–±–∞–≤–ª—è–µ–º ReplyKeyboardBuilder
from loguru import logger 

from .callback_data_factories import CoreMenuNavigate, ModuleMenuEntry, CoreServiceAction
from core.rbac.service import PERMISSION_CORE_VIEW_ADMIN_PANEL 
from core.database.core_models import User as DBUser

if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from core.ui.registry_ui import ModuleUIEntry
    from sqlalchemy.ext.asyncio import AsyncSession 

# –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ –∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏
TEXTS_CORE_KEYBOARDS_EN = {
    # –î–ª—è Reply Keyboard (–≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)
    "main_menu_reply_modules": "üóÇ –ú–æ–¥—É–ª–∏", # –¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ
    "main_menu_reply_profile": "üë§ –ü—Ä–æ—Ñ–∏–ª—å",
    "main_menu_reply_feedback": "‚úçÔ∏è –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å",
    "main_menu_reply_admin_panel": "üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å",

    # –î–ª—è Inline Keyboard (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ–Ω—é)
    "main_menu_inline_modules": "üóÇ Modules", # –û—Å—Ç–∞–≤–∏–º —Å—Ç–∞—Ä—ã–µ –¥–ª—è –∏–Ω–ª–∞–π–Ω, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è
    "main_menu_inline_profile": "üë§ Profile",
    "main_menu_inline_feedback": "‚úçÔ∏è Feedback",
    "main_menu_inline_admin_panel": "üõ† Admin Panel",

    "modules_list_no_modules": "ü§∑ No modules available",
    "modules_list_title_template": "Available Modules (Page {current_page}/{total_pages}):",
    "pagination_prev": "‚¨ÖÔ∏è Prev",
    "pagination_next": "Next ‚û°Ô∏è",
    "navigation_back_to_main": "üè† Main Menu", # –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏ –¥–ª—è –∏–Ω–ª–∞–π–Ω, –∏ –¥–ª—è reply (–∫–∞–∫ /start)
    "service_delete_message": "‚ùå Close this menu",
    "confirm_yes": "‚úÖ Yes",
    "confirm_no": "‚ùå No",
    "welcome_message_title": "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SwiftDevBot!",
    "welcome_message_body": (
        "–Ø ‚Äî –≤–∞—à –º–æ–¥—É–ª—å–Ω—ã–π Telegram-–ø–æ–º–æ—â–Ω–∏–∫, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á.\n\n"
        "üîç **–ß—Ç–æ —è –º–æ–≥—É?**\n"
        "–ú–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π. –≠—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —É—Ç–∏–ª–∏—Ç—ã, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.\n\n"
        "üîí **–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:**\n"
        "–Ø –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ç–æ–ª—å–∫–æ —Ç–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –º–æ–µ–π —Ä–∞–±–æ—Ç—ã –∏ —Ä–∞–±–æ—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π. "
        "–ú—ã —Ü–µ–Ω–∏–º –≤–∞—à—É –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –±–æ—Ç–∞.\n\n"
        "–ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —Ç–µ–º, —á—Ç–æ –±–æ—Ç –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–≤–æ–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π."
    ),
    "welcome_button_continue": "‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
    "welcome_button_cancel": "‚ùå –û—Ç–º–µ–Ω–∞",
    "registration_cancelled_message": "–û—á–µ–Ω—å –∂–∞–ª—å, —á—Ç–æ –≤—ã –ø–µ—Ä–µ–¥—É–º–∞–ª–∏. –ï—Å–ª–∏ –Ω–∞–¥—É–º–∞–µ—Ç–µ —Å–Ω–æ–≤–∞, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ /start.",
    "user_middleware_please_register": (
        "üëã –ü–æ—Ö–æ–∂–µ, –≤—ã –µ—â–µ –Ω–µ –∑–Ω–∞–∫–æ–º—ã —Å–æ –º–Ω–æ–π! "
        "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ /start –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /start."
    ),
    "profile_title": "üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å",
    "profile_info_template": (
        "üÜî –í–∞—à Telegram ID: {user_id}\n"
        "üìù –ò–º—è: {full_name}\n"
        "üë§ Username: @{username}\n"
        "üìÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {registration_date}\n"
        "üó£ –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: {current_language}"
    ),
    "profile_no_username": "–Ω–µ —É–∫–∞–∑–∞–Ω",
    "profile_no_reg_date": "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
    "profile_button_change_language": "üåê –°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫", # –≠—Ç–æ –±—É–¥–µ—Ç –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
    "profile_select_language_title": "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:",
}

# --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø REPLY KEYBOARD –ì–õ–ê–í–ù–û–ì–û –ú–ï–ù–Æ ---
async def get_main_menu_reply_keyboard( 
    services_provider: 'BotServicesProvider', 
    user_telegram_id: int
) -> ReplyKeyboardMarkup:
    builder = ReplyKeyboardBuilder() # –ò—Å–ø–æ–ª—å–∑—É–µ–º ReplyKeyboardBuilder
    texts = TEXTS_CORE_KEYBOARDS_EN 
    
    builder.button(text=texts["main_menu_reply_modules"])
    builder.button(text=texts["main_menu_reply_profile"])
    
    show_admin_button = False
    if user_telegram_id in services_provider.config.core.super_admins:
        show_admin_button = True
    else:
        try:
            async with services_provider.db.get_session() as session: 
                if await services_provider.rbac.user_has_permission(session, user_telegram_id, PERMISSION_CORE_VIEW_ADMIN_PANEL):
                    show_admin_button = True
        except Exception as e: 
            logger.error(f"[MainMenuReplyKeyboard] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{PERMISSION_CORE_VIEW_ADMIN_PANEL}' –¥–ª—è {user_telegram_id}: {e}")
            
    if show_admin_button:
        builder.button(text=texts["main_menu_reply_admin_panel"])
        
    builder.button(text=texts["main_menu_reply_feedback"])
    
    # –†–∞—Å–ø–æ–ª–æ–∂–∏–º –∫–Ω–æ–ø–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ 2 –≤ —Ä—è–¥
    builder.adjust(2, 2) # –ü–µ—Ä–≤—ã–µ –¥–≤–∞ —Ä—è–¥–∞ –ø–æ 2 –∫–Ω–æ–ø–∫–∏
    
    return builder.as_markup(
        resize_keyboard=True, 
        # one_time_keyboard=True # –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–∫—Ä—ã–≤–∞–ª–∞—Å—å –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è
        input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é..." # –ü–æ–¥—Å–∫–∞–∑–∫–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    )

# –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (–º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤ –∏–ª–∏ –µ—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å)
async def get_main_menu_inline_keyboard( # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
    services_provider: 'BotServicesProvider', 
    user_telegram_id: int
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = TEXTS_CORE_KEYBOARDS_EN 
    
    builder.button(
        text=texts["main_menu_inline_modules"], # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç—ã –¥–ª—è –∏–Ω–ª–∞–π–Ω
        callback_data=CoreMenuNavigate(target_menu="modules_list", page=1).pack()
    )
    builder.button(
        text=texts["main_menu_inline_profile"],
        callback_data=CoreMenuNavigate(target_menu="profile").pack()
    )
    # ... (–ª–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∫–∏ –∫–∞–∫ –±—ã–ª–∞) ...
    show_admin_button = False
    if user_telegram_id in services_provider.config.core.super_admins:
        show_admin_button = True
    else:
        try:
            async with services_provider.db.get_session() as session: 
                if await services_provider.rbac.user_has_permission(session, user_telegram_id, PERMISSION_CORE_VIEW_ADMIN_PANEL):
                    show_admin_button = True
        except Exception: pass # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å –≤ get_main_menu_reply_keyboard
            
    if show_admin_button:
        builder.button(
            text=texts["main_menu_inline_admin_panel"],
            callback_data=CoreMenuNavigate(target_menu="admin_panel_main").pack()
        )
    builder.button(
        text=texts["main_menu_inline_feedback"],
        callback_data=CoreMenuNavigate(target_menu="feedback").pack()
    )
    builder.adjust(2) 
    return builder.as_markup()


async def get_modules_list_keyboard( # –û—Å—Ç–∞–µ—Ç—Å—è –∏–Ω–ª–∞–π–Ω
    # ... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    services_provider: 'BotServicesProvider',
    user_telegram_id: int, 
    current_page: int = 1,
    items_per_page: int = 5
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = TEXTS_CORE_KEYBOARDS_EN
    
    all_module_ui_entries: List['ModuleUIEntry'] = services_provider.ui_registry.get_all_module_entries()
    
    accessible_module_entries: List['ModuleUIEntry'] = []
    if all_module_ui_entries:
        async with services_provider.db.get_session() as session: 
            for entry in all_module_ui_entries:
                if entry.required_permission_to_view:
                    if await services_provider.rbac.user_has_permission(session, user_telegram_id, entry.required_permission_to_view):
                        accessible_module_entries.append(entry)
                else:
                    accessible_module_entries.append(entry)

    if not accessible_module_entries:
        builder.button(
            text=texts["modules_list_no_modules"],
            callback_data="core:dummy_no_modules"
        )
    else:
        # ... (–ª–æ–≥–∏–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏ –∫–Ω–æ–ø–æ–∫ –º–æ–¥—É–ª–µ–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
        total_items = len(accessible_module_entries)
        total_pages = (total_items + items_per_page - 1) // items_per_page
        current_page = max(1, min(current_page, total_pages if total_pages > 0 else 1))

        start_index = (current_page - 1) * items_per_page
        end_index = start_index + items_per_page
        paginated_entries = accessible_module_entries[start_index:end_index]

        for entry in paginated_entries:
            button_text = f"{entry.icon} {entry.display_name}" if entry.icon else entry.display_name
            builder.button(
                text=button_text,
                callback_data=entry.entry_callback_data
            )
        builder.adjust(1)

        if total_pages > 1:
            pagination_buttons_row: List[InlineKeyboardButton] = []
            if current_page > 1:
                pagination_buttons_row.append(InlineKeyboardButton(text=texts["pagination_prev"], callback_data=CoreMenuNavigate(target_menu="modules_list", page=current_page - 1).pack()))
            pagination_buttons_row.append(InlineKeyboardButton(text=f"{current_page}/{total_pages}", callback_data="core:dummy_page_indicator"))
            if current_page < total_pages:
                pagination_buttons_row.append(InlineKeyboardButton(text=texts["pagination_next"], callback_data=CoreMenuNavigate(target_menu="modules_list", page=current_page + 1).pack()))
            if pagination_buttons_row:
                 builder.row(*pagination_buttons_row)
    builder.row(
        InlineKeyboardButton(
            text=texts["navigation_back_to_main"], 
            callback_data=CoreMenuNavigate(target_menu="main_reply").pack() # <--- –ò–ó–ú–ï–ù–ï–ù–û: –≤–æ–∑–≤—Ä–∞—Ç –∫ reply-–º–µ–Ω—é
        )
    )
    return builder.as_markup()


def get_welcome_confirmation_keyboard() -> InlineKeyboardMarkup: # –û—Å—Ç–∞–µ—Ç—Å—è –∏–Ω–ª–∞–π–Ω
    # ... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    builder = InlineKeyboardBuilder()
    texts = TEXTS_CORE_KEYBOARDS_EN
    builder.button(
        text=texts["welcome_button_continue"],
        callback_data=CoreServiceAction(action="confirm_registration").pack()
    )
    builder.button(
        text=texts["welcome_button_cancel"],
        callback_data=CoreServiceAction(action="cancel_registration").pack()
    )
    builder.adjust(2)
    return builder.as_markup()

async def get_profile_menu_keyboard( # –û—Å—Ç–∞–µ—Ç—Å—è –∏–Ω–ª–∞–π–Ω
    # ... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    db_user: DBUser, 
    services_provider: 'BotServicesProvider'
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = TEXTS_CORE_KEYBOARDS_EN
    available_langs = services_provider.config.core.i18n.available_locales
    if len(available_langs) > 1:
        builder.button(
            text=texts["profile_button_change_language"],
            callback_data=CoreMenuNavigate(target_menu="profile_change_lang_list").pack()
        )
    if not builder.export():
        builder.button(text="–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ", callback_data="core_profile:dummy_no_actions")
    builder.row(
        InlineKeyboardButton(
            text=texts["navigation_back_to_main"],
            callback_data=CoreMenuNavigate(target_menu="main_reply").pack() # <--- –ò–ó–ú–ï–ù–ï–ù–û: –≤–æ–∑–≤—Ä–∞—Ç –∫ reply-–º–µ–Ω—é
        )
    )
    builder.adjust(1)
    return builder.as_markup()

async def get_language_selection_keyboard( # –û—Å—Ç–∞–µ—Ç—Å—è –∏–Ω–ª–∞–π–Ω
    # ... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    current_lang_code: Optional[str],
    available_locales: List[str], 
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    for lang_code in available_locales:
        prefix = "‚úÖ " if lang_code == current_lang_code else "‚ñ´Ô∏è "
        display_name = lang_code.upper() 
        builder.button(
            text=f"{prefix}{display_name}",
            callback_data=CoreMenuNavigate(target_menu="profile_set_lang", payload=lang_code).pack()
        )
    builder.adjust(1) 
    builder.row(
        InlineKeyboardButton(
            text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å", 
            callback_data=CoreMenuNavigate(target_menu="profile").pack()
        )
    )
    return builder.as_markup()

# ... (get_confirm_action_keyboard, get_close_button_keyboard –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç.–∫. –æ–Ω–∏ –∏–Ω–ª–∞–π–Ω)
def get_confirm_action_keyboard(
    confirm_callback_data: str,
    cancel_callback_data: str,
    confirm_text_key: str = "confirm_yes",
    cancel_text_key: str = "confirm_no"
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = TEXTS_CORE_KEYBOARDS_EN
    
    builder.button(text=texts[confirm_text_key], callback_data=confirm_callback_data)
    builder.button(text=texts[cancel_text_key], callback_data=cancel_callback_data)
    builder.adjust(2)
    return builder.as_markup()

def get_close_button_keyboard(
    close_text_key: str = "service_delete_message"
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = TEXTS_CORE_KEYBOARDS_EN
    builder.button(
        text=texts[close_text_key],
        callback_data=CoreServiceAction(action="delete_this_message").pack()
    )
    return builder.as_markup()


======================================================================

------------------------------ FILE: core/ui/navigation_core.py ------------------------------
# core/ui/navigation_core.py

from aiogram import Router, F, types, Bot
from aiogram.exceptions import TelegramBadRequest
from aiogram.utils.markdown import hbold, hitalic
from loguru import logger

from .callback_data_factories import CoreMenuNavigate, ModuleMenuEntry, CoreServiceAction
from .keyboards_core import (
    get_main_menu_keyboard, 
    get_modules_list_keyboard,
    # get_close_button_keyboard, # –ï—Å–ª–∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —è–≤–Ω–æ
    TEXTS_CORE_KEYBOARDS_EN 
)

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider

core_navigation_router = Router(name="sdb_core_ui_navigation_handlers")

@core_navigation_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "main"))
async def cq_nav_to_main_menu(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider' 
):
    user_id = query.from_user.id
    user_full_name = query.from_user.full_name
    logger.debug(f"User {user_id} ({user_full_name}) navigating to main menu.")
    
    texts = TEXTS_CORE_KEYBOARDS_EN
    text = f"üè† {hbold('–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é SwiftDevBot')}\n–ü—Ä–∏–≤–µ—Ç, {hbold(user_full_name)}! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    
    keyboard = await get_main_menu_keyboard(services_provider=services_provider, user_telegram_id=user_id)
    
    try:
        if query.message:
            if query.message.text != text or query.message.reply_markup != keyboard:
                await query.message.edit_text(text, reply_markup=keyboard)
            else:
                logger.trace("–°–æ–æ–±—â–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (—Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ–≤–ø–∞–¥–∞—é—Ç).")
        await query.answer()
    except TelegramBadRequest as e:
        if "message is not modified" in str(e).lower():
            logger.trace("–°–æ–æ–±—â–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
            await query.answer()
        else:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (user: {user_id}): {e}")
            await query.answer("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é.", show_alert=True)
    except Exception as e:
        logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (user: {user_id}): {e}", exc_info=True)
        await query.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ä—å–µ–∑–Ω–∞—è –æ—à–∏–±–∫–∞.", show_alert=True)


@core_navigation_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "modules_list"))
async def cq_nav_to_modules_list(
    query: types.CallbackQuery, 
    callback_data: CoreMenuNavigate, 
    services_provider: 'BotServicesProvider' 
):
    user_id = query.from_user.id
    page = callback_data.page if callback_data.page is not None else 1
    logger.debug(f"User {user_id} requested modules list, page: {page}")

    texts = TEXTS_CORE_KEYBOARDS_EN
    
    module_ui_entries = services_provider.ui_registry.get_all_module_entries()
    items_per_page = 5 
    total_pages = (len(module_ui_entries) + items_per_page - 1) // items_per_page
    total_pages = max(1, total_pages) 

    text = texts["modules_list_title_template"].format(current_page=page, total_pages=total_pages)
    
    keyboard = await get_modules_list_keyboard(
        services_provider=services_provider, 
        user_telegram_id=user_id, 
        current_page=page,
        items_per_page=items_per_page
    )
    
    try:
        if query.message:
            if query.message.text != text or query.message.reply_markup != keyboard:
                await query.message.edit_text(text, reply_markup=keyboard)
            else:
                logger.trace("–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")
        await query.answer()
    except TelegramBadRequest as e:
        if "message is not modified" in str(e).lower():
            logger.trace("–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
            await query.answer()
        else:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π (user: {user_id}): {e}")
            await query.answer("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞.", show_alert=True)
    except Exception as e:
        logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π (user: {user_id}): {e}", exc_info=True)
        await query.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ä—å–µ–∑–Ω–∞—è –æ—à–∏–±–∫–∞.", show_alert=True)

@core_navigation_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "profile"))
async def cq_nav_to_profile(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider' 
):
    user_id = query.from_user.id
    logger.debug(f"User {user_id} requested profile menu (WIP).")
    text = "üë§ –†–∞–∑–¥–µ–ª '–ü—Ä–æ—Ñ–∏–ª—å' –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ."
    keyboard = await get_main_menu_keyboard(services_provider=services_provider, user_telegram_id=user_id) 
    if query.message:
        
        try:
            if query.message.text != text or query.message.reply_markup != keyboard:
                await query.message.edit_text(text, reply_markup=keyboard)
        except TelegramBadRequest as e:
            if "message is not modified" not in str(e).lower():
                logger.warning(f"–û—à–∏–±–∫–∞ edit_text –≤ cq_nav_to_profile: {e}")
    await query.answer("–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.")

@core_navigation_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "feedback"))
async def cq_nav_to_feedback(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider' 
):
    user_id = query.from_user.id
    logger.debug(f"User {user_id} requested feedback menu (WIP).")
    text = "‚úçÔ∏è –†–∞–∑–¥–µ–ª '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å' –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ."
    keyboard = await get_main_menu_keyboard(services_provider=services_provider, user_telegram_id=user_id) 
    if query.message:
        try:
            if query.message.text != text or query.message.reply_markup != keyboard:
                await query.message.edit_text(text, reply_markup=keyboard)
        except TelegramBadRequest as e:
            if "message is not modified" not in str(e).lower():
                logger.warning(f"–û—à–∏–±–∫–∞ edit_text –≤ cq_nav_to_feedback: {e}")
    await query.answer("–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.")

# –£–¥–∞–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ cq_nav_to_admin_panel, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª
# —Å —Ä–∞–±–æ—á–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º –≤ core/admin/handlers_admin_entry.py

@core_navigation_router.callback_query(CoreServiceAction.filter(F.action == "delete_this_message"))
async def cq_service_action_delete_message(query: types.CallbackQuery, bot: Bot):
    user_id = query.from_user.id
    message_id = query.message.message_id if query.message else "N/A"
    logger.debug(f"User {user_id} requested to delete message_id: {message_id}")
    
    try:
        if query.message:
            await bot.delete_message(chat_id=query.message.chat.id, message_id=query.message.message_id)
            await query.answer("–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ.") 
        else:
            logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É –æ—Ç user {user_id}.")
            await query.answer("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
    except TelegramBadRequest as e:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ {message_id} –¥–ª—è user {user_id}: {e}")
        await query.answer()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è {message_id} –¥–ª—è user {user_id}: {e}", exc_info=True)
        await query.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.", show_alert=True)


======================================================================

------------------------------ FILE: core/ui/__init__.py ------------------------------



======================================================================

------------------------------ FILE: core/ui/callback_data_factories.py ------------------------------
# SwiftDevBot/core/ui/callback_data_factories.py
from typing import Optional, Literal, Union 
from aiogram.filters.callback_data import CallbackData

CORE_CALLBACK_PREFIX = "sdb_core"
ADMIN_CALLBACK_PREFIX = "sdb_admin" 

# --- –§–∞–±—Ä–∏–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —è–¥—Ä–∞ ---
class CoreMenuNavigate(CallbackData, prefix=f"{CORE_CALLBACK_PREFIX}_nav"):
    target_menu: str 
    page: Optional[int] = None
    action: Optional[str] = None 
    # –î–æ–±–∞–≤–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–¥–∞ —è–∑—ã–∫–∞
    payload: Optional[str] = None 

class ModuleMenuEntry(CallbackData, prefix=f"{CORE_CALLBACK_PREFIX}_module_entry"):
    module_name: str

class CoreServiceAction(CallbackData, prefix=f"{CORE_CALLBACK_PREFIX}_service"):
    action: Literal[
        "delete_this_message", 
        "close_menu_silently",
        "confirm_registration", 
        "cancel_registration",
    ]

# --- –§–∞–±—Ä–∏–∫–∏ –¥–ª—è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ ---
# ... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
ADMIN_MAIN_MENU_PREFIX = "sdb_admin_main"
class AdminMainMenuNavigate(CallbackData, prefix=ADMIN_MAIN_MENU_PREFIX):
    target_section: str 

ADMIN_USERS_PREFIX = "sdb_admin_users"
class AdminUsersPanelNavigate(CallbackData, prefix=ADMIN_USERS_PREFIX):
    action: str 
    item_id: Optional[int] = None       
    page: Optional[int] = None          
    role_id: Optional[int] = None       
    permission_id: Optional[int] = None 
    
    category_key: Optional[str] = None 
    entity_name: Optional[str] = None  


ADMIN_ROLES_PREFIX = "sdb_admin_roles"
class AdminRolesPanelNavigate(CallbackData, prefix=ADMIN_ROLES_PREFIX):
    action: str 
    item_id: Optional[int] = None       
    permission_id: Optional[int] = None 
    category_key: Optional[str] = None  
    entity_name: Optional[str] = None   
    page: Optional[int] = None          

ADMIN_SYSINFO_PREFIX = "sdb_admin_sysinfo"
class AdminSysInfoPanelNavigate(CallbackData, prefix=ADMIN_SYSINFO_PREFIX):
    action: str 

ADMIN_MODULES_PREFIX = "sdb_admin_modules"
class AdminModulesPanelNavigate(CallbackData, prefix=ADMIN_MODULES_PREFIX):
    action: str 
    item_id: Optional[str] = None 
    page: Optional[int] = None

ADMIN_LOGS_PREFIX = "sdb_admin_logs"
class AdminLogsPanelNavigate(CallbackData, prefix=ADMIN_LOGS_PREFIX):
    action: str 
    item_id: Optional[str] = None 
    page: Optional[int] = None

class AdminPanelNavigate(CallbackData, prefix=ADMIN_CALLBACK_PREFIX): 
    section: str 
    action: Optional[str] = None
    item_id: Optional[Union[int, str]] = None 
    page: Optional[int] = None
    role_id: Optional[int] = None 
    permission_name: Optional[str] = None


======================================================================

------------------------------ FILE: core/users/middleware.py ------------------------------
# SwiftDevBot/core/users/middleware.py
from typing import Callable, Dict, Any, Awaitable, Optional
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject, User as AiogramUser, Update 
from loguru import logger
from datetime import datetime, timezone 

from core.database.core_models import User as DBUser
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from core.ui.keyboards_core import TEXTS_CORE_KEYBOARDS_EN


from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from core.users.service import UserService 

MODULE_NAME_FOR_LOG = "UserStatusMiddleware"

class UserStatusMiddleware(BaseMiddleware):
    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: Update, 
        data: Dict[str, Any]
    ) -> Any:
        
        aiogram_event_user: Optional[AiogramUser] = data.get("event_from_user")
        if not aiogram_event_user:
            return await handler(event, data)

        user_tg_id = aiogram_event_user.id
        user_mention = f"@{aiogram_event_user.username}" if aiogram_event_user.username else f"ID:{user_tg_id}"
        
        services_provider: Optional['BotServicesProvider'] = data.get("services_provider")
        if not (services_provider and hasattr(services_provider, 'db') and hasattr(services_provider, 'user_service')):
            logger.critical(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã (DBManager, UserService) –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã "
                           f"–∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ data. –ü—Ä–æ–≤–µ—Ä–∫–∞/—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.")
            if event.message: await event.message.reply("–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –±–æ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–æ–±—â–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
            elif event.callback_query: await event.callback_query.answer("–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤.", show_alert=True)
            return None

        db_user: Optional[DBUser] = None
        user_service: 'UserService' = services_provider.user_service
        user_was_created_in_this_middleware_call = False # –§–ª–∞–≥ –¥–ª—è —ç—Ç–æ–≥–æ –≤—ã–∑–æ–≤–∞ middleware

        try:
            async with services_provider.db.get_session() as session:
                stmt = select(DBUser).where(DBUser.telegram_id == user_tg_id)
                result = await session.execute(stmt)
                db_user = result.scalars().first()
        except Exception as e_get_user:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention}: {e_get_user}", exc_info=True)
            if event.message: await event.message.reply("–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            elif event.callback_query: await event.callback_query.answer("–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.", show_alert=True)
            return None

        is_owner_from_config = user_tg_id in services_provider.config.core.super_admins
        is_start_command = event.message and event.message.text and event.message.text.startswith("/start")

        if not db_user: 
            if is_start_command or is_owner_from_config:
                logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î. "
                            f"–≠—Ç–æ {'/start' if is_start_command else '–í–ª–∞–¥–µ–ª–µ—Ü ('+str(user_tg_id)+')'}. "
                            f"–í—ã–∑–æ–≤ UserService.process_user_on_start –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...")
                try:
                    processed_user, created_flag = await user_service.process_user_on_start(aiogram_event_user)
                    db_user = processed_user
                    if created_flag: # –ï—Å–ª–∏ UserService –µ–≥–æ –¢–û–õ–¨–ö–û –ß–¢–û –°–û–ó–î–ê–õ
                        user_was_created_in_this_middleware_call = True
                    
                    if not db_user:
                        # ... (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ process_user_on_start)
                        logger.error(f"[{MODULE_NAME_FOR_LOG}] UserService.process_user_on_start –Ω–µ —Å–º–æ–≥ —Å–æ–∑–¥–∞—Ç—å/–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} –≤ middleware. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.")
                        if event.message: await event.message.reply("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start –µ—â–µ —Ä–∞–∑ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")
                        elif event.callback_query: await event.callback_query.answer("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.", show_alert=True)
                        return None
                    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} (DB ID: {db_user.id}) —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω/–æ–±—Ä–∞–±–æ—Ç–∞–Ω UserService –≤ middleware. –ë—ã–ª —Å–æ–∑–¥–∞–Ω —Å–µ–π—á–∞—Å: {user_was_created_in_this_middleware_call}")
                except Exception as e_create_mw:
                    # ... (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è e_create_mw)
                    logger.error(f"[{MODULE_NAME_FOR_LOG}] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ process_user_on_start –∏–∑ middleware –¥–ª—è {user_mention}: {e_create_mw}", exc_info=True)
                    if event.message: await event.message.reply("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.")
                    elif event.callback_query: await event.callback_query.answer("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è.", show_alert=True)
                    return None
            else: 
                logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î –∏ —ç—Ç–æ –Ω–µ /start/–≤–ª–∞–¥–µ–ª–µ—Ü. –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–∑—ã–≤–∞ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
                please_register_text = TEXTS_CORE_KEYBOARDS_EN.get("user_middleware_please_register", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º.")
                # ... (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ return None)
                if event.message:
                    try: await event.message.reply(please_register_text)
                    except Exception as e_reply: logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä. {user_mention}: {e_reply}")
                elif event.callback_query:
                    try: await event.callback_query.answer(please_register_text, show_alert=True)
                    except Exception as e_answer: logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ callback –æ —Ä–µ–≥–∏—Å—Ç—Ä. {user_mention}: {e_answer}")
                return None 
        elif not is_start_command: 
            logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} –Ω–∞–π–¥–µ–Ω. –í—ã–∑–æ–≤ process_user_on_start –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...")
            try:
                processed_user, _ = await user_service.process_user_on_start(aiogram_event_user) # –§–ª–∞–≥ created –∑–¥–µ—Å—å –Ω–µ —Ç–∞–∫ –≤–∞–∂–µ–Ω
                if processed_user:
                    db_user = processed_user 
                else: 
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] process_user_on_start –≤–µ—Ä–Ω—É–ª None –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} –≤ middleware.")
            except Exception as e_update_mw:
                 logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} –≤ middleware: {e_update_mw}", exc_info=True)
        
        if not db_user:
            logger.critical(f"[{MODULE_NAME_FOR_LOG}] db_user –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è/—Å–æ–∑–¥–∞–Ω–∏—è –¥–ª—è {user_mention}. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.")
            return None

        # –ü—Ä–æ–≤–µ—Ä–∫–∏ is_active –∏ is_bot_blocked (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        if not db_user.is_active:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} (DB ID: {db_user.id}) –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω. –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.")
            # ... (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ return None)
            return None 

        if db_user.is_bot_blocked:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} (DB ID: {db_user.id}) –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ. –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.")
            # ... (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ return None)
            return None 
            
        logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} (DB ID: {db_user.id}) –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–µ–ª. –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω.")
        data['sdb_user'] = db_user
        # --- –ü–ï–†–ï–î–ê–ï–ú –§–õ–ê–ì –û –°–û–ó–î–ê–ù–ò–ò –í –•–≠–ù–î–õ–ï–† /start ---
        if is_start_command: # –¢–æ–ª—å–∫–æ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /start –ø–µ—Ä–µ–¥–∞–µ–º —ç—Ç–æ—Ç —Ñ–ª–∞–≥
            data['user_was_just_created'] = user_was_created_in_this_middleware_call
            logger.debug(f"[{MODULE_NAME_FOR_LOG}] –î–ª—è /start –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–ª–∞–≥ user_was_just_created = {user_was_created_in_this_middleware_call}")

        return await handler(event, data)


======================================================================

------------------------------ FILE: core/users/__init__.py ------------------------------
# core/users/__init__.py
from .service import UserService

__all__ = ["UserService"]


======================================================================

------------------------------ FILE: core/users/service.py ------------------------------
# SwiftDevBot/core/users/service.py
from typing import TYPE_CHECKING, Optional, Tuple, List 
from aiogram import types as aiogram_types
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, orm 
from sqlalchemy.orm import attributes as orm_attributes 
from loguru import logger
from sqlalchemy.exc import IntegrityError 
from datetime import datetime, timezone 

from core.database.core_models import User as DBUser, Role as DBRole 
from core.rbac.service import DEFAULT_ROLE_USER 

if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from core.app_settings import I18nSettings 
    from core.rbac.service import RBACService 


class UserService:
    def __init__(self, services_provider: 'BotServicesProvider'):
        self._services = services_provider
        self._logger = logger.bind(service="UserService")
        self._logger.info("UserService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

    async def _get_user_by_telegram_id(self, telegram_id: int, session: AsyncSession, load_roles: bool = False, load_direct_perms: bool = False) -> Optional[DBUser]:
        self._logger.trace(f"–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î. TG ID: {telegram_id}, –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–µ–π: {load_roles}, –ø—Ä—è–º—ã—Ö –ø—Ä–∞–≤: {load_direct_perms}")
        stmt = select(DBUser).where(DBUser.telegram_id == telegram_id)
        options_to_load = []
        if load_roles:
            options_to_load.append(orm.selectinload(DBUser.roles).selectinload(DBRole.permissions))
        if load_direct_perms:
            options_to_load.append(orm.selectinload(DBUser.direct_permissions))
        
        if options_to_load:
            stmt = stmt.options(*options_to_load)
            
        result = await session.execute(stmt)
        user = result.scalars().first()
        if user:
            roles_loaded_str = "–Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω–æ"
            if load_roles:
                is_roles_relationship_loaded = orm_attributes.instance_state(user).has_identity and \
                                            'roles' in orm_attributes.instance_state(user).committed_state
                
                roles_loaded_str = "–∑–∞–≥—Ä—É–∂–µ–Ω—ã" if is_roles_relationship_loaded and user.roles is not None else "–ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
                if is_roles_relationship_loaded and user.roles is not None:
                     self._logger.trace(f"User roles data (count): {len(user.roles)}")
                elif not is_roles_relationship_loaded:
                    self._logger.trace(f"–ê—Ç—Ä–∏–±—É—Ç 'roles' –Ω–µ –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}, —Ö–æ—Ç—è load_roles=True.")

            self._logger.trace(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {telegram_id} –Ω–∞–π–¥–µ–Ω –≤ –ë–î (DB ID: {user.id}). –†–æ–ª–∏: {roles_loaded_str}")
        else:
            self._logger.trace(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î.")
        return user

    async def _update_existing_user_data(
        self,
        db_user: DBUser,
        tg_user: aiogram_types.User,
        current_lang_code: str
        ) -> bool: # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –±—ã–ª–∏ –∑–Ω–∞—á–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–∫—Ä–æ–º–µ last_activity_at)
        updated_fields_log: dict = {}
        data_changed_meaningfully = False # –§–ª–∞–≥ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫—Ä–æ–º–µ last_activity

        if db_user.username != tg_user.username:
            updated_fields_log['username'] = (db_user.username, tg_user.username)
            db_user.username = tg_user.username
            db_user.username_lower = tg_user.username.lower() if tg_user.username else None 
            data_changed_meaningfully = True
        if db_user.first_name != tg_user.first_name:
            updated_fields_log['first_name'] = (db_user.first_name, tg_user.first_name)
            db_user.first_name = tg_user.first_name
            data_changed_meaningfully = True
        if db_user.last_name != tg_user.last_name:
            updated_fields_log['last_name'] = (db_user.last_name, tg_user.last_name)
            db_user.last_name = tg_user.last_name
            data_changed_meaningfully = True
        if db_user.preferred_language_code != current_lang_code:
            updated_fields_log['preferred_language_code'] = (db_user.preferred_language_code, current_lang_code)
            db_user.preferred_language_code = current_lang_code
            data_changed_meaningfully = True
        
        is_owner_check = tg_user.id in self._services.config.core.super_admins

        if is_owner_check:
            if not db_user.is_active:
                db_user.is_active = True; data_changed_meaningfully = True
                updated_fields_log['is_active (owner override)'] = (False, True)
            if db_user.is_bot_blocked:
                db_user.is_bot_blocked = False; data_changed_meaningfully = True
                updated_fields_log['is_bot_blocked (owner override)'] = (True, False)
        else: 
            if db_user.is_bot_blocked: 
                updated_fields_log['is_bot_blocked (user active)'] = (db_user.is_bot_blocked, False)
                db_user.is_bot_blocked = False 
                data_changed_meaningfully = True
            if not db_user.is_active: 
                updated_fields_log['is_active (user active)'] = (db_user.is_active, True)
                db_user.is_active = True
                data_changed_meaningfully = True

        # –û–±–Ω–æ–≤–ª—è–µ–º last_activity_at –≤—Å–µ–≥–¥–∞
        db_user.last_activity_at = datetime.now(timezone.utc)
        
        if data_changed_meaningfully:
            self._logger.info(f"–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è TG ID: {tg_user.id} (DB ID: {db_user.id}) –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã: {updated_fields_log}")
        
        return data_changed_meaningfully

    async def process_user_on_start(self, tg_user: aiogram_types.User) -> Tuple[Optional[DBUser], bool]:
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–ª–∏ –ª—é–±–æ–º –¥—Ä—É–≥–æ–º —Å–æ–±—ã—Ç–∏–∏.
        –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ (DBUser, user_was_created_bool).
        """
        self._logger.info(f"UserService.process_user_on_start –¥–ª—è TG ID: {tg_user.id} (@{tg_user.username or 'N/A'})")
        
        is_owner = tg_user.id in self._services.config.core.super_admins
        if is_owner:
            self._logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {tg_user.id} –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ –í–ª–∞–¥–µ–ª–µ—Ü —Å–∏—Å—Ç–µ–º—ã.")

        user_was_created = False # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–ª–∞–≥

        async with self._services.db.get_session() as session:
            try:
                db_user = await self._get_user_by_telegram_id(tg_user.id, session, load_roles=True) # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Ä–æ–ª—è–º–∏
                
                data_actually_changed_in_db = False # –§–ª–∞–≥ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –∫–æ–º–º–∏—Ç–∞

                i18n_settings: Optional["I18nSettings"] = getattr(self._services.config.core, 'i18n', None)
                available_locales = getattr(i18n_settings, 'available_locales', ['en', 'ua']) if i18n_settings else ['en', 'ua']
                default_locale = getattr(i18n_settings, 'default_locale', 'en') if i18n_settings else 'en'
                current_lang_code = tg_user.language_code if tg_user.language_code and tg_user.language_code in available_locales else default_locale
                self._logger.trace(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω —è–∑—ã–∫ '{current_lang_code}' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {tg_user.id}.")

                if not db_user:
                    self._logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID: {tg_user.id} –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
                    db_user = DBUser(
                        telegram_id=tg_user.id, username=tg_user.username,
                        username_lower=tg_user.username.lower() if tg_user.username else None,
                        first_name=tg_user.first_name, last_name=tg_user.last_name,
                        preferred_language_code=current_lang_code,
                        is_active=True, is_bot_blocked=False,
                        last_activity_at=datetime.now(timezone.utc) 
                    )
                    session.add(db_user) 
                    user_was_created = True # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
                    data_actually_changed_in_db = True
                    self._logger.info(f"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID: {tg_user.id} –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∫ —Å–æ–∑–¥–∞–Ω–∏—é.")
                else:
                    self._logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID: {tg_user.id} (DB ID: {db_user.id}) –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...")
                    if await self._update_existing_user_data(db_user, tg_user, current_lang_code):
                        data_actually_changed_in_db = True
                    # last_activity_at –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ _update_existing_user_data, –∏ –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å,
                    # —Ç–æ data_actually_changed_in_db –º–æ–∂–µ—Ç –±—ã—Ç—å False, –Ω–æ —Å–µ—Å—Å–∏—è –≤—Å–µ —Ä–∞–≤–Ω–æ –±—É–¥–µ—Ç dirty.
                    if db_user not in session.dirty and db_user not in session.new :
                        session.add(db_user) # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–µ—Å—Å–∏—é –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ —Ç–∞–º
                    self._logger.info(f"–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è TG ID: {tg_user.id} –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è —Å–µ—Å—Å–∏–µ–π (–∏–∑–º–µ–Ω–µ–Ω–∏—è: {data_actually_changed_in_db}).")
                
                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏
                rbac_service: Optional["RBACService"] = getattr(self._services, 'rbac', None)
                if rbac_service:
                    if user_was_created: 
                        await session.flush([db_user]) # –ü–æ–ª—É—á–∞–µ–º ID
                        self._logger.info(f"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID: {tg_user.id} –ø–æ–ª—É—á–∏–ª DB ID: {db_user.id} –ø–æ—Å–ª–µ flush.")
                        if not is_owner:
                            if await rbac_service.assign_role_to_user(session, db_user, DEFAULT_ROLE_USER):
                                data_actually_changed_in_db = True
                    elif db_user: # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π
                        if is_owner: # –°–Ω–∏–º–∞–µ–º –≤—Å–µ —Ä–æ–ª–∏ —Å –≤–ª–∞–¥–µ–ª—å—Ü–∞
                            if db_user.roles:
                                roles_removed_from_owner = False
                                for role_in_db in list(db_user.roles): # –ö–æ–ø–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
                                    if await rbac_service.remove_role_from_user(session, db_user, role_in_db.name):
                                        roles_removed_from_owner = True
                                if roles_removed_from_owner: data_actually_changed_in_db = True
                        elif not db_user.roles: # –û–±—ã—á–Ω—ã–π —é–∑–µ—Ä –±–µ–∑ —Ä–æ–ª–µ–π - –¥–∞–µ–º User
                            if await rbac_service.assign_role_to_user(session, db_user, DEFAULT_ROLE_USER):
                                data_actually_changed_in_db = True
                
                # –ö–æ–º–º–∏—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–µ—Å—Å–∏—è "–≥—Ä—è–∑–Ω–∞—è"
                # (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ last_activity_at –¥–µ–ª–∞–µ—Ç —Å–µ—Å—Å–∏—é –≥—Ä—è–∑–Ω–æ–π)
                if data_actually_changed_in_db or (session.new or session.dirty or session.deleted): 
                    self._logger.info(f"UserService: –ü–ï–†–ï–î session.commit() –¥–ª—è TG ID {tg_user.id}. "
                                     f"Data changed: {data_actually_changed_in_db}, Dirty: {session.dirty}, New: {session.new}")
                    await session.commit()
                    self._logger.success(f"UserService: –ü–û–°–õ–ï session.commit() –¥–ª—è TG ID {tg_user.id}.")
                    if db_user: # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î
                        await session.refresh(db_user, attribute_names=['id', 'roles', 'direct_permissions', 'last_activity_at', 'is_active', 'is_bot_blocked'])
                        logger.debug(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {db_user.id} –æ–±–Ω–æ–≤–ª–µ–Ω –∏–∑ –ë–î –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞ –≤ UserService.")
                else:
                    self._logger.trace(f"–ù–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–µ—Å—Å–∏–∏ –¥–ª—è TG ID {tg_user.id} –≤ UserService. –ö–æ–º–º–∏—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
                
                return db_user, user_was_created

            except IntegrityError as ie: # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–Ω–∫–∏ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –º–µ–∂–¥—É SELECT –∏ INSERT)
                await session.rollback()
                self._logger.error(f"–û—à–∏–±–∫–∞ IntegrityError –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ TG ID {tg_user.id}. {ie.orig if hasattr(ie, 'orig') else ie}", exc_info=True)
                self._logger.info(f"–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è TG ID {tg_user.id} –ø–æ—Å–ª–µ IntegrityError.")
                db_user_retry = await self._get_user_by_telegram_id(tg_user.id, session, load_roles=True)
                if db_user_retry:
                    self._logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {tg_user.id} –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ.")
                    meaningful_data_updated_on_retry = await self._update_existing_user_data(db_user_retry, tg_user, current_lang_code)
                    
                    # –õ–æ–≥–∏–∫–∞ —Ä–æ–ª–µ–π –ø—Ä–∏ —Ä–µ—Ç—Ä–∞–µ (—É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü –±–µ–∑ —Ä–æ–ª–µ–π, –∞ —é–∑–µ—Ä —Å —Ä–æ–ª—å—é User)
                    if rbac_service:
                        if is_owner:
                            if db_user_retry.roles:
                                for role_retry in list(db_user_retry.roles): await rbac_service.remove_role_from_user(session, db_user_retry, role_retry.name)
                        elif not db_user_retry.roles: # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü –∏ —É –Ω–µ–≥–æ –Ω–µ—Ç —Ä–æ–ª–µ–π
                             await rbac_service.assign_role_to_user(session, db_user_retry, DEFAULT_ROLE_USER)
                    
                    if meaningful_data_updated_on_retry or (session.new or session.dirty or session.deleted):
                        self._logger.info(f"UserService (retry): –ü–ï–†–ï–î session.commit() –¥–ª—è TG ID {tg_user.id}.")
                        await session.commit()
                        self._logger.success(f"UserService (retry): –ü–û–°–õ–ï session.commit() –¥–ª—è TG ID {tg_user.id}.")
                        await session.refresh(db_user_retry, attribute_names=['id', 'roles', 'direct_permissions', 'last_activity_at', 'is_active', 'is_bot_blocked'])
                    return db_user_retry, False # False, —Ç.–∫. –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª –Ω–∞ –º–æ–º–µ–Ω—Ç —Ä–µ—Ç—Ä–∞—è
                self._logger.error(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å TG ID {tg_user.id} –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–∞–∂–µ –ø–æ—Å–ª–µ IntegrityError –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏.")
                return None, False
            except Exception as e: 
                self._logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ ({type(e).__name__}) –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ TG ID {tg_user.id} –≤ UserService: {e}", exc_info=True)
                if hasattr(session, 'is_active') and session.is_active: 
                    await session.rollback()
                return None, False
        
        self._logger.error(f"–í—ã—Ö–æ–¥ –∏–∑ process_user_on_start –¥–ª—è TG ID {tg_user.id} –±–µ–∑ —è–≤–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞.")
        return None, False
    
    async def update_user_language(self, user: DBUser, language_code: str, session: AsyncSession) -> bool:
        if user.preferred_language_code != language_code:
            user.preferred_language_code = language_code
            if user not in session.dirty and user not in session.new : session.add(user) 
            self._logger.info(f"–Ø–∑—ã–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id} (DB ID: {user.id}) –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ '{language_code}' (–¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–µ—Å—Å–∏—é).")
            return True
        return False

    async def set_user_active_status(self, user: DBUser, is_active: bool, session: AsyncSession) -> bool:
        if user.telegram_id in self._services.config.core.super_admins:
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞ ({user.telegram_id}). –î–µ–π—Å—Ç–≤–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
            return False 

        if user.is_active != is_active:
            user.is_active = is_active
            if user not in session.dirty and user not in session.new : session.add(user)
            self._logger.info(f"–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id} (DB ID: {user.id}) –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {is_active} (–¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–µ—Å—Å–∏—é).")
            return True
        return False

    async def set_user_bot_blocked_status(self, user: DBUser, is_bot_blocked: bool, session: AsyncSession) -> bool:
        if user.telegram_id in self._services.config.core.super_admins:
            self._logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞ ({user.telegram_id}). –î–µ–π—Å—Ç–≤–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
            return False 

        if user.is_bot_blocked != is_bot_blocked:
            user.is_bot_blocked = is_bot_blocked
            if user not in session.dirty and user not in session.new : session.add(user)
            self._logger.info(f"–°—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id} (DB ID: {user.id}) –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {is_bot_blocked} (–¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–µ—Å—Å–∏—é).")
            return True
        return False


======================================================================

------------------------------ FILE: core/cache/manager.py ------------------------------
# core/cache/manager.py

import asyncio
import time
import pickle
from typing import Optional, Any, Union, TYPE_CHECKING
from abc import ABC, abstractmethod

# –ò—Å–ø–æ–ª—å–∑—É–µ–º redis.asyncio –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Redis
try:
    import redis.asyncio as redis_async
    from redis.asyncio.client import Redis as AsyncRedisClient
    from redis.exceptions import RedisError, ConnectionError as RedisConnectionError, TimeoutError as RedisTimeoutError
    REDIS_PY_AVAILABLE = True
except ImportError:
    redis_async = None # type: ignore
    AsyncRedisClient = Any # type: ignore
    RedisError = Exception # type: ignore
    RedisConnectionError = Exception # type: ignore
    RedisTimeoutError = asyncio.TimeoutError # –§–æ–ª–ª–±—ç–∫ –Ω–∞ asyncio.TimeoutError
    REDIS_PY_AVAILABLE = False

try:
    from cachetools import TTLCache
except ImportError:
    TTLCache = None # type: ignore

from loguru import logger

if TYPE_CHECKING:
    from core.app_settings import CacheSettings

class BaseCache(ABC):
    @abstractmethod
    async def initialize(self) -> None: pass
    @abstractmethod
    async def dispose(self) -> None: pass
    @abstractmethod
    async def get(self, key: str) -> Optional[Any]: raise NotImplementedError
    @abstractmethod
    async def set(self, key: str, value: Any, ttl_seconds: Optional[int] = None) -> None: raise NotImplementedError
    @abstractmethod
    async def delete(self, key: str) -> bool: raise NotImplementedError
    @abstractmethod
    async def exists(self, key: str) -> bool: raise NotImplementedError
    @abstractmethod
    async def clear(self) -> None: raise NotImplementedError

class MemoryCache(BaseCache):
    def __init__(self, maxsize: int = 1024, default_ttl: int = 300):
        self._default_ttl = default_ttl
        if TTLCache:
            self._cache: Union[TTLCache, dict] = TTLCache(maxsize=maxsize, ttl=default_ttl)
            self._uses_cachetools = True
        else:
            logger.warning("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'cachetools' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è —Ä—É—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è MemoryCache —Å TTL.")
            self._cache = {} 
            self._maxsize = maxsize
            self._uses_cachetools = False
        logger.info(f"MemoryCache –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç cachetools: {self._uses_cachetools}, default TTL: {default_ttl}s).")

    async def initialize(self) -> None: logger.debug("MemoryCache.initialize() - –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")
    async def dispose(self) -> None: await self.clear(); logger.debug("MemoryCache.dispose() - –∫—ç—à –æ—á–∏—â–µ–Ω.")

    async def get(self, key: str) -> Optional[Any]:
        if self._uses_cachetools and isinstance(self._cache, TTLCache):
            try: return self._cache[key]
            except KeyError: return None
        elif isinstance(self._cache, dict):
            item = self._cache.get(key)
            if item:
                value, expiry_timestamp = item
                if time.time() < expiry_timestamp: return value
                else: 
                    # –Ø–≤–Ω–æ —É–¥–∞–ª—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –∫–ª—é—á
                    await self.delete(key) 
            return None
        return None

    async def set(self, key: str, value: Any, ttl_seconds: Optional[int] = None) -> None:
        effective_ttl = ttl_seconds if ttl_seconds is not None else self._default_ttl
        if self._uses_cachetools and isinstance(self._cache, TTLCache):
            if ttl_seconds is not None and ttl_seconds != self._cache.ttl: # type: ignore
                 # TTLCache –∏–º–µ–µ—Ç –æ–±—â–∏–π TTL, –Ω–æ –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –æ—á–µ–Ω—å –Ω—É–∂–Ω–æ.
                 # –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π TTL.
                 logger.trace(f"MemoryCache (TTLCache) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—â–∏–π TTL ({self._cache.ttl} —Å–µ–∫) –¥–ª—è –≤—Å–µ—Ö –∫–ª—é—á–µ–π.") # type: ignore
            self._cache[key] = value
        elif isinstance(self._cache, dict):
            if len(self._cache) >= self._maxsize and key not in self._cache:
                # –ü—Ä–æ—Å—Ç–∞—è LRU-–ø–æ–¥–æ–±–Ω–∞—è –ª–æ–≥–∏–∫–∞: —É–¥–∞–ª—è–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π (–ø–µ—Ä–≤—ã–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π)
                # –≠—Ç–æ –Ω–µ –Ω–∞—Å—Ç–æ—è—â–∏–π LRU, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–π–¥–µ—Ç.
                try:
                    oldest_key = next(iter(self._cache))
                    del self._cache[oldest_key]
                    logger.trace(f"MemoryCache –¥–æ—Å—Ç–∏–≥ maxsize, —É–¥–∞–ª–µ–Ω –∫–ª—é—á (FIFO-like): {oldest_key}")
                except StopIteration: pass # –ü—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å
            self._cache[key] = (value, time.time() + effective_ttl)

    async def delete(self, key: str) -> bool:
        if key in self._cache: 
            del self._cache[key]
            return True
        return False

    async def exists(self, key: str) -> bool: 
        # –î–ª—è TTLCache –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç TTL
        # –î–ª—è —Ä—É—á–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ get() —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç TTL
        return await self.get(key) is not None

    async def clear(self) -> None: 
        self._cache.clear()
        logger.info("MemoryCache –æ—á–∏—â–µ–Ω.")


class RedisCache(BaseCache):
    def __init__(self, redis_url: str):
        if not REDIS_PY_AVAILABLE:
            msg = "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'redis' (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π asyncio) –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. `pip install redis`. RedisCache –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å."
            logger.critical(msg)
            raise ImportError(msg)
        self.redis_url = redis_url
        self._redis_client: Optional[AsyncRedisClient] = None
        logger.info(f"RedisCache –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è URL: {self.redis_url} (–∏—Å–ø–æ–ª—å–∑—É—è redis.asyncio)")

    async def initialize(self) -> None:
        logger.debug(f"RedisCache: –ü–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è URL: {self.redis_url}")
        if not redis_async:
            logger.critical("RedisCache.initialize: redis.asyncio –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!")
            raise ImportError("redis.asyncio –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω")

        try:
            logger.debug(f"RedisCache: –í—ã–∑–æ–≤ redis.asyncio.from_url('{self.redis_url}')")
            self._redis_client = redis_async.from_url(
                self.redis_url, 
                decode_responses=False, # –í–∞–∂–Ω–æ –¥–ª—è pickle
                socket_timeout=5,
                socket_connect_timeout=5,
                # health_check_interval=30 # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
            )
            logger.debug(f"RedisCache: redis.asyncio.from_url –≤—ã–ø–æ–ª–Ω–µ–Ω. –ö–ª–∏–µ–Ω—Ç: {type(self._redis_client)}")
            
            if self._redis_client:
                logger.debug("RedisCache: –ü–æ–ø—ã—Ç–∫–∞ PING...")
                await self._redis_client.ping()
                logger.success(f"–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ PING –∫ Redis: {self.redis_url}")
            else:
                # –≠—Ç–∞ –≤–µ—Ç–∫–∞ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–∞, —Ç–∞–∫ –∫–∞–∫ from_url –æ–±—ã—á–Ω–æ –ª–∏–±–æ –ø–∞–¥–∞–µ—Ç, –ª–∏–±–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç
                logger.error(f"RedisCache: redis.asyncio.from_url –≤–µ—Ä–Ω—É–ª None –¥–ª—è {self.redis_url}")
                self._redis_client = None 
                raise RedisConnectionError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç Redis (from_url –≤–µ—Ä–Ω—É–ª None)")

        except (asyncio.TimeoutError, RedisTimeoutError) as te: 
            logger.error(f"RedisCache: –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏/–ø–∏–Ω–≥–µ –∫ Redis ({self.redis_url}): {te}", exc_info=False) # exc_info=False —Ç.–∫. —Ç–∞–π–º–∞—É—Ç - —ç—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–µ
            self._redis_client = None
            raise
        except RedisConnectionError as ce: 
            logger.error(f"RedisCache: –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è Redis ({self.redis_url}): {ce}", exc_info=True)
            self._redis_client = None
            raise
        except RedisError as re: 
            logger.error(f"RedisCache: –û–±—â–∞—è –æ—à–∏–±–∫–∞ Redis –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏/–ø–∏–Ω–≥–µ ({self.redis_url}): {re}", exc_info=True)
            self._redis_client = None
            raise
        except Exception as e: 
            logger.error(f"RedisCache: –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Redis ({self.redis_url}): {type(e).__name__} - {e}", exc_info=True)
            self._redis_client = None
            raise

    async def dispose(self) -> None:
        if self._redis_client:
            logger.info(f"RedisCache: –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Redis ({self.redis_url})...")
            try:
                await self._redis_client.close()
                # –î–ª—è redis-py 4.2+ –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∑–∞–∫—Ä—ã—Ç—å –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω –Ω–µ –æ–±—â–∏–π
                # –∏ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ (–æ–±—ã—á–Ω–æ close() –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
                if hasattr(self._redis_client, 'connection_pool') and hasattr(self._redis_client.connection_pool, 'disconnect'):
                     await self._redis_client.connection_pool.disconnect()
                logger.info(f"–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Redis ({self.redis_url}) —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ.")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Redis ({self.redis_url}): {e}", exc_info=True)
            finally:
                self._redis_client = None

    async def get(self, key: str) -> Optional[Any]:
        if not self._redis_client: return None
        try:
            pickled_value = await self._redis_client.get(key)
            if pickled_value: return pickle.loads(pickled_value)
            return None
        except RedisError as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ Redis –ø—Ä–∏ GET –¥–ª—è –∫–ª—é—á–∞ '{key}': {e}"); return None
        except pickle.UnpicklingError as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–ª—é—á–∞ '{key}': {e}"); return None
        except Exception as e_unexp: logger.error(f"RedisCache: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ GET –¥–ª—è –∫–ª—é—á–∞ '{key}': {e_unexp}"); return None


    async def set(self, key: str, value: Any, ttl_seconds: Optional[int] = None) -> None:
        if not self._redis_client: return
        try:
            pickled_value = pickle.dumps(value)
            await self._redis_client.set(key, pickled_value, ex=ttl_seconds)
        except pickle.PicklingError as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–ª—é—á–∞ '{key}': {e}")
        except RedisError as e_redis: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ Redis –ø—Ä–∏ SET –¥–ª—è –∫–ª—é—á–∞ '{key}': {e_redis}")
        except Exception as e_unexp: logger.error(f"RedisCache: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ SET –¥–ª—è –∫–ª—é—á–∞ '{key}': {e_unexp}")


    async def delete(self, key: str) -> bool:
        if not self._redis_client: return False
        try: 
            deleted_count = await self._redis_client.delete(key)
            return deleted_count > 0
        except RedisError as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ Redis –ø—Ä–∏ DELETE –¥–ª—è –∫–ª—é—á–∞ '{key}': {e}"); return False
        except Exception as e_unexp: logger.error(f"RedisCache: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ DELETE –¥–ª—è –∫–ª—é—á–∞ '{key}': {e_unexp}"); return False


    async def exists(self, key: str) -> bool:
        if not self._redis_client: return False
        try: 
            exists_count = await self._redis_client.exists(key)
            return exists_count > 0
        except RedisError as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ Redis –ø—Ä–∏ EXISTS –¥–ª—è –∫–ª—é—á–∞ '{key}': {e}"); return False
        except Exception as e_unexp: logger.error(f"RedisCache: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ EXISTS –¥–ª—è –∫–ª—é—á–∞ '{key}': {e_unexp}"); return False


    async def clear(self) -> None:
        if not self._redis_client: return
        try:
            logger.warning(f"RedisCache: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ FLUSHDB –¥–ª—è Redis ({self.redis_url})!")
            await self._redis_client.flushdb()
            logger.info(f"RedisCache: FLUSHDB –¥–ª—è Redis ({self.redis_url}) –≤—ã–ø–æ–ª–Ω–µ–Ω.")
        except RedisError as e: logger.error(f"RedisCache: –û—à–∏–±–∫–∞ Redis –ø—Ä–∏ FLUSHDB: {e}")
        except Exception as e_unexp: logger.error(f"RedisCache: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ FLUSHDB: {e_unexp}")


    def get_client_instance(self) -> Optional[AsyncRedisClient]:
        return self._redis_client


class CacheManager:
    def __init__(self, cache_settings: 'CacheSettings'):
        self._settings = cache_settings
        self._cache_backend: Optional[BaseCache] = None
        self._is_initialized_successfully = False
        logger.info(f"CacheManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –°–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–∏–ø –∫—ç—à–∞: {self._settings.type}")

    async def initialize(self) -> None:
        if self._is_initialized_successfully:
            logger.debug(f"CacheManager (–±—ç–∫–µ–Ω–¥: {self._settings.type}) —É–∂–µ –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
            return
        self._is_initialized_successfully = False # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –ø–æ–ø—ã—Ç–∫–æ–π

        if self._settings.type == "redis":
            if not self._settings.redis_url:
                logger.error("–¢–∏–ø –∫—ç—à–∞ 'redis', –Ω–æ redis_url –Ω–µ —É–∫–∞–∑–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö. –ö—ç—à –Ω–µ –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
                return
            if not REDIS_PY_AVAILABLE:
                logger.critical("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'redis' (–¥–ª—è asyncio) –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –Ω–æ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø –∫—ç—à–∞ 'redis'. –ö—ç—à –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
                return
            try:
                self._cache_backend = RedisCache(redis_url=str(self._settings.redis_url))
            except ImportError as e_imp_redis: 
                logger.critical(f"CacheManager: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å RedisCache (ImportError): {e_imp_redis}")
                return 
        elif self._settings.type == "memory":
            self._cache_backend = MemoryCache() 
        else:
            logger.warning(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∫—ç—à–∞: '{self._settings.type}'. –ö—ç—à –Ω–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω.")
            return

        if self._cache_backend:
            try:
                await self._cache_backend.initialize()
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Redis, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–ª—Å—è
                if isinstance(self._cache_backend, RedisCache) and self._cache_backend.get_client_instance() is None:
                    logger.error(f"CacheManager: RedisCache.initialize() –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –Ω–æ –∫–ª–∏–µ–Ω—Ç Redis –æ—Å—Ç–∞–ª—Å—è None. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å.")
                    self._cache_backend = None # –°–±—Ä–∞—Å—ã–≤–∞–µ–º, —á—Ç–æ–±—ã is_available() –≤–µ—Ä–Ω—É–ª False
                else:
                    self._is_initialized_successfully = True
                    logger.success(f"–ë—ç–∫–µ–Ω–¥ –∫—ç—à–∞ '{self._settings.type}' —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
            except Exception as e_init_backend: 
                logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±—ç–∫–µ–Ω–¥–∞ –∫—ç—à–∞ '{self._settings.type}': {type(e_init_backend).__name__} - {e_init_backend}", exc_info=False)
                self._cache_backend = None 
    
    async def dispose(self) -> None:
        if self._cache_backend: 
            try: await self._cache_backend.dispose()
            except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –∫—ç—à–∞ '{self._settings.type}': {e}", exc_info=True)
        self._is_initialized_successfully = False 
        self._cache_backend = None 
        logger.info(f"–†–µ—Å—É—Ä—Å—ã CacheManager –¥–ª—è –±—ç–∫–µ–Ω–¥–∞ '{self._settings.type}' –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã (–∏–ª–∏ –ø–æ–ø—ã—Ç–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è).")


    def is_available(self) -> bool:
        return self._cache_backend is not None and self._is_initialized_successfully

    async def get(self, key: str, default: Optional[Any] = None) -> Optional[Any]:
        if not self.is_available() or self._cache_backend is None:
            logger.trace(f"–ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. get('{key}') –≤–µ—Ä–Ω–µ—Ç default ({default}).")
            return default
        return await self._cache_backend.get(key)

    async def set(self, key: str, value: Any, ttl_seconds: Optional[int] = None) -> None:
        if not self.is_available() or self._cache_backend is None:
            logger.trace(f"–ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. set('{key}', ...) –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.")
            return
        await self._cache_backend.set(key, value, ttl_seconds=ttl_seconds)

    async def delete(self, key: str) -> bool:
        if not self.is_available() or self._cache_backend is None:
            logger.trace(f"–ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. delete('{key}') –≤–µ—Ä–Ω–µ—Ç False.")
            return False
        return await self._cache_backend.delete(key)

    async def exists(self, key: str) -> bool:
        if not self.is_available() or self._cache_backend is None:
            logger.trace(f"–ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. exists('{key}') –≤–µ—Ä–Ω–µ—Ç False.")
            return False
        return await self._cache_backend.exists(key)

    async def clear_all_cache(self) -> None:
        if not self.is_available() or self._cache_backend is None:
            logger.trace(f"–ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. clear_all_cache() –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.")
            return
        logger.warning(f"–ó–∞–ø—Ä–æ—à–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –¥–ª—è –±—ç–∫–µ–Ω–¥–∞ '{self._settings.type}'.")
        await self._cache_backend.clear()

    async def get_redis_client_instance(self) -> Optional[AsyncRedisClient]:
        if self.is_available() and isinstance(self._cache_backend, RedisCache):
            return self._cache_backend.get_client_instance()
        logger.debug("–ó–∞–ø—Ä–æ—à–µ–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä Redis –∫–ª–∏–µ–Ω—Ç–∞, –Ω–æ RedisCache –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–ª–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        return None


======================================================================

------------------------------ FILE: core/cache/__init__.py ------------------------------



======================================================================

------------------------------ FILE: core/database/manager.py ------------------------------
# core/database/manager.py

from pathlib import Path
from contextlib import asynccontextmanager
from typing import AsyncGenerator, List, Type, Optional, TYPE_CHECKING

from sqlalchemy.ext.asyncio import (
    AsyncSession,
    async_sessionmaker,
    create_async_engine,
    AsyncEngine
)
from sqlalchemy.pool import NullPool
from loguru import logger

from .base import Base
from core.app_settings import DEFAULT_PROJECT_DATA_DIR_NAME

if TYPE_CHECKING:
    from core.app_settings import DBSettings, AppSettings

class DBManager:
    def __init__(self, db_settings: 'DBSettings', app_settings: 'AppSettings'): # app_settings —Ç–µ–ø–µ—Ä—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
        self._db_settings: 'DBSettings' = db_settings
        self._app_settings: 'AppSettings' = app_settings
        self._engine: Optional[AsyncEngine] = None
        self._session_factory: Optional[async_sessionmaker[AsyncSession]] = None
        self._db_url: Optional[str] = None

        self._logger = logger.bind(service="DBManager")
        self._logger.info(f"DBManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ç–∏–ø–∞ –ë–î: {self._db_settings.type}")

    def _build_db_url(self) -> str:
        if self._db_url:
            return self._db_url

        db_type = self._db_settings.type
        url: str

        if db_type == "sqlite":
            sqlite_path_str = self._db_settings.sqlite_path
            path_obj = Path(sqlite_path_str)
            abs_path: Path

            if path_obj.is_absolute():
                abs_path = path_obj.resolve()
            else:
                # self._app_settings –∑–¥–µ—Å—å –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω, —Ç.–∫. –æ–Ω –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
                if DEFAULT_PROJECT_DATA_DIR_NAME in path_obj.parts:
                    project_root_dir = self._app_settings.core.project_data_path.parent
                    abs_path = (project_root_dir / path_obj).resolve()
                else: 
                    abs_path = (self._app_settings.core.project_data_path / path_obj).resolve()
            
            abs_path.parent.mkdir(parents=True, exist_ok=True)
            self._logger.debug(f"–û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –¥–ª—è SQLite: {abs_path}")
            url = f"sqlite+aiosqlite:///{abs_path}"
            
        elif db_type == "postgresql":
            if not self._db_settings.pg_dsn:
                msg = "DSN –¥–ª—è PostgreSQL (pg_dsn) –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."
                self._logger.error(msg)
                raise ValueError(msg)
            url = str(self._db_settings.pg_dsn)
            
        elif db_type == "mysql":
            if not self._db_settings.mysql_dsn:
                msg = "DSN –¥–ª—è MySQL (mysql_dsn) –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."
                self._logger.error(msg)
                raise ValueError(msg)
            url = str(self._db_settings.mysql_dsn)
            
        else:
            msg = f"–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö: '{db_type}'"
            self._logger.error(msg)
            raise ValueError(msg)
        
        self._db_url = url
        return url

    async def initialize(self) -> None:
        if self._engine is not None:
            self._logger.debug("DBManager (engine) —É–∂–µ –±—ã–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
            return

        db_url = self._build_db_url()
        self._logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞ SQLAlchemy –¥–ª—è URL: '{db_url[:db_url.find('://')+3]}...' (–¥–µ—Ç–∞–ª–∏ URL —Å–∫—Ä—ã—Ç—ã)")
        
        echo_sql = self._db_settings.echo_sql

        try:
            self._engine = create_async_engine(
                db_url,
                echo=echo_sql, 
                poolclass=NullPool,
            )
            
            self._session_factory = async_sessionmaker(
                bind=self._engine,
                class_=AsyncSession,
                expire_on_commit=False,
                autoflush=False,
                autocommit=False,
            )
            self._logger.success("SQLAlchemy AsyncEngine –∏ SessionFactory —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã.")
        except Exception as e:
            self._logger.critical(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ SQLAlchemy Engine –∏–ª–∏ SessionFactory –¥–ª—è URL '{db_url}': {e}", exc_info=True)
            self._engine = None
            self._session_factory = None
            raise

    async def dispose(self) -> None:
        if self._engine:
            self._logger.info("–ó–∞–∫—Ä—ã—Ç–∏–µ SQLAlchemy AsyncEngine...")
            try:
                await self._engine.dispose()
                self._logger.success("SQLAlchemy AsyncEngine —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç.")
            except Exception as e:
                self._logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ SQLAlchemy AsyncEngine: {e}", exc_info=True)
            finally:
                self._engine = None
                self._session_factory = None
        else:
            self._logger.debug("DBManager (engine) –Ω–µ –±—ã–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ —É–∂–µ –∑–∞–∫—Ä—ã—Ç.")

    @asynccontextmanager
    async def get_session(self) -> AsyncGenerator[AsyncSession, None]:
        if not self._session_factory:
            msg = "DBManager SessionFactory –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞! –í—ã–∑–æ–≤–∏—Ç–µ initialize() –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º —Å–µ—Å—Å–∏–∏."
            self._logger.critical(msg)
            raise RuntimeError(msg)

        session: AsyncSession = self._session_factory()
        self._logger.trace(f"–°–µ—Å—Å–∏—è –ë–î {id(session)} –æ—Ç–∫—Ä—ã—Ç–∞.")
        try:
            yield session
        except Exception as e:
            self._logger.error(f"–û—à–∏–±–∫–∞ –≤ —Å–µ—Å—Å–∏–∏ –ë–î {id(session)}: {e}. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–∫–∞—Ç (rollback).", exc_info=True)
            await session.rollback()
            raise
        finally:
            await session.close()
            self._logger.trace(f"–°–µ—Å—Å–∏—è –ë–î {id(session)} –∑–∞–∫—Ä—ã—Ç–∞.")

    async def create_all_core_tables(self) -> None:
        if not self._engine:
            err_msg = "DBManager Engine –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã."
            self._logger.error(err_msg)
            raise RuntimeError(err_msg)

        self._logger.info("–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü —è–¥—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ Base.metadata...")
        async with self._engine.begin() as conn:
            from core.database import core_models # noqa: F401
            await conn.run_sync(Base.metadata.create_all)
        self._logger.success("–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —è–¥—Ä–∞ (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ Base.metadata) —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã (–∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏).")

    async def create_specific_module_tables(self, module_model_classes: List[Type[Base]]) -> None:
        if not self._engine:
            err_msg = "DBManager Engine –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è."
            self._logger.error(err_msg)
            raise RuntimeError(err_msg)
        if not module_model_classes:
            self._logger.debug("–ù–µ—Ç –º–æ–¥–µ–ª–µ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è (—Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç).")
            return

        tables_to_create = [model_cls.__table__ for model_cls in module_model_classes]
        table_names_str = ", ".join([table.name for table in tables_to_create])
        self._logger.info(f"–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –¥–ª—è –º–æ–¥—É–ª—è: [{table_names_str}]")

        async with self._engine.begin() as conn:
            await conn.run_sync(Base.metadata.create_all, tables=tables_to_create)
        self._logger.success(f"–¢–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è [{table_names_str}] —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã (–∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏).")

    async def drop_specific_module_tables(self, module_model_classes: List[Type[Base]]) -> None:
        if not self._engine:
            err_msg = "DBManager Engine –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è."
            self._logger.error(err_msg)
            raise RuntimeError(err_msg)
        if not module_model_classes:
            self._logger.debug("–ù–µ—Ç –º–æ–¥–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è (—Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç).")
            return

        tables_to_drop = [model_cls.__table__ for model_cls in module_model_classes]
        tables_to_drop_ordered = tables_to_drop[::-1] 
        table_names_str = ", ".join([table.name for table in tables_to_drop_ordered])
        
        self._logger.warning(f"–ó–ê–ü–†–û–° –ù–ê –£–î–ê–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶ –ú–û–î–£–õ–Ø (–û–ü–ê–°–ù–û!): [{table_names_str}]")
        
        async with self._engine.begin() as conn:
            await conn.run_sync(Base.metadata.drop_all, tables=tables_to_drop_ordered)
        self._logger.success(f"–¢–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è [{table_names_str}] —É—Å–ø–µ—à–Ω–æ –£–î–ê–õ–ï–ù–´.")


======================================================================

------------------------------ FILE: core/database/db_utils.py ------------------------------
"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö.
"""
from typing import Optional, Dict, Any
from sqlalchemy import create_engine, text
from sqlalchemy.engine import Engine


class DatabaseDialectHandler:
    """–ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ —Ä–∞–∑–Ω—ã—Ö –¥–∏–∞–ª–µ–∫—Ç–æ–≤ –ë–î"""
    
    @staticmethod
    def get_dialect_features(engine: Engine) -> Dict[str, bool]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–∏–∞–ª–µ–∫—Ç–∞ –ë–î"""
        dialect_name = engine.dialect.name.lower()
        
        features = {
            'supports_comments': True,
            'supports_check_constraints': True,
            'supports_deferrable_fks': True,
            'supports_sequences': True,
            'supports_returning': True,
            'case_sensitive': True,
        }
        
        if dialect_name == 'sqlite':
            features.update({
                'supports_comments': False,
                'supports_deferrable_fks': False,
                'supports_sequences': False,
                'supports_returning': False,  # –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ SQLite
                'case_sensitive': False,
            })
        elif dialect_name in ['mysql', 'mariadb']:
            features.update({
                'supports_comments': True,
                'supports_check_constraints': True,  # MySQL 8.0+
                'supports_deferrable_fks': False,
                'supports_sequences': False,  # –î–æ MySQL 8.0
                'supports_returning': False,
                'case_sensitive': False,  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
            })
        elif dialect_name == 'postgresql':
            features.update({
                'supports_comments': True,
                'supports_check_constraints': True,
                'supports_deferrable_fks': True,
                'supports_sequences': True,
                'supports_returning': True,
                'case_sensitive': True,
            })
        
        return features
    
    @staticmethod
    def get_recommended_types(engine: Engine) -> Dict[str, str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∏–∞–ª–µ–∫—Ç–∞"""
        dialect_name = engine.dialect.name.lower()
        
        if dialect_name == 'sqlite':
            return {
                'id': 'INTEGER',
                'bigint': 'INTEGER',
                'string_short': 'TEXT',
                'string_long': 'TEXT',
                'text': 'TEXT',
                'boolean': 'INTEGER',
                'datetime': 'DATETIME',
                'json': 'TEXT',
            }
        elif dialect_name in ['mysql', 'mariadb']:
            return {
                'id': 'INT AUTO_INCREMENT',
                'bigint': 'BIGINT',
                'string_short': 'VARCHAR(255)',
                'string_long': 'TEXT',
                'text': 'TEXT',
                'boolean': 'TINYINT(1)',
                'datetime': 'DATETIME',
                'json': 'JSON',  # MySQL 5.7+
            }
        elif dialect_name == 'postgresql':
            return {
                'id': 'SERIAL',
                'bigint': 'BIGINT',
                'string_short': 'VARCHAR(255)',
                'string_long': 'TEXT',
                'text': 'TEXT',
                'boolean': 'BOOLEAN',
                'datetime': 'TIMESTAMP WITH TIME ZONE',
                'json': 'JSONB',
            }
        
        return {}
    
    @staticmethod
    def create_db_if_not_exists(connection_url: str, db_name: str) -> bool:
        """–°–æ–∑–¥–∞–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–¥–ª—è MySQL/PostgreSQL)"""
        try:
            if 'mysql' in connection_url or 'mariadb' in connection_url:
                # –î–ª—è MySQL
                base_url = connection_url.rsplit('/', 1)[0]
                engine = create_engine(base_url + '/mysql')
                with engine.connect() as conn:
                    conn.execute(text(f"CREATE DATABASE IF NOT EXISTS `{db_name}` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci"))
                    conn.commit()
                return True
                
            elif 'postgresql' in connection_url:
                # –î–ª—è PostgreSQL
                base_url = connection_url.rsplit('/', 1)[0]
                engine = create_engine(base_url + '/postgres')
                with engine.connect() as conn:
                    # PostgreSQL —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç –¥–ª—è CREATE DATABASE
                    conn.execute(text("COMMIT"))
                    result = conn.execute(text(f"SELECT 1 FROM pg_database WHERE datname = '{db_name}'"))
                    if not result.fetchone():
                        conn.execute(text(f'CREATE DATABASE "{db_name}" WITH ENCODING "UTF8"'))
                return True
                
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ë–î {db_name}: {e}")
            return False
        
        return True  # SQLite —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏


def get_db_info_query(dialect_name: str) -> Optional[str]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ë–î"""
    if dialect_name == 'sqlite':
        return "SELECT sqlite_version() as version"
    elif dialect_name in ['mysql', 'mariadb']:
        return "SELECT VERSION() as version"
    elif dialect_name == 'postgresql':
        return "SELECT version() as version"
    return None


def optimize_for_dialect(engine: Engine) -> Dict[str, Any]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –¥–∏–∞–ª–µ–∫—Ç–∞ –ë–î"""
    dialect_name = engine.dialect.name.lower()
    
    settings = {}
    
    if dialect_name == 'sqlite':
        settings = {
            'pool_pre_ping': False,
            'pool_recycle': -1,
            'echo': False,
            'connect_args': {
                'check_same_thread': False,
                'timeout': 30,
            }
        }
    elif dialect_name in ['mysql', 'mariadb']:
        settings = {
            'pool_pre_ping': True,
            'pool_recycle': 3600,
            'pool_size': 10,
            'max_overflow': 20,
            'connect_args': {
                'charset': 'utf8mb4',
                'connect_timeout': 60,
            }
        }
    elif dialect_name == 'postgresql':
        settings = {
            'pool_pre_ping': True,
            'pool_recycle': 3600,
            'pool_size': 10,
            'max_overflow': 20,
            'connect_args': {
                'connect_timeout': 60,
                'application_name': 'SwiftDevBot',
            }
        }
    
    return settings


======================================================================

------------------------------ FILE: core/database/core_models.py ------------------------------
# core/database/core_models.py
from datetime import datetime
from typing import List, Optional, TYPE_CHECKING
from sqlalchemy import String, ForeignKey, UniqueConstraint, Text, BigInteger
from sqlalchemy.orm import Mapped, mapped_column, relationship

from .base import SDBBaseModel 

SDB_CORE_TABLE_PREFIX = "sdb_"

if TYPE_CHECKING:
    pass 

def get_column_comment(text: str) -> Optional[str]:
    return text

class Permission(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}permissions"
    
    name: Mapped[str] = mapped_column(
        String(100), 
        unique=True, 
        index=True, 
        nullable=False, 
        comment=get_column_comment("–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'view_users', 'manage_modules')")
    )
    description: Mapped[Optional[str]] = mapped_column(
        Text, 
        nullable=True, 
        comment=get_column_comment("–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è")
    )
    
    roles: Mapped[List["Role"]] = relationship(
        "Role",
        secondary=f"{SDB_CORE_TABLE_PREFIX}role_permissions",
        back_populates="permissions",
        lazy="selectin" 
    )
    
    # –ù–æ–≤–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–ª—è –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    users_with_direct_access: Mapped[List["User"]] = relationship(
        "User",
        secondary=f"{SDB_CORE_TABLE_PREFIX}user_permissions", # –ò–º—è –Ω–æ–≤–æ–π —Å–≤—è–∑—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã
        back_populates="direct_permissions",
        lazy="selectin" # –∏–ª–∏ "noload", –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ —á–∞—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—é
    )

    def __repr__(self) -> str:
        return f"<Permission(id={self.id}, name='{self.name}')>"

class RolePermission(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}role_permissions"
    __table_args__ = (
        UniqueConstraint('role_id', 'permission_id', name=f'uq_{SDB_CORE_TABLE_PREFIX}role_permissions_role_id_permission_id'),
    )
    
    role_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}roles.id", ondelete="CASCADE"), 
        nullable=False, 
        index=True,
        comment=get_column_comment("ID —Ä–æ–ª–∏")
    )
    permission_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}permissions.id", ondelete="CASCADE"), 
        nullable=False, 
        index=True,
        comment=get_column_comment("ID —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è")
    )

    def __repr__(self) -> str:
        return f"<RolePermission(id={self.id}, role_id={self.role_id}, permission_id={self.permission_id})>"
        
class Role(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}roles"
    
    name: Mapped[str] = mapped_column(
        String(50), 
        unique=True, 
        index=True, 
        nullable=False, 
        comment=get_column_comment("–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ä–æ–ª–∏")
    )
    description: Mapped[Optional[str]] = mapped_column(
        Text, 
        nullable=True, 
        comment=get_column_comment("–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏")
    )
    
    users: Mapped[List["User"]] = relationship(
        "User", 
        secondary=f"{SDB_CORE_TABLE_PREFIX}user_roles",
        back_populates="roles",
        lazy="selectin",
        cascade="save-update, merge" 
    )

    permissions: Mapped[List["Permission"]] = relationship(
        "Permission",
        secondary=f"{SDB_CORE_TABLE_PREFIX}role_permissions",
        back_populates="roles",
        lazy="selectin", 
        cascade="save-update, merge"
    )

    def __repr__(self) -> str:
        return f"<Role(id={self.id}, name='{self.name}')>"


class UserRole(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}user_roles"
    __table_args__ = (
        UniqueConstraint('user_id', 'role_id', name=f'uq_{SDB_CORE_TABLE_PREFIX}user_roles_user_id_role_id'),
    )
    
    user_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}users.id", ondelete="CASCADE"), 
        nullable=False, 
        index=True,
        comment=get_column_comment("ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    )
    role_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}roles.id", ondelete="CASCADE"), 
        nullable=False, 
        index=True,
        comment=get_column_comment("ID —Ä–æ–ª–∏")
    )

    def __repr__(self) -> str:
        return f"<UserRole(id={self.id}, user_id={self.user_id}, role_id={self.role_id})>"

# --- –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Å–≤—è–∑–∏ User <-> Permission ---
class UserPermission(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}user_permissions"
    __table_args__ = (
        UniqueConstraint('user_id', 'permission_id', name=f'uq_{SDB_CORE_TABLE_PREFIX}user_permissions_user_id_permission_id'),
    )

    user_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}users.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
        comment=get_column_comment("ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    )
    permission_id: Mapped[int] = mapped_column(
        ForeignKey(f"{SDB_CORE_TABLE_PREFIX}permissions.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
        comment=get_column_comment("ID —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è")
    )

    def __repr__(self) -> str:
        return f"<UserPermission(id={self.id}, user_id={self.user_id}, permission_id={self.permission_id})>"


class User(SDBBaseModel):
    __tablename__ = f"{SDB_CORE_TABLE_PREFIX}users"

    username_lower: Mapped[Optional[str]] = mapped_column(
        String(32), 
        nullable=True, 
        index=True, 
        comment=get_column_comment("Telegram username –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ –¥–ª—è –ø–æ–∏—Å–∫–∞")
    )
    
    telegram_id: Mapped[int] = mapped_column(
        BigInteger, 
        unique=True, 
        index=True, 
        nullable=False, 
        comment=get_column_comment("–£–Ω–∏–∫–∞–ª—å–Ω—ã–π Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    )
    username: Mapped[Optional[str]] = mapped_column( 
        String(32), 
        nullable=True, 
        index=True, 
        comment=get_column_comment("Telegram username (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä)")
    )
    first_name: Mapped[Optional[str]] = mapped_column(
        String(255), 
        nullable=True, 
        comment=get_column_comment("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    )
    last_name: Mapped[Optional[str]] = mapped_column(
        String(255), 
        nullable=True, 
        comment=get_column_comment("–§–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    )
    preferred_language_code: Mapped[Optional[str]] = mapped_column(
        String(10), 
        nullable=True, 
        comment=get_column_comment("–ö–æ–¥ —è–∑—ã–∫–∞ –±–æ—Ç–∞")
    )
    is_active: Mapped[bool] = mapped_column(
        default=True, 
        nullable=False, 
        comment=get_column_comment("–ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
    )
    is_bot_blocked: Mapped[bool] = mapped_column(
        default=False, 
        nullable=False, 
        comment=get_column_comment("–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–æ—Ç–∞")
    )
    last_activity_at: Mapped[Optional[datetime]] = mapped_column(
        nullable=True, 
        comment=get_column_comment("–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏")
    )

    roles: Mapped[List["Role"]] = relationship(
        "Role", 
        secondary=f"{SDB_CORE_TABLE_PREFIX}user_roles",
        back_populates="users",
        lazy="selectin",
        cascade="save-update, merge"
    )
    
    # –ù–æ–≤–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–ª—è –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
    direct_permissions: Mapped[List["Permission"]] = relationship(
        "Permission",
        secondary=f"{SDB_CORE_TABLE_PREFIX}user_permissions", # –ò–º—è –Ω–æ–≤–æ–π —Å–≤—è–∑—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã
        back_populates="users_with_direct_access",
        lazy="selectin", # –∏–ª–∏ "noload", –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ —á–∞—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø—Ä–∞–≤–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —é–∑–µ—Ä–∞
        cascade="save-update, merge" # –ü–æ–∑–≤–æ–ª–∏—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ user.direct_permissions.append()
    )
    
    @property
    def full_name(self) -> str:
        parts = []
        if self.first_name: parts.append(self.first_name)
        if self.last_name: parts.append(self.last_name)
        if parts: return " ".join(parts)
        elif self.username: return f"@{self.username}"
        return f"User_{self.telegram_id}"

    def __repr__(self) -> str:
        return f"<User(id={self.id}, tg_id={self.telegram_id}, name='{self.full_name}')>"


======================================================================

------------------------------ FILE: core/database/__init__.py ------------------------------



======================================================================

------------------------------ FILE: core/database/base.py ------------------------------
# core/database/base.py
from typing import Any, Dict
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column
from sqlalchemy import func, MetaData
from datetime import datetime, timezone 

convention = {
    "ix": "ix_%(column_0_label)s",
    "uq": "uq_%(table_name)s_%(column_0_name)s",
    "ck": "ck_%(table_name)s_%(constraint_name)s",
    "fk": "fk_%(table_name)s_%(column_0_name)s_%(referred_table_name)s",
    "pk": "pk_%(table_name)s"
}
metadata_obj = MetaData(naming_convention=convention)

class Base(DeclarativeBase):
    metadata = metadata_obj

class SDBBaseModel(Base):
    __abstract__ = True
    id: Mapped[int] = mapped_column(primary_key=True, index=True, autoincrement=True)
    created_at: Mapped[datetime] = mapped_column(
        default=lambda: datetime.now(timezone.utc),
        server_default=func.now()
    )
    updated_at: Mapped[datetime] = mapped_column(
        default=lambda: datetime.now(timezone.utc),
        onupdate=lambda: datetime.now(timezone.utc),
        server_default=func.now(),
        server_onupdate=func.now() 
    )
    def to_dict(self, exclude: set = None) -> Dict[str, Any]:
        if exclude is None: exclude = set()
        data = {}
        for prop in self.__mapper__.iterate_properties:
            if hasattr(prop, 'columns') and prop.key not in exclude:
                try: data[prop.key] = getattr(self, prop.key)
                except AttributeError: pass
        return data
    def __repr__(self) -> str:
        pk_column_names = [pk_col.name for pk_col in self.__table__.primary_key.columns]
        pk_values_str = ", ".join(f"{name}={getattr(self, name)!r}" for name in pk_column_names)
        return f"<{self.__class__.__name__}({pk_values_str})>"


======================================================================

------------------------------ FILE: core/admin/filters_admin.py ------------------------------
# core/admin/filters_admin.py

from aiogram import types
from loguru import logger

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
from core.rbac.service import PERMISSION_CORE_VIEW_ADMIN_PANEL 

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider

MODULE_NAME_FOR_LOG = "AdminFilters"

async def can_view_admin_panel_filter(event: types.TelegramObject, services_provider: 'BotServicesProvider') -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–º–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ—Å—Ç—É–ø –∫ –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–∞–∑–¥–µ–ª–∞–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.
    –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω, –µ—Å–ª–∏:
    1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ super_admins –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
    2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ PERMISSION_CORE_VIEW_ADMIN_PANEL.
    """
    user = getattr(event, 'from_user', None) 
    if not user: 
        logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–±—ã—Ç–∏–µ –±–µ–∑ 'from_user', –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –∏–ª–∏ –∑–∞–ø—Ä–µ—â–µ–Ω.")
        return False

    user_id = user.id
    user_mention = f"@{user.username}" if user.username else f"ID:{user.id}"

    if user_id in services_provider.config.core.super_admins:
        logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (super_admin –∏–∑ config).")
        return True
    try:
        async with services_provider.db.get_session() as session:
            has_permission = await services_provider.rbac.user_has_permission(
                session, user_id, PERMISSION_CORE_VIEW_ADMIN_PANEL
            )
            if has_permission:
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} –∏–º–µ–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{PERMISSION_CORE_VIEW_ADMIN_PANEL}' (–¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω).")
                return True
    except Exception as e:
        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{PERMISSION_CORE_VIEW_ADMIN_PANEL}' –¥–ª—è {user_mention} –≤ –ë–î: {e}", exc_info=True)
        return False 
    
    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_mention} "
                   f"–ø–æ–ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è '{PERMISSION_CORE_VIEW_ADMIN_PANEL}'.")
    return False



======================================================================

------------------------------ FILE: core/admin/handlers_log_viewer.py ------------------------------
# core/admin/handlers_log_viewer.py
import logging
from aiogram import Router, types
from aiogram.filters import Command

router = Router()

@router.message(Command("some_command")) 
async def some_handler(message: types.Message):
    await message.answer("You triggered some_command!")


======================================================================

------------------------------ FILE: core/admin/keyboards_admin_common.py ------------------------------
# core/admin/keyboards_admin_common.py
from aiogram import types 
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder 
from core.ui.callback_data_factories import CoreMenuNavigate, AdminMainMenuNavigate

from typing import TYPE_CHECKING 
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession
    from core.rbac.service import (
        PERMISSION_CORE_USERS_VIEW_LIST,
        PERMISSION_CORE_MODULES_VIEW_LIST,
        PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC,
        PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL,
        PERMISSION_CORE_ROLES_VIEW
    )

ADMIN_COMMON_TEXTS = {
    "back_to_main_menu_sdb": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é SDB",
    "back_to_admin_menu_main": "‚¨ÖÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–ì–ª–∞–≤–Ω–∞—è)",
    "pagination_prev": "‚¨ÖÔ∏è –ü—Ä–µ–¥.",
    "pagination_next": "–°–ª–µ–¥. ‚û°Ô∏è",
    "confirm_yes": "‚úÖ –î–∞",
    "confirm_no": "‚ùå –ù–µ—Ç",
    "close_message": "‚ùå –ó–∞–∫—Ä—ã—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ",
    "error_general": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
    "access_denied": "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.",
    "not_found_generic": "–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.",
    
    # –¢–µ–∫—Å—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –∞–¥–º–∏–Ω–∫–∏
    "manage_users": "üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏",
    "manage_roles": "üõ°Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏",
    "manage_modules": "üß© –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏",
    "system_info": "‚öôÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ",

    # –¢–µ–∫—Å—Ç—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –≥—Ä—É–ø–ø —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (–¥–æ–±–∞–≤–ª–µ–Ω—ã)
    "perm_category_core": "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ø–¥—Ä–∞",
    "perm_category_modules": "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –ú–æ–¥—É–ª–µ–π",
    "perm_core_group_users": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–Ø–¥—Ä–æ)",
    "perm_core_group_roles": "–†–æ–ª–∏ (–Ø–¥—Ä–æ)",
    "perm_core_group_modules_core": "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ (–Ø–¥—Ä–æ)", # –ò–∑–º–µ–Ω–µ–Ω–æ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
    "perm_core_group_system": "–°–∏—Å—Ç–µ–º–∞ (–Ø–¥—Ä–æ)",
    "perm_core_group_settings_core": "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ø–¥—Ä–∞",
    "perm_core_group_other": "–ü—Ä–æ—á–∏–µ (–Ø–¥—Ä–æ)",
    "back_to_perm_categories": "‚¨ÖÔ∏è –ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π",
    "back_to_core_perm_groups": "‚¨ÖÔ∏è –ö –≥—Ä—É–ø–ø–∞–º –Ø–¥—Ä–∞",
    "back_to_module_list_for_perms": "‚¨ÖÔ∏è –ö —Å–ø–∏—Å–∫—É –º–æ–¥—É–ª–µ–π (–¥–ª—è –ø—Ä–∞–≤)",
    "no_modules_with_perms": "–ù–µ—Ç –º–æ–¥—É–ª–µ–π —Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏ –ø—Ä–∞–≤",
    "no_permissions_in_group": "–í —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π",

    # –¢–µ–∫—Å—Ç—ã –¥–ª—è FSM (–¥–æ–±–∞–≤–ª–µ–Ω—ã)
    "fsm_enter_role_name": "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–π —Ä–æ–ª–∏:",
    "fsm_role_name_empty": "–ò–º—è —Ä–æ–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.",
    "fsm_role_name_taken": "–†–æ–ª—å —Å –∏–º–µ–Ω–µ–º \"{role_name}\" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.",
    "fsm_enter_role_description": "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name}:",
    "fsm_command_skip_description": "/skip_description - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å",
    "fsm_command_cancel_role_creation": "/cancel_role_creation - –û—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ",
    "fsm_role_created_successfully": "–†–æ–ª—å \"{role_name}\" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!",
    "fsm_role_creation_cancelled": "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
    
    "fsm_edit_role_title": "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏: {role_name}",
    "fsm_edit_role_name_not_allowed": "–ò–º—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ä–æ–ª–∏ {role_name} –∏–∑–º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è.",
    "fsm_enter_new_role_description": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name} (—Ç–µ–∫—É—â–µ–µ: {current_description}):",
    "fsm_enter_new_role_name": "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è —Ä–æ–ª–∏ (—Ç–µ–∫—É—â–µ–µ: {current_name}):",
    "fsm_command_skip_name": "/skip_name - –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å",
    "fsm_command_cancel_role_edit": "/cancel_role_edit - –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
    "fsm_role_updated_successfully": "–†–æ–ª—å \"{role_name}\" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!",
    "fsm_role_update_cancelled": "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.",

    "delete_role_confirm_text": "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å {role_name}?\n{warning_if_users}\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!",
    "role_is_standard_cant_delete": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ä–æ–ª—å \"{role_name}\" —É–¥–∞–ª—è—Ç—å –Ω–µ–ª—å–∑—è.",
    "role_delete_failed": "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å \"{role_name}\".",
    "role_deleted_successfully": "–†–æ–ª—å \"{role_name}\" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.",
}

def get_back_to_admin_main_menu_button() -> InlineKeyboardButton:
    return InlineKeyboardButton(
        text=ADMIN_COMMON_TEXTS["back_to_admin_menu_main"],
        callback_data=AdminMainMenuNavigate(target_section="main_admin").pack()
    )

def get_back_to_sdb_main_menu_button() -> InlineKeyboardButton:
    return InlineKeyboardButton(
        text=ADMIN_COMMON_TEXTS["back_to_main_menu_sdb"],
        callback_data=CoreMenuNavigate(target_menu="main").pack()
    )

async def get_admin_main_menu_keyboard( 
    services: 'BotServicesProvider',
    user_tg_id: int,
    session: 'AsyncSession' 
) -> types.InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = ADMIN_COMMON_TEXTS 

    rbac = services.rbac
    user_is_owner_from_config = user_tg_id in services.config.core.super_admins

    from core.rbac.service import (
        PERMISSION_CORE_USERS_VIEW_LIST,
        PERMISSION_CORE_MODULES_VIEW_LIST,
        PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC,
        PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL,
        PERMISSION_CORE_ROLES_VIEW
    )
    
    if user_is_owner_from_config or \
       await rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC) or \
       await rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL):
        builder.button(
            text=texts["system_info"],
            callback_data=AdminMainMenuNavigate(target_section="sys_info").pack() 
        )

    if user_is_owner_from_config or \
       await rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_USERS_VIEW_LIST):
        builder.button(
            text=texts["manage_users"],
            callback_data=AdminMainMenuNavigate(target_section="users").pack() 
        )
    
    if user_is_owner_from_config or \
       await rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_ROLES_VIEW): 
        builder.button(
            text=texts["manage_roles"],
            callback_data=AdminMainMenuNavigate(target_section="roles").pack() 
        )

    if user_is_owner_from_config or \
       await rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_MODULES_VIEW_LIST):
        builder.button(
            text=texts["manage_modules"],
            callback_data=AdminMainMenuNavigate(target_section="modules").pack() 
        )
    
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    # from core.rbac.service import PERMISSION_CORE_SYSTEM_VIEW_LOGS_BASIC
    # if user_is_owner_from_config or \
    #    await rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_SYSTEM_VIEW_LOGS_BASIC):
    #     builder.button(
    #         text="–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤", # –î–æ–±–∞–≤–∏—Ç—å –≤ ADMIN_COMMON_TEXTS
    #         callback_data=AdminMainMenuNavigate(target_section="logs_view").pack()
    #     )
    
    if builder.export(): 
        builder.adjust(1)

    builder.row(get_back_to_sdb_main_menu_button()) 
    return builder.as_markup()


======================================================================

------------------------------ FILE: core/admin/handlers_module_management.py ------------------------------
# core/admin/handlers_module_management.py
import logging
from aiogram import Router, types
from aiogram.filters import Command

router = Router()

@router.message(Command("some_command")) 
async def some_handler(message: types.Message):
    await message.answer("You triggered some_command!")


======================================================================

------------------------------ FILE: core/admin/__init__.py ------------------------------
# core/admin/__init__.py
from aiogram import Router
from loguru import logger

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º "—Å–æ–±–∏—Ä–∞—é—â–∏–µ" —Ä–æ—É—Ç–µ—Ä—ã –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
try:
    from .entry import section_entry_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'entry' (section router) loaded.")
except ImportError as e:
    section_entry_router = Router(name="sdb_admin_entry_stub_main") 
    logger.error(f"Failed to load admin submodule 'entry' (section router): {e}")

try:
    from .users import section_users_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'users' (section router) loaded.")
except ImportError as e:
    section_users_router = Router(name="sdb_admin_users_stub_main")
    logger.error(f"Failed to load admin submodule 'users' (section router): {e}")

try:
    from .roles import section_roles_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'roles' (section router) loaded.")
except ImportError as e:
    section_roles_router = Router(name="sdb_admin_roles_stub_main")
    logger.error(f"Failed to load admin submodule 'roles' (section router): {e}")

try:
    from .sys_info import section_sys_info_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'sys_info' (section router) loaded.")
except ImportError as e:
    section_sys_info_router = Router(name="sdb_admin_sys_info_stub_main")
    logger.error(f"Failed to load admin submodule 'sys_info' (section router): {e}")

try:
    from .modules_mgmt import section_modules_mgmt_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'modules_mgmt' (section router) loaded.")
except ImportError as e:
    section_modules_mgmt_router = Router(name="sdb_admin_modules_mgmt_stub_main")
    logger.error(f"Failed to load admin submodule 'modules_mgmt' (section router): {e}")

try:
    from .logs_viewer import section_logs_viewer_router # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
    logger.info("Admin submodule 'logs_viewer' (section router) loaded.")
except ImportError as e:
    section_logs_viewer_router = Router(name="sdb_admin_logs_viewer_stub_main")
    logger.error(f"Failed to load admin submodule 'logs_viewer' (section router): {e}")


# –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
admin_router = Router(name="sdb_admin_top_level_router") # –î–∞–µ–º –µ–º—É —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è

admin_router.include_router(section_entry_router)
admin_router.include_router(section_users_router)
admin_router.include_router(section_roles_router)
admin_router.include_router(section_sys_info_router)
admin_router.include_router(section_modules_mgmt_router)
admin_router.include_router(section_logs_viewer_router)

logger.success("Main admin_router composed from section routers.")

__all__ = ["admin_router"]


======================================================================

------------------------------ FILE: core/i18n/middleware.py ------------------------------
# core/i18n/middleware.py

from typing import Callable, Dict, Any, Awaitable, Optional
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject, User as AiogramUser # User –∏–∑ aiogram.types

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à Translator –∏ AppSettings (–¥–ª—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —è–∑—ã–∫–∞ –∏ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö)
from .translator import Translator
from core.app_settings import settings as sdb_settings # –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
from core.database.core_models import User as DBUser # –ù–∞—à–∞ –º–æ–¥–µ–ª—å User –∏–∑ –ë–î
from sqlalchemy.ext.asyncio import AsyncSession # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î

# –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ BotServicesProvider –∏–∑ workflow_data –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ (–µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å)
# from core.services_provider import BotServicesProvider


class I18nMiddleware(BaseMiddleware):
    """
    Middleware –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ (gettext) –≤ —Ö—ç–Ω–¥–ª–µ—Ä—ã.
    """
    def __init__(self, translator: Translator):
        super().__init__()
        self.translator = translator
        self.default_locale = translator.default_locale
        self.available_locales = translator.available_locales
        # logger –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ data, –µ—Å–ª–∏ BotServicesProvider –µ–≥–æ –ø–µ—Ä–µ–¥–∞–µ—Ç, –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π

    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: TelegramObject, # –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å Message, CallbackQuery, etc.
        data: Dict[str, Any]   # –°–ª–æ–≤–∞—Ä—å –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–π –≤ —Ö—ç–Ω–¥–ª–µ—Ä
    ) -> Any:
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ —Å–æ–±—ã—Ç–∏–∏
        aiogram_event_user: Optional[AiogramUser] = data.get("event_from_user")
        
        user_locale: str = self.default_locale # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —è–∑—ã–∫ —Å–∏—Å—Ç–µ–º—ã

        if aiogram_event_user:
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –Ω–∞—à–µ–π –ë–î
            # –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ DBManager –∏–ª–∏ —Å–µ—Å—Å–∏–∏
            # –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ BotServicesProvider (services) –¥–æ—Å—Ç—É–ø–µ–Ω –≤ data
            services = data.get("services_provider") # –ò–º—è –∫–ª—é—á–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫ –º—ã –µ–≥–æ –ø–æ–ª–æ–∂–∏–ª–∏ –≤ Dispatcher
            
            db_user: Optional[DBUser] = None
            if services and hasattr(services, 'db'):
                try:
                    async with services.db.get_session() as session: # type: AsyncSession
                        # –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id
                        from sqlalchemy import select # –õ–µ–Ω–∏–≤—ã–π –∏–º–ø–æ—Ä—Ç
                        stmt = select(DBUser).where(DBUser.telegram_id == aiogram_event_user.id)
                        result = await session.execute(stmt)
                        db_user = result.scalars().first()
                        
                        if db_user and db_user.preferred_language_code and db_user.preferred_language_code in self.available_locales:
                            user_locale = db_user.preferred_language_code
                        elif db_user and not db_user.preferred_language_code:
                            # –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –Ω–µ—Ç —è–∑—ã–∫–∞, –Ω–æ –µ—Å—Ç—å —è–∑—ã–∫ –≤ Telegram –∏ –æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                            if aiogram_event_user.language_code and aiogram_event_user.language_code in self.available_locales:
                                user_locale = aiogram_event_user.language_code
                                # –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —è–∑—ã–∫ –≤ –ë–î –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                # db_user.preferred_language_code = user_locale
                                # await session.commit() # –û–°–¢–û–†–û–ñ–ù–û: commit –≤ middleware
                        elif not db_user: # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –ë–î
                            if aiogram_event_user.language_code and aiogram_event_user.language_code in self.available_locales:
                                user_locale = aiogram_event_user.language_code
                except Exception as e:
                    # logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –¥–ª—è TG ID {aiogram_event_user.id}: {e}")
                    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–≥–≥–µ—Ä –∏–∑ data, –µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å
                    data.get("logger", logger).error(f"I18nMiddleware: –û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —è–∑—ã–∫–∞ –¥–ª—è TG ID {aiogram_event_user.id}: {e}")
                    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å default_locale –∏–ª–∏ —è–∑—ã–∫–æ–º –∏–∑ Telegram, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–∞–Ω–µ–µ
            else: # –ï—Å–ª–∏ services –∏–ª–∏ services.db –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
                 data.get("logger", logger).warning("I18nMiddleware: BotServicesProvider –∏–ª–∏ DBManager –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ data. –Ø–∑—ã–∫ –∏–∑ –ë–î –Ω–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω.")
                 # –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —è–∑—ã–∫ –∏–∑ Telegram API, –µ—Å–ª–∏ –æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                 if aiogram_event_user.language_code and aiogram_event_user.language_code in self.available_locales:
                     user_locale = aiogram_event_user.language_code
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —è–∑—ã–∫ –≤ data –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –≤ —Ö—ç–Ω–¥–ª–µ—Ä–∞—Ö
        data["user_locale"] = user_locale
        
        # –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º —Ö—ç–Ω–¥–ª–µ—Ä–∞–º —É–¥–æ–±–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
        # –û–Ω–∏ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å user_locale, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤ data
        # –≠—Ç–æ –æ–±–µ—Ä—Ç–∫–∏, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å locale –∫–∞–∂–¥—ã–π —Ä–∞–∑
        data["gettext"] = lambda message_key, **kwargs: self.translator.gettext(message_key, user_locale, **kwargs)
        data["ngettext"] = lambda singular_key, plural_key, count, **kwargs: self.translator.ngettext(singular_key, plural_key, count, user_locale, **kwargs)
        
        # –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —Å–∞–º –æ–±—ä–µ–∫—Ç translator, –µ—Å–ª–∏ —ç—Ç–æ —É–¥–æ–±–Ω–µ–µ
        data["translator"] = self.translator 
        
        # data.get("logger", logger).debug(f"I18nMiddleware: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —è–∑—ã–∫ '{user_locale}' –¥–ª—è TG ID {aiogram_event_user.id if aiogram_event_user else 'N/A'}.")
        
        return await handler(event, data)


======================================================================

------------------------------ FILE: core/i18n/translator.py ------------------------------
# core/i18n/translator.py

import gettext # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è i18n
from pathlib import Path
from typing import Dict, List, Optional, Any
from loguru import logger

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å –ø—É—Ç—å –∫ 'locales' –∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —è–∑—ã–∫
# –≠—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å —É–±—Ä–∞–Ω, –µ—Å–ª–∏ Translator –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑–≤–Ω–µ
# from core.app_settings import settings as sdb_settings # –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ i18n —Ç–∞–º –µ—Å—Ç—å

class Translator:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏ (–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π) —Å—Ç—Ä–æ–∫.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º gettext.
    """
    def __init__(
        self, 
        locales_dir: Path, 
        domain: str = "bot", # –ò–º—è –¥–æ–º–µ–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–º–µ–Ω–∏ .mo/.po —Ñ–∞–π–ª–∞)
        default_locale: str = "en", 
        available_locales: Optional[List[str]] = None
    ):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä.

        Args:
            locales_dir: –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 'locales' (–≥–¥–µ –ª–µ–∂–∞—Ç –ø–∞–ø–∫–∏ en/, ua/, etc.).
            domain: –ò–º—è –¥–æ–º–µ–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–æ–±—ã—á–Ω–æ –∏–º—è –≤–∞—à–µ–≥–æ .po/.mo —Ñ–∞–π–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, 'bot').
            default_locale: –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω.
            available_locales: –°–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —è–∑—ã–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ['en', 'ua']).
                               –ï—Å–ª–∏ None, –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ –ø–∞–ø–æ–∫ –≤ locales_dir.
        """
        self.locales_dir = locales_dir
        self.domain = domain
        self.default_locale = default_locale
        self._translations: Dict[str, gettext.GNUTranslations] = {} # –ö—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤

        if available_locales:
            self.available_locales = available_locales
        else:
            # –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —è–∑—ã–∫–∏ –ø–æ –ø–∞–ø–∫–∞–º –≤ locales_dir
            self.available_locales = []
            if self.locales_dir.is_dir():
                for item in self.locales_dir.iterdir():
                    if item.is_dir() and (item / "LC_MESSAGES" / f"{self.domain}.mo").exists():
                        self.available_locales.append(item.name)
            if not self.available_locales:
                 logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ .mo —Ñ–∞–π–ª—ã –≤ {self.locales_dir} –¥–ª—è –¥–æ–º–µ–Ω–∞ '{self.domain}'. "
                                f"–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.")
            elif default_locale not in self.available_locales and self.available_locales:
                logger.warning(f"–Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é '{default_locale}' –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ä–µ–¥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö: {self.available_locales}. "
                               f"–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —è–∑—ã–∫ –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, –µ—Å–ª–∏ gettext –Ω–µ –Ω–∞–π–¥–µ—Ç –Ω–∏—á–µ–≥–æ.")
        
        logger.info(f"Translator –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. Locales dir: '{self.locales_dir}', Domain: '{self.domain}', "
                    f"Default: '{self.default_locale}', Available: {self.available_locales}")
        
        # –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –≥—Ä—É–∑–∏—Ç—å –ø–æ –∑–∞–ø—Ä–æ—Å—É)
        self.load_all_translations()


    def load_translation(self, locale: str) -> Optional[gettext.GNUTranslations]:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑ –∫—ç—à–∞ –æ–±—ä–µ–∫—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞."""
        if locale in self._translations:
            return self._translations[locale]
        
        if locale not in self.available_locales:
            logger.trace(f"–Ø–∑—ã–∫ '{locale}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ –¥–ª—è –Ω–µ–≥–æ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–≤–æ–¥–∞.")
            return None # –ò–ª–∏ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è default_locale

        try:
            # gettext.translation —Ç—Ä–µ–±—É–µ—Ç –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π en/LC_MESSAGES, ua/LC_MESSAGES –∏ —Ç.–¥.
            # –∏ —Å–ø–∏—Å–æ–∫ —è–∑—ã–∫–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ (fallback).
            translation = gettext.translation(
                domain=self.domain,
                localedir=str(self.locales_dir),
                languages=[locale, self.default_locale] # –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω –¥–ª—è fallback
            )
            self._translations[locale] = translation
            logger.debug(f"–ü–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è —è–∑—ã–∫–∞ '{locale}' —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")
            return translation
        except FileNotFoundError:
            logger.warning(f"–§–∞–π–ª –ø–µ—Ä–µ–≤–æ–¥–∞ .mo –¥–ª—è —è–∑—ã–∫–∞ '{locale}' (–¥–æ–º–µ–Ω '{self.domain}') –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ '{self.locales_dir}'.")
            # –ú–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å None, —á—Ç–æ–±—ã –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è –≥—Ä—É–∑–∏—Ç—å —Å–Ω–æ–≤–∞
            self._translations[locale] = gettext.NullTranslations() # type: ignore # –ò—Å–ø–æ–ª—å–∑—É–µ–º NullTranslations –∫–∞–∫ –∑–∞–≥–ª—É—à–∫—É
            return self._translations[locale]
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –¥–ª—è —è–∑—ã–∫–∞ '{locale}': {e}", exc_info=True)
            return None

    def load_all_translations(self) -> None:
        """–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã."""
        logger.info(f"–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤ ({self.available_locales})...")
        for lang in self.available_locales:
            self.load_translation(lang)

    def gettext(self, message_key: str, locale: str, **kwargs: Any) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –ø–æ –∫–ª—é—á—É –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞.
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å kwargs.

        –ü—Ä–∏–º–µ—Ä –∫–ª—é—á–∞: "main_menu:button_profile" –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ "Profile Button Text"
        """
        translation = self._translations.get(locale)
        if not translation: # –ï—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ NullTranslations
            # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å
            translation = self.load_translation(locale) or self._translations.get(self.default_locale)
            if not translation: # –ï—Å–ª–∏ –∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                translation = self.load_translation(self.default_locale) or gettext.NullTranslations() # type: ignore
                self._translations[self.default_locale] = translation # –ö—ç—à–∏—Ä—É–µ–º NullTranslations –¥–ª—è –¥–µ—Ñ–æ–ª—Ç–∞

        # gettext.gettext() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º GNUTranslations
        translated_text = translation.gettext(message_key) # type: ignore

        try:
            # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å kwargs
            return translated_text.format(**kwargs) if kwargs else translated_text
        except (KeyError, IndexError) as e_format:
            logger.warning(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–ª—é—á–∞ '{message_key}' (locale: {locale}): {e_format}. "
                           f"–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: '{translated_text}', kwargs: {kwargs}")
            return translated_text # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏

    def ngettext(self, singular_key: str, plural_key: str, count: int, locale: str, **kwargs: Any) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É —Å —É—á–µ—Ç–æ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞.
        """
        translation = self._translations.get(locale)
        if not translation:
            translation = self.load_translation(locale) or self._translations.get(self.default_locale)
            if not translation:
                translation = self.load_translation(self.default_locale) or gettext.NullTranslations() # type: ignore
                self._translations[self.default_locale] = translation

        # ngettext –æ–∂–∏–¥–∞–µ—Ç msgid1, msgid2, n
        # –ï—Å–ª–∏ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á–∏, —Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ –∫–∞–∫-—Ç–æ –∏—Ö –ø–µ—Ä–µ–¥–∞—Ç—å.
        # –ü—Ä–æ—Å—Ç–æ–π gettext.GNUTranslations.ngettext(msgid1, msgid2, n) –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–∞—à–∏–º–∏ –∫–ª—é—á–∞–º–∏.
        # –ù–∞–º –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã .po —Ñ–∞–π–ª—ã —Å–æ–¥–µ—Ä–∂–∞–ª–∏ msgid –∏ msgid_plural.
        # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –∫–ª—é—á–∏ —ç—Ç–æ –∏ –µ—Å—Ç—å msgid/msgid_plural.
        translated_text = translation.ngettext(singular_key, plural_key, count) # type: ignore
        
        # –î–æ–±–∞–≤–ª—è–µ–º count –≤ kwargs –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç
        format_kwargs = {**kwargs, 'count': count}
        try:
            return translated_text.format(**format_kwargs)
        except (KeyError, IndexError) as e_format:
            logger.warning(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ngettext –¥–ª—è –∫–ª—é—á–µ–π '{singular_key}/{plural_key}' (locale: {locale}): {e_format}. "
                           f"–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: '{translated_text}', kwargs: {format_kwargs}")
            return translated_text

    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
    # –µ—Å–ª–∏ —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–≤–µ—Å—Ç–µ–Ω —Å–µ—Ä–≤–∏—Å—É.
    # async def gettext_for_user(self, user_id: int, message_key: str, **kwargs) -> str:
    #     user_locale = await self._get_user_locale(user_id) # –ù—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –ë–î –∏–ª–∏ –∫—ç—à—É —Å —è–∑—ã–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    #     return self.gettext(message_key, user_locale, **kwargs)


======================================================================

------------------------------ FILE: core/i18n/__init__.py ------------------------------



======================================================================

------------------------------ FILE: core/admin/modules_mgmt/handlers_modules.py ------------------------------
# core/admin/modules_mgmt/handlers_modules.py
from aiogram import Router, types, F
from loguru import logger

from core.ui.callback_data_factories import AdminModulesPanelNavigate # –ü—Ä–∏–º–µ—Ä
from core.admin.filters_admin import can_view_admin_panel_filter
# from .keyboards_modules import ...

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider

modules_mgmt_router = Router(name="sdb_admin_modules_mgmt_handlers")
MODULE_NAME_FOR_LOG = "AdminModulesMgmt"

#modules_mgmt_router.callback_query.filter(can_view_admin_panel_filter)

@modules_mgmt_router.callback_query(AdminModulesPanelNavigate.filter(F.action == "list"))
async def cq_admin_modules_list_stub(
    query: types.CallbackQuery,
    callback_data: AdminModulesPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π –≤—ã–∑–≤–∞–Ω–∞.")
    await query.answer("–†–∞–∑–¥–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥—É–ª—è–º–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.", show_alert=True)


======================================================================

------------------------------ FILE: core/admin/modules_mgmt/keyboards_modules.py ------------------------------
# core/admin/modules_mgmt/keyboards_modules.py
# –ü–æ–∫–∞ –ø—É—Å—Ç–æ–π, –Ω–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder

# def get_some_keyboard():
#     builder = InlineKeyboardBuilder()
#     # ...
#     return builder.as_markup()


======================================================================

------------------------------ FILE: core/admin/modules_mgmt/__init__.py ------------------------------
# core/admin/modules_mgmt/__init__.py
from aiogram import Router

from .handlers_modules import modules_mgmt_router # –†–æ—É—Ç–µ—Ä –∏–∑ handlers_modules.py

section_modules_mgmt_router = Router(name="sdb_admin_section_modules_mgmt_router")
section_modules_mgmt_router.include_router(modules_mgmt_router)

__all__ = ["section_modules_mgmt_router"]


======================================================================

------------------------------ FILE: core/admin/entry/handlers_entry.py ------------------------------
# core/admin/entry/handlers_entry.py
from aiogram import Router, types, F, Bot
from aiogram.filters import Command
from aiogram.utils.markdown import hbold
from loguru import logger
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_admin_main_menu_keyboard 
from core.ui.callback_data_factories import CoreMenuNavigate, AdminMainMenuNavigate
from core.admin.filters_admin import can_view_admin_panel_filter 

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession 


admin_entry_router = Router(name="sdb_admin_entry_handlers")
MODULE_NAME_FOR_LOG = "AdminEntry"

#admin_entry_router.message.filter(can_view_admin_panel_filter)
#admin_entry_router.callback_query.filter(can_view_admin_panel_filter)


async def send_admin_main_menu(message_or_query: types.Message | types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = message_or_query.from_user.id 
    
    text = (f"üõ† {hbold('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å SwiftDevBot')}\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:")
    
    async with services_provider.db.get_session() as session: 
        keyboard = await get_admin_main_menu_keyboard(services_provider, user_id, session)

    if isinstance(message_or_query, types.Message):
        await message_or_query.answer(text, reply_markup=keyboard)
    elif isinstance(message_or_query, types.CallbackQuery) and message_or_query.message:
        try:
            if message_or_query.message.text != text or message_or_query.message.reply_markup != keyboard:
                await message_or_query.message.edit_text(text, reply_markup=keyboard)
            else:
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")
            await message_or_query.answer() 
        except TelegramBadRequest as e_tbr: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
            if "message is not modified" in str(e_tbr).lower():
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ TelegramBadRequest).")
                await message_or_query.answer()
            else:
                logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: {e_tbr}")
                if isinstance(message_or_query, types.CallbackQuery): 
                    try:
                        await message_or_query.bot.send_message(user_id, text, reply_markup=keyboard)
                        await message_or_query.message.delete() 
                        await message_or_query.answer()
                    except Exception as e_send_new:
                        logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e_send_new}")
                        await message_or_query.answer(ADMIN_COMMON_TEXTS["error_general"], show_alert=True)
                else: 
                    await message_or_query.answer(ADMIN_COMMON_TEXTS["error_general"], show_alert=True)
        except Exception as e:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: {e}", exc_info=True)
            if isinstance(message_or_query, types.CallbackQuery):
                await message_or_query.answer(ADMIN_COMMON_TEXTS["error_general"], show_alert=True)


@admin_entry_router.message(Command("admin"))
async def cmd_admin_panel_main(message: types.Message, services_provider: 'BotServicesProvider'):
    user_id = message.from_user.id 
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} (—Å –ø—Ä–∞–≤–∞–º–∏) –≤–æ—à–µ–ª –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /admin.")
    await send_admin_main_menu(message, services_provider)

@admin_entry_router.callback_query(CoreMenuNavigate.filter(F.target_menu == "admin_panel_main"))
async def cq_core_nav_to_admin_panel_main(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} (—Å –ø—Ä–∞–≤–∞–º–∏) –≤–æ—à–µ–ª –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é SDB.")
    await send_admin_main_menu(query, services_provider)

@admin_entry_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "main_admin"))
async def cq_admin_nav_to_main_admin_menu(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –≤–µ—Ä–Ω—É–ª—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.")
    await send_admin_main_menu(query, services_provider)

@admin_entry_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "users"))
async def cq_admin_main_to_users_list(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider'
):
    from core.admin.users.handlers_list import cq_admin_users_list_entry
    from core.ui.callback_data_factories import AdminUsersPanelNavigate 
    await cq_admin_users_list_entry(query, AdminUsersPanelNavigate(action="list", page=1), services_provider)

@admin_entry_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "roles"))
async def cq_admin_main_to_roles_list(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider',
    bot: Bot 
):
    from core.admin.roles.handlers_list import cq_admin_roles_list_entry
    from core.ui.callback_data_factories import AdminRolesPanelNavigate 
    await cq_admin_roles_list_entry(query, AdminRolesPanelNavigate(action="list"), services_provider, bot)

@admin_entry_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "sys_info"))
async def cq_admin_main_to_sys_info(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider',
    bot: Bot
):
    from core.admin.sys_info.handlers_sys_info import cq_admin_show_system_info_entry
    from core.ui.callback_data_factories import AdminSysInfoPanelNavigate 
    await cq_admin_show_system_info_entry(query, AdminSysInfoPanelNavigate(action="show"), services_provider, bot)

@admin_entry_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "modules"))
async def cq_admin_main_to_modules(query: types.CallbackQuery, services_provider: 'BotServicesProvider'):
    await query.answer("–†–∞–∑–¥–µ–ª '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏' –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.", show_alert=True)


======================================================================

------------------------------ FILE: core/admin/entry/__init__.py ------------------------------
# core/admin/entry/__init__.py
from aiogram import Router

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º "–∫–æ–Ω–µ—á–Ω—ã–π" —Ä–æ—É—Ç–µ—Ä
from .handlers_entry import admin_entry_router

# –°–æ–∑–¥–∞–µ–º "—Å–æ–±–∏—Ä–∞—é—â–∏–π" —Ä–æ—É—Ç–µ—Ä –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞
section_entry_router = Router(name="sdb_admin_section_entry_router")
section_entry_router.include_router(admin_entry_router)

__all__ = ["section_entry_router"]


======================================================================

------------------------------ FILE: core/admin/users/handlers_details.py ------------------------------
# core/admin/users/handlers_details.py
from aiogram import Router, types, F
from aiogram.utils.markdown import hbold, hcode
from loguru import logger
from sqlalchemy.orm import selectinload
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

from core.ui.callback_data_factories import AdminUsersPanelNavigate
from .keyboards_users import get_admin_user_details_keyboard_local, USERS_MGMT_TEXTS 
from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS 
from core.admin.filters_admin import can_view_admin_panel_filter
from core.rbac.service import PERMISSION_CORE_USERS_VIEW_DETAILS, PERMISSION_CORE_USERS_MANAGE_STATUS
from core.database.core_models import User as DBUser

from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession

user_details_router = Router(name="sdb_admin_user_details_handlers")
MODULE_NAME_FOR_LOG = "AdminUserDetails"

#user_details_router.callback_query.filter(can_view_admin_panel_filter)

async def _send_or_edit_user_details_local( 
    query: types.CallbackQuery, 
    target_user: DBUser, 
    services_provider: 'BotServicesProvider', 
    session: 'AsyncSession', 
    admin_tg_id: int
):
    target_user_is_owner = target_user.telegram_id in services_provider.config.core.super_admins
    
    roles_display_str: str
    if target_user_is_owner:
        roles_display_str = USERS_MGMT_TEXTS["user_is_owner_text"]
    elif target_user.roles:
        roles_display_str = ", ".join(sorted([role.name for role in target_user.roles]))
    else:
        roles_display_str = "–Ω–µ—Ç"

    text_parts = [
        f"üë§ {hbold(USERS_MGMT_TEXTS['user_details_title'])}: {target_user.full_name}",
        f"   Telegram ID: {hcode(str(target_user.telegram_id))}",
        f"   DB ID: {hcode(str(target_user.id))}",
        f"   Username: {hcode(f'@{target_user.username}') if target_user.username else '-'}",
        f"   –ò–º—è: {hcode(target_user.first_name or '-')}",
        f"   –§–∞–º–∏–ª–∏—è: {hcode(target_user.last_name or '-')}",
        f"   –Ø–∑—ã–∫: {hcode(target_user.preferred_language_code or '-')}",
        f"   –ê–∫—Ç–∏–≤–µ–Ω: {'–î–∞ ‚úÖ' if target_user.is_active else '–ù–µ—Ç üí§'}",
        f"   –ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {'–î–∞ üö´' if target_user.is_bot_blocked else '–ù–µ—Ç ‚úÖ'}",
        f"   –†–æ–ª–∏/–°—Ç–∞—Ç—É—Å: {hbold(roles_display_str)}",
        f"   –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {target_user.created_at.strftime('%Y-%m-%d %H:%M') if target_user.created_at else '-'}",
        f"   –ü–æ—Å–ª. –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {target_user.last_activity_at.strftime('%Y-%m-%d %H:%M') if target_user.last_activity_at else '-'}",
    ]
    text = "\n".join(text_parts)
    keyboard = await get_admin_user_details_keyboard_local(target_user, services_provider, admin_tg_id, session)

    if query.message:
        try:
            if query.message.text != text or query.message.reply_markup != keyboard:
                await query.message.edit_text(text, reply_markup=keyboard)
            else:
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ({target_user.id}) –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")
        except TelegramBadRequest as e_tbr: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
            if "message is not modified" in str(e_tbr).lower():
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ({target_user.id}) –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
            else:
                logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ({target_user.id}): {e_tbr}")
        except Exception as e_edit:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ _send_or_edit_user_details_local –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_user.id}: {e_edit}", exc_info=True)


@user_details_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "view"))
async def cq_admin_user_view_details_entry( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    target_user_db_id: Optional[int] = None

    if callback_data.item_id is not None:
        try: target_user_db_id = int(str(callback_data.item_id))
        except ValueError:
            await query.answer("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", show_alert=True); return
    
    if target_user_db_id is None:
        await query.answer("–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É–∫–∞–∑–∞–Ω.", show_alert=True); return
        
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –¥–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å DB ID: {target_user_db_id}")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_VIEW_DETAILS):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return

        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.roles)])
        
        if not target_user:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return
        
        await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id)
    await query.answer() 

@user_details_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "toggle_active"))
async def cq_admin_user_toggle_active_details( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    target_user_db_id: Optional[int] = None
    if callback_data.item_id is not None:
        try: target_user_db_id = int(str(callback_data.item_id))
        except ValueError: pass
    
    if target_user_db_id is None:
        await query.answer("–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É–∫–∞–∑–∞–Ω.", show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –∏–∑–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è DB ID: {target_user_db_id}")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_MANAGE_STATUS):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return

        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.roles)])
        if not target_user:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return
        
        if target_user.telegram_id in services_provider.config.core.super_admins:
            await query.answer("–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å –í–ª–∞–¥–µ–ª—å—Ü–∞ —Å–∏—Å—Ç–µ–º—ã.", show_alert=True)
            await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id)
            return

        new_status = not target_user.is_active
        changed = await services_provider.user_service.set_user_active_status(target_user, new_status, session)
        alert_text = ""
        if changed:
            try:
                await session.commit()
                alert_text = f"–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ {target_user.full_name} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {'–ê–∫—Ç–∏–≤–µ–Ω ‚úÖ' if new_status else '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω üí§'}"
                logger.info(f"[{MODULE_NAME_FOR_LOG}] {alert_text}")
            except Exception as e_commit:
                await session.rollback()
                alert_text = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π."
        else:
            alert_text = "–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω."
        await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id)
        await query.answer(alert_text, show_alert=bool(changed and "–û—à–∏–±–∫–∞" not in alert_text)) 

@user_details_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "toggle_blocked"))
async def cq_admin_user_toggle_blocked_details( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    target_user_db_id: Optional[int] = None
    if callback_data.item_id is not None:
        try: target_user_db_id = int(str(callback_data.item_id))
        except ValueError: pass
    if target_user_db_id is None:
        await query.answer("–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É–∫–∞–∑–∞–Ω.", show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –∏–∑–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è DB ID: {target_user_db_id}")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_MANAGE_STATUS):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return

        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.roles)])
        if not target_user:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return
        if target_user.telegram_id in services_provider.config.core.super_admins:
            await query.answer("–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞ —Å–∏—Å—Ç–µ–º—ã.", show_alert=True)
            await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id)
            return

        new_status = not target_user.is_bot_blocked
        changed = await services_provider.user_service.set_user_bot_blocked_status(target_user, new_status, session)
        alert_text = ""
        if changed:
            try:
                await session.commit()
                alert_text = f"–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è {target_user.full_name} –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: {'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª üö´' if new_status else '–ù–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª ‚úÖ'}"
            except Exception as e_commit: await session.rollback(); alert_text = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."
        else: alert_text = "–°—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω."
        await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id)
        await query.answer(alert_text, show_alert=bool(changed and "–û—à–∏–±–∫–∞" not in alert_text))


======================================================================

------------------------------ FILE: core/admin/users/handlers_list.py ------------------------------
# core/admin/users/handlers_list.py
from aiogram import Router, types, F
from aiogram.utils.markdown import hbold
from loguru import logger
from sqlalchemy import select, func as sql_func # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢ func

from core.ui.callback_data_factories import AdminUsersPanelNavigate
from .keyboards_users import get_admin_users_list_keyboard_local, USERS_MGMT_TEXTS 
from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS 
from core.admin.filters_admin import can_view_admin_panel_filter
from core.rbac.service import PERMISSION_CORE_USERS_VIEW_LIST
from core.database.core_models import User as DBUser

from typing import TYPE_CHECKING, List
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider

users_list_router = Router(name="sdb_admin_users_list_handlers")
MODULE_NAME_FOR_LOG = "AdminUserList"

#users_list_router.callback_query.filter(can_view_admin_panel_filter)

USERS_PER_PAGE_ADMIN_LOCAL = 10 

@users_list_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "list"))
async def cq_admin_users_list_entry( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider' 
):
    admin_user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å—Ç—Ä–∞–Ω–∏—Ü–∞: {callback_data.page or 1}")

    async with services_provider.db.get_session() as session: 
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins: 
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_VIEW_LIST):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True)
                return
        
        current_page = callback_data.page if callback_data.page is not None else 1
        
        total_users = 0
        try:
            count_stmt = select(sql_func.count(DBUser.id)) 
            total_users_res = await session.execute(count_stmt)
            total_users = total_users_res.scalar_one_or_none() or 0
        except Exception as e_count:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e_count}")
            await query.answer("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö.", show_alert=True)
            return
        
        total_pages = (total_users + USERS_PER_PAGE_ADMIN_LOCAL - 1) // USERS_PER_PAGE_ADMIN_LOCAL
        total_pages = max(1, total_pages) 
        current_page = max(1, min(current_page, total_pages))
        offset = (current_page - 1) * USERS_PER_PAGE_ADMIN_LOCAL

        stmt_users = (
            select(DBUser)
            .order_by(DBUser.id.desc()) 
            .limit(USERS_PER_PAGE_ADMIN_LOCAL)
            .offset(offset)
        )
        users_result = await session.execute(stmt_users)
        users_on_page: List[DBUser] = list(users_result.scalars().all())

        text = USERS_MGMT_TEXTS["user_list_title_template"].format(current_page=current_page, total_pages=total_pages)
        if total_users == 0 : 
             text = "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏\n\n–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."

        keyboard = await get_admin_users_list_keyboard_local(users_on_page, total_pages, current_page)

        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
                else:
                    logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ.")
                await query.answer()
            except types.TelegramBadRequest as e_tbr:
                if "message is not modified" in str(e_tbr).lower():
                    logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
                    await query.answer()
                else:
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e_tbr}")
                    await query.answer() 
            except Exception as e_edit:
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ cq_admin_users_list_entry: {e_edit}", exc_info=True)
                await query.answer(ADMIN_COMMON_TEXTS["error_general"], show_alert=True)


======================================================================

------------------------------ FILE: core/admin/users/handlers_direct_perms.py ------------------------------
# core/admin/users/handlers_direct_perms.py
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.markdown import hbold
from loguru import logger
from sqlalchemy.orm import selectinload
from aiogram.filters import StateFilter # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º StateFilter
from aiogram.exceptions import TelegramBadRequest # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º TelegramBadRequest

from core.ui.callback_data_factories import AdminUsersPanelNavigate
from .keyboards_users import get_user_direct_perms_keyboard, USERS_MGMT_TEXTS 
from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS 
from core.admin.filters_admin import can_view_admin_panel_filter
from core.rbac.service import PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS 
from core.database.core_models import User as DBUser, Permission as DBPermission, Role as DBRole # –î–æ–±–∞–≤–∏–ª DBRole

from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession

user_direct_perms_router = Router(name="sdb_admin_user_direct_perms_handlers")
MODULE_NAME_FOR_LOG = "AdminUserDirectPerms"

#user_direct_perms_router.callback_query.filter(can_view_admin_panel_filter)

# --- FSM –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –ø—Ä—è–º—ã–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
class FSMDirectUserPermsNavigation(StatesGroup):
    navigating_direct_perms = State()

# --- –í—Ö–æ–¥ –≤ FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ ---
@user_direct_perms_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "edit_direct_perms_start"))
async def cq_admin_user_edit_direct_perms_entry( # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    admin_user_id = query.from_user.id
    target_user_db_id = callback_data.item_id

    if target_user_db_id is None:
        await query.answer("–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É–∫–∞–∑–∞–Ω.", show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –≤—Ö–æ–¥–∏—Ç –≤ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–ª—è User DB ID: {target_user_db_id}")

    async with services_provider.db.get_session() as session:
        current_admin_is_owner = admin_user_id in services_provider.config.core.super_admins
        if not current_admin_is_owner and \
           not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS):
            await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True)
            return
        
        target_user = await session.get(DBUser, target_user_db_id)
        if not target_user:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return
        if target_user.telegram_id in services_provider.config.core.super_admins:
            await query.answer("–ù–µ–ª—å–∑—è —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞ —Å–∏—Å—Ç–µ–º—ã.", show_alert=True); return

    await state.clear() 
    await state.set_state(FSMDirectUserPermsNavigation.navigating_direct_perms)
    await state.update_data(
        target_user_id_for_perms=target_user_db_id, 
    )
    
    await _show_user_direct_perms_menu(query, services_provider, state)

# --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º/—Å—É—â–Ω–æ—Å—Ç—è–º/—Å—Ç—Ä–∞–Ω–∏—Ü–∞–º –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π ---
@user_direct_perms_router.callback_query(
    AdminUsersPanelNavigate.filter(F.action == "direct_perms_nav"),
    StateFilter(FSMDirectUserPermsNavigation.navigating_direct_perms)
)
async def cq_admin_user_direct_perms_navigate(
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    fsm_data = await state.get_data()
    target_user_db_id = fsm_data.get("target_user_id_for_perms")
    if target_user_db_id is None: 
        await query.answer("–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.", show_alert=True)
        await state.clear(); return

    new_fsm_context_data = {
        "category_key": callback_data.category_key,
        "entity_name": callback_data.entity_name,
        "current_page": callback_data.page or 1
    }
    await state.update_data(**new_fsm_context_data)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {query.from_user.id} –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä—è–º—ã–º –ø—Ä–∞–≤–∞–º (User ID: {target_user_db_id}). "
                f"–ù–æ–≤—ã–π FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: {new_fsm_context_data}")
    
    await _show_user_direct_perms_menu(query, services_provider, state)

# --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä—è–º–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
@user_direct_perms_router.callback_query(
    AdminUsersPanelNavigate.filter(F.action == "toggle_direct_perm"),
    StateFilter(FSMDirectUserPermsNavigation.navigating_direct_perms)
)
async def cq_admin_user_toggle_direct_perm(
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    admin_user_id = query.from_user.id
    fsm_data = await state.get_data()
    target_user_db_id: Optional[int] = fsm_data.get("target_user_id_for_perms")
    permission_to_toggle_id: Optional[int] = callback_data.permission_id

    if target_user_db_id is None or permission_to_toggle_id is None:
        await query.answer("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.", show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –∏–∑–º–µ–Ω—è–µ—Ç –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ "
                f"PermID:'{permission_to_toggle_id}' –¥–ª—è User DBID:{target_user_db_id}")

    async with services_provider.db.get_session() as session:
        current_admin_is_owner = admin_user_id in services_provider.config.core.super_admins
        if not current_admin_is_owner and \
           not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS):
            await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return
        
        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.direct_permissions)])
        permission_to_modify = await session.get(DBPermission, permission_to_toggle_id)

        if not target_user or not permission_to_modify:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return
        if target_user.telegram_id in services_provider.config.core.super_admins: 
            await query.answer("–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä—è–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –í–ª–∞–¥–µ–ª—å—Ü–∞.", show_alert=True); return

        user_has_direct_perm = permission_to_modify in target_user.direct_permissions
        alert_text, action_performed = "", False

        if user_has_direct_perm:
            if await services_provider.rbac.remove_direct_permission_from_user(session, target_user, permission_to_modify.name):
                action_performed = True
                alert_text = f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_to_modify.name}' —Å–Ω—è—Ç–æ."
            else: alert_text = f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_to_modify.name}'."
        else:
            if await services_provider.rbac.assign_direct_permission_to_user(session, target_user, permission_to_modify.name, auto_create_perm=False):
                action_performed = True
                alert_text = f"–ü—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_to_modify.name}' –Ω–∞–∑–Ω–∞—á–µ–Ω–æ."
            else: alert_text = f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä—è–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_to_modify.name}'."
        
        if action_performed:
            try: await session.commit(); logger.info(f"[{MODULE_NAME_FOR_LOG}] {alert_text} –¥–ª—è User ID: {target_user.id}"); await session.refresh(target_user, attribute_names=['direct_permissions'])
            except Exception as e: await session.rollback(); logger.error(f"–û—à–∏–±–∫–∞ commit: {e}"); alert_text = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."
        
        await query.answer(alert_text, show_alert=action_performed and "–ù–µ —É–¥–∞–ª–æ—Å—å" not in alert_text)
        await _show_user_direct_perms_menu(query, services_provider, state) 

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é –ø—Ä—è–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π ---
async def _show_user_direct_perms_menu(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider', 
    state: FSMContext
):
    admin_user_id = query.from_user.id
    fsm_data = await state.get_data()
    
    target_user_db_id = fsm_data.get("target_user_id_for_perms")
    category_key = fsm_data.get("category_key")
    entity_name = fsm_data.get("entity_name")
    page = fsm_data.get("current_page", 1)

    if target_user_db_id is None:
        await query.answer("–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).", show_alert=True); await state.clear(); return

    async with services_provider.db.get_session() as session:
        target_user = await session.get(DBUser, target_user_db_id, options=[
            selectinload(DBUser.direct_permissions), 
            selectinload(DBUser.roles).selectinload(DBRole.permissions) 
        ])
        if not target_user:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); await state.clear(); return

        all_system_permissions = await services_provider.rbac.get_all_permissions(session)
        
        base_text = USERS_MGMT_TEXTS["edit_direct_perms_for_user"].format(user_name=hbold(target_user.full_name))
        current_level_text = ""
        if category_key == "core":
            current_level_text = " / –Ø–¥—Ä–æ"
            if entity_name: current_level_text += f" / {ADMIN_COMMON_TEXTS.get(f'perm_core_group_{entity_name}', entity_name.capitalize())}"
        elif category_key == "module":
            current_level_text = " / –ú–æ–¥—É–ª–∏"
            if entity_name:
                mod_info = services_provider.modules.get_module_info(entity_name)
                current_level_text += f" / {mod_info.manifest.display_name if mod_info and mod_info.manifest else entity_name}"
        
        text = f"{base_text}{current_level_text}\n–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä—è–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:"
        
        keyboard = await get_user_direct_perms_keyboard(
            target_user=target_user, 
            all_system_permissions=all_system_permissions, 
            services=services_provider, 
            current_admin_tg_id=admin_user_id, 
            session=session,
            category_key=category_key, entity_name=entity_name, page=page
        )

        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
            except TelegramBadRequest as e: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
                if "message is not modified" not in str(e).lower(): 
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ edit_text (_show_user_direct_perms_menu): {e}")
            except Exception as e_edit:
                logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ _show_user_direct_perms_menu: {e_edit}", exc_info=True)
                if query.message: await query.answer("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.", show_alert=True)

# –í—ã—Ö–æ–¥ –∏–∑ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ö –¥–µ—Ç–∞–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
@user_direct_perms_router.callback_query(
    AdminUsersPanelNavigate.filter(F.action == "view"), 
    StateFilter(FSMDirectUserPermsNavigation.navigating_direct_perms) 
)
async def cq_back_to_user_details_from_direct_perms_fsm(
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    await state.clear() 
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {query.from_user.id} –≤—ã—à–µ–ª –∏–∑ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏.")
    from .handlers_details import cq_admin_user_view_details_entry
    await cq_admin_user_view_details_entry(query, callback_data, services_provider)


======================================================================

------------------------------ FILE: core/admin/users/keyboards_users.py ------------------------------
# SwiftDevBot/core/admin/users/keyboards_users.py
from typing import TYPE_CHECKING, List, Set, Dict, Optional
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from loguru import logger

from core.ui.callback_data_factories import AdminUsersPanelNavigate, AdminMainMenuNavigate
from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_back_to_admin_main_menu_button
from core.rbac.service import (
    PERMISSION_CORE_USERS_ASSIGN_ROLES, 
    PERMISSION_CORE_USERS_MANAGE_STATUS,
    PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS, # <--- –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢
    DEFAULT_ROLE_USER 
)

if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession
    from core.database.core_models import User as DBUser, Role as DBRole, Permission as DBPermission


USERS_MGMT_TEXTS = {
    "user_list_title_template": ADMIN_COMMON_TEXTS.get("user_list_title_template", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–°—Ç—Ä. {current_page}/{total_pages})"),
    "user_details_title": ADMIN_COMMON_TEXTS.get("user_details_title", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"),
    "user_action_change_roles": ADMIN_COMMON_TEXTS.get("user_action_change_roles", "–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª–∏"),
    "user_action_toggle_active": ADMIN_COMMON_TEXTS.get("user_action_toggle_active", "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {status}"),
    "user_action_toggle_blocked": ADMIN_COMMON_TEXTS.get("user_action_toggle_blocked", "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞: {status}"),
    "edit_roles_for_user": ADMIN_COMMON_TEXTS.get("edit_roles_for_user", "–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π –¥–ª—è: {user_name}"),
    "back_to_user_details": ADMIN_COMMON_TEXTS.get("back_to_user_details", "‚¨ÖÔ∏è –ö –¥–µ—Ç–∞–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"),
    "user_is_owner_text": ADMIN_COMMON_TEXTS.get("user_is_owner_text", "üëë –í–ª–∞–¥–µ–ª–µ—Ü —Å–∏—Å—Ç–µ–º—ã (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π)"),
    "user_action_direct_perms": "üíé –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è",
    # –¢–µ–∫—Å—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    "edit_direct_perms_for_user": "üíé –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è: {user_name}",
    "perm_status_direct": "‚úÖ (–ø—Ä—è–º–æ–µ)",
    "perm_status_role": "‚òëÔ∏è (—á–µ—Ä–µ–∑ —Ä–æ–ª—å)",
    "perm_status_none": "‚¨ú (–Ω–µ—Ç)",
    "back_to_direct_perm_categories": "‚¨ÖÔ∏è –ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (–¥–ª—è —é–∑–µ—Ä–∞)",
    "back_to_direct_perm_core_groups": "‚¨ÖÔ∏è –ö –≥—Ä—É–ø–ø–∞–º –Ø–¥—Ä–∞ (–¥–ª—è —é–∑–µ—Ä–∞)",
    "back_to_direct_perm_module_list": "‚¨ÖÔ∏è –ö –º–æ–¥—É–ª—è–º (–¥–ª—è —é–∑–µ—Ä–∞)",
}


async def get_admin_users_list_keyboard_local( 
    users_on_page: List['DBUser'],
    total_pages: int,
    current_page: int,
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    if not users_on_page and current_page == 1:
        builder.button(text="–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data=AdminUsersPanelNavigate(action="dummy_no_users").pack())
    else:
        for user_obj in users_on_page:
            user_display = f"{user_obj.full_name}"
            if user_obj.username: user_display += f" (@{user_obj.username})"
            else: user_display += f" (ID: {user_obj.telegram_id})"
            
            status_icons = ["üí§" if not user_obj.is_active else "", "üö´" if user_obj.is_bot_blocked else ""]
            status_prefix = "".join(filter(None, status_icons)) + " " if any(status_icons) else ""

            builder.button(
                text=f"{status_prefix}{user_display}",
                callback_data=AdminUsersPanelNavigate(action="view", item_id=user_obj.id).pack()
            )
        builder.adjust(1)

    if total_pages > 1:
        pagination_row = []
        if current_page > 1:
            pagination_row.append(InlineKeyboardButton(
                text=ADMIN_COMMON_TEXTS["pagination_prev"],
                callback_data=AdminUsersPanelNavigate(action="list", page=current_page - 1).pack()
            ))
        pagination_row.append(InlineKeyboardButton(
            text=f"{current_page}/{total_pages}",
            callback_data=AdminUsersPanelNavigate(action="dummy_page").pack() 
        ))
        if current_page < total_pages:
            pagination_row.append(InlineKeyboardButton(
                text=ADMIN_COMMON_TEXTS["pagination_next"],
                callback_data=AdminUsersPanelNavigate(action="list", page=current_page + 1).pack()
            ))
        if pagination_row:
            builder.row(*pagination_row)

    builder.row(get_back_to_admin_main_menu_button())
    return builder.as_markup()


async def get_admin_user_details_keyboard_local( 
    target_user: 'DBUser', 
    services: 'BotServicesProvider',
    current_admin_tg_id: int, 
    session: 'AsyncSession'
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    rbac = services.rbac
    current_admin_is_owner = current_admin_tg_id in services.config.core.super_admins
    target_user_is_owner = target_user.telegram_id in services.config.core.super_admins

    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –£–°–õ–û–í–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–ù–û–ü–ö–ò "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è" ---
    can_manage_direct_perms = False
    if not target_user_is_owner: # –ù–µ–ª—å–∑—è —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∞–≤–∞–º–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞
        if current_admin_is_owner: # –í–ª–∞–¥–µ–ª–µ—Ü –∫–æ–Ω—Ñ–∏–≥–∞ –º–æ–∂–µ—Ç –≤—Å—ë (–∫—Ä–æ–º–µ –ø—Ä–∞–≤ –¥—Ä—É–≥–∏—Ö –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤)
            can_manage_direct_perms = True
        else:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS
            if await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_USERS_MANAGE_DIRECT_PERMISSIONS):
                can_manage_direct_perms = True
    
    if can_manage_direct_perms:
    # --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
        builder.button(
            text=USERS_MGMT_TEXTS["user_action_direct_perms"],
            callback_data=AdminUsersPanelNavigate(action="edit_direct_perms_start", item_id=target_user.id).pack()
        )

    if not target_user_is_owner: 
        if current_admin_is_owner or \
           await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_USERS_ASSIGN_ROLES):
            builder.button(
                text=USERS_MGMT_TEXTS["user_action_change_roles"],
                callback_data=AdminUsersPanelNavigate(action="edit_roles_start", item_id=target_user.id).pack()
            )

        if current_admin_is_owner or \
           await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_USERS_MANAGE_STATUS):
            active_status_text = "–í—ã–∫–ª üí§" if target_user.is_active else "–í–∫–ª ‚úÖ" 
            builder.button(
                text=USERS_MGMT_TEXTS["user_action_toggle_active"].format(status=active_status_text),
                callback_data=AdminUsersPanelNavigate(action="toggle_active", item_id=target_user.id).pack()
            )
            blocked_status_text = "–î–∞ üö´" if target_user.is_bot_blocked else "–ù–µ—Ç ‚úÖ" 
            builder.button(
                text=USERS_MGMT_TEXTS["user_action_toggle_blocked"].format(status=blocked_status_text),
                callback_data=AdminUsersPanelNavigate(action="toggle_blocked", item_id=target_user.id).pack()
            )
    
    if builder.export(): 
        builder.adjust(1)

    builder.row(InlineKeyboardButton(
        text="‚¨ÖÔ∏è –ö —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
        callback_data=AdminUsersPanelNavigate(action="list", page=1).pack() 
    ))
    builder.row(get_back_to_admin_main_menu_button())
    return builder.as_markup()

async def get_admin_user_edit_roles_keyboard_local( 
    target_user: 'DBUser',
    all_system_roles: List['DBRole'],
    services: 'BotServicesProvider',
    current_admin_tg_id: int,
    session: 'AsyncSession'
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    rbac = services.rbac
    current_admin_is_owner = current_admin_tg_id in services.config.core.super_admins

    target_user_role_ids: Set[int] = {role.id for role in target_user.roles if role.id is not None}

    for role in sorted(all_system_roles, key=lambda r: r.name):
        if role.id is None: continue 

        is_assigned = role.id in target_user_role_ids
        prefix = "‚úÖ " if is_assigned else "‚¨ú "
        
        can_toggle_this_role = False
        if current_admin_is_owner:
            can_toggle_this_role = True
        elif await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_USERS_ASSIGN_ROLES):
            if role.name == DEFAULT_ROLE_USER and is_assigned and len(target_user.roles) == 1:
                can_toggle_this_role = False
                prefix = "üîí " 
            else:
                can_toggle_this_role = True
        
        if can_toggle_this_role:
            builder.button(
                text=f"{prefix}{role.name}",
                callback_data=AdminUsersPanelNavigate(
                    action="toggle_role", 
                    item_id=target_user.id, 
                    role_id=role.id 
                ).pack()
            )
        else: 
            builder.button(
                text=f"{prefix}{role.name} (–Ω–µ—Ç –ø—Ä–∞–≤)", 
                callback_data=AdminUsersPanelNavigate(action="dummy_cant_toggle").pack() 
            )

    builder.adjust(1)
    builder.row(InlineKeyboardButton(
        text=USERS_MGMT_TEXTS["back_to_user_details"], 
        callback_data=AdminUsersPanelNavigate(action="view", item_id=target_user.id).pack()
    ))
    return builder.as_markup()

# --- –ù–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä—è–º—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
async def get_user_direct_perms_keyboard(
    target_user: 'DBUser', # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —á—å–∏ –ø—Ä–∞–≤–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è
    services: 'BotServicesProvider',
    current_admin_tg_id: int, # –ê–¥–º–∏–Ω, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç
    session: 'AsyncSession',
    all_system_permissions: List['DBPermission'], # –í—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ FSM –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:
    category_key: Optional[str] = None,
    entity_name: Optional[str] = None,
    page: int = 1,
    perms_per_page: int = 7 
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = USERS_MGMT_TEXTS 
    
    user_direct_perm_ids: Set[int] = {perm.id for perm in target_user.direct_permissions if perm.id is not None}
    user_role_perm_ids: Set[int] = set()
    for role in target_user.roles:
        if role.permissions:
            user_role_perm_ids.update(p.id for p in role.permissions if p.id is not None)

    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ –¥–µ—Ç–∞–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    builder.row(InlineKeyboardButton(
        text=texts["back_to_user_details"],
        callback_data=AdminUsersPanelNavigate(action="view", item_id=target_user.id).pack()
    ))

    # --- –£—Ä–æ–≤–µ–Ω—å 1: –í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (–Ø–¥—Ä–æ / –ú–æ–¥—É–ª–∏) ---
    if not category_key:
        builder.button(
            text=ADMIN_COMMON_TEXTS["perm_category_core"], # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="core", page=1).pack()
        )
        module_perms_exist = any(not p.name.startswith("core.") for p in all_system_permissions)
        if module_perms_exist:
            builder.button(
                text=ADMIN_COMMON_TEXTS["perm_category_modules"],
                callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="module", page=1).pack()
            )
        builder.adjust(1)
        return builder.as_markup()

    # --- –£—Ä–æ–≤–µ–Ω—å 2 –∏ 3: –í—ã–±–æ—Ä –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏/–º–æ–¥—É–ª—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π ---
    permissions_to_display_final: List['DBPermission'] = []
    
    if category_key == "core":
        CORE_PERM_GROUPS_MAP_USERS: Dict[str, str] = { # –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã, —Ç.–∫. –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ä–æ–ª–µ–π
            "users": USERS_MGMT_TEXTS.get("perm_core_group_users", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–Ø–¥—Ä–æ)"), 
            "roles": USERS_MGMT_TEXTS.get("perm_core_group_roles", "–†–æ–ª–∏ (–Ø–¥—Ä–æ)"),
            # ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ, –∫–æ–ø–∏—Ä—É–µ–º –∏–∑ ADMIN_COMMON_TEXTS –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–¥–µ—Å—å
            "modules_core": ADMIN_COMMON_TEXTS["perm_core_group_modules_core"], 
            "system": ADMIN_COMMON_TEXTS["perm_core_group_system"],
            "settings_core": ADMIN_COMMON_TEXTS["perm_core_group_settings_core"], 
            "other": ADMIN_COMMON_TEXTS["perm_core_group_other"]
        }
        CORE_PERM_PREFIXES_MAP_USERS: Dict[str, str] = { # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ
            "users": "core.users.", "roles": "core.roles.", "modules_core": "core.modules.",
            "system": "core.system.", "settings_core": "core.settings."
        }

        if not entity_name: # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —è–¥—Ä–∞
            for group_key, group_display_name in CORE_PERM_GROUPS_MAP_USERS.items():
                prefix_to_check = CORE_PERM_PREFIXES_MAP_USERS.get(group_key)
                has_perms_in_group = False
                if prefix_to_check:
                    if any(p.name.startswith(prefix_to_check) for p in all_system_permissions): has_perms_in_group = True
                elif group_key == "other": 
                    known_prefixes = list(CORE_PERM_PREFIXES_MAP_USERS.values())
                    if any(p.name.startswith("core.") and not any(p.name.startswith(kp) for kp in known_prefixes) for p in all_system_permissions): has_perms_in_group = True
                if has_perms_in_group:
                    builder.button(text=group_display_name, callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="core", entity_name=group_key, page=1).pack())
            builder.adjust(1)
            builder.row(InlineKeyboardButton(text=texts["back_to_direct_perm_categories"], callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id).pack()))
        else: # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —è–¥—Ä–∞
            if entity_name == "other":
                known_prefixes = list(CORE_PERM_PREFIXES_MAP_USERS.values())
                permissions_to_display_final = [p for p in all_system_permissions if p.name.startswith("core.") and not any(p.name.startswith(kp) for kp in known_prefixes)]
            elif entity_name in CORE_PERM_PREFIXES_MAP_USERS:
                prefix = CORE_PERM_PREFIXES_MAP_USERS[entity_name]
                permissions_to_display_final = [p for p in all_system_permissions if p.name.startswith(prefix)]
            builder.row(InlineKeyboardButton(text=texts["back_to_direct_perm_core_groups"], callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="core").pack()))

    elif category_key == "module":
        if not services.modules: 
            builder.button(text="–û—à–∏–±–∫–∞: –ó–∞–≥—Ä—É–∑—á–∏–∫ –º–æ–¥—É–ª–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.", callback_data="dummy_error_no_module_loader"); return builder.as_markup()
        module_permissions_map: Dict[str, List['DBPermission']] = {}
        module_display_names: Dict[str, str] = {}
        for p in all_system_permissions:
            if not p.name.startswith("core."):
                module_name_candidate = p.name.split('.')[0]
                if module_name_candidate not in module_permissions_map:
                    module_permissions_map[module_name_candidate] = []
                    mod_info = services.modules.get_module_info(module_name_candidate)
                    module_display_names[module_name_candidate] = mod_info.manifest.display_name if mod_info and mod_info.manifest else module_name_candidate
                module_permissions_map[module_name_candidate].append(p)
        if not entity_name: 
            sorted_module_names = sorted(module_permissions_map.keys())
            if not sorted_module_names: builder.button(text=ADMIN_COMMON_TEXTS["no_modules_with_perms"], callback_data="dummy_no_mod_perms_for_user")
            else:
                for mod_name in sorted_module_names:
                    builder.button(text=f"üß© {module_display_names.get(mod_name, mod_name)}", callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="module", entity_name=mod_name, page=1).pack())
            builder.adjust(1)
            builder.row(InlineKeyboardButton(text=texts["back_to_direct_perm_categories"], callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id).pack()))
        else: 
            permissions_to_display_final = module_permissions_map.get(entity_name, [])
            builder.row(InlineKeyboardButton(text=texts["back_to_direct_perm_module_list"], callback_data=AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key="module").pack()))
    
    if permissions_to_display_final:
        permissions_to_display_final.sort(key=lambda p: p.name)
        total_perms_in_list = len(permissions_to_display_final)
        total_perm_pages = (total_perms_in_list + perms_per_page - 1) // perms_per_page
        total_perm_pages = max(1, total_perm_pages)
        current_perm_page = max(1, min(page, total_perm_pages))
        start_idx = (current_perm_page - 1) * perms_per_page
        end_idx = start_idx + perms_per_page
        paginated_perms = permissions_to_display_final[start_idx:end_idx]

        if not paginated_perms and current_perm_page == 1:
            builder.button(text=ADMIN_COMMON_TEXTS["no_permissions_in_group"], callback_data="dummy_no_perms_in_group_for_user")
        else:
            for perm in paginated_perms:
                if perm.id is None: continue
                status_prefix = texts["perm_status_none"] # ‚¨ú
                is_direct = perm.id in user_direct_perm_ids
                is_via_role = perm.id in user_role_perm_ids

                if is_direct:
                    status_prefix = texts["perm_status_direct"] # ‚úÖ
                elif is_via_role: # –ù–µ –ø—Ä—è–º–æ–µ, –Ω–æ —á–µ—Ä–µ–∑ —Ä–æ–ª—å
                    status_prefix = texts["perm_status_role"] # ‚òëÔ∏è
                
                button_text = f"{status_prefix} {perm.name}"
                
                can_toggle_locally = not (is_via_role and not is_direct)

                if can_toggle_locally:
                    builder.button(
                        text=button_text,
                        callback_data=AdminUsersPanelNavigate(
                            action="toggle_direct_perm", 
                            item_id=target_user.id, 
                            permission_id=perm.id,
                            category_key=category_key, 
                            entity_name=entity_name, 
                            page=current_perm_page
                        ).pack()
                    )
                else: 
                    builder.button(
                        text=button_text,
                        callback_data=AdminUsersPanelNavigate(action="dummy_perm_via_role").pack()
                    )
            builder.adjust(1)

            if total_perm_pages > 1:
                pagination_row_perms = []
                nav_cb_data_base = AdminUsersPanelNavigate(action="direct_perms_nav", item_id=target_user.id, category_key=category_key, entity_name=entity_name)
                if current_perm_page > 1: pagination_row_perms.append(InlineKeyboardButton(text=ADMIN_COMMON_TEXTS["pagination_prev"], callback_data=nav_cb_data_base.model_copy(update={"page": current_perm_page - 1}).pack()))
                pagination_row_perms.append(InlineKeyboardButton(text=f"{current_perm_page}/{total_perm_pages}", callback_data="dummy_direct_perm_page"))
                if current_perm_page < total_perm_pages: pagination_row_perms.append(InlineKeyboardButton(text=ADMIN_COMMON_TEXTS["pagination_next"], callback_data=nav_cb_data_base.model_copy(update={"page": current_perm_page + 1}).pack()))
                if pagination_row_perms: builder.row(*pagination_row_perms)
    elif entity_name: 
        builder.button(text=ADMIN_COMMON_TEXTS["no_permissions_in_group"], callback_data="dummy_no_perms_in_group_for_user_entity")

    builder.row(get_back_to_admin_main_menu_button())
    return builder.as_markup()

def get_admin_main_menu_keyboard_placeholder() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    builder.button(text="–í—Ä–µ–º–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞", callback_data="temp")
    return builder.as_markup()


======================================================================

------------------------------ FILE: core/admin/users/__init__.py ------------------------------
# SwiftDevBot/core/admin/users/__init__.py
from aiogram import Router
from loguru import logger

# --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ò–ú–ü–û–†–¢ ---
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ core/admin/, –∞ –Ω–µ core/admin/users/
from ..filters_admin import can_view_admin_panel_filter # –ò—Å–ø–æ–ª—å–∑—É–µ–º .. –¥–ª—è –ø–æ–¥—ä–µ–º–∞ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º "–∫–æ–Ω–µ—á–Ω—ã–µ" —Ä–æ—É—Ç–µ—Ä—ã –∏–∑ —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
from .handlers_list import users_list_router
from .handlers_details import user_details_router
from .handlers_roles_assign import user_roles_assign_router
from .handlers_direct_perms import user_direct_perms_router

# –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω "—Å–æ–±–∏—Ä–∞—é—â–∏–π" —Ä–æ—É—Ç–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ "users"
section_users_router = Router(name="sdb_admin_section_users_router")

# –ú–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –∑–¥–µ—Å—å, –µ—Å–ª–∏ –æ–Ω –¥–æ–ª–∂–µ–Ω –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–∞ –≤–µ—Å—å —Ä–∞–∑–¥–µ–ª users
# section_users_router.message.filter(can_view_admin_panel_filter)
# section_users_router.callback_query.filter(can_view_admin_panel_filter)
# –û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ –≥–ª–∞–≤–Ω–æ–º—É admin_router, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω–æ,
# –Ω–æ –Ω–µ –≤—Ä–µ–¥–Ω–æ. –õ—É—á—à–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–∞–≤–∞ –∑–¥–µ—Å—å, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å.

section_users_router.include_router(users_list_router)
section_users_router.include_router(user_details_router)
section_users_router.include_router(user_roles_assign_router)
section_users_router.include_router(user_direct_perms_router)

__all__ = ["section_users_router"]


======================================================================

------------------------------ FILE: core/admin/users/handlers_roles_assign.py ------------------------------
# core/admin/users/handlers_roles_assign.py
from aiogram import Router, types, F
from aiogram.utils.markdown import hbold
from loguru import logger
from sqlalchemy.orm import selectinload
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

from core.ui.callback_data_factories import AdminUsersPanelNavigate
from .keyboards_users import get_admin_user_edit_roles_keyboard_local, USERS_MGMT_TEXTS 
from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS 
from core.admin.filters_admin import can_view_admin_panel_filter
from core.rbac.service import PERMISSION_CORE_USERS_ASSIGN_ROLES, DEFAULT_ROLE_USER
from core.database.core_models import User as DBUser, Role as DBRole
from .handlers_details import _send_or_edit_user_details_local

from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession

user_roles_assign_router = Router(name="sdb_admin_user_roles_assign_handlers")
MODULE_NAME_FOR_LOG = "AdminUserRolesAssign"

#user_roles_assign_router.callback_query.filter(can_view_admin_panel_filter)

@user_roles_assign_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "edit_roles_start"))
async def cq_admin_user_edit_roles_start_assign( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    target_user_db_id: Optional[int] = None
    if callback_data.item_id is not None:
        try: 
            target_user_db_id = int(str(callback_data.item_id))
        except ValueError:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π item_id '{callback_data.item_id}' –¥–ª—è edit_roles_start.")
            await query.answer("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", show_alert=True)
            return
    
    if target_user_db_id is None: 
        await query.answer("–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–æ–ª–µ–π –Ω–µ —É–∫–∞–∑–∞–Ω.", show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–æ–ª–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è DB ID: {target_user_db_id}")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_ASSIGN_ROLES):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return
        
        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.roles)])
        if not target_user:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return

        if target_user.telegram_id in services_provider.config.core.super_admins:
            await query.answer("–†–æ–ª–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞ —Å–∏—Å—Ç–µ–º—ã –Ω–µ –∏–∑–º–µ–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.", show_alert=True)
            await _send_or_edit_user_details_local(query, target_user, services_provider, session, admin_user_id)
            return

        all_system_roles = await services_provider.rbac.get_all_roles(session)
        text = USERS_MGMT_TEXTS["edit_roles_for_user"].format(user_name=hbold(target_user.full_name))
        keyboard = await get_admin_user_edit_roles_keyboard_local(target_user, all_system_roles, services_provider, admin_user_id, session)

        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
                await query.answer()
            except TelegramBadRequest as e_tbr: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
                if "message is not modified" not in str(e_tbr).lower(): await query.answer()
                else: logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ edit_text –¥–ª—è —Ä–æ–ª–µ–π: {e_tbr}")
            except Exception as e_edit:
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –≤ cq_admin_user_edit_roles_start_assign: {e_edit}", exc_info=True)
                await query.answer(ADMIN_COMMON_TEXTS["error_general"], show_alert=True)

@user_roles_assign_router.callback_query(AdminUsersPanelNavigate.filter(F.action == "toggle_role"))
async def cq_admin_user_toggle_role_assign( 
    query: types.CallbackQuery,
    callback_data: AdminUsersPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    target_user_db_id: Optional[int] = None
    role_to_toggle_id: Optional[int] = None

    if callback_data.item_id is not None: 
        try: 
            target_user_db_id = int(str(callback_data.item_id))
        except ValueError: 
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π item_id '{callback_data.item_id}' –¥–ª—è toggle_role.")
            pass 
    
    if callback_data.role_id is not None: 
        try: 
            role_to_toggle_id = int(str(callback_data.role_id))
        except ValueError: 
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π role_id '{callback_data.role_id}' –¥–ª—è toggle_role.")
            pass 

    if target_user_db_id is None or role_to_toggle_id is None:
        logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ ID –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–æ–ª–∏: user_id={target_user_db_id}, role_id={role_to_toggle_id}")
        await query.answer("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏.", show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –ø—ã—Ç–∞–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å ID:{role_to_toggle_id} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è DB ID:{target_user_db_id}")

    async with services_provider.db.get_session() as session:
        is_current_admin_owner = admin_user_id in services_provider.config.core.super_admins
        if not is_current_admin_owner:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_USERS_ASSIGN_ROLES):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return
        
        target_user = await session.get(DBUser, target_user_db_id, options=[selectinload(DBUser.roles)])
        role_to_modify = await session.get(DBRole, role_to_toggle_id)

        if not target_user or not role_to_modify:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return
        if target_user.telegram_id in services_provider.config.core.super_admins:
            await query.answer("–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞.", show_alert=True); return
            
        user_has_this_role = role_to_modify in target_user.roles
        if role_to_modify.name == DEFAULT_ROLE_USER and user_has_this_role and len(target_user.roles) == 1:
            await query.answer(f"–ù–µ–ª—å–∑—è —Å–Ω—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ä–æ–ª—å '{DEFAULT_ROLE_USER}'.", show_alert=True); return
        
        alert_text, action_performed = "", False
        if user_has_this_role: 
            if await services_provider.rbac.remove_role_from_user(session, target_user, role_to_modify.name):
                action_performed, alert_text = True, f"–†–æ–ª—å '{role_to_modify.name}' —Å–Ω—è—Ç–∞."
            else: alert_text = f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å —Ä–æ–ª—å '{role_to_modify.name}'."
        else: 
            if await services_provider.rbac.assign_role_to_user(session, target_user, role_to_modify.name):
                action_performed, alert_text = True, f"–†–æ–ª—å '{role_to_modify.name}' –Ω–∞–∑–Ω–∞—á–µ–Ω–∞."
            else: alert_text = f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å '{role_to_modify.name}'."
        
        if action_performed:
            try: 
                await session.commit()
                logger.info(f"[{MODULE_NAME_FOR_LOG}] {alert_text} –¥–ª—è {target_user.full_name}")
                await session.refresh(target_user, attribute_names=['roles'])
            except Exception as e: 
                await session.rollback()
                logger.error(f"–û—à–∏–±–∫–∞ commit: {e}")
                alert_text = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."
                action_performed=False 
        
        all_roles = await services_provider.rbac.get_all_roles(session) 
        keyboard_text = USERS_MGMT_TEXTS["edit_roles_for_user"].format(user_name=hbold(target_user.full_name))
        kb = await get_admin_user_edit_roles_keyboard_local(target_user, all_roles, services_provider, admin_user_id, session)
        if query.message: 
            try: 
                await query.message.edit_text(keyboard_text, reply_markup=kb) # –ò–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã keyboard_text
            except TelegramBadRequest as e_tbr: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
                if "message is not modified" not in str(e_tbr).lower():
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Ä–æ–ª–µ–π (toggle): {e_tbr}")
            except Exception as e: 
                logger.warning(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è kb —Ä–æ–ª–µ–π (toggle): {e}")
        await query.answer(alert_text, show_alert=action_performed and "–ù–µ —É–¥–∞–ª–æ—Å—å" not in alert_text)


======================================================================

------------------------------ FILE: core/admin/logs_viewer/handlers_modules.py ------------------------------
# core/admin/logs_viewer/handlers_logs.py
from aiogram import Router, types, F
from loguru import logger

from core.ui.callback_data_factories import AdminMainMenuNavigate # –ü—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –±—É–¥–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—è
from core.admin.filters_admin import can_view_admin_panel_filter
# from .keyboards_logs import ...

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider

logs_viewer_router = Router(name="sdb_admin_logs_viewer_handlers")
MODULE_NAME_FOR_LOG = "AdminLogsViewer"

#logs_viewer_router.callback_query.filter(can_view_admin_panel_filter)

# –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Ä–∞–∑–¥–µ–ª –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
# –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –≤ AdminMainMenuNavigate —É –Ω–∞—Å –±—É–¥–µ—Ç target_section="logs_view"
@logs_viewer_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "logs_view"))
async def cq_admin_logs_view_start(
    query: types.CallbackQuery,
    # callback_data: AdminMainMenuNavigate, # –ï—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏–∑ callback
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ (—Ä–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ).")
    
    # TODO: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä, PERMISSION_CORE_SYSTEM_VIEW_LOGS_BASIC
    
    # text = "üõ†Ô∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Å–∏—Å—Ç–µ–º—ã\n\n–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ."
    # keyboard = ... # –°–¥–µ–ª–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –æ–ø—Ü–∏–∏ (–≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞, —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Ç.–¥.)
    # await query.message.edit_text(text, reply_markup=keyboard)
    await query.answer("–†–∞–∑–¥–µ–ª –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.", show_alert=True)


======================================================================

------------------------------ FILE: core/admin/logs_viewer/keyboards_modules.py ------------------------------
# core/admin/logs_viewer/keyboards_logs.py
# –ü–æ–∫–∞ –ø—É—Å—Ç–æ–π, –Ω–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è –±—É–¥—É—â–µ–π –ª–æ–≥–∏–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞.
from aiogram.types import InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder
# from core.admin.keyboards_admin_common import get_back_to_admin_main_menu_button

# –ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è:
# def get_logs_viewer_main_keyboard() -> InlineKeyboardMarkup:
#     builder = InlineKeyboardBuilder()
#     # builder.button(text="–°–∫–∞—á–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–æ–≥-—Ñ–∞–π–ª", callback_data=...)
#     # builder.button(text="–í—ã–±—Ä–∞—Ç—å –ª–æ–≥-—Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞", callback_data=...)
#     # builder.row(get_back_to_admin_main_menu_button())
#     return builder.as_markup()


======================================================================

------------------------------ FILE: core/admin/logs_viewer/handlers_logs.py ------------------------------
# core/admin/logs_viewer/handlers_logs.py
from aiogram import Router, types, F
from loguru import logger

from core.ui.callback_data_factories import AdminMainMenuNavigate 
from core.admin.filters_admin import can_view_admin_panel_filter

from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider

logs_viewer_router = Router(name="sdb_admin_logs_viewer_handlers")
MODULE_NAME_FOR_LOG = "AdminLogsViewer"

#logs_viewer_router.callback_query.filter(can_view_admin_panel_filter)

@logs_viewer_router.callback_query(AdminMainMenuNavigate.filter(F.target_section == "logs_view"))
async def cq_admin_logs_view_start(
    query: types.CallbackQuery,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ (—Ä–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ).")
    await query.answer("–†–∞–∑–¥–µ–ª –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.", show_alert=True)


======================================================================

------------------------------ FILE: core/admin/logs_viewer/__init__.py ------------------------------
# core/admin/logs_viewer/__init__.py
from aiogram import Router

from .handlers_logs import logs_viewer_router 

section_logs_viewer_router = Router(name="sdb_admin_section_logs_viewer_router")
section_logs_viewer_router.include_router(logs_viewer_router)

__all__ = ["section_logs_viewer_router"]


======================================================================

------------------------------ FILE: core/admin/roles/handlers_crud_fsm.py ------------------------------
# core/admin/roles/handlers_crud_fsm.py
from aiogram import Router, types, F, Bot
from aiogram.filters import Command, StateFilter 
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup 
from aiogram.utils.markdown import hbold, hcode, hitalic
from aiogram.utils.keyboard import InlineKeyboardBuilder 
from loguru import logger
from sqlalchemy import select, func as sql_func
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

from core.ui.callback_data_factories import AdminRolesPanelNavigate
from .keyboards_roles import get_admin_roles_list_keyboard_local, ROLES_MGMT_TEXTS 
from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS 
from core.admin.filters_admin import can_view_admin_panel_filter
from core.rbac.service import PERMISSION_CORE_ROLES_CREATE, PERMISSION_CORE_ROLES_EDIT, PERMISSION_CORE_ROLES_DELETE, DEFAULT_ROLES_DEFINITIONS
from core.database.core_models import Role as DBRole, UserRole


from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession


role_crud_fsm_router = Router(name="sdb_admin_role_crud_fsm_handlers")
MODULE_NAME_FOR_LOG = "AdminRoleCRUD"

#role_crud_fsm_router.callback_query.filter(can_view_admin_panel_filter)
#role_crud_fsm_router.message.filter(can_view_admin_panel_filter)

class FSMAdminCreateRole(StatesGroup):
    waiting_for_name = State()
    waiting_for_description = State()

class FSMAdminEditRole(StatesGroup): 
    waiting_for_new_name = State()
    waiting_for_new_description = State()

@role_crud_fsm_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "create_start"))
async def cq_admin_role_create_start_fsm( 
    query: types.CallbackQuery,
    state: FSMContext,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–æ–ª–∏ (FSM).")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_CREATE):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True)
                return
    
    await state.set_state(FSMAdminCreateRole.waiting_for_name)
    
    text = (f"{ADMIN_COMMON_TEXTS.get('fsm_enter_role_name', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–æ–ª–∏:')}\n\n"
            f"{hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_cancel_role_creation', '/cancel_role_creation - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
    
    if query.message:
        try:
            await query.message.edit_text(text, reply_markup=None) 
        except TelegramBadRequest as e: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è FSM (create_start): {e}. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ.")
            await query.bot.send_message(query.from_user.id, text) 
        except Exception as e_fatal:
            logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ cq_admin_role_create_start_fsm –ø—Ä–∏ edit/send: {e_fatal}")
            await query.answer(ADMIN_COMMON_TEXTS["error_general"], show_alert=True)
    else: 
        await query.bot.send_message(query.from_user.id, text) 
    await query.answer()


@role_crud_fsm_router.message(StateFilter(FSMAdminCreateRole.waiting_for_name), F.text)
async def process_fsm_role_name_crud( 
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = message.from_user.id
    role_name = message.text.strip() if message.text else ""

    if not role_name:
        await message.reply(ADMIN_COMMON_TEXTS.get('fsm_role_name_empty', '–ò–º—è —Ä–æ–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.'))
        return

    async with services_provider.db.get_session() as session:
        existing_role = await services_provider.rbac._get_role_by_name(session, role_name) 
        if existing_role:
            await message.reply(ADMIN_COMMON_TEXTS.get('fsm_role_name_taken','–†–æ–ª—å —Å –∏–º–µ–Ω–µ–º "{role_name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.').format(role_name=hcode(role_name)))
            return
            
    await state.update_data(new_role_name=role_name)
    await state.set_state(FSMAdminCreateRole.waiting_for_description)
    
    text = (f"{ADMIN_COMMON_TEXTS.get('fsm_enter_role_description','–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name}:').format(role_name=hcode(role_name))}\n\n"
            f"{hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_skip_description','/skip_description - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'))} –∏–ª–∏ {hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_cancel_role_creation','/cancel_role_creation - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
    await message.answer(text)


@role_crud_fsm_router.message(StateFilter(FSMAdminCreateRole.waiting_for_description), F.text)
async def process_fsm_role_description_crud( 
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider',
    bot: Bot 
):
    admin_user_id = message.from_user.id
    
    if message.text and message.text.lower() == "/skip_description": 
        role_description = None
    else:
        role_description = message.text.strip() if message.text else None

    user_data = await state.get_data()
    role_name = user_data.get("new_role_name")

    if not role_name: 
        logger.error(f"[{MODULE_NAME_FOR_LOG}] FSM: –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–º—è —Ä–æ–ª–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è.")
        await message.answer(ADMIN_COMMON_TEXTS["error_general"])
        await state.clear()
        from .handlers_list import cq_admin_roles_list_entry 
        chat_id_for_reply = message.chat.id
        dummy_message_for_cb = types.Message(message_id=0, chat=types.Chat(id=chat_id_for_reply, type="private"), date=0) 
        await cq_admin_roles_list_entry(
            types.CallbackQuery(id="dummy_fsm_error_cb", from_user=message.from_user, chat_instance=str(chat_id_for_reply), data="dummy", message=dummy_message_for_cb), 
            AdminRolesPanelNavigate(action="list"), services_provider, bot
        )
        return

    async with services_provider.db.get_session() as session:
        created_role = await services_provider.rbac.get_or_create_role(session, role_name, role_description)
        if created_role:
            try:
                await session.commit()
                logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–ª —Ä–æ–ª—å: '{role_name}'.")
                await message.answer(ADMIN_COMMON_TEXTS.get('fsm_role_created_successfully','–†–æ–ª—å "{role_name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!').format(role_name=hcode(role_name)))
            except Exception as e_commit:
                await session.rollback()
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ commit –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–æ–ª–∏ '{role_name}': {e_commit}", exc_info=True)
                await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏.")
        else:
            await message.answer("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")
        
        await state.clear()
        from .handlers_list import cq_admin_roles_list_entry 
        chat_id_for_reply = message.chat.id
        dummy_message_for_cb = types.Message(message_id=0, chat=types.Chat(id=chat_id_for_reply, type="private"), date=0)
        await cq_admin_roles_list_entry(
            types.CallbackQuery(id="dummy_fsm_create_cb", from_user=message.from_user, chat_instance=str(chat_id_for_reply), data="dummy", message=dummy_message_for_cb), 
            AdminRolesPanelNavigate(action="list"), services_provider, bot
        )

@role_crud_fsm_router.message(Command("cancel_role_creation"), StateFilter(FSMAdminCreateRole))
async def cancel_create_role_fsm_command(
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider', 
    bot: Bot
):
    admin_user_id = message.from_user.id
    current_fsm_state = await state.get_state()
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –æ—Ç–º–µ–Ω–∏–ª —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è {current_fsm_state} –∫–æ–º–∞–Ω–¥–æ–π.")
    await state.clear()
    await message.answer(ADMIN_COMMON_TEXTS.get('fsm_role_creation_cancelled', "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ."))
    
    from .handlers_list import cq_admin_roles_list_entry
    chat_id_for_reply = message.chat.id
    dummy_message_for_cb = types.Message(message_id=0, chat=types.Chat(id=chat_id_for_reply, type="private"), date=0)
    await cq_admin_roles_list_entry(
        types.CallbackQuery(id="dummy_fsm_cancel_cb", from_user=message.from_user, chat_instance=str(chat_id_for_reply), data="dummy", message=dummy_message_for_cb), 
        AdminRolesPanelNavigate(action="list"), services_provider, bot
    )

@role_crud_fsm_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "edit_start"))
async def cq_admin_role_edit_start_fsm( 
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    state: FSMContext,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    role_id_to_edit = callback_data.item_id

    if role_id_to_edit is None or not str(role_id_to_edit).isdigit(): 
        await query.answer("–û—à–∏–±–∫–∞: ID —Ä–æ–ª–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.", show_alert=True); return
    
    role_id_to_edit = int(str(role_id_to_edit)) 

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ ID: {role_id_to_edit} (FSM).")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_EDIT):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return
        
        role_to_edit = await session.get(DBRole, role_id_to_edit)
        if not role_to_edit:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return

        await state.update_data(
            editing_role_id=role_to_edit.id,
            current_role_name=role_to_edit.name,
            current_role_description=role_to_edit.description or "" 
        )

        title_text = ADMIN_COMMON_TEXTS.get('fsm_edit_role_title','–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏: {role_name}').format(role_name=hcode(role_to_edit.name))
        
        if role_to_edit.name in DEFAULT_ROLES_DEFINITIONS:
            await state.set_state(FSMAdminEditRole.waiting_for_new_description)
            prompt_text = (f"{title_text}\n"
                           f"{ADMIN_COMMON_TEXTS.get('fsm_edit_role_name_not_allowed','–ò–º—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ä–æ–ª–∏ {role_name} –∏–∑–º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è.').format(role_name=hcode(role_to_edit.name))}\n\n"
                           f"{ADMIN_COMMON_TEXTS.get('fsm_enter_new_role_description','–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name} (—Ç–µ–∫—É—â–µ–µ: {current_description}):').format(role_name=hcode(role_to_edit.name), current_description=hitalic(role_to_edit.description or '–ø—É—Å—Ç–æ'))}\n\n"
                           f"{hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_skip_description','/skip_description - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'))} –∏–ª–∏ {hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_cancel_role_edit','/cancel_role_edit - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
        else:
            await state.set_state(FSMAdminEditRole.waiting_for_new_name)
            prompt_text = (f"{title_text}\n"
                           f"{ADMIN_COMMON_TEXTS.get('fsm_enter_new_role_name','–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è —Ä–æ–ª–∏ (—Ç–µ–∫—É—â–µ–µ: {current_name}):').format(current_name=hcode(role_to_edit.name))}\n\n"
                           f"{hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_skip_name','/skip_name - –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å'))} –∏–ª–∏ {hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_cancel_role_edit','/cancel_role_edit - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
    
    if query.message:
        try:
            await query.message.edit_text(prompt_text, reply_markup=None) 
        except TelegramBadRequest as e: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è FSM (edit_start): {e}. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ.")
            await query.bot.send_message(query.from_user.id, prompt_text) 
    else:
        await query.bot.send_message(query.from_user.id, prompt_text) 
    await query.answer()


@role_crud_fsm_router.message(StateFilter(FSMAdminEditRole.waiting_for_new_name), F.text)
async def process_fsm_edit_role_name_crud( 
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider'
):
    admin_user_id = message.from_user.id
    new_role_name_input = message.text.strip() if message.text else ""
    
    user_data = await state.get_data()
    current_role_name = user_data.get("current_role_name")
    role_id = user_data.get("editing_role_id")

    final_role_name = current_role_name 

    if new_role_name_input.lower() == "/skip_name":
        logger.info(f"[{MODULE_NAME_FOR_LOG}] FSM Edit Role: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {admin_user_id} –ø—Ä–æ–ø—É—Å—Ç–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –¥–ª—è —Ä–æ–ª–∏ ID {role_id}.")
    elif not new_role_name_input:
        await message.reply(ADMIN_COMMON_TEXTS.get('fsm_role_name_empty', '–ò–º—è —Ä–æ–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.'))
        return
    elif new_role_name_input != current_role_name:
        async with services_provider.db.get_session() as session:
            existing_role_with_new_name = await services_provider.rbac._get_role_by_name(session, new_role_name_input)
            if existing_role_with_new_name and existing_role_with_new_name.id != role_id:
                await message.reply(ADMIN_COMMON_TEXTS.get('fsm_role_name_taken','–†–æ–ª—å —Å –∏–º–µ–Ω–µ–º "{role_name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.').format(role_name=hcode(new_role_name_input)))
                return
        final_role_name = new_role_name_input
        logger.info(f"[{MODULE_NAME_FOR_LOG}] FSM Edit Role: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {admin_user_id} –≤–≤–µ–ª –Ω–æ–≤–æ–µ –∏–º—è '{final_role_name}' –¥–ª—è —Ä–æ–ª–∏ ID {role_id}.")
    
    await state.update_data(edited_role_name=final_role_name) 
    await state.set_state(FSMAdminEditRole.waiting_for_new_description)
    
    current_description = user_data.get("current_role_description", "–ø—É—Å—Ç–æ")
    text = (f"{ADMIN_COMMON_TEXTS.get('fsm_enter_new_role_description','–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ {role_name} (—Ç–µ–∫—É—â–µ–µ: {current_description}):').format(role_name=hcode(final_role_name), current_description=hitalic(current_description))}\n\n"
            f"{hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_skip_description','/skip_description - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'))} –∏–ª–∏ {hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_cancel_role_edit','/cancel_role_edit - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
    await message.answer(text)


@role_crud_fsm_router.message(StateFilter(FSMAdminEditRole.waiting_for_new_description), F.text)
async def process_fsm_edit_role_description_crud( 
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider',
    bot: Bot
):
    admin_user_id = message.from_user.id
    new_role_description_input = message.text.strip() if message.text else None

    user_data = await state.get_data()
    role_id = user_data.get("editing_role_id")
    final_role_name = user_data.get("edited_role_name", user_data.get("current_role_name")) 
    current_role_description = user_data.get("current_role_description")

    final_role_description = current_role_description 
    if new_role_description_input and new_role_description_input.lower() == "/skip_description":
        final_role_description = current_role_description if current_role_description is not None else None 
        logger.info(f"[{MODULE_NAME_FOR_LOG}] FSM Edit Role: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {admin_user_id} –ø—Ä–æ–ø—É—Å—Ç–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ä–æ–ª–∏ ID {role_id}.")
    elif new_role_description_input is not None: 
        final_role_description = new_role_description_input if new_role_description_input else None 
        logger.info(f"[{MODULE_NAME_FOR_LOG}] FSM Edit Role: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {admin_user_id} –≤–≤–µ–ª –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏ ID {role_id}.")

    if role_id is None or final_role_name is None: 
        logger.error(f"[{MODULE_NAME_FOR_LOG}] FSM Edit: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID —Ä–æ–ª–∏ –∏–ª–∏ –∏–º—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏.")
        await message.answer(ADMIN_COMMON_TEXTS["error_general"])
        await state.clear()
        return

    async with services_provider.db.get_session() as session:
        role_to_update = await session.get(DBRole, role_id)
        if not role_to_update:
            await message.answer(ADMIN_COMMON_TEXTS["not_found_generic"])
            await state.clear()
            return
        
        made_changes = False
        if role_to_update.name != final_role_name and role_to_update.name not in DEFAULT_ROLES_DEFINITIONS:
            if final_role_name != user_data.get("current_role_name"): 
                existing_role_check = await services_provider.rbac._get_role_by_name(session, final_role_name)
                if existing_role_check and existing_role_check.id != role_id:
                    await message.reply(ADMIN_COMMON_TEXTS.get('fsm_role_name_taken','–†–æ–ª—å —Å –∏–º–µ–Ω–µ–º "{role_name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.').format(role_name=hcode(final_role_name)))
                    await state.set_state(FSMAdminEditRole.waiting_for_new_name)
                    current_name_for_prompt = user_data.get("current_role_name")
                    title_text = ADMIN_COMMON_TEXTS.get('fsm_edit_role_title','–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏: {role_name}').format(role_name=hcode(current_name_for_prompt))
                    prompt_text = (f"{title_text}\n"
                                   f"{ADMIN_COMMON_TEXTS.get('fsm_enter_new_role_name','–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è —Ä–æ–ª–∏ (—Ç–µ–∫—É—â–µ–µ: {current_name}):').format(current_name=hcode(current_name_for_prompt))}\n\n"
                                   f"{hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_skip_name','/skip_name - –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å'))} –∏–ª–∏ {hitalic(ADMIN_COMMON_TEXTS.get('fsm_command_cancel_role_edit','/cancel_role_edit - –û—Ç–º–µ–Ω–∏—Ç—å'))}")
                    await message.answer(prompt_text)
                    return
            role_to_update.name = final_role_name
            made_changes = True
        elif role_to_update.name != final_role_name and role_to_update.name in DEFAULT_ROLES_DEFINITIONS:
            logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ä–æ–ª–∏ '{role_to_update.name}' –Ω–∞ '{final_role_name}'. –ò–º—è –Ω–µ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–æ.")
        
        if role_to_update.description != final_role_description:
            role_to_update.description = final_role_description
            made_changes = True
        
        if made_changes:
            session.add(role_to_update)
            try:
                await session.commit()
                logger.info(f"[{MODULE_NAME_FOR_LOG}] –†–æ–ª—å ID {role_id} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞. –ò–º—è: '{role_to_update.name}', –æ–ø–∏—Å–∞–Ω–∏–µ: '{role_to_update.description}'.")
                await message.answer(ADMIN_COMMON_TEXTS.get('fsm_role_updated_successfully','–†–æ–ª—å "{role_name}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!').format(role_name=hcode(role_to_update.name)))
            except Exception as e_commit:
                await session.rollback()
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ commit –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–æ–ª–∏ ID {role_id}: {e_commit}", exc_info=True)
                await message.answer("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–æ–ª–∏.")
        else:
            await message.answer("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")

        await state.clear()
        from .handlers_list import cq_admin_roles_list_entry
        chat_id_for_reply = message.chat.id
        dummy_message_for_cb = types.Message(message_id=0, chat=types.Chat(id=chat_id_for_reply, type="private"), date=0)
        await cq_admin_roles_list_entry(
            types.CallbackQuery(id="dummy_fsm_edit_cb", from_user=message.from_user, chat_instance=str(chat_id_for_reply), data="dummy", message=dummy_message_for_cb), 
            AdminRolesPanelNavigate(action="list"), services_provider, bot
        )

@role_crud_fsm_router.message(Command("cancel_role_edit"), StateFilter(FSMAdminEditRole))
async def cancel_edit_role_fsm_command_crud( 
    message: types.Message, 
    state: FSMContext, 
    services_provider: 'BotServicesProvider', 
    bot: Bot
):
    admin_user_id = message.from_user.id
    current_fsm_state = await state.get_state()
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –æ—Ç–º–µ–Ω–∏–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è {current_fsm_state} –∫–æ–º–∞–Ω–¥–æ–π.")
    await state.clear()
    await message.answer(ADMIN_COMMON_TEXTS.get('fsm_role_update_cancelled', "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ."))
    
    from .handlers_list import cq_admin_roles_list_entry
    chat_id_for_reply = message.chat.id
    dummy_message_for_cb = types.Message(message_id=0, chat=types.Chat(id=chat_id_for_reply, type="private"), date=0)
    await cq_admin_roles_list_entry(
        types.CallbackQuery(id="dummy_fsm_cancel_edit_cb", from_user=message.from_user, chat_instance=str(chat_id_for_reply), data="dummy", message=dummy_message_for_cb), 
        AdminRolesPanelNavigate(action="list"), services_provider, bot
    )

@role_crud_fsm_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "delete_confirm"))
async def cq_admin_role_delete_confirm_crud( 
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    services_provider: 'BotServicesProvider'
):
    admin_user_id = query.from_user.id
    role_id_to_delete = callback_data.item_id

    if role_id_to_delete is None or not str(role_id_to_delete).isdigit():
        await query.answer("–û—à–∏–±–∫–∞: ID —Ä–æ–ª–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.", show_alert=True); return
    
    role_id_to_delete = int(str(role_id_to_delete))

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–ª–∏ ID: {role_id_to_delete}.")

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_DELETE):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return

        role_to_delete = await session.get(DBRole, role_id_to_delete)
        if not role_to_delete:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return

        if role_to_delete.name in DEFAULT_ROLES_DEFINITIONS:
            await query.answer(ADMIN_COMMON_TEXTS.get('role_is_standard_cant_delete','–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ä–æ–ª—å "{role_name}" —É–¥–∞–ª—è—Ç—å –Ω–µ–ª—å–∑—è.').format(role_name=hcode(role_to_delete.name)), show_alert=True); return
        
        user_role_count_stmt = select(sql_func.count(UserRole.id)).where(UserRole.role_id == role_id_to_delete)
        user_role_count_res = await session.execute(user_role_count_stmt)
        user_count_with_role = user_role_count_res.scalar_one()

        warning_text = ""
        if user_count_with_role > 0:
            text_with_warning = (f"üö´ {hbold('–£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ!')}\n"
                                 f"–†–æ–ª—å {hcode(role_to_delete.name)} –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ {hbold(str(user_count_with_role))} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é(—è–º).\n"
                                 f"–°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∏—Ç–µ —ç—Ç—É —Ä–æ–ª—å —Å–æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
            builder = InlineKeyboardBuilder()
            builder.button(text=ROLES_MGMT_TEXTS.get('back_to_role_details', "–ù–∞–∑–∞–¥"), 
                           callback_data=AdminRolesPanelNavigate(action="view", item_id=role_id_to_delete).pack())
            if query.message: await query.message.edit_text(text_with_warning, reply_markup=builder.as_markup())
            await query.answer(f"–†–æ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è {user_count_with_role} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.", show_alert=True)
            return

        text = ADMIN_COMMON_TEXTS.get('delete_role_confirm_text','–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å {role_name}?\n{warning_if_users}\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!').format(role_name=hbold(role_to_delete.name), warning_if_users=warning_text)
        
        from core.ui.keyboards_core import get_confirm_action_keyboard 
        keyboard = get_confirm_action_keyboard(
            confirm_callback_data=AdminRolesPanelNavigate(action="delete_execute", item_id=role_id_to_delete).pack(),
            cancel_callback_data=AdminRolesPanelNavigate(action="view", item_id=role_id_to_delete).pack() 
        )
        if query.message:
            await query.message.edit_text(text, reply_markup=keyboard)
        await query.answer()


@role_crud_fsm_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "delete_execute"))
async def cq_admin_role_delete_execute_crud( 
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    services_provider: 'BotServicesProvider',
    bot: Bot
):
    admin_user_id = query.from_user.id
    role_id_to_delete = callback_data.item_id

    if role_id_to_delete is None or not str(role_id_to_delete).isdigit():
        await query.answer("–û—à–∏–±–∫–∞: ID —Ä–æ–ª–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.", show_alert=True); return
    
    role_id_to_delete = int(str(role_id_to_delete))

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —É–¥–∞–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ ID: {role_id_to_delete}.")
    
    default_fail_text = ADMIN_COMMON_TEXTS.get('role_delete_failed','–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å "{role_name}".')
    alert_text = default_fail_text.format(role_name="ID:"+str(role_id_to_delete)) 

    async with services_provider.db.get_session() as session:
        if not services_provider.config.core.super_admins or admin_user_id not in services_provider.config.core.super_admins:
            if not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_DELETE):
                await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return

        role_to_delete = await session.get(DBRole, role_id_to_delete) 
        if not role_to_delete:
            alert_text = ADMIN_COMMON_TEXTS["not_found_generic"]
        elif role_to_delete.name in DEFAULT_ROLES_DEFINITIONS:
            alert_text = ADMIN_COMMON_TEXTS.get('role_is_standard_cant_delete','–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ä–æ–ª—å "{role_name}" —É–¥–∞–ª—è—Ç—å –Ω–µ–ª—å–∑—è.').format(role_name=hcode(role_to_delete.name))
        else:
            user_role_count_stmt = select(sql_func.count(UserRole.id)).where(UserRole.role_id == role_id_to_delete)
            user_role_count_res = await session.execute(user_role_count_stmt)
            if user_role_count_res.scalar_one() > 0:
                alert_text = "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –≤—Å–µ –µ—â–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º."
            else:
                role_name_deleted = role_to_delete.name
                if await services_provider.rbac.delete_role(session, role_id_to_delete): 
                    try:
                        await session.commit()
                        alert_text = ADMIN_COMMON_TEXTS.get('role_deleted_successfully','–†–æ–ª—å "{role_name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.').format(role_name=hcode(role_name_deleted))
                        logger.info(f"[{MODULE_NAME_FOR_LOG}] {alert_text}")
                    except Exception as e_commit:
                        await session.rollback()
                        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ commit –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–æ–ª–∏: {e_commit}", exc_info=True)
                        alert_text = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–ª–∏."
                else: 
                    alert_text = default_fail_text.format(role_name=hcode(role_name_deleted))
        
        from .handlers_list import cq_admin_roles_list_entry 
        if query.message: 
            try: await query.message.delete() 
            except Exception: pass 
        
        from_user_obj = query.from_user if query.from_user else types.User(id=0, is_bot=False, first_name="Unknown")
        chat_id_for_reply = query.message.chat.id if query.message else from_user_obj.id 
        chat_instance_str = query.chat_instance or str(chat_id_for_reply) 
        
        dummy_cb_for_list = types.CallbackQuery(
            id="dummy_after_delete_cb", 
            from_user=from_user_obj, 
            chat_instance=chat_instance_str, 
            data="dummy", 
            message=None 
        )
        await cq_admin_roles_list_entry(dummy_cb_for_list, AdminRolesPanelNavigate(action="list"), services_provider, bot)

    await query.answer(alert_text, show_alert=True)


======================================================================

------------------------------ FILE: core/admin/roles/keyboards_roles.py ------------------------------
# core/admin/roles/keyboards_roles.py
from typing import TYPE_CHECKING, List, Optional, Set, Dict
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton # –£–±–µ–¥–∏–º—Å—è —á—Ç–æ types –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
from aiogram.utils.keyboard import InlineKeyboardBuilder
from loguru import logger 

from core.ui.callback_data_factories import AdminRolesPanelNavigate
from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_back_to_admin_main_menu_button
from core.rbac.service import (
    PERMISSION_CORE_ROLES_CREATE, 
    PERMISSION_CORE_ROLES_EDIT, 
    PERMISSION_CORE_ROLES_DELETE, 
    PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS,
    DEFAULT_ROLES_DEFINITIONS 
)

if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession
    from core.database.core_models import Role as DBRole, Permission as DBPermission
    from aiogram import types as AiogramTypes # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Å–µ–≤–¥–æ–Ω–∏–º, —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å —Å types –≤ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è—Ö

ROLES_MGMT_TEXTS = {
    "role_list_title": "üõ°Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏",
    "role_list_select_action": "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:",
    "role_list_no_roles": "–ù–µ—Ç —Ä–æ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",
    "role_details_title": "üõ°Ô∏è –î–µ—Ç–∞–ª–∏ —Ä–æ–ª–∏",
    "role_action_edit_permissions": "–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è",
    "role_action_edit_role": "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª—å", 
    "role_action_delete_role": "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å",    
    "back_to_roles_list": "‚¨ÖÔ∏è –ö —Å–ø–∏—Å–∫—É —Ä–æ–ª–µ–π",
    "edit_permissions_for_role": "–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ä–æ–ª–∏: {role_name}", 
    "role_action_create_role": "‚ûï –°–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å",
}


async def get_admin_roles_list_keyboard_local( 
    all_roles: List['DBRole'],
    services: Optional['BotServicesProvider'] = None, 
    user_tg_id: Optional[int] = None,          
    session: Optional['AsyncSession'] = None    
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = ROLES_MGMT_TEXTS

    logger.debug(f"[AdminRolesKeyboards] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π. –í—Å–µ–≥–æ —Ä–æ–ª–µ–π: {len(all_roles)}")
    if not all_roles:
        cb_dummy_data = AdminRolesPanelNavigate(action="dummy_no_roles").pack()
        builder.button(
            text=texts["role_list_no_roles"],
            callback_data=cb_dummy_data
        )
        logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '–Ω–µ—Ç —Ä–æ–ª–µ–π', callback: {cb_dummy_data}")
    else:
        for role in sorted(all_roles, key=lambda r: r.name):
            cb_data = AdminRolesPanelNavigate(action="view", item_id=role.id).pack()
            builder.button(
                text=f"üõ°Ô∏è {role.name}",
                callback_data=cb_data
            )
            logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –¥–ª—è —Ä–æ–ª–∏ '{role.name}' (ID: {role.id}), callback: {cb_data}")
        builder.adjust(1)
    
    if services and user_tg_id and session:
        is_owner_from_config = user_tg_id in services.config.core.super_admins
        can_create_roles = False
        try: 
            can_create_roles = is_owner_from_config or await services.rbac.user_has_permission(session, user_tg_id, PERMISSION_CORE_ROLES_CREATE)
        except Exception as e_perm_check:
            logger.error(f"[AdminRolesKeyboards] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∞ PERMISSION_CORE_ROLES_CREATE –¥–ª—è user {user_tg_id}: {e_perm_check}")

        if can_create_roles:
            cb_create_data = AdminRolesPanelNavigate(action="create_start").pack()
            builder.row( 
                InlineKeyboardButton(
                    text=texts["role_action_create_role"],
                    callback_data=cb_create_data
                )
            )
            logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '—Å–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å', callback: {cb_create_data}")

    builder.row(get_back_to_admin_main_menu_button())
    return builder.as_markup()


async def get_admin_role_details_keyboard_local( 
    target_role: 'DBRole',
    services: 'BotServicesProvider',
    current_admin_tg_id: int,
    session: 'AsyncSession'
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = ROLES_MGMT_TEXTS
    rbac = services.rbac
    current_admin_is_owner = current_admin_tg_id in services.config.core.super_admins
    logger.debug(f"[AdminRolesKeyboards] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ—Ç–∞–ª–µ–π –¥–ª—è —Ä–æ–ª–∏ '{target_role.name}' (ID: {target_role.id}). –ê–¥–º–∏–Ω: {current_admin_tg_id}, –≤–ª–∞–¥–µ–ª–µ—Ü: {current_admin_is_owner}")

    can_edit_role = False
    can_assign_perms = False
    can_delete_role = False

    try: 
        can_edit_role = current_admin_is_owner or await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_ROLES_EDIT)
        can_assign_perms = current_admin_is_owner or await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS)
        can_delete_role = current_admin_is_owner or await rbac.user_has_permission(session, current_admin_tg_id, PERMISSION_CORE_ROLES_DELETE)
    except Exception as e_perm_check_details:
        logger.error(f"[AdminRolesKeyboards] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏ {target_role.id} –∞–¥–º–∏–Ω–æ–º {current_admin_tg_id}: {e_perm_check_details}")


    if can_edit_role:
        cb_edit_data = AdminRolesPanelNavigate(action="edit_start", item_id=target_role.id).pack()
        builder.button(
            text=texts["role_action_edit_role"],
            callback_data=cb_edit_data
        )
        logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª—å', callback: {cb_edit_data}")
        
    if can_assign_perms:
        cb_edit_perms_data = AdminRolesPanelNavigate(action="edit_perms_start", item_id=target_role.id, page=1).pack()
        builder.button(
            text=texts["role_action_edit_permissions"],
            callback_data=cb_edit_perms_data
        )
        logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '–∏–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è', callback: {cb_edit_perms_data}")
    
    if target_role.name not in DEFAULT_ROLES_DEFINITIONS: 
        if can_delete_role:
            cb_delete_data = AdminRolesPanelNavigate(action="delete_confirm", item_id=target_role.id).pack()
            builder.button(
                text=texts["role_action_delete_role"],
                callback_data=cb_delete_data
            )
            logger.debug(f"[AdminRolesKeyboards] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '—É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å', callback: {cb_delete_data}")

    if builder.export(): 
        builder.adjust(1)
    
    builder.row(InlineKeyboardButton(
        text=texts["back_to_roles_list"],
        callback_data=AdminRolesPanelNavigate(action="list").pack()
    ))
    builder.row(get_back_to_admin_main_menu_button())
    return builder.as_markup()

async def get_admin_role_edit_permissions_keyboard_local( 
    target_role: 'DBRole',
    services: 'BotServicesProvider',
    current_admin_tg_id: int,
    session: 'AsyncSession',
    all_system_permissions: Optional[List['DBPermission']] = None,
    category_key: Optional[str] = None,
    entity_name: Optional[str] = None,
    page: int = 1,
    perms_per_page: int = 7 
) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    texts = ADMIN_COMMON_TEXTS 
    rbac = services.rbac
    
    role_permission_ids: Set[int] = {perm.id for perm in target_role.permissions if perm.id is not None}

    builder.row(InlineKeyboardButton(
        text=ROLES_MGMT_TEXTS.get("back_to_role_details", "‚¨ÖÔ∏è –ö –¥–µ—Ç–∞–ª—è–º —Ä–æ–ª–∏"),
        callback_data=AdminRolesPanelNavigate(action="view", item_id=target_role.id).pack()
    ))

    if not category_key:
        builder.button(
            text=texts["perm_category_core"], 
            callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="core", page=1).pack()
        )
        module_perms_exist = False
        if services.modules:
            declared_module_perms = services.modules.get_all_declared_permissions_from_active_modules()
            if declared_module_perms: module_perms_exist = True
        if module_perms_exist:
            builder.button(
                text=texts["perm_category_modules"],
                callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="module", page=1).pack()
            )
        builder.adjust(1)
        # –ù–µ –∑–∞–±—ã–≤–∞–µ–º –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥ –≤ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" –∏ –∑–¥–µ—Å—å, –µ—Å–ª–∏ —ç—Ç–æ –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        builder.row(get_back_to_admin_main_menu_button())
        return builder.as_markup()

    permissions_to_display_final: List['DBPermission'] = []
    if all_system_permissions is None: 
        all_system_permissions = await rbac.get_all_permissions(session)

    back_to_category_selection_button = InlineKeyboardButton(
        text=texts["back_to_perm_categories"], 
        callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key=None, entity_name=None, page=1).pack()
    )

    if category_key == "core":
        CORE_PERM_GROUPS_MAP_ROLES: Dict[str, str] = { 
            k: texts[f"perm_core_group_{k}"] for k in ["users", "roles", "modules_core", "system", "settings_core", "other"]
        }
        CORE_PERM_PREFIXES_MAP_ROLES: Dict[str, str] = {
            "users": "core.users.", "roles": "core.roles.", "modules_core": "core.modules.",
            "system": "core.system.", "settings_core": "core.settings."
        }
        if not entity_name: 
            for group_key, group_display_name in CORE_PERM_GROUPS_MAP_ROLES.items():
                prefix_to_check = CORE_PERM_PREFIXES_MAP_ROLES.get(group_key)
                has_perms_in_group = False
                if prefix_to_check:
                    if any(p.name.startswith(prefix_to_check) for p in all_system_permissions): has_perms_in_group = True
                elif group_key == "other": 
                    known_prefixes = list(CORE_PERM_PREFIXES_MAP_ROLES.values())
                    if any(p.name.startswith("core.") and not any(p.name.startswith(kp) for kp in known_prefixes) for p in all_system_permissions): has_perms_in_group = True
                if has_perms_in_group:
                    builder.button(text=group_display_name, callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="core", entity_name=group_key, page=1).pack())
            builder.adjust(1)
            builder.row(back_to_category_selection_button)
        else: 
            if entity_name == "other":
                known_prefixes = list(CORE_PERM_PREFIXES_MAP_ROLES.values())
                permissions_to_display_final = [p for p in all_system_permissions if p.name.startswith("core.") and not any(p.name.startswith(kp) for kp in known_prefixes)]
            elif entity_name in CORE_PERM_PREFIXES_MAP_ROLES:
                prefix = CORE_PERM_PREFIXES_MAP_ROLES[entity_name]
                permissions_to_display_final = [p for p in all_system_permissions if p.name.startswith(prefix)]
            builder.row(InlineKeyboardButton(text=texts["back_to_core_perm_groups"], callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="core", entity_name=None, page=1).pack()))
    elif category_key == "module":
        if not services.modules: 
            builder.button(text="–û—à–∏–±–∫–∞: –ó–∞–≥—Ä—É–∑—á–∏–∫ –º–æ–¥—É–ª–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.", callback_data="dummy_error_no_module_loader_perms"); return builder.as_markup() # –ò–∑–º–µ–Ω–µ–Ω–∞ dummy_data
        module_permissions_map: Dict[str, List['DBPermission']] = {}
        module_display_names: Dict[str, str] = {}
        for p in all_system_permissions:
            if not p.name.startswith("core."):
                module_name_candidate = p.name.split('.')[0]
                if module_name_candidate not in module_permissions_map:
                    module_permissions_map[module_name_candidate] = []
                    mod_info = services.modules.get_module_info(module_name_candidate)
                    module_display_names[module_name_candidate] = mod_info.manifest.display_name if mod_info and mod_info.manifest else module_name_candidate
                module_permissions_map[module_name_candidate].append(p)
        if not entity_name: 
            sorted_module_names = sorted(module_permissions_map.keys())
            if not sorted_module_names: builder.button(text=texts["no_modules_with_perms"], callback_data="dummy_no_mod_perms_for_role") # –ò–∑–º–µ–Ω–µ–Ω–∞ dummy_data
            else:
                for mod_name in sorted_module_names:
                    builder.button(text=f"üß© {module_display_names.get(mod_name, mod_name)}", callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="module", entity_name=mod_name, page=1).pack())
            builder.adjust(1)
            builder.row(back_to_category_selection_button)
        else: 
            permissions_to_display_final = module_permissions_map.get(entity_name, [])
            builder.row(InlineKeyboardButton(text=texts["back_to_module_list_for_perms"], callback_data=AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key="module", entity_name=None, page=1).pack()))
    
    if permissions_to_display_final:
        permissions_to_display_final.sort(key=lambda p: p.name)
        total_perms_in_list = len(permissions_to_display_final)
        total_perm_pages = (total_perms_in_list + perms_per_page - 1) // perms_per_page
        total_perm_pages = max(1, total_perm_pages)
        current_perm_page = max(1, min(page, total_perm_pages))
        start_idx = (current_perm_page - 1) * perms_per_page
        end_idx = start_idx + perms_per_page
        paginated_perms = permissions_to_display_final[start_idx:end_idx]
        if not paginated_perms and current_perm_page == 1: builder.button(text=texts["no_permissions_in_group"], callback_data="dummy_no_perms_in_group_for_role") # –ò–∑–º–µ–Ω–µ–Ω–∞ dummy_data
        else:
            for perm in paginated_perms:
                is_assigned = perm.id in role_permission_ids
                prefix = "‚úÖ " if is_assigned else "‚¨ú "
                button_text = f"{prefix}{perm.name}"
                if perm.id is None: continue 
                builder.button(text=button_text, callback_data=AdminRolesPanelNavigate(action="toggle_perm", item_id=target_role.id, permission_id=perm.id, category_key=category_key, entity_name=entity_name, page=current_perm_page).pack())
            builder.adjust(1)
            if total_perm_pages > 1:
                pagination_row_perms = []
                nav_cb_data_base = AdminRolesPanelNavigate(action="edit_perms_nav", item_id=target_role.id, category_key=category_key, entity_name=entity_name) 
                if current_perm_page > 1: pagination_row_perms.append(InlineKeyboardButton(text=texts["pagination_prev"], callback_data=nav_cb_data_base.model_copy(update={"page": current_perm_page - 1}).pack()))
                pagination_row_perms.append(InlineKeyboardButton(text=f"{current_perm_page}/{total_perm_pages}", callback_data="dummy_role_perm_page")) # –ò–∑–º–µ–Ω–µ–Ω–∞ dummy_data
                if current_perm_page < total_perm_pages: pagination_row_perms.append(InlineKeyboardButton(text=texts["pagination_next"], callback_data=nav_cb_data_base.model_copy(update={"page": current_perm_page + 1}).pack()))
                if pagination_row_perms: builder.row(*pagination_row_perms)
    elif entity_name: 
        builder.button(text=texts["no_permissions_in_group"], callback_data="dummy_no_perms_in_group_for_role_entity") # –ò–∑–º–µ–Ω–µ–Ω–∞ dummy_data

    builder.row(get_back_to_admin_main_menu_button())
    return builder.as_markup()


======================================================================

------------------------------ FILE: core/admin/roles/handlers_role_perms.py ------------------------------
# core/admin/roles/handlers_role_perms.py
from aiogram import Router, types, F, Bot
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.markdown import hbold
from loguru import logger
from sqlalchemy.orm import selectinload
from aiogram.filters import StateFilter # <--- –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
from core.ui.callback_data_factories import AdminRolesPanelNavigate 
from .keyboards_roles import get_admin_role_edit_permissions_keyboard_local, ROLES_MGMT_TEXTS
from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS
from core.admin.filters_admin import can_view_admin_panel_filter
from core.rbac.service import PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS
from core.database.core_models import Role as DBRole, Permission as DBPermission

from typing import TYPE_CHECKING, Optional, List
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession

role_permissions_router = Router(name="sdb_admin_role_permissions_handlers")
MODULE_NAME_FOR_LOG = "AdminRolePermissions"

#role_permissions_router.callback_query.filter(can_view_admin_panel_filter)

# --- FSM –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º —Ä–æ–ª–∏ ---
class FSMEditRolePermissions(StatesGroup):
    navigating_role_permissions = State()

# --- –í—Ö–æ–¥ –≤ FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ —Ä–æ–ª–∏ ---
@role_permissions_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "edit_perms_start"))
async def cq_admin_role_edit_permissions_entry(
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    admin_user_id = query.from_user.id
    target_role_db_id = callback_data.item_id
    page = callback_data.page or 1 

    if target_role_db_id is None:
        await query.answer("–û—à–∏–±–∫–∞: ID —Ä–æ–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω.", show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –≤—Ö–æ–¥–∏—Ç –≤ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∞–º–∏ –¥–ª—è Role ID: {target_role_db_id}, page: {page}")

    async with services_provider.db.get_session() as session:
        current_admin_is_owner = admin_user_id in services_provider.config.core.super_admins
        if not current_admin_is_owner and \
           not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS):
            await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True)
            return
        
        target_role = await session.get(DBRole, target_role_db_id, options=[selectinload(DBRole.permissions)])
        if not target_role:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return

    await state.clear()
    await state.set_state(FSMEditRolePermissions.navigating_role_permissions)
    await state.update_data(
        target_role_id_for_perms=target_role_db_id,
        current_page=page, 
        # category_key –∏ entity_name –±—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    )
    
    await _show_role_permissions_menu(query, services_provider, state)

# --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º/—Å—É—â–Ω–æ—Å—Ç—è–º/—Å—Ç—Ä–∞–Ω–∏—Ü–∞–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Ä–æ–ª–∏ ---
@role_permissions_router.callback_query(
    AdminRolesPanelNavigate.filter(F.action == "edit_perms_nav"),
    StateFilter(FSMEditRolePermissions.navigating_role_permissions)
)
async def cq_admin_role_permissions_navigate(
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    fsm_data = await state.get_data()
    target_role_db_id = fsm_data.get("target_role_id_for_perms")
    if target_role_db_id is None:
        await query.answer("–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.", show_alert=True)
        await state.clear(); return

    new_fsm_context_data = {
        "category_key": callback_data.category_key,
        "entity_name": callback_data.entity_name,
        "current_page": callback_data.page or 1
    }
    await state.update_data(**new_fsm_context_data)
    
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {query.from_user.id} –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä–∞–≤–∞–º —Ä–æ–ª–∏ (Role ID: {target_role_db_id}). "
                f"–ù–æ–≤—ã–π FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: {new_fsm_context_data}")
    
    await _show_role_permissions_menu(query, services_provider, state)

# --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ä–æ–ª–∏ ---
@role_permissions_router.callback_query(
    AdminRolesPanelNavigate.filter(F.action == "toggle_perm"),
    StateFilter(FSMEditRolePermissions.navigating_role_permissions)
)
async def cq_admin_role_toggle_permission(
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate,
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    admin_user_id = query.from_user.id
    fsm_data = await state.get_data()
    target_role_db_id: Optional[int] = fsm_data.get("target_role_id_for_perms")
    permission_to_toggle_id: Optional[int] = callback_data.permission_id

    if target_role_db_id is None or permission_to_toggle_id is None:
        await query.answer("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.", show_alert=True); return

    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –∏–∑–º–µ–Ω—è–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ "
                f"PermID:'{permission_to_toggle_id}' –¥–ª—è Role DBID:{target_role_db_id}")

    async with services_provider.db.get_session() as session:
        current_admin_is_owner = admin_user_id in services_provider.config.core.super_admins
        if not current_admin_is_owner and \
           not await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_ASSIGN_PERMISSIONS):
            await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True); return
        
        target_role = await session.get(DBRole, target_role_db_id, options=[selectinload(DBRole.permissions)])
        permission_to_modify = await session.get(DBPermission, permission_to_toggle_id)

        if not target_role or not permission_to_modify:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); return

        role_has_this_perm = permission_to_modify in target_role.permissions
        alert_text, action_performed = "", False

        if role_has_this_perm:
            if await services_provider.rbac.remove_permission_from_role(session, target_role, permission_to_modify.name):
                action_performed = True
                alert_text = f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_to_modify.name}' —Å–Ω—è—Ç–æ —Å —Ä–æ–ª–∏."
            else: alert_text = f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_to_modify.name}'."
        else:
            if await services_provider.rbac.assign_permission_to_role(session, target_role, permission_to_modify.name, auto_create_perm=False):
                action_performed = True
                alert_text = f"–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_to_modify.name}' –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–æ–ª–∏."
            else: alert_text = f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ '{permission_to_modify.name}'."
        
        if action_performed:
            try: await session.commit(); logger.info(f"[{MODULE_NAME_FOR_LOG}] {alert_text} –¥–ª—è Role ID: {target_role.id}"); await session.refresh(target_role, attribute_names=['permissions'])
            except Exception as e: await session.rollback(); logger.error(f"–û—à–∏–±–∫–∞ commit: {e}"); alert_text = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."
        
        await query.answer(alert_text, show_alert=action_performed and "–ù–µ —É–¥–∞–ª–æ—Å—å" not in alert_text)
        await _show_role_permissions_menu(query, services_provider, state)

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Ä–æ–ª–∏ ---
async def _show_role_permissions_menu(
    query: types.CallbackQuery, 
    services_provider: 'BotServicesProvider', 
    state: FSMContext
):
    admin_user_id = query.from_user.id
    fsm_data = await state.get_data()
    
    target_role_db_id = fsm_data.get("target_role_id_for_perms")
    category_key = fsm_data.get("category_key")
    entity_name = fsm_data.get("entity_name")
    page = fsm_data.get("current_page", 1)

    if target_role_db_id is None:
        await query.answer("–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM (ID —Ä–æ–ª–∏).", show_alert=True); await state.clear(); return

    async with services_provider.db.get_session() as session:
        target_role = await session.get(DBRole, target_role_db_id, options=[selectinload(DBRole.permissions)])
        if not target_role:
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True); await state.clear(); return

        all_system_permissions = await services_provider.rbac.get_all_permissions(session)
        
        base_text = ROLES_MGMT_TEXTS["edit_permissions_for_role"].format(role_name=hbold(target_role.name))
        current_level_text = ""
        if category_key == "core":
            current_level_text = f" / –Ø–¥—Ä–æ"
            if entity_name: current_level_text += f" / {ADMIN_COMMON_TEXTS.get(f'perm_core_group_{entity_name}', entity_name.capitalize())}"
        elif category_key == "module":
            current_level_text = f" / –ú–æ–¥—É–ª–∏"
            if entity_name:
                mod_info = services_provider.modules.get_module_info(entity_name)
                current_level_text += f" / {mod_info.manifest.display_name if mod_info and mod_info.manifest else entity_name}"
        
        text = f"{base_text}{current_level_text}\n–û—Ç–º–µ—Ç—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è/—Å–Ω—è—Ç–∏—è:"
        
        keyboard = await get_admin_role_edit_permissions_keyboard_local(
            target_role=target_role, 
            all_system_permissions=all_system_permissions, 
            services=services_provider, 
            current_admin_tg_id=admin_user_id, 
            session=session,
            category_key=category_key, entity_name=entity_name, page=page
        )

        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
            except types.TelegramBadRequest as e:
                if "message is not modified" not in str(e).lower(): 
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ edit_text (_show_role_permissions_menu): {e}")
            except Exception as e_edit:
                logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ _show_role_permissions_menu: {e_edit}", exc_info=True)
                if query.message: await query.answer("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.", show_alert=True)

# –í—ã—Ö–æ–¥ –∏–∑ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ —Ä–æ–ª–∏ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ö –¥–µ—Ç–∞–ª—è–º —Ä–æ–ª–∏")
@role_permissions_router.callback_query(
    AdminRolesPanelNavigate.filter(F.action == "view"), 
    StateFilter(FSMEditRolePermissions.navigating_role_permissions) 
)
async def cq_back_to_role_details_from_perms_fsm(
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate, 
    services_provider: 'BotServicesProvider',
    state: FSMContext
):
    await state.clear() 
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {query.from_user.id} –≤—ã—à–µ–ª –∏–∑ FSM —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ —Ä–æ–ª–∏.")
    from .handlers_details import cq_admin_role_view_details_entry
    await cq_admin_role_view_details_entry(query, callback_data, services_provider)


======================================================================

------------------------------ FILE: core/admin/roles/handlers_details.py ------------------------------
# core/admin/roles/handlers_details.py
from aiogram import Router, types, F, Bot
from aiogram.utils.markdown import hbold, hcode, hitalic
from loguru import logger
from sqlalchemy.orm import selectinload
from sqlalchemy import select, func as sql_func 
from aiogram.exceptions import TelegramBadRequest 

from core.ui.callback_data_factories import AdminRolesPanelNavigate
from .keyboards_roles import get_admin_role_details_keyboard_local, ROLES_MGMT_TEXTS
from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS
from core.admin.filters_admin import can_view_admin_panel_filter
from core.rbac.service import PERMISSION_CORE_ROLES_VIEW, DEFAULT_ROLES_DEFINITIONS
from core.database.core_models import Role as DBRole

from typing import TYPE_CHECKING, Optional
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession 

role_details_router = Router(name="sdb_admin_role_details_handlers")
MODULE_NAME_FOR_LOG = "AdminRoleMgmtDetails"

#role_details_router.callback_query.filter(can_view_admin_panel_filter)

@role_details_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "view"))
async def cq_admin_role_view_details_entry( 
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate, 
    services_provider: 'BotServicesProvider'
):
    # logger.critical(f"!!! [{MODULE_NAME_FOR_LOG}] –•–≠–ù–î–õ–ï–† cq_admin_role_view_details_entry –í–´–ó–í–ê–ù! Callback: {callback_data.model_dump_json(exclude_none=True)}") # <--- –£–ë–†–ê–ù–û
    
    admin_user_id = query.from_user.id
    target_role_db_id: Optional[int] = None 
    
    logger.debug(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—É—á–µ–Ω callback –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏: {callback_data.model_dump_json(exclude_none=True)}")

    if callback_data.item_id is None or not str(callback_data.item_id).isdigit():
        logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π item_id (ID —Ä–æ–ª–∏: {callback_data.item_id}) –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π.")
        await query.answer("–û—à–∏–±–∫–∞: ID —Ä–æ–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.", show_alert=True)
        return
    
    target_role_db_id = int(str(callback_data.item_id))
        
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –¥–µ—Ç–∞–ª–∏ —Ä–æ–ª–∏ —Å DB ID: {target_role_db_id}")

    async with services_provider.db.get_session() as session: # type: AsyncSession
        has_perm_to_view = False
        is_owner_from_config = admin_user_id in services_provider.config.core.super_admins
        if is_owner_from_config:
            has_perm_to_view = True
            logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} —è–≤–ª—è–µ—Ç—Å—è –í–ª–∞–¥–µ–ª—å—Ü–µ–º, –¥–æ—Å—Ç—É–ø –∫ –¥–µ—Ç–∞–ª—è–º —Ä–æ–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω.")
        else:
            try:
                has_perm_to_view = await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_VIEW)
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ '{PERMISSION_CORE_ROLES_VIEW}': {has_perm_to_view}")
            except Exception as e_perm:
                 logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∞ PERMISSION_CORE_ROLES_VIEW –¥–ª—è {admin_user_id}: {e_perm}")
                 await query.answer(ADMIN_COMMON_TEXTS["error_general"], show_alert=True)
                 return

        if not has_perm_to_view:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω {admin_user_id} –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏.")
            await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True)
            return

        role = await session.get(DBRole, target_role_db_id, options=[selectinload(DBRole.permissions)])
        
        if not role:
            logger.warning(f"[{MODULE_NAME_FOR_LOG}] –†–æ–ª—å —Å DB ID: {target_role_db_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            await query.answer(ADMIN_COMMON_TEXTS["not_found_generic"], show_alert=True)
            return
        
        logger.debug(f"[{MODULE_NAME_FOR_LOG}] –†–æ–ª—å '{role.name}' –Ω–∞–π–¥–µ–Ω–∞, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã...")
        permissions_list_str = "\n".join(
            [f"  ‚ñ´Ô∏è {hcode(p.name)} ({hitalic(p.description or '–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è')})" for p in sorted(role.permissions, key=lambda x: x.name)]
        ) if role.permissions else "  (–Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π)"

        text_parts = [
            f"{ROLES_MGMT_TEXTS['role_details_title']}: {hcode(role.name)}",
            f"   DB ID: {hcode(str(role.id))}",
            f"   –û–ø–∏—Å–∞–Ω–∏–µ: {hitalic(role.description or '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')}",
            f"\n{hbold('–†–∞–∑—Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π —Ä–æ–ª–∏:')}",
            permissions_list_str
        ]
        text = "\n".join(text_parts)
        
        keyboard = await get_admin_role_details_keyboard_local(role, services_provider, admin_user_id, session)
        logger.debug(f"[{MODULE_NAME_FOR_LOG}] –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏ '{role.name}' —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞.")

        if query.message:
            try:
                if query.message.text != text or query.message.reply_markup != keyboard:
                    await query.message.edit_text(text, reply_markup=keyboard)
                    logger.debug(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ä–æ–ª–∏ '{role.name}' –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ.")
                else:
                    logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏ ({role.id}) –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")
                await query.answer()
            except TelegramBadRequest as e_tbr:
                if "message is not modified" in str(e_tbr).lower():
                    logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏ ({role.id}) –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
                    await query.answer()
                else:
                    logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π —Ä–æ–ª–∏ ({role.id}): {e_tbr}")
            except Exception as e_edit:
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ cq_admin_role_view_details_entry –¥–ª—è —Ä–æ–ª–∏ {role.id}: {e_edit}", exc_info=True)
                await query.answer(ADMIN_COMMON_TEXTS["error_general"], show_alert=True)
        else: 
             logger.warning(f"[{MODULE_NAME_FOR_LOG}] query.message is None –≤ cq_admin_role_view_details_entry –¥–ª—è —Ä–æ–ª–∏ {role.id}.")
             await query.answer()


======================================================================

------------------------------ FILE: core/admin/roles/handlers_list.py ------------------------------
# core/admin/roles/handlers_list.py
from aiogram import Router, types, F, Bot 
from aiogram.utils.markdown import hbold
from loguru import logger
from sqlalchemy import select, func as sql_func
from aiogram.exceptions import TelegramBadRequest # <--- –ò–°–ü–†–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢

from core.ui.callback_data_factories import AdminRolesPanelNavigate
from .keyboards_roles import get_admin_roles_list_keyboard_local, ROLES_MGMT_TEXTS
from core.admin.filters_admin import can_view_admin_panel_filter 
from core.rbac.service import PERMISSION_CORE_ROLES_VIEW
from core.database.core_models import Role as DBRole

from typing import TYPE_CHECKING, List
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider
    from sqlalchemy.ext.asyncio import AsyncSession 

roles_list_router = Router(name="sdb_admin_roles_list_handlers")
MODULE_NAME_FOR_LOG = "AdminRoleMgmtList"

#roles_list_router.callback_query.filter(can_view_admin_panel_filter) 

@roles_list_router.callback_query(AdminRolesPanelNavigate.filter(F.action == "list"))
async def cq_admin_roles_list_entry( 
    query: types.CallbackQuery,
    callback_data: AdminRolesPanelNavigate, 
    services_provider: 'BotServicesProvider',
    bot: Bot 
):
    admin_user_id = query.from_user.id
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π.")

    async with services_provider.db.get_session() as session: # type: AsyncSession
        has_perm_to_view_list = False
        is_owner_from_config = admin_user_id in services_provider.config.core.super_admins
        if is_owner_from_config:
            has_perm_to_view_list = True
        else:
            try:
                has_perm_to_view_list = await services_provider.rbac.user_has_permission(session, admin_user_id, PERMISSION_CORE_ROLES_VIEW)
            except Exception as e_perm_check_list:
                logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∞ PERMISSION_CORE_ROLES_VIEW –¥–ª—è user {admin_user_id}: {e_perm_check_list}")
                await query.answer("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤.", show_alert=True) 
                return

        if not has_perm_to_view_list:
            await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π.", show_alert=True) 
            return
        
        all_roles: List[DBRole] = await services_provider.rbac.get_all_roles(session)
        
        text = f"{ROLES_MGMT_TEXTS['role_list_title']}\n{ROLES_MGMT_TEXTS['role_list_select_action']}"
        keyboard = await get_admin_roles_list_keyboard_local(all_roles, services_provider, admin_user_id, session)

        target_chat_id = query.message.chat.id if query.message else admin_user_id

        try:
            if query.message and (query.message.text != text or query.message.reply_markup != keyboard):
                await query.message.edit_text(text, reply_markup=keyboard)
                logger.debug(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ä–æ–ª–µ–π –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ.")
            elif not query.message: 
                 await bot.send_message(target_chat_id, text, reply_markup=keyboard)
                 logger.debug(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ä–æ–ª–µ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (—Ç.–∫. query.message –±—ã–ª None).")
            else:
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ.")
            await query.answer()
        except TelegramBadRequest as e_tbr: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TelegramBadRequest
            if query.message and "message to edit not found" in str(e_tbr).lower(): 
                logger.warning(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ: {e_tbr}")
                await bot.send_message(target_chat_id, text, reply_markup=keyboard)
                await query.answer()
            elif "message is not modified" in str(e_tbr).lower():
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
                await query.answer()
            else:
                logger.warning(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ Telegram BadRequest –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏/–æ—Ç–ø—Ä–∞–≤–∫–µ —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π: {e_tbr}")
                await query.answer("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞.", show_alert=True)
        except Exception as e_edit:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ cq_admin_roles_list_entry: {e_edit}", exc_info=True)
            await query.answer("–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π.", show_alert=True)


======================================================================

------------------------------ FILE: core/admin/roles/__init__.py ------------------------------
# core/admin/roles/__init__.py
from aiogram import Router

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º "–∫–æ–Ω–µ—á–Ω—ã–µ" —Ä–æ—É—Ç–µ—Ä—ã –∏–∑ —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
from .handlers_list import roles_list_router
from .handlers_details import role_details_router
from .handlers_role_perms import role_permissions_router
from .handlers_crud_fsm import role_crud_fsm_router

# –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω "—Å–æ–±–∏—Ä–∞—é—â–∏–π" —Ä–æ—É—Ç–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ "roles"
section_roles_router = Router(name="sdb_admin_section_roles_router")

section_roles_router.include_router(roles_list_router)
section_roles_router.include_router(role_details_router)
section_roles_router.include_router(role_permissions_router)
section_roles_router.include_router(role_crud_fsm_router)

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–±–∏—Ä–∞—é—â–∏–π —Ä–æ—É—Ç–µ—Ä —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
__all__ = ["section_roles_router"]


======================================================================

------------------------------ FILE: core/admin/sys_info/keyboards_sys_info.py ------------------------------
# core/admin/sys_info/keyboards_sys_info.py
from aiogram import types # <--- –î–û–ë–ê–í–õ–ï–ù –≠–¢–û–¢ –ò–ú–ü–û–†–¢
from aiogram.utils.keyboard import InlineKeyboardBuilder
from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS, get_back_to_admin_main_menu_button

def get_sys_info_keyboard() -> types.InlineKeyboardMarkup: # –ò—Å–ø–æ–ª—å–∑—É–µ–º types.InlineKeyboardMarkup
    builder = InlineKeyboardBuilder()
    builder.row(get_back_to_admin_main_menu_button())
    return builder.as_markup()

# –ï—Å–ª–∏ –¥–ª—è sys_info –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è —Å–≤–æ–∏ —Ç–µ–∫—Å—Ç—ã, –∏—Ö –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—é–¥–∞:
SYS_INFO_TEXTS = {
    "system_info_title": "üñ•Ô∏è –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è SwiftDevBot",
    # ... –¥—Ä—É–≥–∏–µ —Ç–µ–∫—Å—Ç—ã ...
}


======================================================================

------------------------------ FILE: core/admin/sys_info/handlers_sys_info.py ------------------------------
# SwiftDevBot/core/admin/sys_info/handlers_sys_info.py
import sys
import platform
from datetime import datetime, timezone 
import psutil 
import aiogram 
import asyncio 
import os 
from pathlib import Path

from aiogram import Router, types, F, Bot
from aiogram.utils.markdown import hbold, hcode 
from loguru import logger
from sqlalchemy import select, func as sql_func 
from aiogram.exceptions import TelegramBadRequest

from core.admin.keyboards_admin_common import ADMIN_COMMON_TEXTS
from .keyboards_sys_info import get_sys_info_keyboard
from core.ui.callback_data_factories import AdminSysInfoPanelNavigate
from core.admin.filters_admin import can_view_admin_panel_filter 
from core.rbac.service import PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL, PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC
from core.database.core_models import User as DBUserModel 
from core.bot_entrypoint import PID_FILENAME

from typing import TYPE_CHECKING, List, Optional
if TYPE_CHECKING:
    from core.services_provider import BotServicesProvider

sys_info_router = Router(name="sdb_admin_sys_info_handlers")
MODULE_NAME_FOR_LOG = "AdminSysInfo"

async def _get_local_total_users_count(services_provider: 'BotServicesProvider') -> Optional[int]:
    try:
        async with services_provider.db.get_session() as session:
            count_stmt = select(sql_func.count(DBUserModel.id))
            total_users_result = await session.execute(count_stmt)
            return total_users_result.scalar_one_or_none() or 0
    except Exception as e: 
        logger.error(f"[{MODULE_NAME_FOR_LOG}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è SysInfo: {e}")
        return None

def format_uptime(start_time: Optional[datetime]) -> str:
    if not start_time:
        return "–ù/–î"
    if start_time.tzinfo is None:
        start_time = start_time.replace(tzinfo=timezone.utc)
    uptime_delta = datetime.now(timezone.utc) - start_time
    days = uptime_delta.days
    hours, remainder = divmod(uptime_delta.seconds, 3600)
    minutes, seconds = divmod(remainder, 60)
    parts = []
    if days > 0: parts.append(f"{int(days)}–¥")
    if hours > 0: parts.append(f"{int(hours)}—á")
    if minutes > 0: parts.append(f"{int(minutes)}–º")
    parts.append(f"{int(seconds)}—Å")
    return " ".join(parts) or "~0—Å"

@sys_info_router.callback_query(AdminSysInfoPanelNavigate.filter(F.action == "show"))
async def cq_admin_show_system_info_entry( 
    query: types.CallbackQuery, 
    callback_data: AdminSysInfoPanelNavigate, 
    services_provider: 'BotServicesProvider',
    bot: Bot 
):
    user_id = query.from_user.id 
    logger.info(f"[{MODULE_NAME_FOR_LOG}] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.")

    can_view_full = False
    can_view_basic = False
    is_owner_from_config = user_id in services_provider.config.core.super_admins
    async with services_provider.db.get_session() as session:
        if not is_owner_from_config: 
            can_view_full = await services_provider.rbac.user_has_permission(session, user_id, PERMISSION_CORE_SYSTEM_VIEW_INFO_FULL)
            if not can_view_full: 
                can_view_basic = await services_provider.rbac.user_has_permission(session, user_id, PERMISSION_CORE_SYSTEM_VIEW_INFO_BASIC)
        
    if not (is_owner_from_config or can_view_full or can_view_basic):
        await query.answer(ADMIN_COMMON_TEXTS["access_denied"], show_alert=True)
        return

    s = services_provider.config 
    
    text_parts: List[str] = [f"üñ•Ô∏è {hbold('–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è SwiftDevBot')}\n"]

    # –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    text_parts.append(f"‚ÑπÔ∏è {hbold('–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è')} ‚îÄ‚îÄ‚îÄ")
    text_parts.append(f"  ‚ñ∏ {hbold('SDB Core')}: {hcode(f'v{s.core.sdb_version}')}")
    text_parts.append(f"  ‚ñ∏ {hbold('Python')}: {hcode(f'v{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}')}")
    text_parts.append(f"  ‚ñ∏ {hbold('Aiogram')}: {hcode(f'v{aiogram.__version__}')}")
    text_parts.append(f"  ‚ñ∏ {hbold('–û–°')}: {platform.system()} {platform.release()} ({platform.machine()})")
    
    # –ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞
    text_parts.append(f"\nü§ñ {hbold('–ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞')} ‚îÄ‚îÄ‚îÄ")
    current_pid_handler = os.getpid() 
    pid_file_path = s.core.project_data_path / PID_FILENAME
    
    pid_for_psutil_stats = current_pid_handler
    pid_display_str = hcode(str(current_pid_handler))

    if pid_file_path.is_file():
        try:
            pid_from_file = int(pid_file_path.read_text().strip())
            pid_display_str = hcode(str(pid_from_file))
            if psutil and psutil.pid_exists(pid_from_file):
                process = psutil.Process(pid_from_file)
                create_time = datetime.fromtimestamp(process.create_time(), tz=timezone.utc)
                uptime_val = format_uptime(create_time)
                start_time_str = create_time.strftime('%d.%m.%Y %H:%M')
                text_parts.append(f"  ‚ñ∏ {hbold('–ó–∞–ø—É—â–µ–Ω')}: {start_time_str}")
                text_parts.append(f"  ‚ñ∏ {hbold('PID')}: {pid_display_str}")
                text_parts.append(f"  ‚ñ∏ {hbold('–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã')}: {hbold(uptime_val)}")
                pid_for_psutil_stats = pid_from_file 
            else:
                status_msg = "–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
                if not psutil: status_msg += " (psutil –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)"
                text_parts.append(f"  ‚ñ∏ {hbold('–°—Ç–∞—Ç—É—Å (PID –∏–∑ —Ñ–∞–π–ª–∞)')}: {hcode(status_msg)} (PID: {pid_display_str})")
                text_parts.append(f"  ‚ñ∏ {hbold('PID (—Ö—ç–Ω–¥–ª–µ—Ä–∞)')}: {hcode(str(current_pid_handler))}")
        except Exception as e_pid:
            logger.warning(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ PID-—Ñ–∞–π–ª–∞: {e_pid}")
            text_parts.append(f"  ‚ñ∏ {hbold('PID (–∏–∑ —Ñ–∞–π–ª–∞)')}: {hcode('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è')}")
            text_parts.append(f"  ‚ñ∏ {hbold('PID (—Ö—ç–Ω–¥–ª–µ—Ä–∞)')}: {hcode(str(current_pid_handler))}")
    elif psutil:
        try:
            process = psutil.Process(current_pid_handler)
            create_time = datetime.fromtimestamp(process.create_time(), tz=timezone.utc)
            uptime_val = format_uptime(create_time)
            start_time_str = create_time.strftime('%d.%m.%Y %H:%M')
            text_parts.append(f"  ‚ñ∏ {hbold('–ó–∞–ø—É—â–µ–Ω (—Ç–µ–∫. –ø—Ä–æ—Ü–µ—Å—Å)')}: {start_time_str} (PID: {pid_display_str})")
            text_parts.append(f"  ‚ñ∏ {hbold('–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (—Ç–µ–∫.)')}: {hbold(uptime_val)}")
        except Exception: 
             text_parts.append(f"  ‚ñ∏ {hbold('–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã')}: –ù/–î (–æ—à–∏–±–∫–∞ psutil –¥–ª—è PID: {pid_display_str})")
    else:
        text_parts.append(f"  ‚ñ∏ {hbold('PID')}: {pid_display_str}")
        text_parts.append(f"  ‚ñ∏ {hbold('–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã')}: –ù/–î (PID-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω / psutil –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)")

    if psutil:
        try:
            target_ps_proc = psutil.Process(pid_for_psutil_stats)
            mem_rss_mb = target_ps_proc.memory_info().rss / (1024 * 1024)
            cpu_perc = target_ps_proc.cpu_percent(interval=0.05)
            text_parts.append(f"  ‚ñ∏ {hbold('–ü–∞–º—è—Ç—å (RSS)')}: {hbold(f'{mem_rss_mb:.2f} MB')}")
            text_parts.append(f"  ‚ñ∏ {hbold('CPU (–º–≥–Ω–æ–≤–µ–Ω.)')}: {hbold(f'{cpu_perc:.1f}%')}")
        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
             text_parts.append(f"  ‚ñ∏ {hbold('–ü–∞–º—è—Ç—å/CPU')}: {hcode(f'–ù/–î (–ø—Ä–æ—Ü–µ—Å—Å {pid_for_psutil_stats} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)')}")
        except Exception as e_ps_stats:
             logger.warning(f"–û—à–∏–±–∫–∞ psutil –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ PID {pid_for_psutil_stats}: {e_ps_stats}")
             text_parts.append(f"  ‚ñ∏ {hbold('–ü–∞–º—è—Ç—å/CPU')}: {hcode('–ù/–î (–æ—à–∏–±–∫–∞ psutil)')}")
    else:
        text_parts.append(f"  ‚ñ∏ {hbold('–ü–∞–º—è—Ç—å/CPU')}: {hcode('psutil –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')}")

    # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    text_parts.append(f"\nüóÉÔ∏è {hbold('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö')} ‚îÄ‚îÄ‚îÄ")
    text_parts.append(f"  ‚ñ∏ –¢–∏–ø: {hbold(s.db.type.upper())}")
    if s.db.type == "sqlite":
        text_parts.append(f"  ‚ñ∏ –ü—É—Ç—å: {hcode(s.db.sqlite_path)}")
    
    # –ö—ç—à
    text_parts.append(f"\nüíæ {hbold('–ö—ç—à')} ‚îÄ‚îÄ‚îÄ")
    text_parts.append(f"  ‚ñ∏ –¢–∏–ø: {hbold(s.cache.type.capitalize())}")
    if s.cache.type == "redis" and s.cache.redis_url:
        text_parts.append(f"  ‚ñ∏ URL: {hcode(str(s.cache.redis_url))}") 
    text_parts.append(f"  ‚ñ∏ –î–æ—Å—Ç—É–ø–µ–Ω: {'‚úÖ –î–∞' if services_provider.cache.is_available() else '‚ùå –ù–µ—Ç'}")

    # –ú–æ–¥—É–ª–∏
    try:
        total_modules = len(services_provider.modules.get_all_modules_info())
        loaded_modules = len(services_provider.modules.get_loaded_modules_info(True, True))
        enabled_plugins = len(services_provider.modules.enabled_plugin_names)
        text_parts.append(f"\nüß© {hbold('–ú–æ–¥—É–ª–∏')} ‚îÄ‚îÄ‚îÄ")
        text_parts.append(f"  ‚ñ∏ –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: {hbold(str(total_modules))}")
        text_parts.append(f"  ‚ñ∏ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤: {hbold(str(enabled_plugins))}")
        text_parts.append(f"  ‚ñ∏ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {hbold(str(loaded_modules))}")
    except Exception as e_mod_info:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥—É–ª—è—Ö: {e_mod_info}")
        text_parts.append(f"\nüß© {hbold('–ú–æ–¥—É–ª–∏')} ‚îÄ‚îÄ‚îÄ")
        text_parts.append(f"  ‚ñ∏ –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    total_users_count = await _get_local_total_users_count(services_provider)
    total_users_str = hbold(str(total_users_count)) if total_users_count is not None else f"{hcode('[–û—à–∏–±–∫–∞]')}"
    text_parts.append(f"\nüë• {hbold('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏')} ‚îÄ‚îÄ‚îÄ")
    text_parts.append(f"  ‚ñ∏ –í—Å–µ–≥–æ –≤ –ë–î: {total_users_str}")

    text_response = "\n".join(text_parts)
    keyboard_sysinfo = get_sys_info_keyboard()

    if query.message:
        try:
            if query.message.text != text_response or query.message.reply_markup != keyboard_sysinfo:
                await query.message.edit_text(text_response, reply_markup=keyboard_sysinfo)
            else:
                logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")
            await query.answer()
        except TelegramBadRequest as e_tbr: 
            if "message is not modified" in str(e_tbr).lower():
                 logger.trace(f"[{MODULE_NAME_FOR_LOG}] –°–æ–æ–±—â–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ (–ø–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ).")
                 await query.answer()
            else:
                logger.error(f"[{MODULE_NAME_FOR_LOG}] TelegramBadRequest –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {e_tbr}", exc_info=True)
                await query.answer(ADMIN_COMMON_TEXTS["error_general"], show_alert=True)
        except Exception as e_edit:
            logger.error(f"[{MODULE_NAME_FOR_LOG}] –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {e_edit}", exc_info=True)
            await query.answer(ADMIN_COMMON_TEXTS["error_general"], show_alert=True)
    else:
        await query.answer()


======================================================================

------------------------------ FILE: core/admin/sys_info/__init__.py ------------------------------
# core/admin/sys_info/__init__.py
from aiogram import Router

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º "–∫–æ–Ω–µ—á–Ω—ã–π" —Ä–æ—É—Ç–µ—Ä
from .handlers_sys_info import sys_info_router

# –°–æ–∑–¥–∞–µ–º "—Å–æ–±–∏—Ä–∞—é—â–∏–π" —Ä–æ—É—Ç–µ—Ä –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ (—Ö–æ—Ç—è –∑–¥–µ—Å—å –æ–Ω –≤–∫–ª—é—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω)
section_sys_info_router = Router(name="sdb_admin_section_sys_info_router")
section_sys_info_router.include_router(sys_info_router)

__all__ = ["section_sys_info_router"]


======================================================================

------------------------------ FILE: alembic_migrations/versions/d10040ec2cb7_initial_migration_for_core_tables.py ------------------------------
# alembic_migrations/script.py.mako
"""Initial migration for core tables

Revision ID: d10040ec2cb7
Revises: 
Create Date: 2025-06-14 08:36:19.434958

"""
from typing import Sequence, Union

from alembic import op # type: ignore
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'd10040ec2cb7'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('mod_example_table_one',
    sa.Column('name', sa.String(length=100), nullable=False, comment='–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è'),
    sa.Column('description', sa.String(length=255), nullable=True, comment='–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞'),
    sa.Column('is_active', sa.Boolean(), server_default='1', nullable=False),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_mod_example_table_one'))
    )
    op.create_index(op.f('ix_mod_example_table_one_id'), 'mod_example_table_one', ['id'], unique=False)
    op.create_table('mod_example_user_notes',
    sa.Column('user_telegram_id', sa.BigInteger(), nullable=False, comment='Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–≤–ª–∞–¥–µ–ª—å—Ü–∞ –∑–∞–º–µ—Ç–∫–∏'),
    sa.Column('note_text', sa.Text(), nullable=False, comment='–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏'),
    sa.Column('is_done', sa.Boolean(), nullable=False, comment='–û—Ç–º–µ—á–µ–Ω–∞ –ª–∏ –∑–∞–º–µ—Ç–∫–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_mod_example_user_notes'))
    )
    op.create_index(op.f('ix_mod_example_user_notes_id'), 'mod_example_user_notes', ['id'], unique=False)
    op.create_index(op.f('ix_mod_example_user_notes_user_telegram_id'), 'mod_example_user_notes', ['user_telegram_id'], unique=False)
    op.create_table('sdb_permissions',
    sa.Column('name', sa.String(length=100), nullable=False, comment="–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'view_users', 'manage_modules')"),
    sa.Column('description', sa.Text(), nullable=True, comment='–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_permissions'))
    )
    op.create_index(op.f('ix_sdb_permissions_id'), 'sdb_permissions', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_permissions_name'), 'sdb_permissions', ['name'], unique=True)
    op.create_table('sdb_roles',
    sa.Column('name', sa.String(length=50), nullable=False, comment='–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ä–æ–ª–∏'),
    sa.Column('description', sa.Text(), nullable=True, comment='–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_roles'))
    )
    op.create_index(op.f('ix_sdb_roles_id'), 'sdb_roles', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_roles_name'), 'sdb_roles', ['name'], unique=True)
    op.create_table('sdb_users',
    sa.Column('username_lower', sa.String(length=32), nullable=True, comment='Telegram username –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ –¥–ª—è –ø–æ–∏—Å–∫–∞'),
    sa.Column('telegram_id', sa.BigInteger(), nullable=False, comment='–£–Ω–∏–∫–∞–ª—å–Ω—ã–π Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'),
    sa.Column('username', sa.String(length=32), nullable=True, comment='Telegram username (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä)'),
    sa.Column('first_name', sa.String(length=255), nullable=True, comment='–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'),
    sa.Column('last_name', sa.String(length=255), nullable=True, comment='–§–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'),
    sa.Column('preferred_language_code', sa.String(length=10), nullable=True, comment='–ö–æ–¥ —è–∑—ã–∫–∞ –±–æ—Ç–∞'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='–ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'),
    sa.Column('is_bot_blocked', sa.Boolean(), nullable=False, comment='–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–æ—Ç–∞'),
    sa.Column('last_activity_at', sa.DateTime(), nullable=True, comment='–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_users'))
    )
    op.create_index(op.f('ix_sdb_users_id'), 'sdb_users', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_users_telegram_id'), 'sdb_users', ['telegram_id'], unique=True)
    op.create_index(op.f('ix_sdb_users_username'), 'sdb_users', ['username'], unique=False)
    op.create_index(op.f('ix_sdb_users_username_lower'), 'sdb_users', ['username_lower'], unique=False)
    op.create_table('mod_another_example_table',
    sa.Column('example_one_id', sa.Integer(), nullable=True),
    sa.Column('value', sa.String(length=200), nullable=False, comment='–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['example_one_id'], ['mod_example_table_one.id'], name=op.f('fk_mod_another_example_table_example_one_id_mod_example_table_one'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_mod_another_example_table'))
    )
    op.create_index(op.f('ix_mod_another_example_table_id'), 'mod_another_example_table', ['id'], unique=False)
    op.create_table('sdb_role_permissions',
    sa.Column('role_id', sa.Integer(), nullable=False, comment='ID —Ä–æ–ª–∏'),
    sa.Column('permission_id', sa.Integer(), nullable=False, comment='ID —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['permission_id'], ['sdb_permissions.id'], name=op.f('fk_sdb_role_permissions_permission_id_sdb_permissions'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['role_id'], ['sdb_roles.id'], name=op.f('fk_sdb_role_permissions_role_id_sdb_roles'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_role_permissions')),
    sa.UniqueConstraint('role_id', 'permission_id', name='uq_sdb_role_permissions_role_id_permission_id')
    )
    op.create_index(op.f('ix_sdb_role_permissions_id'), 'sdb_role_permissions', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_role_permissions_permission_id'), 'sdb_role_permissions', ['permission_id'], unique=False)
    op.create_index(op.f('ix_sdb_role_permissions_role_id'), 'sdb_role_permissions', ['role_id'], unique=False)
    op.create_table('sdb_user_permissions',
    sa.Column('user_id', sa.Integer(), nullable=False, comment='ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'),
    sa.Column('permission_id', sa.Integer(), nullable=False, comment='ID —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['permission_id'], ['sdb_permissions.id'], name=op.f('fk_sdb_user_permissions_permission_id_sdb_permissions'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['sdb_users.id'], name=op.f('fk_sdb_user_permissions_user_id_sdb_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_user_permissions')),
    sa.UniqueConstraint('user_id', 'permission_id', name='uq_sdb_user_permissions_user_id_permission_id')
    )
    op.create_index(op.f('ix_sdb_user_permissions_id'), 'sdb_user_permissions', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_user_permissions_permission_id'), 'sdb_user_permissions', ['permission_id'], unique=False)
    op.create_index(op.f('ix_sdb_user_permissions_user_id'), 'sdb_user_permissions', ['user_id'], unique=False)
    op.create_table('sdb_user_roles',
    sa.Column('user_id', sa.Integer(), nullable=False, comment='ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'),
    sa.Column('role_id', sa.Integer(), nullable=False, comment='ID —Ä–æ–ª–∏'),
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('(CURRENT_TIMESTAMP)'), nullable=False),
    sa.ForeignKeyConstraint(['role_id'], ['sdb_roles.id'], name=op.f('fk_sdb_user_roles_role_id_sdb_roles'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['sdb_users.id'], name=op.f('fk_sdb_user_roles_user_id_sdb_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_sdb_user_roles')),
    sa.UniqueConstraint('user_id', 'role_id', name='uq_sdb_user_roles_user_id_role_id')
    )
    op.create_index(op.f('ix_sdb_user_roles_id'), 'sdb_user_roles', ['id'], unique=False)
    op.create_index(op.f('ix_sdb_user_roles_role_id'), 'sdb_user_roles', ['role_id'], unique=False)
    op.create_index(op.f('ix_sdb_user_roles_user_id'), 'sdb_user_roles', ['user_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_sdb_user_roles_user_id'), table_name='sdb_user_roles')
    op.drop_index(op.f('ix_sdb_user_roles_role_id'), table_name='sdb_user_roles')
    op.drop_index(op.f('ix_sdb_user_roles_id'), table_name='sdb_user_roles')
    op.drop_table('sdb_user_roles')
    op.drop_index(op.f('ix_sdb_user_permissions_user_id'), table_name='sdb_user_permissions')
    op.drop_index(op.f('ix_sdb_user_permissions_permission_id'), table_name='sdb_user_permissions')
    op.drop_index(op.f('ix_sdb_user_permissions_id'), table_name='sdb_user_permissions')
    op.drop_table('sdb_user_permissions')
    op.drop_index(op.f('ix_sdb_role_permissions_role_id'), table_name='sdb_role_permissions')
    op.drop_index(op.f('ix_sdb_role_permissions_permission_id'), table_name='sdb_role_permissions')
    op.drop_index(op.f('ix_sdb_role_permissions_id'), table_name='sdb_role_permissions')
    op.drop_table('sdb_role_permissions')
    op.drop_index(op.f('ix_mod_another_example_table_id'), table_name='mod_another_example_table')
    op.drop_table('mod_another_example_table')
    op.drop_index(op.f('ix_sdb_users_username_lower'), table_name='sdb_users')
    op.drop_index(op.f('ix_sdb_users_username'), table_name='sdb_users')
    op.drop_index(op.f('ix_sdb_users_telegram_id'), table_name='sdb_users')
    op.drop_index(op.f('ix_sdb_users_id'), table_name='sdb_users')
    op.drop_table('sdb_users')
    op.drop_index(op.f('ix_sdb_roles_name'), table_name='sdb_roles')
    op.drop_index(op.f('ix_sdb_roles_id'), table_name='sdb_roles')
    op.drop_table('sdb_roles')
    op.drop_index(op.f('ix_sdb_permissions_name'), table_name='sdb_permissions')
    op.drop_index(op.f('ix_sdb_permissions_id'), table_name='sdb_permissions')
    op.drop_table('sdb_permissions')
    op.drop_index(op.f('ix_mod_example_user_notes_user_telegram_id'), table_name='mod_example_user_notes')
    op.drop_index(op.f('ix_mod_example_user_notes_id'), table_name='mod_example_user_notes')
    op.drop_table('mod_example_user_notes')
    op.drop_index(op.f('ix_mod_example_table_one_id'), table_name='mod_example_table_one')
    op.drop_table('mod_example_table_one')
    # ### end Alembic commands ###


======================================================================

------------------------------ FILE: alembic_migrations/versions/.gitkeep ------------------------------



======================================================================
