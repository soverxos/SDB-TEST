# 🔗 Управление API (api)

## Обзор

Модуль `api` предоставляет инструменты для управления API сервисами SwiftDevBot, включая мониторинг, управление ключами, настройку лимитов и тестирование endpoints.

## Основные команды

### `python sdb api status`

Показывает статус всех API сервисов.

**Опции:**
- `--detailed` - подробная информация
- `--json` - вывод в формате JSON
- `--health` - только проверка здоровья

**Примеры:**

```bash
# Показать статус API
python sdb api status

# Подробная информация
python sdb api status --detailed

# Только проверка здоровья
python sdb api status --health
```

**Результат:**
```
🔗 Статус API сервисов SwiftDevBot-Lite

📊 Основные сервисы:
   ✅ REST API: Работает (порт 8000)
      📊 Endpoints: 25 активных
      📈 Запросов/мин: 45
      📊 Среднее время ответа: 85ms
      🔗 Активные соединения: 12

   ✅ WebSocket API: Работает (порт 8001)
      📊 Подключений: 8 активных
      📈 Сообщений/мин: 120
      📊 Latency: 15ms
      🔗 Стабильность: 99.9%

   ✅ GraphQL API: Работает (порт 8002)
      📊 Схем: 3 активные
      📈 Запросов/мин: 15
      📊 Среднее время ответа: 120ms
      🔗 Кэш: Активен

📊 Дополнительные сервисы:
   ✅ Admin API: Работает (порт 8003)
   ✅ Metrics API: Работает (порт 8004)
   ✅ Health API: Работает (порт 8005)

📊 Общая статистика:
   🟢 Все API сервисы работают нормально
   📈 Общий uptime: 99.8%
   📊 Среднее время ответа: 95ms
   🔗 Rate limiting: Активен
```

### `python sdb api keys --generate`

Управляет API ключами.

**Опции:**
- `--generate` - создать новый ключ
- `--list` - показать все ключи
- `--revoke KEY` - отозвать ключ
- `--permissions PERMS` - установить права

**Примеры:**

```bash
# Создать новый API ключ
python sdb api keys --generate

# Показать все ключи
python sdb api keys --list

# Отозвать ключ
python sdb api keys --revoke api_key_abc123

# Создать ключ с правами
python sdb api keys --generate --permissions "read,write"
```

**Результат:**
```
🔑 Управление API ключами

📋 Создание нового ключа:
   🔑 Тип: Стандартный API ключ
   📊 Права: read, write, admin
   📅 Срок действия: 365 дней
   📋 Статус: Создается...

✅ API ключ успешно создан
🔑 Ключ: sdb_api_abc123def456ghi789
📊 Права: read, write, admin
📅 Создан: 2024-01-15 14:35:22
📅 Истекает: 2025-01-15 14:35:22
📋 Статус: Активен

📋 Информация о ключе:
   📊 Тип: Стандартный
   📊 Уровень доступа: Полный
   📊 IP ограничения: Нет
   📊 Rate limit: 1000 запросов/час

⚠️ ВНИМАНИЕ: Сохраните ключ в безопасном месте!
📋 Пример использования:
   curl -H "Authorization: Bearer sdb_api_abc123def456ghi789" \
        https://api.example.com/v1/status
```

### `python sdb api rate-limit --set`

Управляет лимитами запросов.

**Опции:**
- `--set LIMIT` - установить лимит
- `--get` - показать текущие лимиты
- `--reset` - сбросить лимиты
- `--user USER` - лимит для конкретного пользователя

**Примеры:**

```bash
# Установить лимит запросов
python sdb api rate-limit --set 1000/hour

# Показать текущие лимиты
python sdb api rate-limit --get

# Сбросить лимиты
python sdb api rate-limit --reset

# Установить лимит для пользователя
python sdb api rate-limit --set 500/hour --user admin
```

**Результат:**
```
⚡ Управление лимитами запросов

📋 Установка лимита:
   📊 Тип: Глобальный лимит
   📈 Лимит: 1000 запросов/час
   📋 Применение: Все пользователи
   📋 Статус: Настраивается...

✅ Лимит успешно установлен
📊 Новые настройки:
   📈 По умолчанию: 1000 запросов/час
   📈 Для премиум: 10000 запросов/час
   📈 Для админов: Без ограничений
   📈 Burst limit: 100 запросов/мин

📊 Текущие лимиты:
   👤 Обычные пользователи: 1000/час
   👤 Премиум пользователи: 10000/час
   👤 Администраторы: Без ограничений
   🔧 Системные запросы: 5000/час

📋 Настройки rate limiting:
   📊 Алгоритм: Token bucket
   📊 Burst tolerance: 10%
   📊 Retry after: 1 час
   📊 Headers: Включены
```

### `python sdb api docs --generate`

Генерирует документацию API.

**Опции:**
- `--generate` - создать документацию
- `--format html/pdf/json` - формат документации
- `--output DIR` - директория для сохранения
- `--include-examples` - включить примеры

**Примеры:**

```bash
# Создать документацию
python sdb api docs --generate

# Создать в HTML формате
python sdb api docs --generate --format html

# Создать с примерами
python sdb api docs --generate --include-examples

# Создать в определенную папку
python sdb api docs --generate --output ./docs/api
```

**Результат:**
```
📚 Генерация документации API

📋 Создание документации:
   📊 Тип: OpenAPI 3.0
   📊 Формат: HTML
   📊 Включить примеры: Да
   📋 Статус: Генерируется...

✅ Документация успешно создана
📁 Файлы созданы:
   📄 api_docs.html (2.3MB)
   📄 openapi.json (150KB)
   📄 postman_collection.json (50KB)
   📄 swagger.yaml (200KB)

📊 Статистика документации:
   📋 Endpoints: 25
   📋 Модели: 15
   📋 Примеры: 50
   📋 Схемы: 8

📋 Доступные форматы:
   📄 HTML: Интерактивная документация
   📄 PDF: Печатная версия
   📄 JSON: OpenAPI спецификация
   📄 YAML: Swagger спецификация

📋 Интеграции:
   📊 Postman: Коллекция создана
   📊 Swagger UI: Готов к использованию
   📊 Redoc: Альтернативный интерфейс
   📊 Insomnia: Совместимо
```

### `python sdb api test --endpoint`

Тестирует API endpoints.

**Опции:**
- `--endpoint ENDPOINT` - тестировать конкретный endpoint
- `--all` - тестировать все endpoints
- `--method GET/POST/PUT/DELETE` - HTTP метод
- `--verbose` - подробный вывод

**Примеры:**

```bash
# Тестировать конкретный endpoint
python sdb api test --endpoint /api/v1/status

# Тестировать все endpoints
python sdb api test --all

# Тестировать с определенным методом
python sdb api test --endpoint /api/v1/users --method POST

# Подробное тестирование
python sdb api test --endpoint /api/v1/health --verbose
```

**Результат:**
```
🧪 Тестирование API endpoints

📋 Тестируемые endpoints:
   📊 Базовый URL: https://api.example.com
   📊 Версия API: v1
   📊 Методы: GET, POST, PUT, DELETE
   📋 Статус: Выполняется...

📊 Результаты тестирования:

✅ GET /api/v1/status:
   ✅ Статус: 200 OK
   📊 Время ответа: 45ms
   📊 Размер ответа: 2.1KB
   📊 Headers: Корректны

✅ POST /api/v1/users:
   ✅ Статус: 201 Created
   📊 Время ответа: 120ms
   📊 Размер ответа: 1.8KB
   📊 Валидация: Успешно

✅ PUT /api/v1/users/{id}:
   ✅ Статус: 200 OK
   📊 Время ответа: 95ms
   📊 Размер ответа: 1.5KB
   📊 Обновление: Успешно

❌ DELETE /api/v1/users/{id}:
   ❌ Статус: 403 Forbidden
   📊 Причина: Недостаточно прав
   📊 Время ответа: 25ms

📊 Общая статистика:
   ✅ Успешных тестов: 3/4
   ❌ Неудачных тестов: 1/4
   📊 Среднее время ответа: 71ms
   📈 Успешность: 75%

📋 Рекомендации:
   🔧 Проверьте права доступа для DELETE
   📊 Все остальные endpoints работают корректно
   ✅ API готов к использованию
```

## Расширенные команды (в разработке)

### `python sdb api monitor --real-time`

Мониторинг API в реальном времени.

**Опции:**
- `--real-time` - мониторинг в реальном времени
- `--dashboard` - веб-интерфейс мониторинга
- `--alerts` - настройка алертов

**Примеры:**

```bash
# Мониторинг в реальном времени
python sdb api monitor --real-time

# Веб-интерфейс мониторинга
python sdb api monitor --dashboard

# Настройка алертов
python sdb api monitor --alerts
```

**Результат:**
```
📊 Мониторинг API в реальном времени

📋 Текущие метрики:
   📊 Активных соединений: 25
   📊 Запросов/мин: 180
   📊 Среднее время ответа: 85ms
   📊 Успешность: 99.2%

📊 Статистика (24 часа):
   📈 Всего запросов: 259,200
   ✅ Успешных: 257,126 (99.2%)
   ❌ Ошибок: 2,074 (0.8%)
   📊 По методам:
      📊 GET: 180,000 (99.5%)
      📊 POST: 45,000 (98.8%)
      📊 PUT: 20,000 (99.1%)
      📊 DELETE: 14,200 (98.9%)

🔔 Алерты:
   🟢 API работает нормально
   ⚠️ 2 медленных запроса (>2 сек) за последний час
   📊 Rate limiting активен

📋 Рекомендации:
   🔧 Оптимизируйте медленные endpoints
   📊 Мониторьте нагрузку на сервер
   🔄 Настройте автоматическое масштабирование
```

### `python sdb api optimize --auto`

Автоматическая оптимизация API.

**Опции:**
- `--auto` - автоматическая оптимизация
- `--analyze` - анализ производительности
- `--cache` - оптимизация кэширования

**Примеры:**

```bash
# Автоматическая оптимизация
python sdb api optimize --auto

# Анализ производительности
python sdb api optimize --analyze

# Оптимизация кэширования
python sdb api optimize --cache
```

**Результат:**
```
🔧 Автоматическая оптимизация API

📋 Анализ производительности:
   📊 Медленные endpoints: 3
   📊 Неоптимальные запросы: 15
   📊 Отсутствующее кэширование: 8
   📊 Избыточные данные: 5

📊 Оптимизации:
   ✅ Добавлено кэширование для 8 endpoints
   ✅ Оптимизированы запросы к БД: 15
   ✅ Уменьшены размеры ответов: 5
   ✅ Настроены индексы: 3

📈 Результаты оптимизации:
   📊 Среднее время ответа: -25% (85ms → 64ms)
   📊 Пропускная способность: +30% (180 → 234 req/min)
   📊 Использование CPU: -15%
   📊 Успешность: +0.5% (99.2% → 99.7%)

📋 Рекомендации:
   🔄 Регулярно выполняйте оптимизацию
   📊 Мониторьте производительность endpoints
   🔧 Настройте автоматическую оптимизацию
```

### `python sdb api security --audit`

Аудит безопасности API.

**Опции:**
- `--audit` - полный аудит безопасности
- `--scan` - сканирование уязвимостей
- `--test` - тестирование безопасности

**Примеры:**

```bash
# Аудит безопасности
python sdb api security --audit

# Сканирование уязвимостей
python sdb api security --scan

# Тестирование безопасности
python sdb api security --test
```

**Результат:**
```
🛡️ Аудит безопасности API

📋 Проверка безопасности:
   ✅ Аутентификация: Настроена
   ✅ Авторизация: Настроена
   ✅ Rate limiting: Активен
   ✅ CORS: Настроен

📊 Результаты сканирования:
   🟢 Критических уязвимостей: 0
   🟢 Средних уязвимостей: 0
   🟢 Низких уязвимостей: 2
   📊 Общий уровень безопасности: Высокий

📋 Найденные проблемы:
   ⚠️ Отсутствует CSRF защита для некоторых endpoints
   ⚠️ Некоторые endpoints не используют HTTPS

📊 Рекомендации по безопасности:
   🔧 Включите CSRF защиту для всех POST/PUT/DELETE
   🔧 Принудительно используйте HTTPS
   🔧 Добавьте дополнительные заголовки безопасности
   🔧 Настройте мониторинг подозрительной активности

📋 Статус безопасности:
   🟢 API защищен от основных атак
   ⚠️ Требуются дополнительные меры
   📊 Готов к продакшену с улучшениями
```

## Безопасность

### ❌ Критически опасные команды:
- `python sdb api keys --revoke --all` - отзовет все ключи
- `python sdb api reset` - сбросит все настройки API

### ⚠️ Опасные команды:
- `python sdb api keys --generate` - создаст новые ключи
- `python sdb api rate-limit --reset` - сбросит лимиты
- `python sdb api optimize --auto` - может изменить настройки

### ✅ Безопасные команды:
- `python sdb api status` - только показывает статус
- `python sdb api keys --list` - только показывает ключи
- `python sdb api rate-limit --get` - только показывает лимиты
- `python sdb api docs --generate` - только генерирует документацию
- `python sdb api test` - только тестирует endpoints

## Рекомендации

1. **Мониторинг**: Регулярно следите за производительностью API
2. **Безопасность**: Проводите аудит безопасности ежемесячно
3. **Документация**: Обновляйте документацию при изменениях
4. **Тестирование**: Регулярно тестируйте все endpoints
5. **Оптимизация**: Оптимизируйте медленные endpoints

## Устранение проблем

### Проблема: "API недоступен"
```bash
# Проверить статус
python sdb api status

# Проверить порты
python sdb system status

# Проверить логи
python sdb system logs --service api
```

### Проблема: "Медленные ответы"
```bash
# Анализ производительности
python sdb api optimize --analyze

# Автоматическая оптимизация
python sdb api optimize --auto

# Проверить мониторинг
python sdb api monitor --real-time
```

### Проблема: "Ошибки аутентификации"
```bash
# Проверить ключи
python sdb api keys --list

# Создать новый ключ
python sdb api keys --generate

# Проверить права
python sdb api keys --permissions
```

## Типы API

### REST API
- Стандартные HTTP методы
- JSON ответы
- RESTful архитектура
- Версионирование

### WebSocket API
- Реальное время
- Двусторонняя связь
- События и уведомления
- Подписки

### GraphQL API
- Гибкие запросы
- Единая схема
- Оптимизация данных
- Интроспекция

### Admin API
- Административные функции
- Системное управление
- Мониторинг
- Конфигурация

## Методы аутентификации

### API Keys
- Простая аутентификация
- Права доступа
- Срок действия
- Отзыв ключей

### JWT Tokens
- Безопасная аутентификация
- Временные токены
- Refresh tokens
- Стандарт RFC 7519

### OAuth 2.0
- Стандартная аутентификация
- Различные grant types
- Scope ограничения
- Третьи стороны

### Basic Auth
- Простая аутентификация
- Username/password
- HTTPS обязателен
- Ограниченное использование 